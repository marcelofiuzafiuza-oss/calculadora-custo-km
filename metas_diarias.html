<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MAX ROTA DI√ÅRIO</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --accent:#10b981;
  --bg1:#041226;
  --bg2:#1b2540;
  --card:rgba(255,255,255,0.03);
  --muted:#9aa6b2;
  --radius:12px;
}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,Arial;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#e6eef6;margin:0;padding:18px}
.wrap{max-width:1100px;margin:0 auto}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));border-radius:14px;padding:14px;margin-bottom:16px;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px}
.logo{display:flex;gap:12px;align-items:center}
.logo img{height:76px;border-radius:10px}
.title{font-size:20px;margin:0}
.sub{color:var(--muted);font-size:13px;margin-top:4px}

/* theme controls */
.theme-controls{display:flex;gap:8px;align-items:center}
.theme-btn{padding:8px 12px;border-radius:10px;background:var(--accent);border:0;color:#012;font-weight:800;cursor:pointer}
.color-dots{display:flex;gap:8px}
.color-dot{width:32px;height:32px;border-radius:999px;cursor:pointer;border:2px solid rgba(255,255,255,0.06)}

/* radio */
.radio-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.station-btn{padding:12px;border-radius:10px;border:0;cursor:pointer;font-weight:800;color:#fff;display:flex;align-items:center;justify-content:center;min-height:52px}
.station-btn.active{box-shadow:0 14px 30px rgba(0,0,0,0.6);transform:translateY(-4px)}

/* player */
.radio-player{display:flex;gap:12px;align-items:center;margin-top:12px}

/* meta */
.meta-row{display:flex;gap:10px;align-items:center}
.big-input{padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:inherit;font-weight:800}
.progress{position:relative;height:50px;border-radius:999px;background:rgba(255,255,255,0.02);overflow:hidden;border:1px solid rgba(255,255,255,0.04);margin-top:12px}
.progress-fill{position:absolute;left:0;top:0;height:100%;width:0;background:linear-gradient(90deg,var(--accent),#2563eb);transition:width .7s}
.progress-text{position:absolute;left:0;right:0;text-align:center;line-height:50px;font-weight:900}

/* km & timer */
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px}
.card-field{background:rgba(255,255,255,0.01);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
.big-value{font-weight:900;font-size:18px;margin-top:6px}

/* actions */
.actions{display:flex;gap:8px;margin-top:12px}
.btn-primary{background:var(--accent);border:0;padding:10px 14px;border-radius:10px;color:#012;font-weight:900;cursor:pointer}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px 12px;border-radius:10px;color:var(--muted);cursor:pointer}

/* lancamentos */
.lancamentos-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.apps-grid,.gastos-grid{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
.app-btn,.gasto-btn{min-width:130px;height:52px;border-radius:12px;border:0;font-weight:900;cursor:pointer;color:#fff;display:flex;align-items:center;justify-content:center}

/* list */
.launch-list{max-height:320px;overflow:auto;margin-top:12px;display:flex;flex-direction:column;gap:8px}
.launch-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:rgba(0,0,0,0.12)}
.launch-item .meta{font-weight:800}

/* resumo */
.resumo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.mini-card{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);font-weight:800}

.metric-compare{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
.metric-panel{padding:12px;border-radius:10px;background:rgba(255,255,255,0.01)}

@media(max-width:980px){
  .radio-grid{grid-template-columns:repeat(2,1fr)}
  .grid-4{grid-template-columns:repeat(2,1fr)}
  .lancamentos-grid{grid-template-columns:1fr}
  .resumo-grid{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
  <div class="wrap">
    <section class="card header">
      <div class="logo">
        <img src="https://i.postimg.cc/3RWn008g/Chat-GPT-Image-12-de-nov-de-2025-14-32-56.png" alt="logo">
        <div>
          <h1 class="title">MAX ROTA DI√ÅRIO</h1>
          <div class="sub">Painel do motorista ‚Äî interface grande</div>
        </div>
      </div>
      <div class="theme-controls">
        <button id="autoTheme" class="theme-btn">Auto üåó</button>
        <div class="color-dots" id="colorDots">
          <div class="color-dot" data-accent="green" style="background:#10b981"></div>
          <div class="color-dot" data-accent="orange" style="background:#f97316"></div>
          <div class="color-dot" data-accent="yellow" style="background:#facc15"></div>
          <div class="color-dot" data-accent="red" style="background:#ef4444"></div>
        </div>
      </div>
    </section>

    <!-- radios -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>üéß Esta√ß√µes</strong><div class="sub">4 por linha</div></div>
      </div>
      <div class="radio-grid" id="stationButtons" role="list">
        <button class="station-btn" data-src="https://live.hunter.fm/pop_high" data-name="Pop Hits" style="background:#10b981">Pop Hits</button>
        <button class="station-btn" data-src="https://live.hunter.fm/pop2k_high" data-name="Pop2K" style="background:#f59e0b;color:#111">Pop2K</button>
        <button class="station-btn" data-src="https://live.hunter.fm/rock_high" data-name="Rock" style="background:#ef4444">Rock</button>
        <button class="station-btn" data-src="https://live.hunter.fm/mpb_high" data-name="MPB" style="background:#2563eb">MPB</button>

        <button class="station-btn" data-src="https://live.hunter.fm/sertanejo_high" data-name="Sertanejo" style="background:#c084fc">Sertanejo</button>
        <button class="station-btn" data-src="https://live.hunter.fm/gospel_high" data-name="Crist√£" style="background:#facc15;color:#111">Crist√£</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/groovesalad-128-mp3" data-name="Eletr√¥nica" style="background:#2563eb">Eletr√¥nica</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/secretagent-128-mp3" data-name="Surf" style="background:#06b6d4">Surf</button>

        <button class="station-btn" data-src="https://ice1.somafm.com/beatblender-128-mp3" data-name="Dance 2000" style="background:#db2777">Dance 2000</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/lush-128-mp3" data-name="Chill Lounge" style="background:#7c3aed">Chill</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/bagel-128-mp3" data-name="Alt Rock" style="background:#ef4444">Alt Rock</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/thetrip-128-mp3" data-name="EDM The Trip" style="background:#06b6d4">EDM</button>
      </div>

      <div class="radio-player">
        <audio id="radioPlayer" controls preload="none" style="width:72%"></audio>
        <div style="width:28%;display:flex;flex-direction:column;align-items:flex-end;gap:8px">
          <button id="stopRadio" class="btn-ghost" style="width:100%">Parar R√°dio</button>
          <div id="nowPlaying" class="sub" style="text-align:right">Nenhuma r√°dio selecionada.</div>
        </div>
      </div>
    </section>

    <!-- meta -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>üéØ Meta Di√°ria</strong><div class="sub">Barra com enchimento fluido</div></div>
      </div>
      <div class="meta-row" style="margin-top:12px">
        <input id="metaInput" class="big-input" type="number" placeholder="Ex: 300">
        <button id="saveMeta" class="btn-primary">Salvar Meta</button>
      </div>
      <div class="progress" role="progressbar" aria-label="Progresso da meta">
        <div id="progressFill" class="progress-fill"></div>
        <div id="progressText" class="progress-text">0%</div>
      </div>
      <div id="progressSub" class="sub" style="margin-top:8px">Defina a meta para acompanhar o progresso.</div>
    </section>

    <!-- km & timer -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>üöó Jornada & KM</strong><div class="sub">Salve KM, inicie expediente e monitore</div></div>
      </div>
      <div class="grid-4">
        <div class="card-field"><label>KM Inicial</label><input id="kmInicial" class="big-input" type="number" placeholder="Ex: 150000"></div>
        <div class="card-field"><label>KM Final</label><input id="kmFinal" class="big-input" type="number" placeholder="Ex: 150250"></div>
        <div class="card-field"><label>Tempo Trabalhado</label><div id="tempoTrabalhado" class="big-value">00:00:00</div></div>
        <div class="card-field"><label>KM Rodados</label><div id="kmRodados" class="big-value">0.0 km</div></div>
      </div>
      <div class="actions" style="margin-top:12px">
        <button id="toggleStart" class="btn-primary">Iniciar Expediente</button>
        <button id="finalizeDay" class="btn-primary" style="background:linear-gradient(90deg,var(--accent),#7c3aed)">Finalizar Dia</button>
        <button id="saveKmBtn" class="btn-primary">Salvar KM</button>
      </div>
      <div id="lastSession" style="margin-top:12px;display:none" class="mini-card"></div>
    </section>

    <!-- lan√ßamentos -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Lan√ßamentos</strong><div class="sub">Entradas (esquerda) ‚Äî Sa√≠das (direita)</div></div>
      </div>
      <div class="lancamentos-grid">
        <div>
          <div style="display:flex;gap:8px">
            <input id="valorEntrada" class="big-input" type="number" placeholder="Valor (R$)">
            <button id="addEntrada" class="btn-primary">Lan√ßar</button>
          </div>
          <div class="apps-grid">
            <button class="app-btn" data-cat="Uber" style="background:#000">Uber</button>
            <button class="app-btn" data-cat="99" style="background:#facc15;color:#111">99</button>
            <button class="app-btn" data-cat="inDriver" style="background:#10b981">inDriver</button>
            <button class="app-btn" data-cat="Particular" style="background:#6b7280">Particular</button>
            <button class="app-btn" data-cat="Loja" style="background:#1e3a8a">Loja</button>
            <button class="app-btn" data-cat="Doa√ß√£o" style="background:#8b5cf6">Doa√ß√£o</button>
          </div>
        </div>
        <div>
          <div style="display:flex;gap:8px">
            <input id="valorSaida" class="big-input" type="number" placeholder="Valor (R$)">
            <button id="addSaida" class="btn-primary">Lan√ßar</button>
          </div>
          <div class="gastos-grid">
            <button class="gasto-btn" data-cat="Combust√≠vel" style="background:#ef4444">Combust√≠vel</button>
            <button class="gasto-btn" data-cat="Alimenta√ß√£o" style="background:#8b5cf6">Alimenta√ß√£o</button>
            <button class="gasto-btn" data-cat="Manuten√ß√£o" style="background:#6b7280">Manuten√ß√£o</button>
            <button class="gasto-btn" data-cat="Outros" style="background:#374151">Outros</button>
          </div>
        </div>
      </div>
    </section>

    <!-- recentes -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Lan√ßamentos Recentes</strong><div class="sub">Edite ou exclua</div></div>
      </div>
      <div id="lancamentosList" class="launch-list"><div class="sub">Nenhum lan√ßamento ainda.</div></div>
    </section>

    <!-- resumo -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Resumo R√°pido</strong><div class="sub">Por categoria</div></div>
      </div>
      <div id="resumoCategorias" class="resumo-grid">
        <div class="mini-card">Sem entradas</div>
        <div class="mini-card">Sem entradas</div>
        <div class="mini-card">Sem entradas</div>
      </div>
    </section>

    <!-- metricas -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>M√©tricas</strong><div class="sub">Compara√ß√£o Apps x Apps+Loja</div></div>
      </div>
      <div class="metric-compare">
        <div class="metric-panel">
          <div class="sub">Ganhos Brutos ‚Äî Somente Apps</div>
          <div id="ganhosApps" class="big-value">R$ 0,00</div>
          <div style="margin-top:10px" class="sub">M√©dia/h (Bruto)</div>
          <div id="mediaHoraApps" class="big-value">R$ 0,00</div>
        </div>
        <div class="metric-panel">
          <div class="sub">Ganhos Brutos ‚Äî Apps + Loja</div>
          <div id="ganhosTotal" class="big-value">R$ 0,00</div>
          <div style="margin-top:10px" class="sub">M√©dia/h (L√≠quido)</div>
          <div id="mediaHoraLiq" class="big-value">R$ 0,00</div>
        </div>
      </div>
    </section>

    <!-- a√ß√µes -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>A√ß√µes</strong><div class="sub">Salvar resumo, exportar e hist√≥rico</div></div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="saveReset" class="btn-primary">Salvar Resumo & Resetar Dia</button>
        <button id="exportBtn" class="btn-ghost">Exportar Resumo (JSON)</button>
        <button id="viewHistory" class="btn-ghost">Ver Hist√≥rico</button>
      </div>
      <div id="historyPanel" style="margin-top:12px;display:none"></div>
    </section>

    <footer style="text-align:center;margin-top:12px;color:var(--muted)">Dados armazenados localmente (localStorage)</footer>
  </div>

  <div id="confetti" class="confetti" aria-hidden="true" style="pointer-events:none;position:fixed;inset:0;z-index:9999"></div>
  <script>
/* Utilities */
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
const uid = ()=>Math.random().toString(36).slice(2,9);
const formatBRL = v=>Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const formatKM = v=>Number(v||0).toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1}) + ' km';
const formatTime = ms=>{ if(!ms||ms<=0) return '00:00:00'; const s=Math.floor(ms/1000), h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60; return [h,m,sec].map(n=>String(n).padStart(2,'0')).join(':') };

/* State */
let state = {
  meta:0, ganhosApps:0, ganhosLoja:0, totalDoacao:0, entradasApps:0, entradasLoja:0, gastos:0,
  history:[], totalTimeWorked:0, lastStartTime:null, status:'stopped', kmInicial:0, kmFinal:0, celebrated:false, lastSession:null
};
let timer = null;

/* Elements */
const stationButtons = $$('#stationButtons .station-btn');
const radioPlayer = $('#radioPlayer'), nowPlaying = $('#nowPlaying'), stopRadio = $('#stopRadio');

const metaInput = $('#metaInput'), saveMeta = $('#saveMeta'), progressFill = $('#progressFill'), progressText = $('#progressText'), progressSub = $('#progressSub');

const kmInicialEl = $('#kmInicial'), kmFinalEl = $('#kmFinal'), tempoTrabalhado = $('#tempoTrabalhado'), kmRodados = $('#kmRodados');
const toggleStart = $('#toggleStart'), finalizeDay = $('#finalizeDay'), saveKmBtn = $('#saveKmBtn');

const valorEntrada = $('#valorEntrada'), addEntrada = $('#addEntrada'), valorSaida = $('#valorSaida'), addSaida = $('#addSaida');
const appBtns = $$('.app-btn'), gastoBtns = $$('.gasto-btn');

const lancamentosList = $('#lancamentosList'), resumoCategorias = $('#resumoCategorias');

const ganhosAppsEl = $('#ganhosApps'), ganhosTotalEl = $('#ganhosTotal'), mediaHoraAppsEl = $('#mediaHoraApps'), mediaHoraLiqEl = $('#mediaHoraLiq');

const saveReset = $('#saveReset'), exportBtn = $('#exportBtn'), viewHistory = $('#viewHistory'), historyPanel = $('#historyPanel');

const lastSessionEl = $('#lastSession');
const confettiRoot = $('#confetti');

const autoTheme = $('#autoTheme'), colorDots = $$('#colorDots .color-dot');

/* Persistence */
function saveState(){ localStorage.setItem('maxrota_state', JSON.stringify(state)); localStorage.setItem('maxrota_meta', state.meta||0); }
function loadState(){ try{ const s = JSON.parse(localStorage.getItem('maxrota_state')||'{}'); if(Object.keys(s).length) Object.assign(state,s); const m = Number(localStorage.getItem('maxrota_meta')||0); if(m) state.meta = m; }catch(e){console.warn(e)} }
loadState();

/* Radio */
function setActive(btn){
  stationButtons.forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
}
stationButtons.forEach(btn=>btn.addEventListener('click', async ()=>{
  const src = btn.dataset.src, name = btn.dataset.name || btn.textContent;
  try{ radioPlayer.pause(); }catch(e){}
  radioPlayer.src = ''; setActive(btn); nowPlaying.textContent = 'Carregando: ' + name + ' ...';
  radioPlayer.crossOrigin = 'anonymous'; radioPlayer.src = src;
  try{ radioPlayer.load(); await radioPlayer.play(); nowPlaying.textContent = 'Tocando: ' + name; }catch(err){ console.warn(err); nowPlaying.textContent = 'Falha ao tocar ' + name; setActive(null); }
}));
stopRadio.addEventListener('click', ()=>{ try{ radioPlayer.pause(); radioPlayer.removeAttribute('src'); radioPlayer.load(); }catch(e){} nowPlaying.textContent='Nenhuma r√°dio selecionada.'; setActive(null); });

/* Timer & KM */
function getTempoTotal(){ let t = Number(state.totalTimeWorked||0); if(state.status==='running' && state.lastStartTime) t += (Date.now() - state.lastStartTime); return t; }
function getKMRodados(){ return (Number(state.kmFinal) > Number(state.kmInicial)) ? (Number(state.kmFinal) - Number(state.kmInicial)) : 0; }

function startTimer(){ stopTimer(); if(!state.lastStartTime) state.lastStartTime = Date.now(); timer = setInterval(()=>{ tempoTrabalhado.textContent = formatTime(getTempoTotal()); updateMetrics(); }, 1000); }
function stopTimer(){ if(timer){ clearInterval(timer); timer = null; } }

toggleStart.addEventListener('click', ()=>{
  if(state.status === 'stopped'){ state.status='running'; state.lastStartTime = Date.now(); toggleStart.textContent='Pausar'; startTimer(); }
  else if(state.status === 'running'){ state.totalTimeWorked += (Date.now() - state.lastStartTime); state.lastStartTime = null; state.status='paused'; toggleStart.textContent='Retomar'; stopTimer(); }
  else if(state.status === 'paused'){ state.status='running'; state.lastStartTime = Date.now(); toggleStart.textContent='Pausar'; startTimer(); }
  saveState(); renderUI();
});

$('#saveKmBtn').addEventListener('click', ()=>{ state.kmInicial = Number(kmInicialEl.value||0); state.kmFinal = Number(kmFinalEl.value||0); saveState(); renderUI(); });

/* Finalize Day: show mini-card with last session, then zero timer values */
finalizeDay.addEventListener('click', ()=>{
  const prior = getTempoTotal();
  const priorText = formatTime(prior);
  state.lastSession = { tempo: prior, label: priorText, date: new Date().toISOString() };
  lastSessionEl.style.display = 'block';
  lastSessionEl.innerHTML = `<strong>√öltima sess√£o</strong><div class="sub">Tempo: ${priorText}</div>`;
  // zero working time
  state.totalTimeWorked = 0; state.lastStartTime = null; state.status = 'stopped';
  stopTimer();
  toggleStart.textContent = 'Iniciar Expediente';
  saveState(); renderUI();
});

/* Meta */
saveMeta.addEventListener('click', ()=>{ const v = Number(metaInput.value||0); state.meta = v>0?v:0; localStorage.setItem('maxrota_meta', state.meta||0); saveState(); renderUI(); });

/* Lan√ßamentos */
function addLancamento(obj){
  const item = { id: uid(), type: obj.type, value: Number(obj.value), category: obj.category||'‚Äî', date: new Date().toISOString() };
  state.history.unshift(item);
  if(item.type === 'ganho'){
    if(item.category === 'Loja'){ state.ganhosLoja += item.value; state.entradasLoja++; }
    else if(item.category === 'Doa√ß√£o'){ state.totalDoacao += item.value; }
    else { state.ganhosApps += item.value; state.entradasApps++; }
  } else { state.gastos += item.value; }
  saveState(); renderUI();
}

appBtns.forEach(b=>b.addEventListener('click', ()=>{ const cat=b.dataset.cat||b.getAttribute('data-cat'); const v = Number(valorEntrada.value); if(isNaN(v)||v<=0){ alert('Valor inv√°lido'); return; } addLancamento({type:'ganho', value:v, category:cat}); valorEntrada.value=''; valorEntrada.focus(); }));
addEntrada.addEventListener('click', ()=>{ const v=Number(valorEntrada.value); if(isNaN(v)||v<=0){ alert('Valor inv√°lido'); return; } addLancamento({type:'ganho', value:v, category:'Particular'}); valorEntrada.value=''; valorEntrada.focus(); });

gastoBtns.forEach(b=>b.addEventListener('click', ()=>{ const cat=b.dataset.cat||b.getAttribute('data-cat'); const v = Number(valorSaida.value); if(isNaN(v)||v<=0){ alert('Valor inv√°lido'); return; } addLancamento({type:'gasto', value:v, category:cat}); valorSaida.value=''; valorSaida.focus(); }));
addSaida.addEventListener('click', ()=>{ const v=Number(valorSaida.value); if(isNaN(v)||v<=0){ alert('Valor inv√°lido'); return; } addLancamento({type:'gasto', value:v, category:'Outros'}); valorSaida.value=''; valorSaida.focus(); });

/* Render lan√ßamentos */
function renderLancamentos(){
  if(!lancamentosList) return;
  if(!state.history || state.history.length===0){ lancamentosList.innerHTML = '<div class="sub">Nenhum lan√ßamento ainda.</div>'; return; }
  lancamentosList.innerHTML = '';
  state.history.slice(0,200).forEach(it=>{
    const el = document.createElement('div'); el.className='launch-item';
    const left = document.createElement('div'); left.innerHTML = `<div class="meta">${it.category} ${it.type==='ganho'?'<span style="color:#10b981">+':'<span style="color:#fb7185">-'} ${formatBRL(it.value)}</span></div><div class="sub">${new Date(it.date).toLocaleString()}</div>`;
    const right = document.createElement('div'); right.style.display='flex';
    const edit = document.createElement('button'); edit.className='btn-ghost'; edit.textContent='Editar';
    const del = document.createElement('button'); del.className='btn-ghost'; del.textContent='Excluir';
    right.appendChild(edit); right.appendChild(del);
    el.appendChild(left); el.appendChild(right);
    lancamentosList.appendChild(el);

    edit.addEventListener('click', ()=>{
      const novoStr = prompt('Novo valor (R$):', it.value.toFixed(2));
      if(novoStr === null) return;
      const novo = Number(novoStr);
      if(isNaN(novo)||novo<0){ alert('Valor inv√°lido'); return; }
      if(it.type==='ganho'){ if(it.category==='Loja') state.ganhosLoja -= it.value; else if(it.category==='Doa√ß√£o') state.totalDoacao -= it.value; else state.ganhosApps -= it.value; } else state.gastos -= it.value;
      it.value = novo;
      if(it.type==='ganho'){ if(it.category==='Loja') state.ganhosLoja += it.value; else if(it.category==='Doa√ß√£o') state.totalDoacao += it.value; else state.ganhosApps += it.value; } else state.gastos += it.value;
      saveState(); renderUI();
    });

    del.addEventListener('click', ()=>{
      if(!confirm('Excluir lan√ßamento?')) return;
      const idx = state.history.findIndex(h=>h.id===it.id); if(idx===-1) return;
      const item = state.history[idx];
      if(item.type==='ganho'){ if(item.category==='Loja'){ state.ganhosLoja -= item.value; state.entradasLoja = Math.max(0,state.entradasLoja-1); } else if(item.category==='Doa√ß√£o'){ state.totalDoacao -= item.value; } else { state.ganhosApps -= item.value; state.entradasApps = Math.max(0,state.entradasApps-1); } } else state.gastos -= item.value;
      state.history.splice(idx,1);
      saveState(); renderUI();
    });
  });
}

/* resumo categorias */
function renderResumo(){
  const totals = {}, counts = {};
  (state.history||[]).forEach(it=>{ if(it.type!=='ganho') return; const cat=it.category||'Outros'; totals[cat]=(totals[cat]||0)+it.value; counts[cat]=(counts[cat]||0)+1; });
  resumoCategorias.innerHTML = '';
  const order=['Uber','99','inDriver','Particular','Loja','Doa√ß√£o'];
  order.forEach(cat=>{
    const v = totals[cat]||0, c = counts[cat]||0;
    const el = document.createElement('div'); el.className='mini-card'; el.innerHTML = `<div style="font-weight:900">${cat}</div><div style="margin-top:6px">${formatBRL(v)}</div><div class="sub">${c} entr.</div>`;
    resumoCategorias.appendChild(el);
  });
  Object.keys(totals).forEach(cat=>{ if(order.includes(cat)) return; const el=document.createElement('div'); el.className='mini-card'; el.innerHTML = `<div style="font-weight:900">${cat}</div><div style="margin-top:6px">${formatBRL(totals[cat])}</div><div class="sub">${counts[cat]||0} entr.</div>`; resumoCategorias.appendChild(el); });
  if(Object.keys(totals).length===0){ resumoCategorias.innerHTML = '<div class="mini-card">Sem entradas</div><div class="mini-card">Sem entradas</div><div class="mini-card">Sem entradas</div>'; }
}

/* metrics & progress */
function updateMetrics(){
  const ganhosBrutosTotal = Number(state.ganhosApps||0) + Number(state.ganhosLoja||0) + Number(state.totalDoacao||0);
  const lucro = ganhosBrutosTotal - Number(state.gastos||0);
  const tempo = getTempoTotal();
  const horas = tempo/(1000*60*60) || 0;
  const mediaHora = horas>0 ? ganhosBrutosTotal / horas : 0;
  const mediaHoraLiq = horas>0 ? lucro / horas : 0;

  ganhosAppsEl.textContent = formatBRL(state.ganhosApps);
  ganhosTotalEl.textContent = formatBRL(ganhosBrutosTotal);
  mediaHoraAppsEl.textContent = formatBRL((state.ganhosApps || 0) / (horas || 1));
  mediaHoraLiqEl.textContent = formatBRL(mediaHoraLiq);

  // progress
  const meta = Number(state.meta||0);
  const current = Number(state.ganhosApps||0) + Number(state.ganhosLoja||0);
  const pct = meta>0 ? Math.min(100,(current/meta)*100) : 0;
  progressFill.style.width = pct + '%';
  progressText.textContent = Math.round(pct) + '%';
  if(meta===0) progressSub.textContent = 'Defina a meta para acompanhar o progresso.'; else { const falt = meta - current; progressSub.textContent = falt>0? `Faltam ${formatBRL(falt)}.` : `Meta batida! (+${formatBRL(Math.abs(falt))})`; }

  // tempo & km
  tempoTrabalhado.textContent = formatTime(getTempoTotal());
  kmRodados.textContent = formatKM(getKMRodados());

  maybeCelebrate();
}

/* celebration */
function playCelebration(){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const now = ctx.currentTime;
    const o = ctx.createOscillator(); o.type='sawtooth'; o.frequency.value=420;
    const g = ctx.createGain(); o.connect(g); g.connect(ctx.destination);
    g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.8, now+0.02); g.gain.exponentialRampToValueAtTime(0.0001, now+1.3);
    o.start(now); o.stop(now+1.3);
    const len = ctx.sampleRate * 4; const buf = ctx.createBuffer(1, len, ctx.sampleRate);
    const data = buf.getChannelData(0); for(let i=0;i<len;i++){ const t=i/ctx.sampleRate; const env=1-(t/4); data[i] = (Math.random()*2-1)*0.6*env; }
    const noise = ctx.createBufferSource(); noise.buffer = buf; const ng = ctx.createGain(); noise.connect(ng); ng.connect(ctx.destination);
    ng.gain.setValueAtTime(0.0001, now+0.6); ng.gain.exponentialRampToValueAtTime(0.9, now+0.62); ng.gain.exponentialRampToValueAtTime(0.0001, now+5.0);
    noise.start(now+0.6);
    setTimeout(()=>{ try{ noise.stop(); ctx.close(); }catch(e){} }, 5500);
  }catch(e){ console.warn('audio fail', e); }
  const colors = ['#10b981','#f97316','#facc15','#ef4444','#ec4899'];
  for(let i=0;i<100;i++){
    const el = document.createElement('div'); el.style.position='absolute'; el.style.width='10px'; el.style.height='14px';
    el.style.left = Math.random()*100 + '%'; el.style.top = Math.random()*40 + '%'; el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el.style.transform = 'rotate(' + (Math.random()*360) + 'deg)'; el.style.opacity = '0.95';
    confettiRoot.appendChild(el);
    const dur = 2200 + Math.random()*2000;
    el.animate([{transform:'translateY(0px)'},{transform:'translateY(400px)'}], {duration:dur, iterations:1, easing:'ease-out'});
    setTimeout(()=>el.remove(), dur+100);
  }
}

/* maybe celebrate */
function maybeCelebrate(){
  const meta = Number(state.meta||0);
  if(meta<=0) return;
  const current = Number(state.ganhosApps||0) + Number(state.ganhosLoja||0);
  const pct = (current/meta)*100;
  if(pct>=100 && !state.celebrated){
    state.celebrated = true;
    playCelebration();
  }
  if(pct<100) state.celebrated = false;
}

/* Save day summary */
function saveDay(){
  try{
    const arr = JSON.parse(localStorage.getItem('maxrota_days')||'[]');
    const ganhosBrutos = Number(state.ganhosApps||0) + Number(state.ganhosLoja||0) + Number(state.totalDoacao||0);
    const lucro = ganhosBrutos - Number(state.gastos||0);
    const tempo = state.lastSession ? state.lastSession.tempo : getTempoTotal();
    const km = getKMRodados();
    const mediaHora = tempo>0 ? ganhosBrutos/(tempo/(1000*60*60)) : 0;
    const resumo = { id:new Date().toISOString(), date:new Date().toISOString(), meta:state.meta, kmInicial:state.kmInicial, kmFinal:state.kmFinal, ganhosApps:state.ganhosApps, ganhosLoja:state.ganhosLoja, ganhoDoacao:state.totalDoacao, entradasApps:state.entradasApps, entradasLoja:state.entradasLoja, gastos:state.gastos, lucro, tempo, km, mediaHora, history: state.history.slice(0,500), lastSession: state.lastSession || null };
    arr.unshift(resumo);
    localStorage.setItem('maxrota_days', JSON.stringify(arr.slice(0,300)));
    return resumo;
  }catch(e){ console.error(e); return null; }
}

/* Save & reset */
$('#saveReset').addEventListener('click', ()=>{
  if(!confirm('Salvar resumo do dia e resetar?')) return;
  const resumo = saveDay();
  if(resumo) alert('Resumo salvo. Lucro: '+formatBRL(resumo.lucro)+'\nKM: '+(resumo.km||0)+' km\nTempo: '+formatTime(resumo.tempo));
  state = { meta:0, ganhosApps:0, ganhosLoja:0, totalDoacao:0, entradasApps:0, entradasLoja:0, gastos:0, history:[], totalTimeWorked:0, lastStartTime:null, status:'stopped', kmInicial:0, kmFinal:0, celebrated:false, lastSession:null };
  kmInicialEl.value=''; kmFinalEl.value=''; metaInput.value=''; valorEntrada.value=''; valorSaida.value='';
  toggleStart.textContent='Iniciar Expediente'; stopTimer(); saveState(); renderUI();
});

/* Export & History */
$('#exportBtn').addEventListener('click', ()=>{
  const data = { state, days: JSON.parse(localStorage.getItem('maxrota_days')||'[]') };
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'maxrota_export.json'; a.click(); URL.revokeObjectURL(url);
});

$('#viewHistory').addEventListener('click', ()=>{ historyPanel.style.display = historyPanel.style.display==='block' ? 'none' : 'block'; renderHistory(); });

function renderHistory(){
  const arr = JSON.parse(localStorage.getItem('maxrota_days')||'[]');
  if(!arr || arr.length===0){ historyPanel.innerHTML = '<div class="sub">Nenhum dia salvo.</div>'; return; }
  historyPanel.innerHTML = arr.map(d=>{
    const date = new Date(d.date); return `<div style="padding:8px;border-radius:8px;background:rgba(0,0,0,0.08);margin-bottom:8px"><div style="font-weight:900">${date.toLocaleDateString()}</div><div class="sub">Lucro: ${formatBRL(d.lucro)} ¬∑ KM: ${d.km} ¬∑ Tempo: ${formatTime(d.tempo)}</div></div>`;
  }).join('');
}

/* Themes */
autoTheme.addEventListener('click', ()=>{
  if(document.body.classList.contains('light')){ document.body.classList.remove('light'); autoTheme.textContent='Auto üåó'; }
  else { document.body.classList.add('light'); autoTheme.textContent='Manual ‚òÄÔ∏è'; }
});
colorDots.forEach(d=>d.addEventListener('click', ()=>{ const acc = d.dataset.accent; document.documentElement.style.setProperty('--accent', acc==='green'?'#10b981': acc==='orange'?'#f97316': acc==='yellow'?'#facc15':'#ef4444'); }));

/* Render UI */
function renderUI(){
  kmInicialEl.value = state.kmInicial || '';
  kmFinalEl.value = state.kmFinal || '';
  metaInput.value = state.meta || '';
  if(state.lastSession){ lastSessionEl.style.display='block'; lastSessionEl.innerHTML = `<strong>√öltima sess√£o</strong><div class="sub">Tempo: ${formatTime(state.lastSession.tempo)}</div>`; } else { lastSessionEl.style.display='none'; }
  renderLancamentos(); renderResumo(); updateMetrics();
  saveState();
}

/* initialize */
function init(){
  if(state.status==='running' && state.lastStartTime) { startTimer(); toggleStart.textContent='Pausar'; }
  renderUI();
  setInterval(()=>{ updateMetrics(); }, 2000);
}
init();
</script>
</body>
</html>
