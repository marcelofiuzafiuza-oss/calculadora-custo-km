<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAX ROTA DI√ÅRIO ‚Äî Sincronizado</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <!-- Chart.js pode ficar se voc√™ quiser gr√°ficos no futuro -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js" defer></script>
  <style>
  /* ===========================
     BLOCO 1 ‚Äî CSS (visual principal)
     =========================== */
  :root{
    --accent:#10b981; --bg1:#041226; --bg2:#2a1160; --text:#e6eef6; --muted:#9aa6b2; --card:rgba(255,255,255,0.06); --radius:12px;
  }
  html,body{height:100%;margin:0;padding:0}
  body{
    font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto;
    background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:var(--text); padding:18px;
  }
  .wrap{max-width:1200px;margin:0 auto}
  .card{background:var(--card);backdrop-filter:blur(6px);border-radius:16px;padding:18px;margin-bottom:18px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 26px rgba(0,0,0,0.35)}
  .header-card{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
  .logo-img{height:72px;border-radius:10px}
  .theme-controls{display:flex;align-items:center;gap:10px}
  .theme-btn{background:linear-gradient(120deg,var(--accent),#3b82f6);color:#fff;padding:10px 14px;border-radius:12px;border:none;font-weight:700;cursor:pointer}
  .theme-dots{display:flex;gap:8px}
  .color-dot{width:28px;height:28px;border-radius:999px;border:2px solid rgba(255,255,255,0.12);cursor:pointer}
  .radio-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .station-btn{padding:12px;border-radius:12px;color:#fff;font-weight:800;border:0;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:0.12s;font-size:14px;height:52px}
  .station-btn.active{box-shadow:0 10px 26px rgba(0,0,0,0.45);transform:translateY(-3px)}
  .radio-player{margin-top:12px;display:flex;gap:12px;align-items:center}
  .meta-row{display:flex;gap:12px}
  .meta-row input{flex:1;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.03);color:var(--text);font-weight:800}
  .progress-container{height:44px;border-radius:22px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);overflow:hidden;position:relative}
  .progress-bar{position:absolute;left:0;top:0;height:100%;background:linear-gradient(120deg,var(--accent),#2563eb);width:0%;transition:width .6s}
  .progress-text{position:absolute;width:100%;height:100%;line-height:44px;text-align:center;font-weight:900}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .grid-4 input{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.03);color:var(--text);font-weight:700}
  .big-time{font-size:20px;font-weight:900}
  .km-actions{margin-top:12px;display:flex;gap:12px;flex-wrap:wrap}
  .btn{padding:12px 16px;border-radius:12px;background:linear-gradient(120deg,var(--accent),#7c3aed);border:none;font-weight:800;cursor:pointer;color:#fff}
  .btn-ghost{padding:12px 16px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);font-weight:700;cursor:pointer;color:var(--muted)}
  .grid-2cols{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .input-row{display:flex;gap:12px}
  .apps-grid,.gastos-grid{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
  .app-btn,.gasto-btn{padding:12px 14px;border:none;border-radius:14px;cursor:pointer;font-weight:900;color:#fff;font-size:14px;min-width:120px}
  .launch-list{max-height:300px;overflow-y:auto;padding:6px}
  .launch-item{display:flex;justify-content:space-between;border-bottom:1px dashed rgba(255,255,255,0.06);padding:10px;border-radius:10px}
  .metric-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
  .metric-col{padding:12px;border-radius:12px;background:rgba(255,255,255,0.04)}
  .muted{color:var(--muted)}
  .small{font-size:13px}
  .hidden-value{visibility:hidden;position:relative}
  .hidden-value::after{content:'****';visibility:visible;position:absolute;left:0;top:0}
  @media(max-width:1000px){.radio-grid{grid-template-columns:repeat(2,1fr)}.grid-4{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>

<body class="accent-green">
  <div class="wrap">

    <!-- HEADER -->
    <header class="card header-card" role="banner" aria-label="Cabe√ßalho MAX ROTA">
      <div style="display:flex;align-items:center;gap:12px">
        <img id="logoImg" class="logo-img" src="https://i.postimg.cc/3RWn008g/Chat-GPT-Image-12-de-nov-de-2025-14-32-56.png" alt="MAX ROTA DI√ÅRIO">
        <div>
          <h1 style="margin:0;font-size:20px">MAX ROTA DI√ÅRIO</h1>
          <div class="small muted">Painel do Motorista ‚Äî sincronizado</div>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;gap:10px;align-items:flex-end">
        <div class="theme-controls" aria-hidden="false">
          <button id="autoThemeBtn" class="theme-btn" title="Ativar modo autom√°tico dia/noite">Auto üåó</button>
          <div class="theme-dots" role="toolbar" aria-label="Temas">
            <button class="color-dot" data-accent="green" style="background:#10b981" title="Verde"></button>
            <button class="color-dot" data-accent="orange" style="background:#f97316" title="Laranja"></button>
            <button class="color-dot" data-accent="yellow" style="background:#facc15" title="Amarelo"></button>
            <button class="color-dot" data-accent="red" style="background:#ef4444" title="Vermelho"></button>
            <button class="color-dot" data-accent="pink" style="background:#ec4899" title="Rosa"></button>
          </div>
        </div>
        <div style="display:flex;gap:8px">
          <div id="userEmail" class="small muted" style="align-self:center">Conectando...</div>
          <button id="logoutBtn" class="btn-ghost">Sair</button>
        </div>
      </div>
    </header>

    <!-- R√ÅDIOS -->
    <section class="card radio-card" aria-label="R√°dios">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:0;font-size:16px">üéß Esta√ß√µes</h2>
        <div class="small muted" id="radioStatus">Nenhuma selecionada</div>
      </div>

      <div id="stationButtons" class="radio-grid" role="list" aria-label="Lista de r√°dios">
        <!-- 4 por linha ‚Äî mantenha as que j√° funcionavam -->
        <button class="station-btn" data-src="https://live.hunter.fm/pop_high" data-name="Hunter Pop" style="background:#10b981">Hunter Pop</button>
        <button class="station-btn" data-src="https://live.hunter.fm/pop2k_high" data-name="Hunter Pop2K" style="background:#06b6d4">Hunter Pop2K</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/u80s-128-mp3" data-name="Flashback 80s" style="background:#8b5cf6">80s</button>
        <button class="station-btn" data-src="http://listen.181fm.com/181-power_128k.mp3" data-name="Power181" style="background:#f97316">Power181</button>

        <button class="station-btn" data-src="https://live.hunter.fm/rock_high" data-name="Rock Classic" style="background:#ef4444">Rock</button>
        <button class="station-btn" data-src="https://live.hunter.fm/sertanejo_high" data-name="Sertanejo" style="background:#f59e0b">Sertanejo</button>
        <button class="station-btn" data-src="https://live.hunter.fm/hiphop_high" data-name="Hip Hop" style="background:#111827">HipHop</button>
        <button class="station-btn" data-src="https://live.hunter.fm/gospel_high" data-name="Crist√£" style="background:#facc15;color:#111">Crist√£</button>

        <button class="station-btn" data-src="https://ice1.somafm.com/groovesalad-128-mp3" data-name="GrooveSalad" style="background:#2563eb">GrooveSalad</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/beatblender-128-mp3" data-name="BeatBlender" style="background:#7c3aed">House/Deep</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/secretagent-128-mp3" data-name="SecretAgent" style="background:#06b6d4">SecretAgent</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/dubstep-128-mp3" data-name="Dubstep/Dub" style="background:#4ade80">Reggae/Dub</button>
      </div>

      <div class="radio-player" aria-label="Player de r√°dio">
        <audio id="radioPlayer" controls preload="none" style="width:100%"></audio>
        <div style="display:flex;flex-direction:column;gap:8px;margin-left:8px">
          <button id="stopRadioBtn" class="btn-ghost">Parar R√°dio</button>
          <div id="nowPlaying" class="small muted">Nenhuma r√°dio selecionada.</div>
        </div>
      </div>
    </section>

    <!-- META -->
    <section class="card meta-card" aria-label="Meta di√°ria">
      <h2 style="margin:0 0 8px 0;font-size:16px">üéØ Meta Di√°ria</h2>
      <div class="meta-row">
        <input id="metaInput" type="number" placeholder="Ex: 300" aria-label="Valor da meta" />
        <button id="setMetaBtn" class="btn">Salvar Meta</button>
      </div>
      <div class="progress-container" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" style="margin-top:12px">
        <div id="progressBar" class="progress-bar" style="width:0%"></div>
        <div id="progressText" class="progress-text">0%</div>
      </div>
      <div id="metaMessage" class="small muted" style="margin-top:8px">Defina a meta para acompanhar o progresso.</div>
    </section>

    <!-- KM & TIMER -->
    <section class="card km-card" aria-label="Jornada e quilometragem">
      <h2 style="margin:0 0 8px 0;font-size:16px">üöó Jornada e KM</h2>
      <div class="grid-4">
        <div>
          <label class="small muted" for="kmInicial">KM Inicial</label>
          <input id="kmInicial" type="number" placeholder="Ex: 150000" />
        </div>
        <div>
          <label class="small muted" for="kmFinal">KM Final</label>
          <input id="kmFinal" type="number" placeholder="Ex: 150250" />
        </div>
        <div>
          <label class="small muted">Tempo Trabalhado</label>
          <div id="tempoTrabalhado" class="big-time">00:00:00</div>
        </div>
        <div>
          <label class="small muted">KM Rodados</label>
          <div id="kmRodados" class="big-time">0.0 km</div>
        </div>
      </div>
      <div class="km-actions">
        <button id="toggleStartBtn" class="btn">Iniciar Expediente</button>
        <button id="finalizeBtn" class="btn-ghost">Finalizar Dia</button>
        <button id="saveKmBtn" class="btn">Salvar KM</button>
      </div>
    </section>

    <!-- LAN√áAMENTOS -->
    <section class="card lancamentos-card grid-2cols" aria-label="Lan√ßamentos">
      <div>
        <h3 style="margin:0 0 8px 0;font-size:15px">‚ûï Entradas (Apps)</h3>
        <div class="input-row">
          <input id="valorEntrada" type="number" placeholder="Valor (R$)" />
          <button id="addEntradaBtn" class="btn">Lan√ßar</button>
        </div>
        <div class="apps-grid">
          <button class="app-btn" data-cat="Uber" style="background:#000">Uber</button>
          <button class="app-btn" data-cat="99" style="background:#facc15;color:#111">99</button>
          <button class="app-btn" data-cat="inDriver" style="background:#10b981">inDriver</button>
          <button class="app-btn" data-cat="Particular" style="background:#6b7280">Particular</button>
          <button class="app-btn" data-cat="Loja" style="background:#1e3a8a">Loja</button>
          <button class="app-btn" data-cat="Doa√ß√£o" style="background:#8b5cf6">Doa√ß√£o</button>
        </div>
      </div>

      <div>
        <h3 style="margin:0 0 8px 0;font-size:15px">‚ûñ Sa√≠das (Gastos)</h3>
        <div class="input-row">
          <input id="valorSaida" type="number" placeholder="Valor (R$)" />
          <button id="addSaidaBtn" class="btn">Lan√ßar</button>
        </div>
        <div class="gastos-grid">
          <button class="gasto-btn" data-cat="Combust√≠vel" style="background:#ef4444">Combust√≠vel</button>
          <button class="gasto-btn" data-cat="Alimenta√ß√£o" style="background:#8b5cf6">Alimenta√ß√£o</button>
          <button class="gasto-btn" data-cat="Manuten√ß√£o" style="background:#6b7280">Manuten√ß√£o</button>
          <button class="gasto-btn" data-cat="Outros" style="background:#374151">Outros</button>
        </div>
      </div>
    </section>

    <!-- LISTAS E M√âTRICAS -->
    <section class="card recentes-card">
      <h3 style="margin:0 0 8px 0;font-size:15px">Lan√ßamentos Recentes</h3>
      <div id="lancamentosList" class="launch-list"><div class="muted small text-center">Nenhum lan√ßamento ainda.</div></div>
    </section>

    <section class="card resumo-cat">
      <h3 style="margin:0 0 8px 0;font-size:15px">Resumo R√°pido por Categoria</h3>
      <div id="resumoCategorias" class="resumo-grid small muted"></div>
    </section>

    <section class="card metric-card">
      <h3 style="margin:0 0 8px 0;font-size:15px">M√©tricas</h3>
      <div class="metric-grid">
        <div class="metric-col"><div class="muted">Ganhos Brutos ‚Äî Apps</div><div id="metricGanhosApps" class="metric-value">R$ 0,00</div></div>
        <div class="metric-col"><div class="muted">Ganhos Brutos ‚Äî Total</div><div id="metricGanhosTotal" class="metric-value">R$ 0,00</div></div>
        <div class="metric-col"><div class="muted">Gastos</div><div id="metricGastosTotal" class="metric-value">R$ 0,00</div></div>
        <div class="metric-col"><div class="muted">Lucro L√≠quido</div><div id="metricLucroTotal" class="metric-value">R$ 0,00</div></div>
      </div>
    </section>

    <section class="card actions-card">
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <button id="saveAndResetBtn" class="btn">Salvar Resumo & Resetar Dia</button>
        <button id="exportBtn" class="btn-ghost">Exportar Resumo (JSON)</button>
        <button id="viewHistoryBtn" class="btn-ghost">Ver Hist√≥rico de Dias</button>
      </div>
      <div id="historyPanel" class="history-panel mt-4 hidden"></div>
    </section>

    <section class="card final-resumo">
      <h3 style="margin:0 0 8px 0;font-size:15px">Resumo Final por Categoria</h3>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px">
        <div style="padding:12px;border-radius:12px;text-align:center"><div class="muted">Total Apps</div><div id="finalTotalApps" class="metric-value">R$ 0,00</div></div>
        <div style="padding:12px;border-radius:12px;text-align:center"><div class="muted">Total Loja</div><div id="finalTotalLoja" class="metric-value">R$ 0,00</div></div>
        <div style="padding:12px;border-radius:12px;text-align:center"><div class="muted">Total Doa√ß√µes</div><div id="finalTotalDoacao" class="metric-value">R$ 0,00</div></div>
        <div style="padding:12px;border-radius:12px;text-align:center;background:linear-gradient(135deg,var(--accent),#3b82f6);color:#fff"><div class="muted">Total Geral (L√≠quido)</div><div id="finalTotalGeral" class="metric-value">R$ 0,00</div></div>
      </div>
    </section>

    <footer class="small muted" style="text-align:center;margin-top:10px">Dados sincronizados no Firebase Firestore ‚Äî n√£o use localStorage como √∫nico backup.</footer>
  </div>

  <!-- DIVIDIDO: BLOCO 3 ‚Äî SCRIPTS (JS + Firebase) -->
  <script type="module">
  /* ===========================
     BLOCO 3 ‚Äî JS (Firebase + app logic)
     =========================== */

  // --------- FIREBASE CONFIG (use sua config aqui) ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBXkQlm0TbCsCdVGil8-5kGWbtj07SKXwA",
    authDomain: "maxrota.firebaseapp.com",
    projectId: "maxrota",
    storageBucket: "maxrota.firebasestorage.app",
    messagingSenderId: "425002957978",
    appId: "1:425002957978:web:1e4f38239e552de452f323",
    measurementId: "G-RBK7LM483D"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getFirestore();

  // --------- HELPERS & REFS ----------
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const uidGen = ()=>Math.random().toString(36).slice(2,9);
  const formatBRL = v => Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const formatKM = v => Number(v||0).toFixed(1) + ' km';
  function formatTime(ms){ if(!ms||ms<=0) return '00:00:00'; const s = Math.floor(ms/1000); const h = Math.floor(s/3600); const m = Math.floor((s%3600)/60); const sec = s%60; return [h,m,sec].map(n=>String(n).padStart(2,'0')).join(':'); }

  // UI elements
  const userEmailEl = $('#userEmail'), logoutBtn = $('#logoutBtn');
  const stationButtons = $$('#stationButtons .station-btn'), radioPlayer = $('#radioPlayer'), nowPlaying = $('#nowPlaying'), stopRadioBtn = $('#stopRadioBtn'), radioStatus = $('#radioStatus');

  const metaInput = $('#metaInput'), setMetaBtn = $('#setMetaBtn'), progressBar = $('#progressBar'), progressText = $('#progressText'), metaMessage = $('#metaMessage');
  const kmInicialEl = $('#kmInicial'), kmFinalEl = $('#kmFinal'), tempoTrabalhado = $('#tempoTrabalhado'), kmRodados = $('#kmRodados'), toggleStartBtn = $('#toggleStartBtn'), finalizeBtn = $('#finalizeBtn'), saveKmBtn = $('#saveKmBtn');

  const valorEntrada = $('#valorEntrada'), addEntradaBtn = $('#addEntradaBtn'), valorSaida = $('#valorSaida'), addSaidaBtn = $('#addSaidaBtn');
  const appBtns = $$('.app-btn'), gastoBtns = $$('.gasto-btn');

  const lancamentosList = $('#lancamentosList'), resumoCategorias = $('#resumoCategorias');

  const metricGanhosApps = $('#metricGanhosApps'), metricGanhosTotal = $('#metricGanhosTotal'), metricGastosTotal = $('#metricGastosTotal'), metricLucroTotal = $('#metricLucroTotal');
  const finalTotalApps = $('#finalTotalApps'), finalTotalLoja = $('#finalTotalLoja'), finalTotalDoacao = $('#finalTotalDoacao'), finalTotalGeral = $('#finalTotalGeral');

  const saveAndResetBtn = $('#saveAndResetBtn'), exportBtn = $('#exportBtn'), viewHistoryBtn = $('#viewHistoryBtn'), historyPanel = $('#historyPanel');

  // app state (local representation)
  let userUid = null;
  let userDocRef = null;
  let daysCollRef = null;
  let unsubscribeUserDoc = null;
  let unsubscribeDays = null;
  let writeTimeout = null;
  let timerInterval = null;

  // default shape
  let state = {
    meta:0, ganhosApps:0, ganhosLoja:0, totalDoacao:0, entradasApps:0, entradasLoja:0, gastos:0,
    history:[], kmInicial:0, kmFinal:0, totalTimeWorked:0, lastStartTime:null, status:'stopped', celebrated:false, updatedAt: Date.now()
  };

  // ---------- AUTH & SYNC ----------
  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      // redirect to login page if not signed in
      userEmailEl.textContent = 'Desconectado';
      // small delay to allow logout flow
      setTimeout(()=>{ if(location.pathname.indexOf('login.html')===-1) location.href = 'login.html'; },500);
      return;
    }
    userUid = user.uid;
    userEmailEl.textContent = user.email || 'Usu√°rio';
    userDocRef = doc(db, 'users', userUid);
    daysCollRef = collection(db, 'users', userUid, 'days');

    // attach real-time listeners
    if(unsubscribeUserDoc) unsubscribeUserDoc();
    unsubscribeUserDoc = onSnapshot(userDocRef, docSnap=>{
      if(!docSnap.exists()) {
        // create initial doc
        setDoc(userDocRef, state).catch(()=>{/*ignore*/});
        return;
      }
      const remote = docSnap.data();
      // merge remote into local but avoid overwriting while user typing heavily:
      // simple strategy: if local updatedAt < remote.updatedAt, accept remote.
      if(!remote.updatedAt || (remote.updatedAt > (state.updatedAt || 0))){
        state = Object.assign({}, state, remote);
        // convert timestamps if necessary
        updateUI(true);
      }
    });

    if(unsubscribeDays) unsubscribeDays();
    // listen last 30 days (ordered)
    const q = query(daysCollRef, orderBy('date','desc'));
    unsubscribeDays = onSnapshot(q, snap=>{
      // update history of days only in historyPanel when shown
      // store days locally for export if needed
      window._maxrota_days = snap.docs.map(d=>Object.assign({id:d.id}, d.data()));
      renderHistoryPanelIfOpen();
    });

    // attempt initial load (if user doc not exist, set)
    const docSnap = await getDoc(userDocRef);
    if(docSnap.exists()){
      const remote = docSnap.data();
      state = Object.assign({}, state, remote);
    } else {
      await setDoc(userDocRef, state);
    }

    updateUI(true);
  });

  logoutBtn.addEventListener('click', async ()=>{
    await signOut(auth);
    location.href = 'login.html';
  });

  // --------- FIRESTORE WRITE (debounced) ----------
  function scheduleSaveToServer(delay = 800){
    if(!userDocRef) return;
    if(writeTimeout) clearTimeout(writeTimeout);
    writeTimeout = setTimeout(async ()=>{
      try{
        state.updatedAt = Date.now();
        await setDoc(userDocRef, state, {merge:true});
      }catch(e){ console.error('Erro salvar server', e); }
    }, delay);
  }

  // --------- RADIO PLAYER ----------
  function setActiveStation(btn){ stationButtons.forEach(b=>b.classList.remove('active')); if(btn) btn.classList.add('active'); }
  stationButtons.forEach(btn=>btn.addEventListener('click', async ()=>{
    try{ radioPlayer.pause(); }catch{}
    radioPlayer.src = btn.dataset.src;
    setActiveStation(btn);
    nowPlaying.textContent = 'Carregando: ' + btn.dataset.name;
    radioStatus.textContent = 'Carregando...';
    try{ await radioPlayer.play(); nowPlaying.textContent = 'Tocando: ' + btn.dataset.name; radioStatus.textContent = btn.dataset.name; }catch(err){ nowPlaying.textContent = 'Falha ao tocar ' + btn.dataset.name; radioStatus.textContent = 'Erro'; setActiveStation(null); }
  }));
  stopRadioBtn.addEventListener('click', ()=>{ try{ radioPlayer.pause(); radioPlayer.removeAttribute('src'); radioPlayer.load(); }catch(e){} nowPlaying.textContent='Nenhuma r√°dio selecionada.'; radioStatus.textContent='Nenhuma'; setActiveStation(null); });
  radioPlayer.addEventListener('error', ()=>{ nowPlaying.textContent='Erro ao carregar a esta√ß√£o.'; radioStatus.textContent='Erro'; setActiveStation(null); });

  // --------- TIMER & KM ----------
  function getTempoTotal(){ let t = Number(state.totalTimeWorked || 0); if(state.status==='running' && state.lastStartTime) t += (Date.now() - state.lastStartTime); return t; }
  function getKMRodados(){ const ini = Number(state.kmInicial||0), fim = Number(state.kmFinal||0); return (fim>ini)?(fim-ini):0; }

  function startTimerLocal(){
    if(timerInterval) clearInterval(timerInterval);
    if(!state.lastStartTime) state.lastStartTime = Date.now();
    timerInterval = setInterval(()=>{
      tempoTrabalhado.textContent = formatTime(getTempoTotal());
      updateDerivedMetrics();
    },1000);
  }
  function stopTimerLocal(){ if(timerInterval) clearInterval(timerInterval); timerInterval = null; }

  $('#toggleStartBtn').addEventListener('click', ()=>{
    if(state.status==='stopped'){ state.status='running'; state.lastStartTime = Date.now(); $('#toggleStartBtn').textContent='Pausar'; startTimerLocal(); }
    else if(state.status==='running'){ state.totalTimeWorked += (Date.now() - state.lastStartTime); state.lastStartTime = null; state.status='paused'; $('#toggleStartBtn').textContent='Retomar'; stopTimerLocal(); }
    else if(state.status==='paused'){ state.status='running'; state.lastStartTime = Date.now(); $('#toggleStartBtn').textContent='Pausar'; startTimerLocal(); }
    scheduleSaveToServer();
    updateUI();
  });

  $('#finalizeBtn').addEventListener('click', ()=>{
    if(state.status==='running'){ state.totalTimeWorked += (Date.now() - state.lastStartTime); state.lastStartTime = null; }
    const tempoFinal = getTempoTotal(); const kmDia = getKMRodados();
    state.status='stopped'; stopTimerLocal();

    // small summary card appended
    const parent = finalizeBtn.parentElement;
    const existing = parent.querySelector('.day-resume-card'); if(existing) existing.remove();
    const resumoCard = document.createElement('div'); resumoCard.className='day-resume-card'; resumoCard.style.padding='10px'; resumoCard.style.marginTop='10px'; resumoCard.style.borderRadius='10px'; resumoCard.style.background='rgba(255,255,255,0.04)';
    resumoCard.innerHTML = `<b>Dia Finalizado</b><br>Tempo Trabalhado: ${formatTime(tempoFinal)}<br>KM Rodado: ${formatKM(kmDia)}<br><small class="muted">Registrado</small>`;
    parent.appendChild(resumoCard);

    // zero totals for new day but keep history
    state.totalTimeWorked = 0;
    state.lastStartTime = null;
    scheduleSaveToServer();
    updateUI();
  });

  $('#saveKmBtn').addEventListener('click', ()=>{
    // write KM values to state and server
    state.kmInicial = Number(kmInicialEl.value) || 0;
    state.kmFinal = Number(kmFinalEl.value) || 0;
    scheduleSaveToServer();
    updateUI();
  });

  // --------- LANCAMENTOS ----------
  function addLancamento({type,value,category}){
    const item = { id: uidGen(), type, value: Number(value), category, date: new Date().toISOString() };
    state.history.unshift(item);
    if(type==='ganho'){
      if(category==='Loja'){ state.ganhosLoja += item.value; state.entradasLoja = (state.entradasLoja||0)+1; }
      else if(category==='Doa√ß√£o'){ state.totalDoacao += item.value; }
      else { state.ganhosApps += item.value; state.entradasApps = (state.entradasApps||0)+1; }
    } else { state.gastos += item.value; }
    scheduleSaveToServer();
    updateUI();
  }

  $('#addEntradaBtn').addEventListener('click', ()=>{ const v = Number(valorEntrada.value); if(isNaN(v)||v<=0){ alert('Valor inv√°lido'); return; } addLancamento({type:'ganho',value:v,category:'Particular'}); valorEntrada.value=''; });
  $('#addSaidaBtn').addEventListener('click', ()=>{ const v = Number(valorSaida.value); if(isNaN(v)||v<=0){ alert('Valor inv√°lido'); return; } addLancamento({type:'gasto',value:v,category:'Outros'}); valorSaida.value=''; });

  appBtns.forEach(b=>b.addEventListener('click', ()=>{ const v = Number(valorEntrada.value); if(isNaN(v)||v<=0){ alert('Valor inv√°lido'); return; } addLancamento({type:'ganho',value:v,category:b.dataset.cat}); valorEntrada.value=''; }));
  gastoBtns.forEach(b=>b.addEventListener('click', ()=>{ const v = Number(valorSaida.value); if(isNaN(v)||v<=0){ alert('Valor inv√°lido'); return; } addLancamento({type:'gasto',value:v,category:b.dataset.cat}); valorSaida.value=''; }));

  // edit / delete handled in renderLancamentos

  // --------- RENDER FUNCTIONS ----------
  function renderLancamentos(){
    if(!state.history || state.history.length===0){ lancamentosList.innerHTML = '<div class="muted small text-center">Nenhum lan√ßamento ainda.</div>'; return; }
    lancamentosList.innerHTML = '';
    state.history.slice(0,200).forEach(it=>{
      const el = document.createElement('div'); el.className='launch-item';
      const left = document.createElement('div'); left.style.fontWeight='800';
      left.innerHTML = `${it.category}: ${it.type==='ganho'?'+':'-'} ${formatBRL(it.value)}<div class="small muted">${new Date(it.date).toLocaleString()}</div>`;
      const right = document.createElement('div');
      const edit = document.createElement('button'); edit.className='btn-ghost'; edit.textContent='‚úèÔ∏è'; edit.style.marginRight='8px';
      const del = document.createElement('button'); del.className='btn-ghost'; del.textContent='üóëÔ∏è';
      right.appendChild(edit); right.appendChild(del);
      el.appendChild(left); el.appendChild(right);
      lancamentosList.appendChild(el);

      edit.addEventListener('click', ()=>{
        const novoStr = prompt('Novo valor (R$):', it.value.toFixed(2));
        if(novoStr===null) return;
        const novo = Number(novoStr);
        if(isNaN(novo) || novo<0){ alert('Valor inv√°lido'); return; }
        // revert old
        if(it.type==='ganho'){
          if(it.category==='Loja') state.ganhosLoja -= it.value;
          else if(it.category==='Doa√ß√£o') state.totalDoacao -= it.value;
          else state.ganhosApps -= it.value;
        } else state.gastos -= it.value;
        // apply
        it.value = novo;
        if(it.type==='ganho'){
          if(it.category==='Loja') state.ganhosLoja += it.value;
          else if(it.category==='Doa√ß√£o') state.totalDoacao += it.value;
          else state.ganhosApps += it.value;
        } else state.gastos += it.value;
        scheduleSaveToServer();
        updateUI();
      });

      del.addEventListener('click', ()=>{
        if(!confirm('Excluir lan√ßamento?')) return;
        state.history = state.history.filter(x=>x.id !== it.id);
        // recompute totals
        recalcTotalsFromHistory();
        scheduleSaveToServer();
        updateUI();
      });
    });
  }

  function recalcTotalsFromHistory(){
    state.ganhosApps=0; state.ganhosLoja=0; state.totalDoacao=0; state.gastos=0; state.entradasApps=0; state.entradasLoja=0;
    state.history.forEach(it=>{
      if(it.type==='ganho'){
        if(it.category==='Loja'){ state.ganhosLoja += it.value; state.entradasLoja++; }
        else if(it.category==='Doa√ß√£o'){ state.totalDoacao += it.value; }
        else { state.ganhosApps += it.value; state.entradasApps++; }
      } else state.gastos += it.value;
    });
  }

  function renderResumoCategorias(){
    const totals = {}; const counts = {};
    state.history.forEach(it=>{ if(it.type!=='ganho') return; const c=it.category||'Outros'; totals[c]=(totals[c]||0)+it.value; counts[c]=(counts[c]||0)+1; });
    resumoCategorias.innerHTML = '';
    const order = ['Uber','99','inDriver','Particular','Loja','Doa√ß√£o'];
    order.forEach(cat=>{
      const val = totals[cat]||0, cnt = counts[cat]||0;
      const node = document.createElement('div');
      node.innerHTML = `<div style="font-weight:900;margin-bottom:6px">${cat}</div><div style="font-weight:800">${formatBRL(val)}</div><div class="small muted">${cnt} entr.</div>`;
      resumoCategorias.appendChild(node);
    });
    Object.keys(totals).forEach(cat=>{
      if(order.includes(cat)) return;
      const node = document.createElement('div');
      node.innerHTML = `<div style="font-weight:900;margin-bottom:6px">${cat}</div><div style="font-weight:800">${formatBRL(totals[cat])}</div><div class="small muted">${counts[cat]||0} entr.</div>`;
      resumoCategorias.appendChild(node);
    });
  }

  function updateDerivedMetrics(){
    const totalBruto = Number(state.ganhosApps||0) + Number(state.ganhosLoja||0) + Number(state.totalDoacao||0);
    const lucro = totalBruto - Number(state.gastos||0);
    const tempo = getTempoTotal();
    const horas = tempo/(1000*60*60) || 0;
    const mediaBruto = horas>0? totalBruto/horas : 0;
    metricGanhosApps.textContent = formatBRL(state.ganhosApps);
    metricGanhosTotal.textContent = formatBRL(totalBruto);
    metricGastosTotal.textContent = formatBRL(state.gastos);
    metricLucroTotal.textContent = formatBRL(lucro);

    tempoTrabalhado.textContent = formatTime(tempo);
    kmRodados.textContent = formatKM(getKMRodados());
    finalTotalApps.textContent = formatBRL(state.ganhosApps);
    finalTotalLoja.textContent = formatBRL(state.ganhosLoja);
    finalTotalDoacao.textContent = formatBRL(state.totalDoacao);
    finalTotalGeral.textContent = formatBRL(totalBruto - state.gastos);

    // progress
    const meta = Number(state.meta||0);
    const atual = state.ganhosApps + state.ganhosLoja;
    if(!meta){ progressBar.style.width='0%'; progressText.textContent='0%'; metaMessage.textContent='Defina a meta para acompanhar o progresso.'; }
    else { const pct = Math.min(100, (atual/meta)*100); progressBar.style.width = pct + '%'; progressText.textContent = Math.round(pct) + '%'; metaMessage.textContent = atual < meta ? `Faltam ${formatBRL(meta - atual)}.` : `Meta batida! (+${formatBRL(atual - meta)})`; if(atual>=meta && !state.celebrated){ state.celebrated=true; playVictory(); scheduleSaveToServer(400); } }
  }

  // celebration simple
  function playVictory(){
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const now = ctx.currentTime;
      const o = ctx.createOscillator(); o.type='sawtooth'; o.frequency.value=500;
      const g = ctx.createGain(); g.gain.setValueAtTime(0.01, now); g.gain.exponentialRampToValueAtTime(0.8, now+0.02);
      o.connect(g); g.connect(ctx.destination); o.start(now); o.stop(now+1.2);
      // applause noise short
      const length = ctx.sampleRate * 2.5;
      const buffer = ctx.createBuffer(1, length, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      for(let i=0;i<length;i++){ data[i] = (Math.random()*2-1) * (1 - i/length) * 0.5; }
      const src = ctx.createBufferSource(); src.buffer = buffer; src.connect(ctx.destination); src.start(now+0.3);
      setTimeout(()=>{ try{ ctx.close(); }catch(e){} }, 3600);
    }catch(e){ console.warn('celebrate failed', e); }
  }

  function renderHistoryPanelIfOpen(){
    if(historyPanel.classList.contains('hidden')) return;
    const arr = window._maxrota_days || [];
    if(!arr || arr.length===0){ historyPanel.innerHTML = '<div class="muted small">Nenhum dia salvo.</div>'; return; }
    historyPanel.innerHTML = arr.map(d=>{
      const date = new Date(d.date);
      return `<div style="padding:10px;border-bottom:1px solid rgba(255,255,255,0.04)"><div style="font-weight:800">${date.toLocaleString()}</div><div class="small muted">Lucro: ${formatBRL(d.lucro)} ¬∑ KM: ${d.km} ¬∑ M√©dia/H: ${formatBRL(d.mediaHora||0)}</div></div>`;
    }).join('');
  }

  viewHistoryBtn.addEventListener('click', ()=>{ historyPanel.classList.toggle('hidden'); renderHistoryPanelIfOpen(); });

  // save day summary to Firestore (subcollection)
  async function saveDaySummary(){
    if(!userUid) return alert('Usu√°rio n√£o autenticado.');
    try{
      const totalBruto = state.ganhosApps + state.ganhosLoja + state.totalDoacao;
      const lucro = totalBruto - state.gastos;
      const tempo = getTempoTotal();
      const km = getKMRodados();
      const mediaHora = tempo>0? totalBruto / (tempo/(1000*60*60)) : 0;
      const resumo = {
        date: new Date().toISOString(), meta: state.meta, kmInicial: state.kmInicial, kmFinal: state.kmFinal,
        ganhosApps: state.ganhosApps, ganhosLoja: state.ganhosLoja, ganhoDoacao: state.totalDoacao,
        entradasApps: state.entradasApps, entradasLoja: state.entradasLoja, gastos: state.gastos,
        lucro, tempo, km, mediaHora, history: state.history.slice(0,500)
      };
      await addDoc(daysCollRef, resumo);
      return true;
    }catch(e){ console.error('saveDaySummary error', e); return false; }
  }

  saveAndResetBtn.addEventListener('click', async ()=>{
    if(!confirm('Deseja salvar o resumo do dia e resetar todos os dados atuais?')) return;
    const ok = await saveDaySummary();
    if(!ok) return alert('Falha salvar resumo.');
    // reset local (but keep authentication)
    state = { meta:0, ganhosApps:0, ganhosLoja:0, totalDoacao:0, entradasApps:0, entradasLoja:0, gastos:0, history:[], kmInicial:0, kmFinal:0, totalTimeWorked:0, lastStartTime:null, status:'stopped', celebrated:false, updatedAt:Date.now() };
    // push to server
    scheduleSaveToServer(200);
    // clear inputs
    kmInicialEl.value=''; kmFinalEl.value=''; metaInput.value=''; valorEntrada.value=''; valorSaida.value='';
    $('#toggleStartBtn').textContent='Iniciar Expediente';
    stopTimerLocal();
    updateUI();
  });

  exportBtn.addEventListener('click', ()=>{
    const data = { state, days: window._maxrota_days || [] };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'maxrota_export.json'; a.click(); URL.revokeObjectURL(url);
  });

  // set meta button saves to state & server
  setMetaBtn.addEventListener('click', ()=>{
    const v = Number(metaInput.value);
    if(isNaN(v) || v<=0){ alert('Meta inv√°lida'); return; }
    state.meta = v;
    scheduleSaveToServer();
    updateUI();
  });

  // change theme dots
  $$('.color-dot').forEach(d=>d.addEventListener('click', ()=>{
    const acc = d.dataset.accent;
    document.body.classList.remove('accent-green','accent-orange','accent-yellow','accent-red','accent-pink');
    document.body.classList.add('accent-'+acc);
    localStorage.setItem('maxrota_accent', acc);
  }));
  const savedAccent = localStorage.getItem('maxrota_accent') || 'green'; document.body.classList.add('accent-'+savedAccent);

  // auto day/night
  let autoMode = true;
  function applyAutoTheme(){ if(!autoMode) return; const h = new Date().getHours(); const isDay = h>=6 && h<18; document.body.classList.toggle('light-mode', isDay); $('#autoThemeBtn').textContent = isDay? 'Modo Dia ‚òÄÔ∏è' : 'Modo Noite üåô'; }
  applyAutoTheme(); setInterval(()=>{ if(autoMode) applyAutoTheme(); },60*1000);
  $('#autoThemeBtn').addEventListener('click', ()=>{ autoMode = !autoMode; if(autoMode) applyAutoTheme(); else document.body.classList.toggle('light-mode'); });

  // safe UI updates ‚Äî don't overwrite while input focused
  function updateUI(fromRemote=false){
    if(document.activeElement !== metaInput) metaInput.value = state.meta || '';
    if(document.activeElement !== kmInicialEl) kmInicialEl.value = state.kmInicial || '';
    if(document.activeElement !== kmFinalEl) kmFinalEl.value = state.kmFinal || '';
    if(state.status==='running') $('#toggleStartBtn').textContent='Pausar';
    else if(state.status==='paused') $('#toggleStartBtn').textContent='Retomar';
    else $('#toggleStartBtn').textContent='Iniciar Expediente';

    // start/stop timer if remote changed status
    if(state.status==='running' && !timerInterval) startTimerLocal();
    if(state.status!=='running' && timerInterval) stopTimerLocal();

    renderLancamentos(); renderResumoCategorias(); updateDerivedMetrics();
    // optionally focus/notify
    // if from remote, you might want a small toast: (omitted for brevity)
  }

  // initial local UI
  updateUI();

  // Periodic UI refresh (keeps progress updated)
  setInterval(()=>{ updateDerivedMetrics(); },2000);

  </script>
</body>
</html>
