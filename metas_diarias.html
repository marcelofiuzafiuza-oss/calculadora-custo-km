<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAX ROTA DI√ÅRIO</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
  /* ===========================
     MAX ROTA ‚Äì ESTILO GLOBAL
     =========================== */
  :root {
    --accent: #10b981;
    --bg1: #041226;
    --bg2: #2a1160;
    --text: #e6eef6;
    --muted: #9aa6b2;
    --card: rgba(255, 255, 255, 0.06);
    --radius: 14px;
    --scale: 1.12;
  }

  html, body { height:100%; margin:0; padding:0; }

  body {
    font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto;
    background: linear-gradient(135deg, var(--bg1), var(--bg2));
    color: var(--text);
    padding: 20px;
    transform: scale(var(--scale));
    transform-origin: top left;
  }

  .wrap { max-width: 1200px; margin: 0 auto; }

  .card {
    background: var(--card);
    backdrop-filter: blur(6px);
    border-radius: 16px;
    padding: 22px;
    margin-bottom: 22px;
    border: 1px solid rgba(255,255,255,0.03);
    box-shadow: 0 10px 26px rgba(0,0,0,0.4);
  }

  .header-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .logo-img {
    height: 82px;
    width: auto;
    border-radius: 12px;
  }

  .theme-controls {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .theme-btn {
    background: linear-gradient(120deg, var(--accent), #3b82f6);
    color: #fff;
    padding: 10px 18px;
    border-radius: 12px;
    border: none;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
  }

  .theme-dots {
    display: flex;
    gap: 12px;
  }

  .color-dot {
    width: 34px;
    height: 34px;
    border-radius: 999px;
    border: 2px solid rgba(255,255,255,0.12);
    cursor: pointer;
    box-shadow: 0 6px 14px rgba(0,0,0,0.3);
  }

  /* R√°dios */
  .radio-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
  }

  .station-btn {
    flex: 1 1 calc(33% - 12px);
    min-width: 200px;
    text-align: center;
    padding: 16px;
    border-radius: 14px;
    color: #fff;
    font-weight: 800;
    border: 0;
    cursor: pointer;
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: center;
    transition: 0.18s;
    font-size: 18px;
  }

  .station-btn .icon { font-size: 22px; }

  .station-btn:hover { transform: scale(1.03); }

  .station-btn.active {
    box-shadow: 0 12px 28px rgba(0,0,0,0.5);
    transform: translateY(-2px);
  }

  .radio-player {
    margin-top: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  /* Meta */
  .meta-row {
    display: flex;
    gap: 12px;
  }

  .meta-row input {
    flex: 1;
    padding: 14px;
    border-radius: var(--radius);
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.04);
    color: var(--text);
    font-weight: 700;
    font-size: 17px;
  }

  .progress-container {
    height: 48px;
    border-radius: 24px;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.07);
    overflow: hidden;
    position: relative;
  }

  .progress-bar {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    background: linear-gradient(120deg, var(--accent), #2563eb);
    width: 0%;
    animation: waveMove 3.5s linear infinite;
    background-size: 200% 200%;
  }

  @keyframes waveMove {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  .progress-text {
    position: absolute;
    width: 100%;
    height: 100%;
    line-height: 48px;
    text-align: center;
    font-weight: 900;
    font-size: 18px;
  }

  .progress-bubbles {
    position: absolute;
    inset: 0;
    pointer-events: none;
    overflow: hidden;
  }

  /* KM */
  .grid-4 {
    display: grid;
    grid-template-columns: repeat(4,1fr);
    gap: 14px;
  }

  .grid-4 input {
    width: 100%;
    padding: 14px;
    border-radius: var(--radius);
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.04);
    color: var(--text);
    font-weight: 700;
    font-size: 17px;
  }

  .big-time {
    font-size: 22px;
    font-weight: 900;
  }

  .km-actions {
    margin-top: 14px;
    display: flex;
    gap: 12px;
  }

  .btn {
    padding: 14px 20px;
    border-radius: var(--radius);
    background: linear-gradient(120deg, var(--accent), #7c3aed);
    border: none;
    font-weight: 900;
    cursor: pointer;
    color: #fff;
    font-size: 16px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.4);
  }

  .btn-ghost {
    padding: 14px 20px;
    border-radius: var(--radius);
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    font-weight: 700;
    cursor: pointer;
    color: var(--muted);
  }

  </style>
</head>

<body class="accent-green">
  <div class="wrap">

    <!-- HEADER -->
    <header class="card header-card">
      <div style="display:flex;align-items:center;gap:14px">
        <img class="logo-img" src="https://i.postimg.cc/3RWn008g/Chat-GPT-Image-12-de-nov-de-2025-14-32-56.png">
        <div>
          <h1 style="margin:0;font-size:22px">MAX ROTA DI√ÅRIO</h1>
          <div class="small muted">Painel do Motorista</div>
        </div>
      </div>

      <div class="theme-controls">
        <button id="autoThemeBtn" class="theme-btn">Auto üåó</button>
        <div class="theme-dots" style="margin-left:8px">
          <button class="color-dot" data-accent="green" style="background:#10b981"></button>
          <button class="color-dot" data-accent="orange" style="background:#f97316"></button>
          <button class="color-dot" data-accent="yellow" style="background:#facc15"></button>
          <button class="color-dot" data-accent="red" style="background:#ef4444"></button>
          <button class="color-dot" data-accent="pink" style="background:#ec4899"></button>
        </div>
      </div>
    </header>

    <!-- R√ÅDIOS -->
    <section class="card radio-card">
      <h2 style="margin:0 0 8px 0;font-size:18px">üéß Esta√ß√µes</h2>

      <div id="stationButtons" class="radio-grid">

        <!-- Pop Hits -->
        <button class="station-btn" data-src="https://live.hunter.fm/pop_high" style="background:#10b981">
          <span class="icon">üé∂</span> Pop Hits
        </button>

        <!-- Flashback -->
        <button class="station-btn" data-src="https://ice1.somafm.com/u80s-128-mp3" style="background:#8b5cf6">
          <span class="icon">üíø</span> Flashback 80s
        </button>

        <!-- Rock -->
        <button class="station-btn" data-src="https://live.hunter.fm/rock_high" style="background:#ef4444">
          <span class="icon">üé∏</span> Rock
        </button>

        <!-- Sertanejo -->
        <button class="station-btn" data-src="https://live.hunter.fm/sertanejo_high" style="background:#c084fc">
          <span class="icon">ü§†</span> Sertanejo
        </button>

        <!-- Hip Hop -->
        <button class="station-btn" data-src="https://listen.181fm.com/181-true-rnb_128k.mp3" style="background:#111827">
          <span class="icon">üé§</span> Hip Hop
        </button>

        <!-- Pop 2000 -->
        <button class="station-btn" data-src="https://listen.181fm.com/181-power2000_128k.mp3" style="background:#f59e0b">
          <span class="icon">üìÄ</span> Pop2K
        </button>

        <!-- Indie -->
        <button class="station-btn" data-src="https://ice1.somafm.com/indiepop-128-mp3" style="background:#6366f1">
          <span class="icon">üåº</span> Indie
        </button>

        <!-- Eletr√¥nica -->
        <button class="station-btn" data-src="https://ice1.somafm.com/groovesalad-128-mp3" style="background:#2563eb">
          <span class="icon">üéß</span> Eletr√¥nica
        </button>

        <!-- Surf -->
        <button class="station-btn" data-src="https://ice1.somafm.com/secretagent-128-mp3" style="background:#06b6d4">
          <span class="icon">üèÑ</span> Surf
        </button>

        <!-- Reggae -->
        <button class="station-btn" data-src="https://ice1.somafm.com/dubstep-128-mp3" style="background:#22c55e">
          <span class="icon">ü•Å</span> Reggae
        </button>

        <!-- Crist√£ -->
        <button class="station-btn" data-src="https://live.hunter.fm/gospel_high" style="background:#facc15">
          <span class="icon">‚úùÔ∏è</span> Crist√£
        </button>

      </div>

      <div class="radio-player">
        <audio id="radioPlayer" controls preload="none"></audio>
        <div style="display:flex;flex-direction:column;gap:6px;margin-left:12px">
          <button id="stopRadioBtn" class="btn-ghost">Parar R√°dio</button>
          <div id="nowPlaying" class="small muted">Nenhuma r√°dio selecionada.</div>
        </div>
      </div>
    </section>
    <!-- META -->
    <section class="card meta-card" aria-label="Meta di√°ria">
      <h2 style="margin:0 0 8px 0;font-size:18px">üéØ Meta Di√°ria</h2>

      <div class="meta-row mt-3" role="form" aria-label="Definir meta di√°ria">
        <input id="metaInput" type="number" placeholder="Ex: 300" aria-label="Valor da meta" />
        <button id="setMetaBtn" class="btn" aria-label="Salvar meta">Salvar Meta</button>
      </div>

      <div class="progress-container mt-4" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div id="progressBar" class="progress-bar" style="width:0%"></div>
        <div id="progressBubbles" class="progress-bubbles" aria-hidden="true"></div>
        <div id="progressText" class="progress-text">0%</div>
      </div>

      <div id="metaMessage" class="small muted mt-2" aria-live="polite">Defina a meta para acompanhar o progresso.</div>
    </section>

    <!-- KM & TIMER -->
    <section class="card km-card" aria-label="Jornada e quilometragem">
      <h2 style="margin:0 0 8px 0;font-size:18px">üöó Jornada e KM</h2>

      <div class="grid-4 mt-3" role="group" aria-label="Campos de quilometragem e tempo">
        <div>
          <label class="small muted" for="kmInicial">KM Inicial</label>
          <input id="kmInicial" type="number" placeholder="Ex: 150000" aria-label="KM inicial" />
        </div>

        <div>
          <label class="small muted" for="kmFinal">KM Final</label>
          <input id="kmFinal" type="number" placeholder="Ex: 150250" aria-label="KM final" />
        </div>

        <div>
          <label class="small muted">Tempo Trabalhado</label>
          <div id="tempoTrabalhado" class="big-time" aria-live="polite">00:00:00</div>
        </div>

        <div>
          <label class="small muted">KM Rodados</label>
          <div id="kmRodados" class="big-time" aria-live="polite">0.0 km</div>
        </div>
      </div>

      <div class="km-actions">
        <button id="toggleStartBtn" class="btn mt-4" aria-pressed="false">Iniciar Expediente</button>
        <button id="finalizeBtn" class="btn-ghost mt-4">Finalizar Dia</button>
        <button id="saveKmBtn" class="btn-ghost mt-4">Salvar KM</button>
      </div>
    </section>

    <!-- LAN√áAMENTOS: Entradas / Sa√≠das -->
    <section class="card lancamentos-card grid-2cols" aria-label="Lan√ßamentos">
      <div>
        <h3 style="margin:0 0 8px 0;font-size:16px">‚ûï Entradas (Apps)</h3>

        <div class="input-row mt-2" role="form" aria-label="Lan√ßar entrada">
          <input id="valorEntrada" type="number" step="0.1" placeholder="Valor (R$)" aria-label="Valor de entrada" />
          <button id="addEntradaBtn" class="btn" aria-label="Adicionar entrada">Lan√ßar</button>
        </div>

        <div class="apps-grid mt-2" role="list" aria-label="Lista de apps">
          <button class="app-btn" data-cat="Uber" style="background:#000" aria-label="Uber"> <span class="app-icon">üöó</span> Uber</button>
          <button class="app-btn" data-cat="99" style="background:#facc15;color:#111" aria-label="99"> <span class="app-icon">üöï</span> 99</button>
          <button class="app-btn" data-cat="inDriver" style="background:#10b981" aria-label="inDriver"> <span class="app-icon">üì≤</span> inDriver</button>
          <button class="app-btn" data-cat="Particular" style="background:#6b7280" aria-label="Particular"> <span class="app-icon">ü§ù</span> Particular</button>
          <button class="app-btn" data-cat="Loja" style="background:#1e3a8a" aria-label="Loja"> <span class="app-icon">üè¨</span> Loja</button>
          <button class="app-btn" data-cat="Doa√ß√£o" style="background:#8b5cf6" aria-label="Doa√ß√£o"> <span class="app-icon">üéÅ</span> Doa√ß√£o</button>
        </div>
      </div>

      <div>
        <h3 style="margin:0 0 8px 0;font-size:16px">‚ûñ Sa√≠das (Gastos)</h3>

        <div class="input-row mt-2" role="form" aria-label="Lan√ßar gasto">
          <input id="valorSaida" type="number" step="0.1" placeholder="Valor (R$)" aria-label="Valor de sa√≠da" />
          <button id="addSaidaBtn" class="btn" aria-label="Adicionar gasto">Lan√ßar</button>
        </div>

        <div class="gastos-grid mt-2" role="list" aria-label="Principais gastos">
          <button class="gasto-btn" data-cat="Combust√≠vel" style="background:#ef4444" aria-label="Combust√≠vel">‚õΩ Combust√≠vel</button>
          <button class="gasto-btn" data-cat="Alimenta√ß√£o" style="background:#8b5cf6" aria-label="Alimenta√ß√£o">üçî Alimenta√ß√£o</button>
          <button class="gasto-btn" data-cat="Manuten√ß√£o" style="background:#6b7280" aria-label="Manuten√ß√£o">üîß Manuten√ß√£o</button>
          <button class="gasto-btn" data-cat="Outros" style="background:#374151" aria-label="Outros">üì¶ Outros</button>
        </div>
      </div>
    </section>

    <!-- Lan√ßamentos recentes -->
    <section class="card recentes-card" aria-label="Lan√ßamentos recentes">
      <h3 style="margin:0 0 8px 0;font-size:16px">Lan√ßamentos Recentes</h3>
      <div id="lancamentosList" class="launch-list mt-2" aria-live="polite">
        <div class="muted small text-center">Nenhum lan√ßamento ainda.</div>
      </div>
    </section>

    <!-- Resumo por categoria -->
    <section class="card resumo-cat" aria-label="Resumo por categoria">
      <h3 style="margin:0 0 8px 0;font-size:16px">Resumo R√°pido por Categoria</h3>
      <div id="resumoCategorias" class="resumo-grid mt-2 small muted" role="list"></div>
    </section>

    <!-- M√©tricas -->
    <section class="card metric-card" aria-label="M√©tricas">
      <h3 style="margin:0 0 8px 0;font-size:16px">M√©tricas</h3>

      <div class="metric-grid mt-3">
        <div class="metric-col">
          <div class="metric-title">Ganhos Brutos ‚Äî Somente Apps</div>
          <div id="metricGanhosApps" class="metric-value text-green-400">R$ 0,00</div>
        </div>

        <div class="metric-col">
          <div class="metric-title">Ganhos Brutos ‚Äî Apps + Loja</div>
          <div id="metricGanhosTotal" class="metric-value text-cyan-300">R$ 0,00</div>
        </div>

        <div class="metric-col">
          <div class="metric-title">Lucro L√≠quido</div>
          <div id="metricLucroTotal" class="metric-value">R$ 0,00</div>
        </div>

        <div class="metric-col">
          <div class="metric-title">M√©dia/Hora (Bruto)</div>
          <div id="metricMediaHoraBrutoTotal" class="metric-value">R$ 0,00</div>
        </div>

        <div class="metric-col">
          <div class="metric-title">M√©dia/Hora (L√≠quido)</div>
          <div id="metricMediaHoraLiqTotal" class="metric-value">R$ 0,00</div>
        </div>

        <div class="metric-col">
          <div class="metric-title">Lucro / KM (L√≠quido)</div>
          <div id="metricLucroKmTotal" class="metric-value">R$ 0,00</div>
        </div>
      </div>
    </section>

    <!-- Actions & History -->
    <section class="card actions-card" aria-label="A√ß√µes">
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <button id="saveAndResetBtn" class="btn">Salvar Resumo & Resetar Dia</button>
        <button id="exportBtn" class="btn-ghost">Exportar Resumo (JSON)</button>
        <button id="viewHistoryBtn" class="btn-ghost">Ver Hist√≥rico de Dias</button>
      </div>

      <div id="historyPanel" class="history-panel mt-4 hidden" aria-live="polite"></div>
    </section>

    <!-- Final resumo -->
    <section class="card final-resumo" aria-label="Resumo final">
      <h3 style="margin:0 0 8px 0;font-size:16px">Resumo Final por Categoria</h3>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:12px">
        <div><div class="muted">Total Apps</div><div id="finalTotalApps" class="metric-value">R$ 0,00</div></div>
        <div><div class="muted">Total Loja</div><div id="finalTotalLoja" class="metric-value">R$ 0,00</div></div>
        <div><div class="muted">Total Doa√ß√µes</div><div id="finalTotalDoacao" class="metric-value">R$ 0,00</div></div>
        <div><div class="muted">Total Geral</div><div id="finalTotalGeral" class="metric-value">R$ 0,00</div></div>
      </div>
    </section>

    <footer class="small muted" style="text-align:center;margin-top:10px">Dados armazenados localmente (localStorage). Fa√ßa export regularmente.</footer>
  </div>

  <!-- confetti holder -->
  <div id="confettiRoot" class="confetti" aria-hidden="true"></div>
  <script>
/* ===========================
   BLOCO 3/3 ‚Äî SCRIPT COMPLETO
   =========================== */

/* UTIL */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const uid = () => Math.random().toString(36).slice(2,9);

function formatBRL(v){ return Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
function formatKM(v){ return Number(v||0).toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1}) + ' km'; }
function formatTime(ms){ if(!ms || ms<=0) return '00:00:00'; const s=Math.floor(ms/1000), h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60; return [h,m,sec].map(n=>String(n).padStart(2,'0')).join(':'); }

/* STATE */
let state = {
  meta: 0,
  ganhosApps: 0,
  ganhosLoja: 0,
  totalDoacao: 0,
  entradasApps: 0,
  entradasLoja: 0,
  gastos: 0,
  history: [],
  totalTimeWorked: 0,
  lastStartTime: null,
  status: 'stopped',
  kmInicial: 0,
  kmFinal: 0,
  celebrated: false
};
let timerInterval = null;
let autoMode = true;

/* REFS */
const stationButtons = $$('#stationButtons .station-btn');
const radioPlayer = $('#radioPlayer');
const nowPlaying = $('#nowPlaying');
const stopRadioBtn = $('#stopRadioBtn');

const metaInput = $('#metaInput'), setMetaBtn = $('#setMetaBtn');
const progressBar = $('#progressBar'), progressText = $('#progressText'), progressBubbles = $('#progressBubbles'), metaMessage = $('#metaMessage');
const confettiRoot = $('#confettiRoot');

const kmInicialEl = $('#kmInicial'), kmFinalEl = $('#kmFinal'), tempoTrabalhado = $('#tempoTrabalhado'), kmRodados = $('#kmRodados');
const toggleStartBtn = $('#toggleStartBtn'), finalizeBtn = $('#finalizeBtn'), saveKmBtn = $('#saveKmBtn');

const valorEntrada = $('#valorEntrada'), addEntradaBtn = $('#addEntradaBtn'), valorSaida = $('#valorSaida'), addSaidaBtn = $('#addSaidaBtn');
const appBtns = $$('.app-btn'), gastoBtns = $$('.gasto-btn');

const lancamentosList = $('#lancamentosList'), resumoCategorias = $('#resumoCategorias');

const metricGanhosApps = $('#metricGanhosApps'), metricGanhosTotal = $('#metricGanhosTotal'), metricLucroTotal = $('#metricLucroTotal');
const metricMediaHoraBrutoTotal = $('#metricMediaHoraBrutoTotal'), metricMediaHoraLiqTotal = $('#metricMediaHoraLiqTotal'), metricLucroKmTotal = $('#metricLucroKmTotal');
const finalTotalApps = $('#finalTotalApps'), finalTotalLoja = $('#finalTotalLoja'), finalTotalDoacao = $('#finalTotalDoacao'), finalTotalGeral = $('#finalTotalGeral');

const saveAndResetBtn = $('#saveAndResetBtn'), exportBtn = $('#exportBtn'), viewHistoryBtn = $('#viewHistoryBtn'), historyPanel = $('#historyPanel');
const autoThemeBtn = $('#autoThemeBtn'), themeDots = $$('.color-dot');

/* PERSIST */
function saveState(){ localStorage.setItem('maxrota_state', JSON.stringify(state)); }
function loadState(){ try{ const s = JSON.parse(localStorage.getItem('maxrota_state')||'{}'); if(Object.keys(s).length) Object.assign(state,s); }catch(e){ console.warn(e);} }
loadState();

/* RADIO */
function setActiveStation(btn){ stationButtons.forEach(b=>{ b.classList.remove('active'); b.setAttribute('aria-pressed','false'); }); if(btn){ btn.classList.add('active'); btn.setAttribute('aria-pressed','true'); } }
stationButtons.forEach(btn=>btn.addEventListener('click', async ()=>{
  const src=btn.dataset.src, name=btn.dataset.name||btn.textContent||'R√°dio';
  try{ radioPlayer.pause(); }catch(e){}
  radioPlayer.src='';
  setActiveStation(btn);
  nowPlaying.textContent = `Carregando: ${name} ...`;
  radioPlayer.crossOrigin='anonymous';
  radioPlayer.src = src;
  try{
    radioPlayer.load();
    await radioPlayer.play();
    nowPlaying.textContent = `Tocando: ${name}`;
  }catch(err){
    console.warn('Erro tocar esta√ß√£o',err);
    nowPlaying.textContent = `Falha ao tocar ${name}. Tente outro.`;
    setActiveStation(null);
  }
}));
stopRadioBtn.addEventListener('click', ()=>{ try{ radioPlayer.pause(); radioPlayer.removeAttribute('src'); radioPlayer.load(); }catch(e){} nowPlaying.textContent='Nenhuma r√°dio selecionada.'; setActiveStation(null); });
radioPlayer.addEventListener('error', ()=>{ nowPlaying.textContent='Erro ao carregar esta√ß√£o.'; setActiveStation(null); });

/* TIMER & KM */
function getTempoTotal(){ let t = Number(state.totalTimeWorked||0); if(state.status==='running' && state.lastStartTime) t += (Date.now() - state.lastStartTime); return t; }
function getKMRodados(){ return (Number(state.kmFinal) > Number(state.kmInicial)) ? (Number(state.kmFinal) - Number(state.kmInicial)) : 0; }

function startTimer(){ stopTimer(); if(!state.lastStartTime) state.lastStartTime = Date.now(); timerInterval = setInterval(()=>{ tempoTrabalhado.textContent = formatTime(getTempoTotal()); updateDerivedMetrics(); }, 1000); }
function stopTimer(){ if(timerInterval){ clearInterval(timerInterval); timerInterval = null; } }

toggleStartBtn.addEventListener('click', ()=>{
  if(state.status === 'stopped'){
    state.status = 'running'; state.lastStartTime = Date.now(); toggleStartBtn.textContent = 'Pausar'; startTimer();
  } else if(state.status === 'running'){
    state.totalTimeWorked += (Date.now() - state.lastStartTime);
    state.lastStartTime = null; state.status = 'paused'; toggleStartBtn.textContent = 'Retomar'; stopTimer();
  } else if(state.status === 'paused'){
    state.status = 'running'; state.lastStartTime = Date.now(); toggleStartBtn.textContent = 'Pausar'; startTimer();
  }
  saveState(); atualizarInterface();
});

finalizeBtn.addEventListener('click', ()=>{
  if(state.status === 'running'){ state.totalTimeWorked += (Date.now() - state.lastStartTime); state.lastStartTime = null; }
  state.status = 'stopped'; toggleStartBtn.textContent = 'Iniciar Expediente'; stopTimer(); saveState(); atualizarInterface();
});

saveKmBtn.addEventListener('click', ()=>{
  const s = Number(kmInicialEl.value) || 0;
  const e = Number(kmFinalEl.value) || 0;
  // update state and persist immediately and re-render
  state.kmInicial = s;
  state.kmFinal = e;
  saveState();
  atualizarInterface();
});

/* META */
setMetaBtn.addEventListener('click', ()=>{
  const v = Number(metaInput.value) || 0;
  state.meta = v>0? v : 0;
  localStorage.setItem('maxrota_meta', state.meta);
  saveState();
  atualizarInterface();
});

/* BUBBLES (progress) */
setInterval(()=>{ const b = document.createElement('div'); const size = 6 + Math.random()*14; b.style.width = size + 'px'; b.style.height = size + 'px'; b.style.position = 'absolute'; b.style.left = (Math.random()*100) + '%'; b.style.bottom = '-10px'; b.style.borderRadius = '50%'; b.style.background = 'rgba(255,255,255,' + (0.06 + Math.random()*0.18) + ')'; b.style.animation = 'riseBubble ' + (2 + Math.random()*2) + 's linear'; progressBubbles.appendChild(b); setTimeout(()=> b.remove(), 4200); }, 420);
const bubbleStyle = document.createElement('style'); bubbleStyle.innerHTML = '@keyframes riseBubble{0%{transform:translateY(0) scale(0.6);opacity:0.6}60%{opacity:0.9}100%{transform:translateY(-120%) scale(1.2);opacity:0}}'; document.head.appendChild(bubbleStyle);

/* LAN√áAMENTOS */
function addLancamento({type, value, category}){
  const item = { id: uid(), type, value: Number(value), category: category || '‚Äî', date: new Date().toISOString() };
  state.history.unshift(item);
  if(type === 'ganho'){
    if(category === 'Loja'){ state.ganhosLoja += item.value; state.entradasLoja++; }
    else if(category === 'Doa√ß√£o'){ state.totalDoacao += item.value; }
    else { state.ganhosApps += item.value; state.entradasApps++; }
  } else {
    state.gastos += item.value;
  }
  saveState(); atualizarInterface();
}

/* UI handlers for lan√ßamentos */
$$('.app-btn').forEach(b => b.addEventListener('click', ()=>{
  const cat = b.dataset.cat || b.getAttribute('data-cat');
  const val = Number(valorEntrada.value);
  if(isNaN(val) || val <= 0){ alert('Valor inv√°lido'); return; }
  addLancamento({ type:'ganho', value: val, category: cat });
  valorEntrada.value = '';
}));
$('#addEntradaBtn').addEventListener('click', ()=>{
  const v = Number(valorEntrada.value);
  if(isNaN(v) || v <= 0){ alert('Valor inv√°lido'); return; }
  addLancamento({ type:'ganho', value: v, category: 'Particular' });
  valorEntrada.value = '';
});
$$('.gasto-btn').forEach(b => b.addEventListener('click', ()=>{
  const cat = b.dataset.cat || b.getAttribute('data-cat');
  const val = Number(valorSaida.value);
  if(isNaN(val) || val <= 0){ alert('Valor inv√°lido'); return; }
  addLancamento({ type:'gasto', value: val, category: cat });
  valorSaida.value = '';
}));
$('#addSaidaBtn').addEventListener('click', ()=>{
  const v = Number(valorSaida.value);
  if(isNaN(v) || v <= 0){ alert('Valor inv√°lido'); return; }
  addLancamento({ type:'gasto', value: v, category: 'Outros' });
  valorSaida.value = '';
});

/* render lan√ßamentos (edit & delete) */
function renderLancamentos(){
  if(!lancamentosList) return;
  if(!state.history || state.history.length === 0){ lancamentosList.innerHTML = '<div class="muted small text-center">Nenhum lan√ßamento ainda.</div>'; return; }
  lancamentosList.innerHTML = '';
  state.history.slice(0,200).forEach(it=>{
    const el = document.createElement('div'); el.className = 'launch-item';
    const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:800">${it.category} ${it.type==='ganho'?'<span style="color:#10b981">+':'<span style="color:#fb7185">-'} ${formatBRL(it.value)}</span></div><div class="small muted">${new Date(it.date).toLocaleString()}</div>`;
    const right = document.createElement('div');
    const edit = document.createElement('button'); edit.className = 'btn-ghost'; edit.textContent = '‚úèÔ∏è';
    const del = document.createElement('button'); del.className = 'btn-ghost'; del.textContent = 'üóëÔ∏è';
    right.appendChild(edit); right.appendChild(del);
    el.appendChild(left); el.appendChild(right);
    lancamentosList.appendChild(el);

    edit.addEventListener('click', ()=>{
      const novoStr = prompt('Novo valor (R$):', it.value.toFixed(2));
      if(novoStr === null) return;
      const novo = Number(novoStr);
      if(isNaN(novo) || novo < 0){ alert('Valor inv√°lido'); return; }
      // revert old totals
      if(it.type === 'ganho'){
        if(it.category === 'Loja') state.ganhosLoja -= it.value;
        else if(it.category === 'Doa√ß√£o') state.totalDoacao -= it.value;
        else state.ganhosApps -= it.value;
      } else state.gastos -= it.value;
      // apply new
      it.value = novo;
      if(it.type === 'ganho'){
        if(it.category === 'Loja') state.ganhosLoja += it.value;
        else if(it.category === 'Doa√ß√£o') state.totalDoacao += it.value;
        else state.ganhosApps += it.value;
      } else state.gastos += it.value;
      saveState(); atualizarInterface();
    });

    del.addEventListener('click', ()=>{
      if(!confirm('Excluir lan√ßamento?')) return;
      const idx = state.history.findIndex(h => h.id === it.id); if(idx === -1) return;
      const item = state.history[idx];
      if(item.type === 'ganho'){
        if(item.category === 'Loja'){ state.ganhosLoja -= item.value; state.entradasLoja = Math.max(0, state.entradasLoja-1); }
        else if(item.category === 'Doa√ß√£o'){ state.totalDoacao -= item.value; }
        else { state.ganhosApps -= item.value; state.entradasApps = Math.max(0, state.entradasApps-1); }
      } else { state.gastos -= item.value; }
      state.history.splice(idx,1);
      saveState(); atualizarInterface();
    });
  });
}

/* resumo categorias */
function renderResumoCategorias(){
  const totals = {}, counts = {};
  (state.history || []).forEach(it=>{
    if(it.type !== 'ganho') return;
    const cat = it.category || 'Outros';
    totals[cat] = (totals[cat] || 0) + it.value;
    counts[cat] = (counts[cat] || 0) + 1;
  });
  resumoCategorias.innerHTML = '';
  const order = ['Uber','99','inDriver','Particular','Loja','Doa√ß√£o'];
  order.forEach(cat=>{
    const val = totals[cat] || 0; const cnt = counts[cat] || 0;
    const node = document.createElement('div');
    node.innerHTML = `<div style="font-weight:900;margin-bottom:6px">${cat}</div><div style="font-weight:800">${formatBRL(val)}</div><div class="small muted">${cnt} entr.</div>`;
    resumoCategorias.appendChild(node);
  });
  Object.keys(totals).forEach(cat=>{
    if(order.includes(cat)) return;
    const node = document.createElement('div');
    node.innerHTML = `<div style="font-weight:900;margin-bottom:6px">${cat}</div><div style="font-weight:800">${formatBRL(totals[cat])}</div><div class="small muted">${counts[cat]||0} entr.</div>`;
    resumoCategorias.appendChild(node);
  });
}

/* metrics & progress */
function updateDerivedMetrics(){
  const ganhosBrutosTotal = Number(state.ganhosApps || 0) + Number(state.ganhosLoja || 0) + Number(state.totalDoacao || 0);
  const lucroTotal = ganhosBrutosTotal - Number(state.gastos || 0);
  const tempoMs = getTempoTotal();
  const horas = tempoMs/(1000*60*60) || 0;
  const mediaHora = horas>0 ? ganhosBrutosTotal / horas : 0;
  const mediaLiq = horas>0 ? lucroTotal / horas : 0;

  metricGanhosApps.textContent = formatBRL(state.ganhosApps);
  metricGanhosTotal.textContent = formatBRL(ganhosBrutosTotal);
  metricLucroTotal.textContent = formatBRL(lucroTotal);
  metricMediaHoraBrutoTotal.textContent = formatBRL(mediaHora);
  metricMediaHoraLiqTotal.textContent = formatBRL(mediaLiq);
  metricLucroKmTotal.textContent = formatBRL(getKMRodados()>0 ? (lucroTotal/getKMRodados()) : 0);

  finalTotalApps.textContent = formatBRL(state.ganhosApps);
  finalTotalLoja.textContent = formatBRL(state.ganhosLoja);
  finalTotalDoacao.textContent = formatBRL(state.totalDoacao);
  finalTotalGeral.textContent = formatBRL(ganhosBrutosTotal - state.gastos);

  // progress
  const meta = Number(state.meta || 0);
  const current = Number(state.ganhosApps || 0) + Number(state.ganhosLoja || 0);
  const pct = meta > 0 ? Math.min(100, (current/meta)*100) : 0;
  progressBar.style.width = pct + '%';
  progressText.textContent = Math.round(pct) + '%';
  if(meta === 0) metaMessage.textContent = 'Defina a meta para acompanhar o progresso.';
  else { const falt = meta - current; metaMessage.textContent = falt > 0 ? `Faltam ${formatBRL(falt)}.` : `Meta batida! (+${formatBRL(Math.abs(falt))})`; }

  tempoTrabalhado.textContent = formatTime(getTempoTotal());
  kmRodados.textContent = formatKM(getKMRodados());

  maybeCelebrate();
}

/* CELEBRATION: trombeta + applause + confetti */
async function playVictorySequence(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const now = ctx.currentTime;

    // Trombeta breve
    const o1 = ctx.createOscillator(); o1.type='sawtooth'; o1.frequency.value = 440;
    const o2 = ctx.createOscillator(); o2.type='sine'; o2.frequency.value = 660;
    const g = ctx.createGain(); g.gain.setValueAtTime(0.0001, now);
    o1.connect(g); o2.connect(g); g.connect(ctx.destination);
    g.gain.exponentialRampToValueAtTime(0.85, now + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, now + 1.05);
    o1.start(now); o2.start(now); o1.stop(now + 1.05); o2.stop(now + 1.05);

    // Flourish melody
    const notes = [880,988,1175];
    const mg = ctx.createGain(); mg.gain.setValueAtTime(0.0001, now + 0.6); mg.connect(ctx.destination);
    notes.forEach((n,i)=>{ const o = ctx.createOscillator(); o.type='triangle'; o.frequency.value = n; o.connect(mg); const t0 = now + 0.6 + i*0.18; o.start(t0); o.stop(t0 + 0.18); });
    mg.gain.exponentialRampToValueAtTime(0.14, now + 0.62);
    mg.gain.exponentialRampToValueAtTime(0.0001, now + 2.6);

    // Applause noise ~5s
    const len = ctx.sampleRate * 5;
    const buffer = ctx.createBuffer(1, len, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for(let i=0;i<len;i++){ const t = i/ctx.sampleRate; const env = 1-(t/5); data[i] = (Math.random()*2-1)*0.6*env*(Math.random()>0.94?1.4:1); }
    const noise = ctx.createBufferSource(); noise.buffer = buffer; const ng = ctx.createGain(); noise.connect(ng); ng.connect(ctx.destination);
    ng.gain.setValueAtTime(0.0001, now + 1.0); ng.gain.exponentialRampToValueAtTime(1.0, now + 1.05); ng.gain.exponentialRampToValueAtTime(0.0001, now + 6.2);
    noise.start(now + 1.0);
    setTimeout(()=>{ try{ noise.stop(); ctx.close(); }catch(e){} }, 7000);
  }catch(e){ console.warn('audio fail', e); }
}

function triggerConfetti(){
  const colors = ['#10b981','#f97316','#facc15','#ef4444','#ec4899'];
  for(let i=0;i<120;i++){
    const el = document.createElement('div'); el.className='c';
    const size = 6 + Math.random()*12; el.style.width = size + 'px'; el.style.height = (size*1.4) + 'px';
    el.style.left = (Math.random()*100) + '%'; el.style.top = (-10 + Math.random()*20) + '%';
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el.style.transform = 'rotate(' + Math.random()*360 + 'deg)';
    confettiRoot.appendChild(el);
    const dur = 2200 + Math.random()*2000;
    el.animate([{ transform: 'translateY(0px) rotate(0deg)', opacity:1 }, { transform: 'translateY(' + (200 + Math.random()*400) + 'px) rotate(' + (360 + Math.random()*720) + 'deg)', opacity:0.2 }], { duration:dur, easing:'ease-out' });
    setTimeout(()=> el.remove(), dur + 100);
  }
}

function maybeCelebrate(){
  const meta = Number(state.meta || 0);
  if(meta <= 0) return;
  const current = Number(state.ganhosApps || 0) + Number(state.ganhosLoja || 0);
  const pct = (current / meta) * 100;
  if(pct >= 100 && !state.celebrated){
    state.celebrated = true;
    playVictorySequence();
    triggerConfetti();
  }
  if(pct < 100) state.celebrated = false;
}

/* SAVE DAY / HISTORY */
function saveDaySummary(){
  try{
    const arr = JSON.parse(localStorage.getItem('maxrota_days')||'[]');
    const ganhosBrutosTotal = Number(state.ganhosApps||0) + Number(state.ganhosLoja||0) + Number(state.totalDoacao||0);
    const lucro = ganhosBrutosTotal - Number(state.gastos||0);
    const tempo = getTempoTotal();
    const km = getKMRodados();
    const mediaHora = tempo>0 ? ganhosBrutosTotal/(tempo/(1000*60*60)) : 0;
    const resumo = {
      id: new Date().toISOString(),
      date: new Date().toISOString(),
      meta: state.meta,
      kmInicial: state.kmInicial,
      kmFinal: state.kmFinal,
      ganhosApps: state.ganhosApps,
      ganhosLoja: state.ganhosLoja,
      ganhoDoacao: state.totalDoacao,
      entradasApps: state.entradasApps,
      entradasLoja: state.entradasLoja,
      gastos: state.gastos,
      lucro,
      tempo,
      km,
      mediaHora,
      history: state.history.slice(0,500)
    };
    arr.unshift(resumo);
    localStorage.setItem('maxrota_days', JSON.stringify(arr.slice(0,300)));
  }catch(e){ console.error('saveDaySummary failed', e); }
}

/* Save & Reset */
saveAndResetBtn.addEventListener('click', ()=>{
  if(!confirm('Deseja salvar o resumo do dia e resetar todos os dados atuais?')) return;
  saveDaySummary();
  state = {
    meta:0, ganhosApps:0, ganhosLoja:0, totalDoacao:0, entradasApps:0, entradasLoja:0, gastos:0,
    history:[], totalTimeWorked:0, lastStartTime:null, status:'stopped', kmInicial:0, kmFinal:0, celebrated:false
  };
  kmInicialEl.value=''; kmFinalEl.value=''; metaInput.value='';
  toggleStartBtn.textContent='Iniciar Expediente';
  stopTimer();
  saveState();
  atualizarInterface();
});

/* Export */
exportBtn.addEventListener('click', ()=>{
  const data = { state, days: JSON.parse(localStorage.getItem('maxrota_days')||'[]') };
  const blob = new Blob([JSON.stringify(data,null,2)], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'maxrota_export.json'; a.click(); URL.revokeObjectURL(url);
});

/* History panel */
viewHistoryBtn.addEventListener('click', ()=>{
  historyPanel.classList.toggle('hidden');
  if(!historyPanel.classList.contains('hidden')) renderHistory();
});
function renderHistory(){
  const arr = JSON.parse(localStorage.getItem('maxrota_days')||'[]');
  if(!arr || arr.length === 0){ historyPanel.innerHTML = '<div class="muted small">Nenhum dia salvo.</div>'; return; }
  historyPanel.innerHTML = arr.map(d=>{
    const date = new Date(d.date);
    return `<div style="padding:8px;border-bottom:1px dashed rgba(255,255,255,0.04)"><div style="font-weight:800">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</div><div class="small muted">Lucro: ${formatBRL(d.lucro)} ¬∑ KM: ${d.km} ¬∑ M√©dia/H: ${formatBRL(d.mediaHora||0)}</div><div style="margin-top:6px"><button class="btn-ghost open-day" data-id="${d.id}">Abrir</button> <button class="btn-ghost del-day" data-id="${d.id}">Excluir</button></div></div>`;
  }).join('');
  historyPanel.querySelectorAll('.del-day').forEach(b=>b.addEventListener('click', ()=>{
    if(!confirm('Excluir dia?')) return;
    const id = b.dataset.id; let arr = JSON.parse(localStorage.getItem('maxrota_days')||'[]'); arr = arr.filter(x=>x.id !== id); localStorage.setItem('maxrota_days', JSON.stringify(arr)); renderHistory();
  }));
  historyPanel.querySelectorAll('.open-day').forEach(b=>b.addEventListener('click', ()=>{
    const id = b.dataset.id; const arr = JSON.parse(localStorage.getItem('maxrota_days')||'[]'); const d = arr.find(x=>x.id === id);
    if(!d) return alert('Dia n√£o encontrado.');
    alert(`Resumo ${new Date(d.date).toLocaleString()}\nLucro: ${formatBRL(d.lucro)}\nKM: ${d.km}\nM√©dia/H: ${formatBRL(d.mediaHora||0)}\nEntradas App: ${d.entradasApps} ¬∑ Loja: ${d.entradasLoja}`);
  }));
}

/* THEMES */
function applyAutoTheme(){ const h = new Date().getHours(); const isDay = (h >= 6 && h < 18); document.body.classList.toggle('light-mode', isDay); autoThemeBtn.textContent = isDay ? 'Modo Dia ‚òÄÔ∏è' : 'Modo Noite üåô'; }
applyAutoTheme();
setInterval(()=>{ if(autoMode) applyAutoTheme(); }, 60*1000);

autoThemeBtn.addEventListener('click', ()=>{
  autoMode = !autoMode;
  if(autoMode){ applyAutoTheme(); localStorage.removeItem('maxrota_manual'); } else { document.body.classList.toggle('light-mode'); localStorage.setItem('maxrota_manual','1'); }
});

themeDots.forEach(d => d.addEventListener('click', ()=>{
  const acc = d.dataset.accent;
  document.body.classList.remove('accent-green','accent-orange','accent-yellow','accent-red','accent-pink');
  document.body.classList.add('accent-'+acc);
  localStorage.setItem('maxrota_accent', acc);
}));
const savedAccent = localStorage.getItem('maxrota_accent') || 'green';
document.body.classList.add('accent-'+savedAccent);

/* RENDER / UPDATE */
function atualizarInterface(){
  // populate inputs from state only when user not typing (safer approach)
  if(document.activeElement !== kmInicialEl) kmInicialEl.value = state.kmInicial || '';
  if(document.activeElement !== kmFinalEl) kmFinalEl.value = state.kmFinal || '';
  if(document.activeElement !== metaInput) metaInput.value = state.meta || '';

  renderLancamentos();
  renderResumoCategorias();
  updateDerivedMetrics();

  if(state.status === 'running') toggleStartBtn.textContent = 'Pausar';
  else if(state.status === 'paused') toggleStartBtn.textContent = 'Retomar';
  else toggleStartBtn.textContent = 'Iniciar Expediente';

  saveState();
}

/* resume timer if needed */
if(state.status === 'running' && state.lastStartTime) { startTimer(); toggleStartBtn.textContent = 'Pausar'; }

/* initial meta load */
const metaSaved = Number(localStorage.getItem('maxrota_meta')||0);
if(metaSaved) state.meta = metaSaved;

/* periodic update */
atualizarInterface();
setInterval(atualizarInterface, 2000);

/* keyboard shortcuts */
valorEntrada.addEventListener('keyup', e => { if(e.key === 'Enter') addEntradaBtn.click(); });
valorSaida.addEventListener('keyup', e => { if(e.key === 'Enter') addSaidaBtn.click(); });

/* final console */
console.log('MAX ROTA DI√ÅRIO ‚Äî script carregado e pronto.');
</script>
</body>
</html>
