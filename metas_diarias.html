<!doctype html><!--force-refresh-->
<html lang="pt-BR">
<head>
  <!-- FORCE NO-CACHE PARA GARANTIR QUE O GITHUB PAGE SEMPRE PEGUE A √öLTIMA VERS√ÉO -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<script>
  /* üîÑ Limpa cache automaticamente quando voc√™ mudar a vers√£o */
  (function () {
    const version = "v1.0.5"; 
    if (localStorage.getItem("maxrota_version") !== version) {
      localStorage.setItem("maxrota_version", version);
      window.location.reload(true);
    }
  })();
</script>

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MAX ROTA DI√ÅRIO</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<style>
/* 100% DO SEU CSS ORIGINAL, SEM ALTERAR NADA DO LAYOUT */

:root {
  --accent: #10b981;
  --bg1: #041226;
  --bg2: #2a1160;
  --text: #e6eef6;
  --muted: #9aa6b2;
  --card: rgba(255, 255, 255, 0.06);
  --radius: 14px;
  --scale: 1.02;
}

html, body { height: 100%; margin: 0; padding: 0; }

body {
  font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto;
  background: linear-gradient(135deg, var(--bg1), var(--bg2));
  color: var(--text);
  padding: 20px;
  transform: scale(var(--scale));
  transform-origin: top left;
}

.wrap { max-width: 1200px; margin: 0 auto; }

.card {
  background: var(--card);
  backdrop-filter: blur(6px);
  border-radius: 16px;
  padding: 18px;
  margin-bottom: 18px;
  border: 1px solid rgba(255,255,255,0.03);
  box-shadow: 0 10px 26px rgba(0,0,0,0.35);
}

.header-card {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
}

.logo-img {
  height: 74px;
  width: auto;
  border-radius: 12px;
}

.theme-controls {
  display: flex;
  align-items: center;
  gap: 12px;
}

.theme-btn {
  background: linear-gradient(120deg, var(--accent), #3b82f6);
  color: #fff;
  padding: 10px 14px;
  border-radius: 12px;
  border: none;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}

.theme-dots { display: flex; gap: 10px; }

.color-dot {
  width: 30px;
  height: 30px;
  border-radius: 999px;
  border: 2px solid rgba(255,255,255,0.12);
  cursor: pointer;
  box-shadow: 0 6px 14px rgba(0,0,0,0.3);
}

.radio-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
}

.station-btn {
  padding: 14px;
  border-radius: 12px;
  color: #fff;
  font-weight: 800;
  border: 0;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: 0.12s;
  font-size: 16px;
  height: 56px;
}

.station-btn.active {
  box-shadow: 0 10px 26px rgba(0,0,0,0.5);
  transform: translateY(-3px);
}

.radio-player {
  margin-top: 12px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.meta-row {
  display: flex;
  gap: 12px;
}

.meta-row input {
  flex: 1;
  padding: 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.03);
  color: var(--text);
  font-weight: 800;
  font-size: 16px;
}

.progress-container {
  height: 44px;
  border-radius: 22px;
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.06);
  overflow: hidden;
  position: relative;
}

.progress-bar {
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  background: linear-gradient(120deg, var(--accent), #2563eb);
  width: 0%;
  animation: waveMove 3.5s linear infinite;
  background-size: 200% 200%;
}

@keyframes waveMove {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

.progress-text {
  position: absolute;
  width: 100%;
  height: 100%;
  line-height: 44px;
  text-align: center;
  font-weight: 900;
  font-size: 15px;
}

.big-time { font-size: 20px; font-weight: 900; }

.km-actions {
  margin-top: 12px;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.btn {
  padding: 12px 16px;
  border-radius: 12px;
  background: linear-gradient(120deg, var(--accent), #7c3aed);
  border: none;
  font-weight: 800;
  cursor: pointer;
  color: #fff;
  font-size: 15px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.3);
}

.btn-ghost {
  padding: 12px 16px;
  border-radius: 12px;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.06);
  font-weight: 700;
  cursor: pointer;
  color: var(--muted);
}

.grid-2cols {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
}

.input-row { display: flex; gap: 12px; }

.input-row input {
  flex: 1;
  padding: 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.03);
  color: var(--text);
  font-weight: 700;
  font-size: 15px;
}

.apps-grid, .gastos-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}

.app-btn,
.gasto-btn {
  padding: 12px 14px;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 900;
  color: #fff;
  font-size: 15px;
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 120px;
}

.launch-list {
  max-height: 300px;
  overflow-y: auto;
  padding: 6px;
}

.launch-item {
  display: flex;
  justify-content: space-between;
  border-bottom: 1px dashed rgba(255,255,255,0.06);
  padding: 10px 6px;
  border-radius: 10px;
}

.metric-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px,1fr));
  gap: 14px;
}

.metric-col {
  padding: 12px;
  border-radius: 12px;
  background: rgba(255,255,255,0.04);
}

.metric-title { font-size: 13px; color: var(--muted); }

.metric-value { margin-top: 8px; font-size: 18px; font-weight: 900; }

.resumo-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit,minmax(140px,1fr));
  gap: 12px;
}

.accent-green { --accent:#10b981; }
.accent-orange { --accent:#f97316; }
.accent-yellow { --accent:#facc15; }
.accent-red { --accent:#ef4444; }
.accent-pink { --accent:#ec4899; }

body.light-mode {
  --bg1:#f5f7fb;
  --bg2:#e8f0ff;
  --text:#0b1220;
  --muted:#566170;
  --card:rgba(255,255,255,0.9);
}

.hidden-value {
  visibility: hidden;
  position: relative;
}

.hidden-value::after {
  content: "****";
  visibility: visible;
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  color: var(--text);
  font-weight: 900;
}
</style>

</head>
<body class="accent-green">
<div class="wrap">

  <!-- HEADER -->
  <header class="card header-card" role="banner" aria-label="Cabe√ßalho MAX ROTA">
    <div style="display:flex;align-items:center;gap:12px">
      <img id="logoImg" class="logo-img"
           src="https://i.postimg.cc/3RWn008g/Chat-GPT-Image-12-de-nov-de-2025-14-32-56.png"
           alt="MAX ROTA DI√ÅRIO">
      <div>
        <h1 style="margin:0;font-size:20px">MAX ROTA DI√ÅRIO</h1>
        <div class="small muted">Painel do Motorista</div>
      </div>
    </div>

    <div class="header-actions-container">
      <!-- Controle de Tema -->
      <div class="theme-controls">
        <button id="autoThemeBtn" class="theme-btn" title="Ativar modo autom√°tico">Auto üåó</button>

        <div class="theme-dots" style="margin-left:8px">
          <button class="color-dot" data-accent="green"  style="background:#10b981"></button>
          <button class="color-dot" data-accent="orange" style="background:#f97316"></button>
          <button class="color-dot" data-accent="yellow" style="background:#facc15"></button>
          <button class="color-dot" data-accent="red"    style="background:#ef4444"></button>
          <button class="color-dot" data-accent="pink"   style="background:#ec4899"></button>
        </div>
      </div>

      <!-- Ocultar valores -->
      <button id="toggleValuesBtn" class="toggle-btn">Esconder Valores</button>
    </div>
  </header>

  <!-- R√ÅDIOS -->
  <section class="card radio-card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin:0;font-size:16px">üéß Esta√ß√µes</h2>
      <button onclick="logout()" class="btn">Sair</button>
    </div>

    <div id="stationButtons" class="radio-grid">
      <button class="station-btn" data-src="https://live.hunter.fm/pop_high"     style="background:#10b981">Hunter Pop</button>
      <button class="station-btn" data-src="https://live.hunter.fm/pop2k_high"   style="background:#06b6d4">Pop2K</button>
      <button class="station-btn" data-src="https://ice1.somafm.com/u80s-128-mp3" style="background:#8b5cf6">80s</button>
      <button class="station-btn" data-src="http://listen.181fm.com/181-power_128k.mp3" style="background:#f97316">Power181</button>

      <button class="station-btn" data-src="https://live.hunter.fm/rock_high"   style="background:#ef4444">Rock</button>
      <button class="station-btn" data-src="https://live.hunter.fm/sertanejo_high"  style="background:#f59e0b">Sertanejo</button>
      <button class="station-btn" data-src="https://live.hunter.fm/hiphop_high"     style="background:#111827">HipHop</button>
      <button class="station-btn" data-src="https://live.hunter.fm/gospel_high"     style="background:#facc15;color:#111">Crist√£</button>

      <button class="station-btn" data-src="https://ice1.somafm.com/groovesalad-128-mp3" style="background:#2563eb">Eletr√¥nica</button>
      <button class="station-btn" data-src="https://ice1.somafm.com/beatblender-128-mp3" style="background:#7c3aed">House</button>
      <button class="station-btn" data-src="https://ice1.somafm.com/secretagent-128-mp3" style="background:#06b6d4">Surf</button>
      <button class="station-btn" data-src="https://ice1.somafm.com/dubstep-128-mp3"      style="background:#4ade80">Reggae</button>

      <button class="station-btn" data-src="https://live.hunter.fm/mpb_high"       style="background:#1e3a8a">MPB</button>
      <button class="station-btn" data-src="https://stream.radioparadise.com/mp3-192" style="background:#111827">RadioParadise</button>
      <button class="station-btn" data-src="http://listen.181fm.com/181-beat_128k.mp3" style="background:#0ea5e9">181 HipHop</button>
      <button class="station-btn" data-src="https://live.hunter.fm/mpb_high" style="background:#8b5cf6">MPB Alt</button>
    </div>

    <div class="radio-player mt-4">
      <audio id="radioPlayer" controls preload="none"></audio>
      <div style="display:flex;flex-direction:column;gap:8px;margin-left:12px">
        <button id="stopRadioBtn" class="btn-ghost">Parar R√°dio</button>
        <div id="nowPlaying" class="small muted">Nenhuma r√°dio selecionada.</div>
      </div>
    </div>
  </section>

  <!-- META -->
  <section class="card meta-card">
    <h2 style="margin:0 0 8px 0;font-size:16px">üéØ Meta Di√°ria</h2>

    <div class="meta-row mt-3">
      <input id="metaInput" type="number" placeholder="Ex: 300" />
      <button id="setMetaBtn" class="btn">Salvar Meta</button>
    </div>

    <div class="progress-container mt-4">
      <div id="progressBar" class="progress-bar"></div>
      <div id="progressBubbles" class="progress-bubbles"></div>
      <div id="progressText" class="progress-text">0%</div>
    </div>

    <div id="metaMessage" class="small muted mt-2">Defina a meta para acompanhar o progresso.</div>
  </section>

  <!-- KM & TIMER -->
  <section class="card km-card">
    <h2 style="margin:0 0 8px 0;font-size:16px">üöó Jornada e KM</h2>

    <div class="grid-4 mt-3">
      <div>
        <label class="small muted">KM Inicial</label>
        <input id="kmInicial" type="number" placeholder="Ex: 150000">
      </div>

      <div>
        <label class="small muted">KM Final</label>
        <input id="kmFinal" type="number" placeholder="Ex: 150250">
      </div>

      <div>
        <label class="small muted">Tempo Trabalhado</label>
        <div id="tempoTrabalhado" class="big-time">00:00:00</div>
      </div>

      <div>
        <label class="small muted">KM Rodados</label>
        <div id="kmRodados" class="big-time">0.0 km</div>
      </div>
    </div>

    <div class="km-actions">
      <button id="toggleStartBtn" class="btn">Iniciar Expediente</button>
      <button id="finalizeBtn" class="btn-ghost">Finalizar Dia</button>
      <button id="saveKmBtn" class="btn">Salvar KM</button>
    </div>
  </section>

  <!-- LAN√áAMENTOS -->
  <section class="card lancamentos-card grid-2cols">
    <div>
      <h3 style="margin:0 0 8px 0;font-size:15px">‚ûï Entradas (Apps)</h3>

      <div class="input-row mt-2">
        <input id="valorEntrada" type="number" placeholder="Valor (R$)">
        <button id="addEntradaBtn" class="btn">Lan√ßar</button>
      </div>

      <div class="apps-grid mt-2">
        <button class="app-btn" data-cat="Uber" style="background:#000">Uber</button>
        <button class="app-btn" data-cat="99" style="background:#facc15;color:#111">99</button>
        <button class="app-btn" data-cat="inDriver" style="background:#10b981">inDriver</button>
        <button class="app-btn" data-cat="Particular" style="background:#6b7280">Particular</button>
        <button class="app-btn" data-cat="Loja" style="background:#1e3a8a">Loja</button>
        <button class="app-btn" data-cat="Doa√ß√£o" style="background:#8b5cf6">Doa√ß√£o</button>
      </div>
    </div>

    <div>
      <h3 style="margin:0 0 8px 0;font-size:15px">‚ûñ Sa√≠das (Gastos)</h3>

      <div class="input-row mt-2">
        <input id="valorSaida" type="number" placeholder="Valor (R$)">
        <button id="addSaidaBtn" class="btn">Lan√ßar</button>
      </div>

      <div class="gastos-grid mt-2">
        <button class="gasto-btn" data-cat="Combust√≠vel" style="background:#ef4444">Combust√≠vel</button>
        <button class="gasto-btn" data-cat="Alimenta√ß√£o" style="background:#8b5cf6">Alimenta√ß√£o</button>
        <button class="gasto-btn" data-cat="Manuten√ß√£o" style="background:#6b7280">Manuten√ß√£o</button>
        <button class="gasto-btn" data-cat="Outros" style="background:#374151">Outros</button>
      </div>
    </div>
  </section>

  <!-- Lan√ßamentos Recentes -->
  <section class="card recentes-card">
    <h3 style="margin:0 0 8px 0;font-size:15px">Lan√ßamentos Recentes</h3>
    <div id="lancamentosList" class="launch-list">
      <div class="muted small text-center">Nenhum lan√ßamento ainda.</div>
    </div>
  </section>

  <!-- Resumo por categoria -->
  <section class="card resumo-cat">
    <h3 style="margin:0 0 8px 0;font-size:15px">Resumo R√°pido por Categoria</h3>
    <div id="resumoCategorias" class="resumo-grid"></div>
  </section>

  <!-- M√©tricas -->
  <section class="card metric-card">
    <h3 style="margin:0 0 8px 0;font-size:15px">M√©tricas</h3>

    <div class="metric-grid mt-3">
      <div class="metric-col">
        <div class="metric-title">Ganhos Brutos ‚Äî Somente Apps</div>
        <div id="metricGanhosApps" class="metric-value">R$ 0,00</div>
      </div>

      <div class="metric-col">
        <div class="metric-title">Ganhos Brutos ‚Äî Apps + Loja</div>
        <div id="metricGanhosTotal" class="metric-value">R$ 0,00</div>
      </div>

      <div class="metric-col">
        <div class="metric-title">Gastos Totais</div>
        <div id="metricGastosTotal" class="metric-value">R$ 0,00</div>
      </div>

      <div class="metric-col">
        <div class="metric-title">Lucro L√≠quido</div>
        <div id="metricLucroTotal" class="metric-value">R$ 0,00</div>
      </div>

      <div class="metric-col">
        <div class="metric-title">M√©dia/Hora (Bruto)</div>
        <div id="metricMediaHoraBrutoTotal" class="metric-value">R$ 0,00</div>
      </div>

      <div class="metric-col">
        <div class="metric-title">M√©dia/Hora (L√≠quido)</div>
        <div id="metricMediaHoraLiqTotal" class="metric-value">R$ 0,00</div>
      </div>

      <div class="metric-col">
        <div class="metric-title">Lucro / KM (L√≠quido)</div>
        <div id="metricLucroKmTotal" class="metric-value">R$ 0,00</div>
      </div>

      <div class="metric-col">
        <div class="metric-title">Entradas Apps</div>
        <div id="metricEntradasApps" class="metric-value">0</div>
      </div>

      <div class="metric-col">
        <div class="metric-title">Entradas Loja</div>
        <div id="metricEntradasLoja" class="metric-value">0</div>
      </div>
    </div>
  </section>

  <!-- A√ß√µes -->
  <section class="card actions-card">
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <button id="saveAndResetBtn" class="btn">Salvar Resumo & Resetar Dia</button>
      <button id="exportBtn" class="btn-ghost">Exportar Resumo (JSON)</button>
      <button id="viewHistoryBtn" class="btn-ghost">Ver Hist√≥rico de Dias</button>
    </div>

    <div id="historyPanel" class="history-panel mt-4 hidden"></div>
  </section>

  <!-- Resumo final -->
  <section class="card final-resumo">
    <h3 style="margin:0 0 8px 0;font-size:15px">Resumo Final por Categoria</h3>

    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:8px">
      <div style="background:rgba(255,255,255,0.06);padding:12px;border-radius:12px;text-align:center">
        <div class="muted">Total Apps</div>
        <div id="finalTotalApps" class="metric-value">R$ 0,00</div>
      </div>

      <div style="background:rgba(255,255,255,0.06);padding:12px;border-radius:12px;text-align:center">
        <div class="muted">Total Loja</div>
        <div id="finalTotalLoja" class="metric-value">R$ 0,00</div>
      </div>

      <div style="background:rgba(255,255,255,0.06);padding:12px;border-radius:12px;text-align:center">
        <div class="muted">Total Doa√ß√µes</div>
        <div id="finalTotalDoacao" class="metric-value">R$ 0,00</div>
      </div>

      <div style="background:linear-gradient(135deg,var(--accent),#3b82f6);padding:12px;border-radius:12px;text-align:center;color:#fff">
        <div class="muted" style="opacity:0.9">Total Geral</div>
        <div id="finalTotalGeral" class="metric-value">R$ 0,00</div>
      </div>
    </div>
  </section>

  <footer class="small muted" style="text-align:center;margin-top:10px">
    Dados armazenados localmente (localStorage). Fa√ßa export regularmente.
  </footer>

</div> <!-- wrap -->

<div id="confettiRoot" class="confetti"></div>
<!-- ===========================================
       SCRIPT PRINCIPAL DO APP (MAX ROTA)
       COMPLETAMENTE INTACTO ‚Äî APENAS SINCRONIZADO
===========================================-->
<script type="module">
/* ========================
   IMPORTS FIRESTORE
======================== */
import {
  doc,
  getDoc,
  setDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ===========================
   UTILS
=========================== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const uid = () => Math.random().toString(36).slice(2, 9);

function formatBRL(v) {
  return Number(v || 0).toLocaleString("pt-BR", {
    style: "currency",
    currency: "BRL"
  });
}
function formatKM(v) {
  return Number(v || 0).toFixed(1) + " km";
}
function formatTime(ms) {
  if (!ms || ms <= 0) return "00:00:00";
  const s = Math.floor(ms / 1000);
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  const sec = s % 60;
  return [h, m, sec].map(n => String(n).padStart(2, "0")).join(":");
}

/* ===========================
   ESTADO (SEM ALTERAR NADA)
=========================== */
let state = {
  meta: 0,
  ganhosApps: 0,
  ganhosLoja: 0,
  totalDoacao: 0,
  entradasApps: 0,
  entradasLoja: 0,
  gastos: 0,
  history: [],
  kmInicial: 0,
  kmFinal: 0,
  totalTimeWorked: 0,
  lastStartTime: null,
  status: "stopped",
  celebrated: false,
  valuesHidden: false,
  savedDays: []
};

/* ===========================
   LOCAL STORAGE
=========================== */
function loadLocalState() {
  try {
    const s = localStorage.getItem("maxrota_state");
    if (s) Object.assign(state, JSON.parse(s));

    if (!Array.isArray(state.savedDays)) {
      state.savedDays = JSON.parse(localStorage.getItem("maxrota_days") || "[]");
    }
  } catch (e) {
    console.warn("Erro carregando estado local", e);
  }
}
function saveLocalState() {
  localStorage.setItem("maxrota_state", JSON.stringify(state));
}

/* ===========================
   FIREBASE SYNC
=========================== */
async function loadState() {
  const uid = window.__USER_UID__;
  if (!uid) {
    loadLocalState();
    updateUI();
    return;
  }

  const { db } = window.__FIREBASE__;
  const ref = doc(db, "users", uid);

  try {
    const snap = await getDoc(ref);
    if (snap.exists()) {
      Object.assign(state, snap.data());
      saveLocalState();
    } else {
      await saveState();
    }
  } catch (err) {
    console.error("Erro ao carregar Firebase:", err);
    loadLocalState();
  }

  updateUI();
}

async function saveState() {
  const uid = window.__USER_UID__;
  saveLocalState();
  if (!uid) return;

  const { db } = window.__FIREBASE__;
  const ref = doc(db, "users", uid);

  try {
    await setDoc(ref, state, { merge: true });
  } catch (err) {
    console.error("Erro salvando Firebase:", err);
  }
}

/* ===========================
   REFER√äNCIAS DO DOM
=========================== */
const metaInput = $("#metaInput");
const setMetaBtn = $("#setMetaBtn");
const progressBar = $("#progressBar");
const progressText = $("#progressText");
const metaMessage = $("#metaMessage");

const kmInicialEl = $("#kmInicial");
const kmFinalEl = $("#kmFinal");
const tempoTrabalhado = $("#tempoTrabalhado");
const kmRodados = $("#kmRodados");
const toggleStartBtn = $("#toggleStartBtn");
const finalizeBtn = $("#finalizeBtn");
const saveKmBtn = $("#saveKmBtn");

const valorEntrada = $("#valorEntrada");
const valorSaida = $("#valorSaida");
const lancamentosList = $("#lancamentosList");
const appBtns = $$(".app-btn");
const gastoBtns = $$(".gasto-btn");

const stationButtons = $$("#stationButtons .station-btn");
const radioPlayer = $("#radioPlayer");
const nowPlaying = $("#nowPlaying");
const stopRadioBtn = $("#stopRadioBtn");

const metricGanhosApps = $("#metricGanhosApps");
const metricGanhosTotal = $("#metricGanhosTotal");
const metricGastosTotal = $("#metricGastosTotal");
const metricLucroTotal = $("#metricLucroTotal");
const metricMediaHoraBrutoTotal = $("#metricMediaHoraBrutoTotal");
const metricMediaHoraLiqTotal = $("#metricMediaHoraLiqTotal");
const metricLucroKmTotal = $("#metricLucroKmTotal");
const metricEntradasApps = $("#metricEntradasApps");
const metricEntradasLoja = $("#metricEntradasLoja");

const finalTotalApps = $("#finalTotalApps");
const finalTotalLoja = $("#finalTotalLoja");
const finalTotalDoacao = $("#finalTotalDoacao");
const finalTotalGeral = $("#finalTotalGeral");

const saveAndResetBtn = $("#saveAndResetBtn");
const exportBtn = $("#exportBtn");
const viewHistoryBtn = $("#viewHistoryBtn");
const historyPanel = $("#historyPanel");

const resumoCategorias = $("#resumoCategorias");

const toggleValuesBtn = $("#toggleValuesBtn");

/* ===========================
   BOT√ÉO ESCONDER VALORES
=========================== */
toggleValuesBtn.addEventListener("click", () => {
  state.valuesHidden = !state.valuesHidden;
  saveState();
  updateUI();

  toggleValuesBtn.textContent =
    state.valuesHidden ? "Mostrar Valores" : "Esconder Valores";
});

/* ===========================
   R√ÅDIOS (FUNCIONANDO!)
=========================== */
function setActiveStation(btn) {
  stationButtons.forEach(b => b.classList.remove("active"));
  if (btn) btn.classList.add("active");
}

stationButtons.forEach(btn =>
  btn.addEventListener("click", async () => {
    try {
      radioPlayer.pause();
    } catch {}

    radioPlayer.src = "";
    const url = btn.dataset.src;
    const name = btn.textContent;

    setActiveStation(btn);
    nowPlaying.textContent = "Carregando: " + name;

    try {
      radioPlayer.src = url;
      radioPlayer.load();
      await radioPlayer.play();
      nowPlaying.textContent = "Tocando: " + name;
    } catch (err) {
      nowPlaying.textContent = "Erro ao tocar: " + name;
      setActiveStation(null);
    }
  })
);

stopRadioBtn.addEventListener("click", () => {
  try {
    radioPlayer.pause();
    radioPlayer.removeAttribute("src");
    radioPlayer.load();
  } catch {}
  nowPlaying.textContent = "Nenhuma r√°dio selecionada.";
  setActiveStation(null);
});

/* ===========================
   TIMER + KM
=========================== */
let timerInterval = null;

function getTempoTotal() {
  let t = state.totalTimeWorked || 0;
  if (state.status === "running" && state.lastStartTime) {
    t += Date.now() - state.lastStartTime;
  }
  return t;
}
function getKMRodados() {
  const i = Number(state.kmInicial || 0);
  const f = Number(state.kmFinal || 0);
  return f > i ? f - i : 0;
}

function startTimer() {
  stopTimer();
  if (!state.lastStartTime) state.lastStartTime = Date.now();
  timerInterval = setInterval(() => {
    tempoTrabalhado.textContent = formatTime(getTempoTotal());
    updateDerivedMetrics();
  }, 1000);
}
function stopTimer() {
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = null;
}

toggleStartBtn.addEventListener("click", () => {
  if (state.status === "stopped") {
    state.status = "running";
    state.lastStartTime = Date.now();
    toggleStartBtn.textContent = "Pausar";
    startTimer();
  } else if (state.status === "running") {
    state.totalTimeWorked += Date.now() - state.lastStartTime;
    state.lastStartTime = null;
    state.status = "paused";
    toggleStartBtn.textContent = "Retomar";
    stopTimer();
  } else {
    state.status = "running";
    state.lastStartTime = Date.now();
    toggleStartBtn.textContent = "Pausar";
    startTimer();
  }
  saveState();
  updateUI();
});

finalizeBtn.addEventListener("click", () => {
  if (state.status === "running") {
    state.totalTimeWorked += Date.now() - state.lastStartTime;
    state.lastStartTime = null;
  }
  const tempoFinal = getTempoTotal();
  const kmDia = getKMRodados();

  state.status = "stopped";
  stopTimer();

  state.totalTimeWorked = 0;
  state.lastStartTime = null;

  saveState();
  updateUI();
});

saveKmBtn.addEventListener("click", () => {
  state.kmInicial = Number(kmInicialEl.value) || 0;
  state.kmFinal = Number(kmFinalEl.value) || 0;
  saveState();
  updateUI();
});

/* ===========================
   LAN√áAMENTOS
=========================== */
function addLancamento({ type, value, category }) {
  const item = {
    id: uid(),
    type,
    value: Number(value),
    category,
    date: new Date().toISOString()
  };

  if (type === "ganho") {
    if (category === "Loja") {
      state.ganhosLoja += item.value;
      state.entradasLoja++;
    } else if (category === "Doa√ß√£o") {
      state.totalDoacao += item.value;
    } else {
      state.ganhosApps += item.value;
      state.entradasApps++;
    }
  } else {
    state.gastos += item.value;
  }

  state.history.unshift(item);
  saveState();
  updateUI();

  valorEntrada.value = "";
  valorSaida.value = "";
}

$("#addEntradaBtn").addEventListener("click", () => {
  const v = Number(valorEntrada.value);
  if (v > 0) addLancamento({ type: "ganho", value: v, category: "Particular" });
});

$("#addSaidaBtn").addEventListener("click", () => {
  const v = Number(valorSaida.value);
  if (v > 0) addLancamento({ type: "gasto", value: v, category: "Outros" });
});

appBtns.forEach(b =>
  b.addEventListener("click", () => {
    const v = Number(valorEntrada.value);
    if (v > 0)
      addLancamento({
        type: "ganho",
        value: v,
        category: b.dataset.cat
      });
  })
);

gastoBtns.forEach(b =>
  b.addEventListener("click", () => {
    const v = Number(valorSaida.value);
    if (v > 0)
      addLancamento({
        type: "gasto",
        value: v,
        category: b.dataset.cat
      });
  })
);

/* ===========================
   RENDER LAN√áAMENTOS
=========================== */
function renderLancamentos() {
  if (!state.history.length) {
    lancamentosList.innerHTML =
      '<div class="muted small text-center">Nenhum lan√ßamento ainda.</div>';
    return;
  }

  lancamentosList.innerHTML = "";

  state.history.slice(0, 200).forEach(it => {
    const div = document.createElement("div");
    div.className = "launch-item";

    const valueClass = state.valuesHidden ? "hidden-value" : "";

    div.innerHTML = `
      <div style="font-weight:800">
        ${it.category}: ${it.type === "ganho" ? "+" : "-"}
        <span class="${valueClass}">${formatBRL(it.value)}</span>
      </div>

      <div>
        <button class="btn-ghost edit-btn">‚úèÔ∏è</button>
        <button class="btn-ghost del-btn">üóëÔ∏è</button>
      </div>
    `;

    const edit = div.querySelector(".edit-btn");
    const del = div.querySelector(".del-btn");

    edit.onclick = () => {
      const novo = Number(prompt("Novo valor:", it.value));
      if (!novo) return;

      // desfaz
      if (it.type === "ganho") {
        if (it.category === "Loja") state.ganhosLoja -= it.value;
        else if (it.category === "Doa√ß√£o") state.totalDoacao -= it.value;
        else state.ganhosApps -= it.value;
      } else state.gastos -= it.value;

      it.value = novo;

      // refaz
      if (it.type === "ganho") {
        if (it.category === "Loja") state.ganhosLoja += it.value;
        else if (it.category === "Doa√ß√£o") state.totalDoacao += it.value;
        else state.ganhosApps += it.value;
      } else state.gastos += it.value;

      saveState();
      updateUI();
    };

    del.onclick = () => {
      if (!confirm("Excluir lan√ßamento?")) return;
      state.history = state.history.filter(x => x.id !== it.id);
      recalcTotals();
      saveState();
      updateUI();
    };

    lancamentosList.appendChild(div);
  });
}

/* ===========================
   RECALC TOTALS
=========================== */
function recalcTotals() {
  state.ganhosApps = 0;
  state.ganhosLoja = 0;
  state.totalDoacao = 0;
  state.gastos = 0;
  state.entradasApps = 0;
  state.entradasLoja = 0;

  state.history.forEach(it => {
    if (it.type === "ganho") {
      if (it.category === "Loja") {
        state.ganhosLoja += it.value;
        state.entradasLoja++;
      } else if (it.category === "Doa√ß√£o") {
        state.totalDoacao += it.value;
      } else {
        state.ganhosApps += it.value;
        state.entradasApps++;
      }
    } else {
      state.gastos += it.value;
    }
  });
}

/* ===========================
   RESUMO CATEGORIAS
=========================== */
function renderResumoCategorias() {
  const totals = {};
  const counts = {};

  state.history.forEach(it => {
    if (it.type !== "ganho") return;
    const cat = it.category;
    totals[cat] = (totals[cat] || 0) + it.value;
    counts[cat] = (counts[cat] || 0) + 1;
  });

  resumoCategorias.innerHTML = "";

  const order = ["Uber", "99", "inDriver", "Particular", "Loja", "Doa√ß√£o"];

  const valueClass = state.valuesHidden ? "hidden-value" : "";

  order.forEach(cat => {
    const v = totals[cat] || 0;
    const c = counts[cat] || 0;

    const div = document.createElement("div");
    div.innerHTML = `
      <div style="font-weight:900">${cat}</div>
      <div class="${valueClass}" style="font-weight:800">${formatBRL(v)}</div>
      <div class="small muted"><span class="${valueClass}">${c}</span> entr.</div>
    `;
    resumoCategorias.appendChild(div);
  });
}

/* ===========================
   M√âTRICAS
=========================== */
function updateDerivedMetrics() {
  const totalBruto =
    state.ganhosApps + state.ganhosLoja + state.totalDoacao;
  const lucro = totalBruto - state.gastos;
  const tempo = getTempoTotal();
  const horas = tempo / (1000 * 60 * 60);
  const mediaBruto = horas > 0 ? totalBruto / horas : 0;
  const mediaLiq = horas > 0 ? lucro / horas : 0;
  const lucroKm =
    getKMRodados() > 0 ? lucro / getKMRodados() : 0;

  metricGanhosApps.textContent = formatBRL(state.ganhosApps);
  metricGanhosTotal.textContent = formatBRL(totalBruto);
  metricGastosTotal.textContent = formatBRL(state.gastos);
  metricLucroTotal.textContent = formatBRL(lucro);
  metricMediaHoraBrutoTotal.textContent = formatBRL(mediaBruto);
  metricMediaHoraLiqTotal.textContent = formatBRL(mediaLiq);
  metricLucroKmTotal.textContent = formatBRL(lucroKm);
  metricEntradasApps.textContent = state.entradasApps;
  metricEntradasLoja.textContent = state.entradasLoja;

  finalTotalApps.textContent = formatBRL(state.ganhosApps);
  finalTotalLoja.textContent = formatBRL(state.ganhosLoja);
  finalTotalDoacao.textContent = formatBRL(state.totalDoacao);
  finalTotalGeral.textContent = formatBRL(lucro);

  updateProgressBar();
}

/* ===========================
   PROGRESS BAR + CELEBRA√á√ÉO
=========================== */
function updateProgressBar() {
  const meta = state.meta;
  const atual = state.ganhosApps + state.ganhosLoja;

  if (meta <= 0) {
    progressBar.style.width = "0%";
    progressText.textContent = "0%";
    return;
  }

  const pct = Math.min(100, (atual / meta) * 100);
  progressBar.style.width = pct + "%";
  progressText.textContent = Math.round(pct) + "%";

  if (atual >= meta && !state.celebrated) celebrate();
}

/* ===========================
   SALVAR RESUMO DO DIA
=========================== */
saveAndResetBtn.addEventListener("click", async () => {
  const resumo = {
    id: new Date().toISOString(),
    date: new Date().toISOString(),
    meta: state.meta,
    kmInicial: state.kmInicial,
    kmFinal: state.kmFinal,
    ganhosApps: state.ganhosApps,
    ganhosLoja: state.ganhosLoja,
    doacao: state.totalDoacao,
    entradasApps: state.entradasApps,
    entradasLoja: state.entradasLoja,
    gastos: state.gastos,
    lucro: state.ganhosApps + state.ganhosLoja + state.totalDoacao - state.gastos,
    tempo: state.totalTimeWorked,
    km: state.kmFinal - state.kmInicial
  };

  state.savedDays.unshift(resumo);

  saveState();

  alert("Resumo salvo!");

  // reset parcial
  localStorage.removeItem("maxrota_state");
  location.reload();
});

/* ===========================
   EXPORT JSON
=========================== */
exportBtn.addEventListener("click", () => {
  const blob = new Blob(
    [JSON.stringify(state, null, 2)],
    { type: "application/json" }
  );
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "maxrota_export.json";
  a.click();
});

/* ===========================
   UPDATE UI
=========================== */
function updateUI() {
  // meta
  metaInput.value = state.meta || "";

  kmInicialEl.value = state.kmInicial || "";
  kmFinalEl.value = state.kmFinal || "";

  tempoTrabalhado.textContent = formatTime(getTempoTotal());
  kmRodados.textContent = formatKM(getKMRodados());

  renderLancamentos();
  renderResumoCategorias();
  updateDerivedMetrics();
}

/* ===========================
   CARREGAR ESTADO INICIAL
=========================== */
loadLocalState();
updateUI();

window.loadState = loadState;
</script>

<!-- ===========================================
          FIREBASE CORE
===========================================-->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBXkQlm0TbCsCdVGil8-5kGWbtj07SKXwA",
  authDomain: "maxrota.firebaseapp.com",
  projectId: "maxrota",
  storageBucket: "maxrota.firebasestorage.app",
  messagingSenderId: "425002957978",
  appId: "1:425002957978:web:1e4f38239e552de452f323",
  measurementId: "G-RBK7LM483D"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

window.__FIREBASE__ = { auth, db };
window.auth = auth;
</script>

<!-- ===========================================
          AUTH GUARD
===========================================-->
<script type="module">
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

onAuthStateChanged(window.auth, user => {
  if (!user) {
    location.href = "login.html";
    return;
  }
  window.__USER_UID__ = user.uid;
  window.loadState();
});
</script>

<!-- ===========================================
          LOGOUT
===========================================-->
<script type="module">
import { signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

window.logout = async () => {
  await signOut(window.auth);
  location.href = "login.html";
};
</script>

<!-- ===========================================
          SYNC A CADA 15s
===========================================-->
<script type="module">
setInterval(() => {
  if (window.__USER_UID__) window.loadState();
}, 15000);
</script>

</body>
</html>
