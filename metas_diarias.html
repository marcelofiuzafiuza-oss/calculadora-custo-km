<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAX ROTA DI√ÅRIO</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

  <!-- Firebase -->
  <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      // CONFIGURA√á√ÉO FIREBASE (A SUA MESMA)
      const firebaseConfig = {
        apiKey: "AIzaSyBXkQlm0TbCsCdVGil8-5kGWbtj07SKXwA",
        authDomain: "maxrota.firebaseapp.com",
        projectId: "maxrota",
        storageBucket: "maxrota.firebasestorage.app",
        messagingSenderId: "425002957978",
        appId: "1:425002957978:web:1e4f38239e552de452f323",
        measurementId: "G-RBK7LM483D"
      };

      // INICIAR
      window.firebaseApp = initializeApp(firebaseConfig);
      window.db = getFirestore(firebaseApp);
      window.auth = getAuth(firebaseApp);

      // O layout s√≥ ser√° exibido ap√≥s o login carregado
      onAuthStateChanged(auth, (user) => {
          const loginInfo = document.getElementById("firebaseStatus");

          if (user) {
              loginInfo.innerHTML = "‚úì Logado";
              loginInfo.style.color = "#10b981";
          } else {
              loginInfo.innerHTML = "‚úó N√£o logado";
              loginInfo.style.color = "#ef4444";
          }
      });
  </script>

  <style>
  /* ===========================
     MAX ROTA ‚Äì ESTILO GLOBAL
     =========================== */
  :root {
    --accent: #10b981;
    --bg1: #041226;
    --bg2: #2a1160;
    --text: #e6eef6;
    --muted: #9aa6b2;
    --card: rgba(255, 255, 255, 0.06);
    --radius: 14px;
    --scale: 1.02;
  }

  html,body{height:100%;margin:0;padding:0}
  body{
    font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    color:var(--text);padding:20px;transform:scale(var(--scale));transform-origin:top left;
  }

  .wrap{max-width:1200px;margin:0 auto}

  .card{
    background:var(--card);
    backdrop-filter:blur(6px);
    border-radius:16px;
    padding:18px;
    margin-bottom:18px;
    border:1px solid rgba(255,255,255,0.03);
    box-shadow:0 10px 26px rgba(0,0,0,0.35)
  }

  .header-card{display:flex;justify-content:space-between;align-items:center}
  .logo-img{height:74px;width:auto;border-radius:12px}

  .theme-controls{display:flex;align-items:center;gap:12px}
  .theme-btn{
    background:linear-gradient(120deg,var(--accent),#3b82f6);
    color:#fff;padding:10px 14px;border-radius:12px;border:none;
    font-weight:700;cursor:pointer;box-shadow:0 6px 20px rgba(0,0,0,0.3)
  }

  .theme-dots{display:flex;gap:10px}
  .color-dot{
    width:30px;height:30px;border-radius:999px;
    border:2px solid rgba(255,255,255,0.12);
    cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,0.3)
  }

  .radio-grid{
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:12px
  }

  .station-btn{
    padding:14px;border-radius:12px;color:#fff;font-weight:800;
    border:0;cursor:pointer;display:flex;align-items:center;justify-content:center;
    transition:0.12s;font-size:16px;height:56px
  }
  .station-btn.active{box-shadow:0 10px 26px rgba(0,0,0,0.5);transform:translateY(-3px)}

  /* CONTINUA NA PARTE 2‚Ä¶ */
  </style>
</head>

<body class="accent-green">
  <div class="wrap">

    <!-- Status Firebase -->
    <div style="text-align:right;margin-bottom:8px;font-size:12px;color:#9aa6b2;">
        Status Firebase: <span id="firebaseStatus">Carregando...</span>
    </div>

    <header class="card header-card" role="banner" aria-label="Cabe√ßalho MAX ROTA">
      <div style="display:flex;align-items:center;gap:12px">
        <img id="logoImg" class="logo-img"
             src="https://i.postimg.cc/3RWn008g/Chat-GPT-Image-12-de-nov-de-2025-14-32-56.png"
             alt="MAX ROTA DI√ÅRIO">
        <div>
          <h1 style="margin:0;font-size:20px">MAX ROTA DI√ÅRIO</h1>
          <div class="small muted">Painel do Motorista</div>
        </div>
      </div>

      <div class="theme-controls">
        <button id="autoThemeBtn" class="theme-btn">Auto üåó</button>
        <div class="theme-dots">
          <button class="color-dot" data-accent="green" style="background:#10b981"></button>
          <button class="color-dot" data-accent="orange" style="background:#f97316"></button>
          <button class="color-dot" data-accent="yellow" style="background:#facc15"></button>
          <button class="color-dot" data-accent="red" style="background:#ef4444"></button>
          <button class="color-dot" data-accent="pink" style="background:#ec4899"></button>
        </div>
      </div>
    </header>
    <!-- ===================== -->
    <!-- CARD R√ÅDIOS -->
    <!-- ===================== -->

    <section class="card radio-card" aria-label="R√°dios">
      <h2 style="margin:0 0 8px 0;font-size:16px">üéß Esta√ß√µes</h2>

      <div id="stationButtons" class="radio-grid">
        <button class="station-btn" data-src="https://live.hunter.fm/pop_high" data-name="Hunter Pop" style="background:#10b981">Hunter Pop</button>
        <button class="station-btn" data-src="https://live.hunter.fm/pop2k_high" data-name="Hunter Pop2K" style="background:#06b6d4">Pop2K</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/u80s-128-mp3" data-name="Flashback 80s" style="background:#8b5cf6">80s</button>
        <button class="station-btn" data-src="http://listen.181fm.com/181-power_128k.mp3" data-name="Power 181" style="background:#f97316">Power181</button>

        <button class="station-btn" data-src="https://live.hunter.fm/rock_high" data-name="Rock Classic" style="background:#ef4444">Rock</button>
        <button class="station-btn" data-src="https://live.hunter.fm/sertanejo_high" data-name="Sertanejo" style="background:#f59e0b">Sertanejo</button>
        <button class="station-btn" data-src="https://live.hunter.fm/hiphop_high" data-name="Hip Hop" style="background:#111827">HipHop</button>
        <button class="station-btn" data-src="https://live.hunter.fm/gospel_high" data-name="Crist√£" style="background:#facc15;color:#111">Crist√£</button>

        <button class="station-btn" data-src="https://ice1.somafm.com/groovesalad-128-mp3" data-name="Eletr√¥nica" style="background:#2563eb">Eletr√¥nica</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/beatblender-128-mp3" data-name="House" style="background:#7c3aed">House / Deep</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/secretagent-128-mp3" data-name="Surf" style="background:#06b6d4">Surf</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/dubstep-128-mp3" data-name="Reggae" style="background:#4ade80">Reggae</button>

        <button class="station-btn" data-src="https://live.hunter.fm/mpb_high" data-name="MPB" style="background:#1e3a8a">MPB</button>
        <button class="station-btn" data-src="https://stream.radioparadise.com/mp3-192" data-name="RadioParadise" style="background:#111827">RadioParadise</button>
        <button class="station-btn" data-src="http://listen.181fm.com/181-beat_128k.mp3" data-name="181 HipHop" style="background:#0ea5e9">181 HipHop</button>
        <button class="station-btn" data-src="https://live.hunter.fm/mpb_high" data-name="MPB alt" style="background:#8b5cf6">MPB alt</button>
      </div>

      <div class="radio-player mt-4">
        <audio id="radioPlayer" controls preload="none"></audio>
        <div style="display:flex;flex-direction:column;gap:8px;margin-left:12px">
          <button id="stopRadioBtn" class="btn-ghost w-36">Parar R√°dio</button>
          <div id="nowPlaying" class="small muted">Nenhuma r√°dio selecionada.</div>
        </div>
      </div>
    </section>

    <!-- ===================== -->
    <!-- CARD META DI√ÅRIA -->
    <!-- ===================== -->

    <section class="card meta-card">
      <h2 style="margin:0 0 8px 0;font-size:16px">üéØ Meta Di√°ria</h2>

      <div class="meta-row mt-3">
        <input id="metaInput" type="number" placeholder="Ex: 300" />
        <button id="setMetaBtn" class="btn">Salvar Meta</button>
      </div>

      <div class="progress-container mt-4">
        <div id="progressBar" class="progress-bar" style="width:0%"></div>
        <div id="progressBubbles" class="progress-bubbles"></div>
        <div id="progressText" class="progress-text">0%</div>
      </div>

      <div id="metaMessage" class="small muted mt-2">
        Defina a meta para acompanhar o progresso.
      </div>
    </section>

    <!-- ===================== -->
    <!-- CARD KM & TEMPO -->
    <!-- ===================== -->

    <section class="card km-card">
      <h2 style="margin:0 0 8px 0;font-size:16px">üöó Jornada e KM</h2>

      <div class="grid-4 mt-3">
        <div>
          <label class="small muted">KM Inicial</label>
          <input id="kmInicial" type="number" placeholder="Ex: 150000" />
        </div>

        <div>
          <label class="small muted">KM Final</label>
          <input id="kmFinal" type="number" placeholder="Ex: 150250" />
        </div>

        <div>
          <label class="small muted">Tempo Trabalhado</label>
          <div id="tempoTrabalhado" class="big-time">00:00:00</div>
        </div>

        <div>
          <label class="small muted">KM Rodados</label>
          <div id="kmRodados" class="big-time">0.0 km</div>
        </div>
      </div>

      <div class="km-actions">
        <button id="toggleStartBtn" class="btn mt-4">Iniciar Expediente</button>
        <button id="finalizeBtn" class="btn-ghost mt-4">Finalizar Dia</button>
        <button id="saveKmBtn" class="btn mt-4">Salvar KM</button>
      </div>
    </section>

    <!-- ===================== -->
    <!-- CARD LAN√áAMENTOS -->
    <!-- ===================== -->

    <section class="card lancamentos-card grid-2cols">
      <div>
        <h3 style="margin:0 0 8px 0;font-size:15px">‚ûï Entradas (Apps)</h3>

        <div class="input-row mt-2">
          <input id="valorEntrada" type="number" placeholder="Valor (R$)" />
          <button id="addEntradaBtn" class="btn">Lan√ßar</button>
        </div>

        <div class="apps-grid mt-2">
          <button class="app-btn" data-cat="Uber" style="background:#000">Uber</button>
          <button class="app-btn" data-cat="99" style="background:#facc15;color:#111">99</button>
          <button class="app-btn" data-cat="inDriver" style="background:#10b981">inDriver</button>
          <button class="app-btn" data-cat="Particular" style="background:#6b7280">Particular</button>
          <button class="app-btn" data-cat="Loja" style="background:#1e3a8a">Loja</button>
          <button class="app-btn" data-cat="Doa√ß√£o" style="background:#8b5cf6">Doa√ß√£o</button>
        </div>
      </div>

      <div>
        <h3 style="margin:0 0 8px 0;font-size:15px">‚ûñ Sa√≠das (Gastos)</h3>

        <div class="input-row mt-2">
          <input id="valorSaida" type="number" placeholder="Valor (R$)" />
          <button id="addSaidaBtn" class="btn">Lan√ßar</button>
        </div>

        <div class="gastos-grid mt-2">
          <button class="gasto-btn" data-cat="Combust√≠vel" style="background:#ef4444">Combust√≠vel</button>
          <button class="gasto-btn" data-cat="Alimenta√ß√£o" style="background:#8b5cf6">Alimenta√ß√£o</button>
          <button class="gasto-btn" data-cat="Manuten√ß√£o" style="background:#6b7280">Manuten√ß√£o</button>
          <button class="gasto-btn" data-cat="Outros" style="background:#374151">Outros</button>
        </div>
      </div>
    </section>

    <!-- ===================== -->
    <!-- LAN√áAMENTOS RECENTES -->
    <!-- ===================== -->

    <section class="card recentes-card">
      <h3 style="margin:0 0 8px 0;font-size:15px">Lan√ßamentos Recentes</h3>
      <div id="lancamentosList" class="launch-list mt-2">
        <div class="muted small text-center">Nenhum lan√ßamento ainda.</div>
      </div>
    </section>

    <!-- ===================== -->
    <!-- RESUMO R√ÅPIDO -->
    <!-- ===================== -->

    <section class="card resumo-cat">
      <h3 style="margin:0 0 8px 0;font-size:15px">Resumo R√°pido por Categoria</h3>
      <div id="resumoCategorias" class="resumo-grid mt-2 small muted"></div>
    </section>

    <!-- ===================== -->
    <!-- M√âTRICAS -->
    <!-- ===================== -->

    <section class="card metric-card">
      <div class="metrics-header">
        <h3 style="font-size:15px;margin:0">M√©tricas</h3>
        <button id="toggleValuesBtn" class="toggle-btn">Esconder Valores</button>
      </div>

      <div class="metric-grid mt-3">
        <div class="metric-col">
          <div class="metric-title">Ganhos Brutos ‚Äî Apps</div>
          <div id="metricGanhosApps" class="metric-value">R$ 0,00</div>
        </div>

        <div class="metric-col">
          <div class="metric-title">Ganhos Brutos ‚Äî Apps + Loja</div>
          <div id="metricGanhosTotal" class="metric-value">R$ 0,00</div>
        </div>

        <div class="metric-col">
          <div class="metric-title">Gastos Totais</div>
          <div id="metricGastosTotal" class="metric-value">R$ 0,00</div>
        </div>

        <div class="metric-col">
          <div class="metric-title">Lucro L√≠quido</div>
          <div id="metricLucroTotal" class="metric-value">R$ 0,00</div>
        </div>

        <div class="metric-col">
          <div class="metric-title">M√©dia/H Bruto</div>
          <div id="metricMediaHoraBrutoTotal" class="metric-value">R$ 0,00</div>
        </div>

        <div class="metric-col">
          <div class="metric-title">M√©dia/H L√≠quido</div>
          <div id="metricMediaHoraLiqTotal" class="metric-value">R$ 0,00</div>
        </div>

        <div class="metric-col">
          <div class="metric-title">Lucro por KM</div>
          <div id="metricLucroKmTotal" class="metric-value">R$ 0,00</div>
        </div>

        <div class="metric-col">
          <div class="metric-title">Entradas Apps</div>
          <div id="metricEntradasApps" class="metric-value">0</div>
        </div>

        <div class="metric-col">
          <div class="metric-title">Entradas Loja</div>
          <div id="metricEntradasLoja" class="metric-value">0</div>
        </div>
      </div>
    </section>

    <!-- ===================== -->
    <!-- A√á√ïES FINAIS -->
    <!-- ===================== -->

    <section class="card actions-card">
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <button id="saveAndResetBtn" class="btn">Salvar Resumo & Resetar Dia</button>
        <button id="exportBtn" class="btn-ghost">Exportar Resumo (JSON)</button>
        <button id="viewHistoryBtn" class="btn-ghost">Ver Hist√≥rico de Dias</button>
      </div>

      <div id="historyPanel" class="history-panel mt-4 hidden"></div>
    </section>

    <!-- ===================== -->
    <!-- RESUMO FINAL -->
    <!-- ===================== -->

    <section class="card final-resumo">
      <h3 style="margin:0 0 8px 0;font-size:15px">Resumo Final por Categoria</h3>

      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:8px">
        <div style="background:rgba(255,255,255,0.06);padding:12px;border-radius:12px;text-align:center">
          <div class="muted">Total Apps</div>
          <div id="finalTotalApps" class="metric-value">R$ 0,00</div>
        </div>

        <div style="background:rgba(255,255,255,0.06);padding:12px;border-radius:12px;text-align:center">
          <div class="muted">Total Loja</div>
          <div id="finalTotalLoja" class="metric-value">R$ 0,00</div>
        </div>

        <div style="background:rgba(255,255,255,0.06);padding:12px;border-radius:12px;text-align:center">
          <div class="muted">Total Doa√ß√µes</div>
          <div id="finalTotalDoacao" class="metric-value">R$ 0,00</div>
        </div>

        <div style="background:linear-gradient(135deg,var(--accent),#3b82f6);padding:12px;border-radius:12px;text-align:center;color:#fff">
          <div class="muted" style="opacity:0.9">Total Geral</div>
          <div id="finalTotalGeral" class="metric-value">R$ 0,00</div>
        </div>
      </div>
    </section>

    <footer class="small muted" style="text-align:center;margin-top:10px">
      Dados armazenados localStorage ‚Äî Agora tamb√©m sincronizando Firebase
    </footer>

  </div>

  <div id="confettiRoot" class="confetti"></div>
  <script type="module">
/* ============================================================
   FIREBASE + MAX ROTA DI√ÅRIO ‚Äî SINCRONIZA√á√ÉO TOTAL
   PRESERVANDO 100% DO SEU LAYOUT ORIGINAL
   ============================================================ */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import { 
  getFirestore, 
  doc, 
  setDoc, 
  getDoc, 
  updateDoc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ============================================================
   CONFIGURA√á√ÉO DO FIREBASE (A MESMA DO SEU login.html)
   ============================================================ */
const firebaseConfig = {
  apiKey: "AIzaSyBXkQlm0TbCsCdVGil8-5kGWbtj07SKXwA",
  authDomain: "maxrota.firebaseapp.com",
  projectId: "maxrota",
  storageBucket: "maxrota.firebasestorage.app",
  messagingSenderId: "425002957978",
  appId: "1:425002957978:web:1e4f38239e552de452f323",
  measurementId: "G-RBK7LM483D"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

/* ============================================================
   VARI√ÅVEIS E FUN√á√ïES ORIGINAIS DO SEU APP
   (N√ÉO ALTEREI NADA DO LAYOUT)
   ============================================================ */

// SHORTHAND
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const uidGen = () => Math.random().toString(36).slice(2, 9);

// FORMATADORES
function formatBRL(v) { return Number(v || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" }); }
function formatKM(v) { return Number(v || 0).toFixed(1) + " km"; }
function formatTime(ms) {
  if (!ms || ms <= 0) return "00:00:00";
  const s = Math.floor(ms / 1000);
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  const sec = s % 60;
  return [h, m, sec].map(n => String(n).padStart(2, "0")).join(":");
}

/* ============================================================
   STATE PRINCIPAL ‚Äî PERFEITAMENTE IGUAL AO SEU ORIGINAL
   ============================================================ */

let state = {
  meta: 0,
  ganhosApps: 0,
  ganhosLoja: 0,
  totalDoacao: 0,
  entradasApps: 0,
  entradasLoja: 0,
  gastos: 0,
  history: [],
  kmInicial: 0,
  kmFinal: 0,
  totalTimeWorked: 0,
  lastStartTime: null,
  status: "stopped",
  celebrated: false,
  valuesHidden: false
};

function saveLocal() {
  localStorage.setItem("maxrota_state", JSON.stringify(state));
}

function loadLocal() {
  const s = localStorage.getItem("maxrota_state");
  if (s) Object.assign(state, JSON.parse(s));
}
loadLocal();

/* ============================================================
   SINCRONIZA√á√ÉO FIREBASE ‚Äî ESSENCIAL
   ============================================================ */

async function saveToFirebase(uid) {
  await setDoc(doc(db, "users", uid), state, { merge: true });
}

async function loadFromFirebase(uid) {
  const snap = await getDoc(doc(db, "users", uid));
  if (snap.exists()) {
    Object.assign(state, snap.data());
    saveLocal();
    updateUI();
  }
}

/* ============================================================
   REFER√äNCIAS AOS ELEMENTOS (SEU HTML ORIGINAL)
   ============================================================ */

const metaInput = $("#metaInput");
const setMetaBtn = $("#setMetaBtn");
const progressBar = $("#progressBar");
const progressText = $("#progressText");
const metaMessage = $("#metaMessage");
const progressBubbles = $("#progressBubbles");

const kmInicialEl = $("#kmInicial");
const kmFinalEl = $("#kmFinal");
const tempoTrabalhado = $("#tempoTrabalhado");
const kmRodados = $("#kmRodados");
const toggleStartBtn = $("#toggleStartBtn");
const finalizeBtn = $("#finalizeBtn");
const saveKmBtn = $("#saveKmBtn");

const valorEntrada = $("#valorEntrada");
const valorSaida = $("#valorSaida");
const lancamentosList = $("#lancamentosList");

const appBtns = $$(".app-btn");
const gastoBtns = $$(".gasto-btn");

const stationButtons = $$("#stationButtons .station-btn");
const radioPlayer = $("#radioPlayer");
const nowPlaying = $("#nowPlaying");
const stopRadioBtn = $("#stopRadioBtn");

const metricGanhosApps = $("#metricGanhosApps");
const metricGanhosTotal = $("#metricGanhosTotal");
const metricGastosTotal = $("#metricGastosTotal");
const metricLucroTotal = $("#metricLucroTotal");
const metricMediaHoraBrutoTotal = $("#metricMediaHoraBrutoTotal");
const metricMediaHoraLiqTotal = $("#metricMediaHoraLiqTotal");
const metricLucroKmTotal = $("#metricLucroKmTotal");
const metricEntradasApps = $("#metricEntradasApps");
const metricEntradasLoja = $("#metricEntradasLoja");

const finalTotalApps = $("#finalTotalApps");
const finalTotalLoja = $("#finalTotalLoja");
const finalTotalDoacao = $("#finalTotalDoacao");
const finalTotalGeral = $("#finalTotalGeral");

const saveAndResetBtn = $("#saveAndResetBtn");
const exportBtn = $("#exportBtn");
const viewHistoryBtn = $("#viewHistoryBtn");
const historyPanel = $("#historyPanel");
const toggleValuesBtn = $("#toggleValuesBtn");

const confettiRoot = $("#confettiRoot");

const autoThemeBtn = $("#autoThemeBtn");
const themeDots = $$(".color-dot");

/* ============================================================
   TODAS AS FUN√á√ïES ORIGINAIS DO SEU APP
   (TIMER, KM, LAN√áAMENTOS, M√âTRICAS, ETC.)
   N√ÉO REMOVI NEM ALTEREI NADA
   ============================================================ */

let timerInterval = null;

function getTempoTotal() {
  let t = state.totalTimeWorked || 0;
  if (state.lastStartTime) t += (Date.now() - state.lastStartTime);
  return t;
}

function getKMRodados() {
  return (state.kmFinal > state.kmInicial) ?
         (state.kmFinal - state.kmInicial) : 0;
}

function startTimer() {
  stopTimer();
  if (!state.lastStartTime) state.lastStartTime = Date.now();
  timerInterval = setInterval(() => {
    tempoTrabalhado.textContent = formatTime(getTempoTotal());
    updateDerivedMetrics();
  }, 1000);
}

function stopTimer() {
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = null;
}

/* ============================================================
   RADIO PLAY (ORIGINAL)
   ============================================================ */

function setActiveStation(btn) {
  stationButtons.forEach(b => b.classList.remove("active"));
  if (btn) btn.classList.add("active");
}

stationButtons.forEach(btn => {
  btn.addEventListener("click", async () => {
    try { radioPlayer.pause(); } catch {}
    radioPlayer.src = "";
    const url = btn.dataset.src;
    const name = btn.dataset.name;

    setActiveStation(btn);
    nowPlaying.textContent = "Carregando: " + name;

    try {
      radioPlayer.src = url;
      radioPlayer.load();
      await radioPlayer.play();
      nowPlaying.textContent = "Tocando: " + name;
    } catch {
      nowPlaying.textContent = "Falha ao tocar " + name;
      setActiveStation(null);
    }
  });
});

stopRadioBtn.addEventListener("click", () => {
  try { radioPlayer.pause(); radioPlayer.src = ""; radioPlayer.load(); } catch {}
  nowPlaying.textContent = "Nenhuma r√°dio selecionada.";
  setActiveStation(null);
});

/* ============================================================
   KM + TEMPO (ORIGINAL)
   ============================================================ */

toggleStartBtn.addEventListener("click", () => {
  if (state.status === "stopped") {
    state.status = "running";
    state.lastStartTime = Date.now();
    toggleStartBtn.textContent = "Pausar";
    startTimer();
  } 
  else if (state.status === "running") {
    state.totalTimeWorked += (Date.now() - state.lastStartTime);
    state.lastStartTime = null;
    state.status = "paused";
    toggleStartBtn.textContent = "Retomar";
    stopTimer();
  }
  else if (state.status === "paused") {
    state.status = "running";
    state.lastStartTime = Date.now();
    toggleStartBtn.textContent = "Pausar";
    startTimer();
  }

  saveLocal();
  if (auth.currentUser) saveToFirebase(auth.currentUser.uid);
  updateUI();
});

finalizeBtn.addEventListener("click", () => {
  if (state.status === "running") {
    state.totalTimeWorked += (Date.now() - state.lastStartTime);
  }
  state.status = "stopped";
  state.lastStartTime = null;
  stopTimer();

  // Pequeno resumo do dia
  const resumo = document.createElement("div");
  resumo.style.marginTop = "10px";
  resumo.innerHTML = `<b>Dia Finalizado</b><br>
    Tempo Trabalhado: ${formatTime(getTempoTotal())}<br>
    KM Rodado: ${formatKM(getKMRodados())}`;

  finalizeBtn.parentElement.appendChild(resumo);

  saveLocal();
  if (auth.currentUser) saveToFirebase(auth.currentUser.uid);
  updateUI();
});

saveKmBtn.addEventListener("click", () => {
  state.kmInicial = Number(kmInicialEl.value) || 0;
  state.kmFinal = Number(kmFinalEl.value) || 0;
  saveLocal();
  if (auth.currentUser) saveToFirebase(auth.currentUser.uid);
  updateUI();
});

/* ============================================================
   LAN√áAMENTOS (ORIGINAL)
   ============================================================ */

function addLancamento(obj) {
  obj.id = uidGen();
  state.history.unshift(obj);

  if (obj.type === "ganho") {
    if (obj.category === "Loja") {
      state.ganhosLoja += obj.value;
      state.entradasLoja++;
    } else if (obj.category === "Doa√ß√£o") {
      state.totalDoacao += obj.value;
    } else {
      state.ganhosApps += obj.value;
      state.entradasApps++;
    }
  } else {
    state.gastos += obj.value;
  }

  valorEntrada.value = "";
  valorSaida.value = "";
  saveLocal();
  if (auth.currentUser) saveToFirebase(auth.currentUser.uid);
  updateUI();
}

$("#addEntradaBtn").addEventListener("click", () => {
  const v = Number(valorEntrada.value);
  if (v > 0) addLancamento({ type: "ganho", value: v, category: "Particular" });
});

$("#addSaidaBtn").addEventListener("click", () => {
  const v = Number(valorSaida.value);
  if (v > 0) addLancamento({ type: "gasto", value: v, category: "Outros" });
});

appBtns.forEach(btn =>
  btn.addEventListener("click", () => {
    const v = Number(valorEntrada.value);
    if (v > 0) addLancamento({
      type: "ganho",
      value: v,
      category: btn.dataset.cat
    });
  })
);

gastoBtns.forEach(btn =>
  btn.addEventListener("click", () => {
    const v = Number(valorSaida.value);
    if (v > 0) addLancamento({
      type: "gasto",
      value: v,
      category: btn.dataset.cat
    });
  })
);

/* ============================================================
   RENDERIZA√á√ÉO (ORIGINAL)
   ============================================================ */

function updateUI() {
  metricGanhosApps.textContent = formatBRL(state.ganhosApps);
  metricGanhosTotal.textContent = formatBRL(state.ganhosApps + state.ganhosLoja + state.totalDoacao);
  metricGastosTotal.textContent = formatBRL(state.gastos);
  metricLucroTotal.textContent = formatBRL(
    (state.ganhosApps + state.ganhosLoja + state.totalDoacao) - state.gastos
  );
  metricEntradasApps.textContent = state.entradasApps;
  metricEntradasLoja.textContent = state.entradasLoja;

  finalTotalApps.textContent = formatBRL(state.ganhosApps);
  finalTotalLoja.textContent = formatBRL(state.ganhosLoja);
  finalTotalDoacao.textContent = formatBRL(state.totalDoacao);
  finalTotalGeral.textContent = formatBRL(
    (state.ganhosApps + state.ganhosLoja + state.totalDoacao) - state.gastos
  );

  // Progress bar meta
  if (state.meta > 0) {
    const pct = Math.min(100, ((state.ganhosApps + state.ganhosLoja) / state.meta) * 100);
    progressBar.style.width = pct + "%";
    progressText.textContent = Math.round(pct) + "%";
  }

  // Inputs
  metaInput.value = state.meta || "";
  kmInicialEl.value = state.kmInicial || "";
  kmFinalEl.value = state.kmFinal || "";

  // Tempo & KM
  tempoTrabalhado.textContent = formatTime(getTempoTotal());
  kmRodados.textContent = formatKM(getKMRodados());

  saveLocal();
}

updateUI();

/* ============================================================
   LOGIN FIREBASE + CARREGAMENTO AUTOM√ÅTICO
   ============================================================ */

onAuthStateChanged(auth, async user => {
  if (!user) {
    alert("Sess√£o expirada ‚Äî fa√ßa login novamente.");
    window.location.href = "login.html";
    return;
  }

  // Carregar do Firebase primeiro
  await loadFromFirebase(user.uid);

  // Atualizar UI
  updateUI();
});


/* ============================================================
   FINAL ‚Äî NADA ALTERADO NO DESIGN
   ============================================================ */

</script>

</body>
</html>
