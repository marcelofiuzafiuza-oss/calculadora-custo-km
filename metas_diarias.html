<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MAX ROTA DI√ÅRIO</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --accent:#10b981;
  --bg1:#041226;
  --bg2:#1b2540;
  --card:rgba(255,255,255,0.03);
  --muted:#9aa6b2;
  --radius:12px;
}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,Arial;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#e6eef6;margin:0;padding:18px}
.wrap{max-width:1100px;margin:0 auto}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));border-radius:14px;padding:14px;margin-bottom:16px;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px}
.logo{display:flex;gap:12px;align-items:center}
.logo img{height:76px;border-radius:10px}
.title{font-size:20px;margin:0}
.sub{color:var(--muted);font-size:13px;margin-top:4px}

/* theme controls */
.theme-controls{display:flex;gap:8px;align-items:center}
.theme-btn{padding:8px 12px;border-radius:10px;background:var(--accent);border:0;color:#012;font-weight:800;cursor:pointer}
.color-dots{display:flex;gap:8px}
.color-dot{width:32px;height:32px;border-radius:999px;cursor:pointer;border:2px solid rgba(255,255,255,0.06)}

/* radio */
.radio-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.station-btn{padding:12px;border-radius:10px;border:0;cursor:pointer;font-weight:800;color:#fff;display:flex;align-items:center;justify-content:center;min-height:52px}
.station-btn.active{box-shadow:0 14px 30px rgba(0,0,0,0.6);transform:translateY(-4px)}

/* player */
.radio-player{display:flex;gap:12px;align-items:center;margin-top:12px}

/* meta */
.meta-row{display:flex;gap:10px;align-items:center}
.big-input{padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:inherit;font-weight:800}
.progress{position:relative;height:50px;border-radius:999px;background:rgba(255,255,255,0.02);overflow:hidden;border:1px solid rgba(255,255,255,0.04);margin-top:12px}
.progress-fill{position:absolute;left:0;top:0;height:100%;width:0;background:linear-gradient(90deg,var(--accent),#2563eb);transition:width .7s}
.progress-text{position:absolute;left:0;right:0;text-align:center;line-height:50px;font-weight:900}

/* km & timer */
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px}
.card-field{background:rgba(255,255,255,0.01);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
.big-value{font-weight:900;font-size:18px;margin-top:6px}

/* actions */
.actions{display:flex;gap:8px;margin-top:12px}
.btn-primary{background:var(--accent);border:0;padding:10px 14px;border-radius:10px;color:#012;font-weight:900;cursor:pointer}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px 12px;border-radius:10px;color:var(--muted);cursor:pointer}

/* lancamentos */
.lancamentos-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.apps-grid,.gastos-grid{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
.app-btn,.gasto-btn{min-width:130px;height:52px;border-radius:12px;border:0;font-weight:900;cursor:pointer;color:#fff;display:flex;align-items:center;justify-content:center}

/* list */
.launch-list{max-height:320px;overflow:auto;margin-top:12px;display:flex;flex-direction:column;gap:8px}
.launch-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:rgba(0,0,0,0.12)}
.launch-item .meta{font-weight:800}

/* resumo */
.resumo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.mini-card{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);font-weight:800}

.metric-compare{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
.metric-panel{padding:12px;border-radius:10px;background:rgba(255,255,255,0.01)}

@media(max-width:980px){
  .radio-grid{grid-template-columns:repeat(2,1fr)}
  .grid-4{grid-template-columns:repeat(2,1fr)}
  .lancamentos-grid{grid-template-columns:1fr}
  .resumo-grid{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
  <div class="wrap">
    <section class="card header">
      <div class="logo">
        <img src="https://i.postimg.cc/3RWn008g/Chat-GPT-Image-12-de-nov-de-2025-14-32-56.png" alt="logo">
        <div>
          <h1 class="title">MAX ROTA DI√ÅRIO</h1>
          <div class="sub">Painel do motorista ‚Äî interface grande</div>
        </div>
      </div>
      <div class="theme-controls">
        <button id="autoTheme" class="theme-btn">Auto üåó</button>
        <div class="color-dots" id="colorDots">
          <div class="color-dot" data-accent="green" style="background:#10b981"></div>
          <div class="color-dot" data-accent="orange" style="background:#f97316"></div>
          <div class="color-dot" data-accent="yellow" style="background:#facc15"></div>
          <div class="color-dot" data-accent="red" style="background:#ef4444"></div>
        </div>
      </div>
    </section>

    <!-- radios -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>üéß Esta√ß√µes</strong><div class="sub">4 por linha</div></div>
      </div>
      <div class="radio-grid" id="stationButtons" role="list">
        <button class="station-btn" data-src="https://live.hunter.fm/pop_high" data-name="Pop Hits" style="background:#10b981">Pop Hits</button>
        <button class="station-btn" data-src="https://live.hunter.fm/pop2k_high" data-name="Pop2K" style="background:#f59e0b;color:#111">Pop2K</button>
        <button class="station-btn" data-src="https://live.hunter.fm/rock_high" data-name="Rock" style="background:#ef4444">Rock</button>
        <button class="station-btn" data-src="https://live.hunter.fm/mpb_high" data-name="MPB" style="background:#2563eb">MPB</button>

        <button class="station-btn" data-src="https://live.hunter.fm/sertanejo_high" data-name="Sertanejo" style="background:#c084fc">Sertanejo</button>
        <button class="station-btn" data-src="https://live.hunter.fm/gospel_high" data-name="Crist√£" style="background:#facc15;color:#111">Crist√£</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/groovesalad-128-mp3" data-name="Eletr√¥nica" style="background:#2563eb">Eletr√¥nica</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/secretagent-128-mp3" data-name="Surf" style="background:#06b6d4">Surf</button>

        <button class="station-btn" data-src="https://ice1.somafm.com/beatblender-128-mp3" data-name="Dance 2000" style="background:#db2777">Dance 2000</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/lush-128-mp3" data-name="Chill Lounge" style="background:#7c3aed">Chill</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/bagel-128-mp3" data-name="Alt Rock" style="background:#ef4444">Alt Rock</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/thetrip-128-mp3" data-name="EDM The Trip" style="background:#06b6d4">EDM</button>
      </div>

      <div class="radio-player">
        <audio id="radioPlayer" controls preload="none" style="width:72%"></audio>
        <div style="width:28%;display:flex;flex-direction:column;align-items:flex-end;gap:8px">
          <button id="stopRadio" class="btn-ghost" style="width:100%">Parar R√°dio</button>
          <div id="nowPlaying" class="sub" style="text-align:right">Nenhuma r√°dio selecionada.</div>
        </div>
      </div>
    </section>

    <!-- meta -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>üéØ Meta Di√°ria</strong><div class="sub">Barra com enchimento fluido</div></div>
      </div>
      <div class="meta-row" style="margin-top:12px">
        <input id="metaInput" class="big-input" type="number" placeholder="Ex: 300">
        <button id="saveMeta" class="btn-primary">Salvar Meta</button>
      </div>
      <div class="progress" role="progressbar" aria-label="Progresso da meta">
        <div id="progressFill" class="progress-fill"></div>
        <div id="progressText" class="progress-text">0%</div>
      </div>
      <div id="progressSub" class="sub" style="margin-top:8px">Defina a meta para acompanhar o progresso.</div>
    </section>

    <!-- km & timer -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>üöó Jornada & KM</strong><div class="sub">Salve KM, inicie expediente e monitore</div></div>
      </div>
      <div class="grid-4">
        <div class="card-field"><label>KM Inicial</label><input id="kmInicial" class="big-input" type="number" placeholder="Ex: 150000"></div>
        <div class="card-field"><label>KM Final</label><input id="kmFinal" class="big-input" type="number" placeholder="Ex: 150250"></div>
        <div class="card-field"><label>Tempo Trabalhado</label><div id="tempoTrabalhado" class="big-value">00:00:00</div></div>
        <div class="card-field"><label>KM Rodados</label><div id="kmRodados" class="big-value">0.0 km</div></div>
      </div>
      <div class="actions" style="margin-top:12px">
        <button id="toggleStart" class="btn-primary">Iniciar Expediente</button>
        <button id="finalizeDay" class="btn-primary" style="background:linear-gradient(90deg,var(--accent),#7c3aed)">Finalizar Dia</button>
        <button id="saveKmBtn" class="btn-primary">Salvar KM</button>
      </div>
      <div id="lastSession" style="margin-top:12px;display:none" class="mini-card"></div>
    </section>

    <!-- lan√ßamentos -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Lan√ßamentos</strong><div class="sub">Entradas (esquerda) ‚Äî Sa√≠das (direita)</div></div>
      </div>
      <div class="lancamentos-grid">
        <div>
          <div style="display:flex;gap:8px">
            <input id="valorEntrada" class="big-input" type="number" placeholder="Valor (R$)">
            <button id="addEntrada" class="btn-primary">Lan√ßar</button>
          </div>
          <div class="apps-grid">
            <button class="app-btn" data-cat="Uber" style="background:#000">Uber</button>
            <button class="app-btn" data-cat="99" style="background:#facc15;color:#111">99</button>
            <button class="app-btn" data-cat="inDriver" style="background:#10b981">inDriver</button>
            <button class="app-btn" data-cat="Particular" style="background:#6b7280">Particular</button>
            <button class="app-btn" data-cat="Loja" style="background:#1e3a8a">Loja</button>
            <button class="app-btn" data-cat="Doa√ß√£o" style="background:#8b5cf6">Doa√ß√£o</button>
          </div>
        </div>
        <div>
          <div style="display:flex;gap:8px">
            <input id="valorSaida" class="big-input" type="number" placeholder="Valor (R$)">
            <button id="addSaida" class="btn-primary">Lan√ßar</button>
          </div>
          <div class="gastos-grid">
            <button class="gasto-btn" data-cat="Combust√≠vel" style="background:#ef4444">Combust√≠vel</button>
            <button class="gasto-btn" data-cat="Alimenta√ß√£o" style="background:#8b5cf6">Alimenta√ß√£o</button>
            <button class="gasto-btn" data-cat="Manuten√ß√£o" style="background:#6b7280">Manuten√ß√£o</button>
            <button class="gasto-btn" data-cat="Outros" style="background:#374151">Outros</button>
          </div>
        </div>
      </div>
    </section>

    <!-- recentes -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Lan√ßamentos Recentes</strong><div class="sub">Edite ou exclua</div></div>
      </div>
      <div id="lancamentosList" class="launch-list"><div class="sub">Nenhum lan√ßamento ainda.</div></div>
    </section>

    <!-- resumo -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Resumo R√°pido</strong><div class="sub">Por categoria</div></div>
      </div>
      <div id="resumoCategorias" class="resumo-grid">
        <div class="mini-card">Sem entradas</div>
        <div class="mini-card">Sem entradas</div>
        <div class="mini-card">Sem entradas</div>
      </div>
    </section>

    <!-- metricas -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>M√©tricas</strong><div class="sub">Compara√ß√£o Apps x Apps+Loja</div></div>
      </div>
      <div class="metric-compare">
        <div class="metric-panel">
          <div class="sub">Ganhos Brutos ‚Äî Somente Apps</div>
          <div id="ganhosApps" class="big-value">R$ 0,00</div>
          <div style="margin-top:10px" class="sub">M√©dia/h (Bruto)</div>
          <div id="mediaHoraApps" class="big-value">R$ 0,00</div>
        </div>
        <div class="metric-panel">
          <div class="sub">Ganhos Brutos ‚Äî Apps + Loja</div>
          <div id="ganhosTotal" class="big-value">R$ 0,00</div>
          <div style="margin-top:10px" class="sub">M√©dia/h (L√≠quido)</div>
          <div id="mediaHoraLiq" class="big-value">R$ 0,00</div>
        </div>
      </div>
    </section>

    <!-- a√ß√µes -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>A√ß√µes</strong><div class="sub">Salvar resumo, exportar e hist√≥rico</div></div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="saveReset" class="btn-primary">Salvar Resumo & Resetar Dia</button>
        <button id="exportBtn" class="btn-ghost">Exportar Resumo (JSON)</button>
        <button id="viewHistory" class="btn-ghost">Ver Hist√≥rico</button>
      </div>
      <div id="historyPanel" style="margin-top:12px;display:none"></div>
    </section>

    <footer style="text-align:center;margin-top:12px;color:var(--muted)">Dados armazenados localmente (localStorage)</footer>
  </div>

  <div id="confetti" class="confetti" aria-hidden="true" style="pointer-events:none;position:fixed;inset:0;z-index:9999"></div>
  <script>

// ===============================
//  MAX ROTA ‚Äì SCRIPT AJUSTADO
// ===============================

// UTILIDADES
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

function formatBRL(v) {
  return Number(v || 0).toLocaleString("pt-BR", {
    style: "currency",
    currency: "BRL",
  });
}
function formatKM(v) {
  return Number(v || 0).toFixed(1) + " km";
}
function formatTime(ms) {
  if (!ms || ms <= 0) return "00:00:00";
  const s = Math.floor(ms / 1000);
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  const sec = s % 60;
  return [h, m, sec].map(n => String(n).padStart(2, "0")).join(":");
}

// ===============================
//  ESTADO PRINCIPAL DO APLICATIVO
// ===============================
let state = {
  meta: 0,
  ganhosApps: 0,
  ganhosLoja: 0,
  totalDoacao: 0,

  entradasApps: 0,
  entradasLoja: 0,

  gastos: 0,
  history: [],

  kmInicial: 0,
  kmFinal: 0,

  totalTimeWorked: 0,
  lastStartTime: null,
  status: "stopped", // running | paused | stopped

  celebrated: false,
};

// CARREGAR E SALVAR
function saveState() {
  localStorage.setItem("maxrota_state", JSON.stringify(state));
}
function loadState() {
  const s = localStorage.getItem("maxrota_state");
  if (!s) return;
  try {
    const obj = JSON.parse(s);
    Object.assign(state, obj);
  } catch {}
}
loadState();

// ===============================
//  REFER√äNCIAS DOS ELEMENTOS
// ===============================

// META
const metaInput = $("#metaInput");
const setMetaBtn = $("#setMetaBtn");
const progressBar = $("#progressBar");
const progressText = $("#progressText");
const metaMessage = $("#metaMessage");

// KM & TEMPO
const kmInicialEl = $("#kmInicial");
const kmFinalEl = $("#kmFinal");
const tempoTrabalhado = $("#tempoTrabalhado");
const kmRodados = $("#kmRodados");
const toggleStartBtn = $("#toggleStartBtn");
const finalizeBtn = $("#finalizeBtn");
const saveKmBtn = $("#saveKmBtn");

// LAN√áAMENTOS
const valorEntrada = $("#valorEntrada");
const valorSaida = $("#valorSaida");
const lancamentosList = $("#lancamentosList");

// R√ÅDIOS
const radioPlayer = $("#radioPlayer");
const nowPlaying = $("#nowPlaying");
const stationButtons = $$("#stationButtons .station-btn");

// M√âTRICAS (NOVOS IDs)
const metricGanhosApps = $("#metricGanhosApps");
const metricGanhosTotal = $("#metricGanhosTotal");
const metricGastosTotal = $("#metricGastosTotal");
const metricLucroTotal = $("#metricLucroTotal");
const metricMediaHoraBrutoTotal = $("#metricMediaHoraBrutoTotal");
const metricMediaHoraLiqTotal = $("#metricMediaHoraLiqTotal");
const metricLucroKmTotal = $("#metricLucroKmTotal");
const metricEntradasApps = $("#metricEntradasApps");
const metricEntradasLoja = $("#metricEntradasLoja");

// RESUMO FINAL MINI-CARDS (NOVOS IDs)
const finalTotalApps = $("#finalTotalApps");
const finalTotalLoja = $("#finalTotalLoja");
const finalTotalDoacao = $("#finalTotalDoacao");
const finalTotalGeral = $("#finalTotalGeral");

// CONFETTI
const confettiRoot = $("#confettiRoot");

// ===============================
//  FUN√á√ïES DE R√ÅDIO (RADIO PLAYER)
// ===============================

function setActiveStation(btn) {
  stationButtons.forEach(b => b.classList.remove("active"));
  if (btn) btn.classList.add("active");
}

stationButtons.forEach(btn => {
  btn.addEventListener("click", async () => {
    try { radioPlayer.pause(); } catch {}
    radioPlayer.src = "";

    const url = btn.dataset.src;
    const name = btn.dataset.name;

    setActiveStation(btn);
    nowPlaying.textContent = "Carregando: " + name;

    try {
      radioPlayer.src = url;
      radioPlayer.load();
      await radioPlayer.play();
      nowPlaying.textContent = "Tocando: " + name;
    } catch {
      nowPlaying.textContent = "Falha ao carregar " + name;
      setActiveStation(null);
    }
  });
});

// ===============================
//     META DI√ÅRIA (SALVAR)
// ===============================
setMetaBtn.addEventListener("click", () => {
  const v = Number(metaInput.value);
  if (v > 0) {
    state.meta = v;
    saveState();
    updateUI();
  }
});
    // ===================================
//  TIMER & KM ‚Äî FUNCIONAMENTO COMPLETO
// ===================================
let timerInterval = null;

function getTempoTotal() {
  let t = Number(state.totalTimeWorked || 0);
  if (state.status === "running" && state.lastStartTime) {
    t += (Date.now() - state.lastStartTime);
  }
  return t;
}

function getKMRodados() {
  const ini = Number(state.kmInicial || 0);
  const fim = Number(state.kmFinal || 0);
  return fim > ini ? (fim - ini) : 0;
}

function startTimer() {
  stopTimer();
  if (!state.lastStartTime) state.lastStartTime = Date.now();

  timerInterval = setInterval(() => {
    tempoTrabalhado.textContent = formatTime(getTempoTotal());
    updateDerivedMetrics();
  }, 1000);
}

function stopTimer() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
}

// Bot√£o iniciar/pausar/continuar
toggleStartBtn.addEventListener("click", () => {
  if (state.status === "stopped") {
    state.status = "running";
    state.lastStartTime = Date.now();
    toggleStartBtn.textContent = "Pausar";
    startTimer();
  } else if (state.status === "running") {
    state.totalTimeWorked += (Date.now() - state.lastStartTime);
    state.lastStartTime = null;
    state.status = "paused";
    toggleStartBtn.textContent = "Retomar";
    stopTimer();
  } else if (state.status === "paused") {
    state.status = "running";
    state.lastStartTime = Date.now();
    toggleStartBtn.textContent = "Pausar";
    startTimer();
  }

  saveState();
  updateUI();
});

// Finalizar dia ‚Äî zerar tempo e registrar card mini
finalizeBtn.addEventListener("click", () => {
  if (state.status === "running") {
    state.totalTimeWorked += (Date.now() - state.lastStartTime);
  }

  const tempoFinal = getTempoTotal();
  const kmDia = getKMRodados();

  state.status = "stopped";
  state.lastStartTime = null;
  stopTimer();

  const resumoCard = document.createElement("div");
  resumoCard.style.padding = "12px";
  resumoCard.style.marginTop = "10px";
  resumoCard.style.borderRadius = "10px";
  resumoCard.style.background = "rgba(255,255,255,0.13)";
  resumoCard.innerHTML = `
      <b>üïí Dia Finalizado</b><br>
      Tempo Trabalhado: <span>${formatTime(tempoFinal)}</span><br>
      KM Rodado: <span>${formatKM(kmDia)}</span>
  `;
  finalizeBtn.parentElement.appendChild(resumoCard);

  state.totalTimeWorked = 0;
  saveState();
  updateUI();
});

// Salvar KM
saveKmBtn.addEventListener("click", () => {
  state.kmInicial = Number(kmInicialEl.value) || 0;
  state.kmFinal = Number(kmFinalEl.value) || 0;
  saveState();
  updateUI();
});

// =======================================
//  LAN√áAMENTOS ‚Äî ENTRADAS & SA√çDAS
// =======================================

function addLancamento({ type, value, category }) {
  const item = {
    id: Math.random().toString(36).slice(2),
    type,
    value: Number(value),
    category
  };

  if (type === "ganho") {
    if (category === "Loja") state.ganhosLoja += item.value;
    else if (category === "Doa√ß√£o") state.totalDoacao += item.value;
    else state.ganhosApps += item.value;
  } else {
    state.gastos += item.value;
  }

  state.history.unshift(item);
  saveState();
  updateUI();
}

addEntradaBtn.addEventListener("click", () => {
  const val = Number(valorEntrada.value);
  if (val <= 0) return alert("Valor inv√°lido");

  addLancamento({ type: "ganho", value: val, category: "Particular" });
  valorEntrada.value = "";
});

addSaidaBtn.addEventListener("click", () => {
  const val = Number(valorSaida.value);
  if (val <= 0) return alert("Valor inv√°lido");

  addLancamento({ type: "gasto", value: val, category: "Outros" });
  valorSaida.value = "";
});

// Bot√µes dos Apps
$$(".app-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const val = Number(valorEntrada.value);
    if (val <= 0) return alert("Valor inv√°lido");

    const cat = btn.dataset.cat;
    addLancamento({ type: "ganho", value: val, category: cat });
    valorEntrada.value = "";
  });
});

// Bot√µes de Gastos
$$(".gasto-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const val = Number(valorSaida.value);
    if (val <= 0) return alert("Valor inv√°lido");

    addLancamento({ type: "gasto", value: val, category: btn.dataset.cat });
    valorSaida.value = "";
  });
});

// ===============================
//  LISTA DE LAN√áAMENTOS
// ===============================
function renderLancamentos() {
  if (!state.history.length) {
    lancamentosList.innerHTML = `<div class="muted small">Nenhum lan√ßamento ainda.</div>`;
    return;
  }

  lancamentosList.innerHTML = "";

  state.history.forEach(l => {
    const item = document.createElement("div");
    item.className = "launch-item";
    item.innerHTML = `
      <div style="font-weight:700;">
        ${l.category}: ${l.type === "ganho" ? "+" : "-"} ${formatBRL(l.value)}
      </div>
      <div>
        <button class="btn-ghost edit" data-id="${l.id}">‚úèÔ∏è</button>
        <button class="btn-ghost delete" data-id="${l.id}">üóëÔ∏è</button>
      </div>
    `;

    // editar
    item.querySelector(".edit").addEventListener("click", () => {
      const novo = Number(prompt("Novo valor:", l.value));
      if (novo <= 0) return;

      // remover antigo
      if (l.type === "ganho") {
        if (l.category === "Loja") state.ganhosLoja -= l.value;
        else if (l.category === "Doa√ß√£o") state.totalDoacao -= l.value;
        else state.ganhosApps -= l.value;
      } else state.gastos -= l.value;

      // aplicar novo
      l.value = novo;

      if (l.type === "ganho") {
        if (l.category === "Loja") state.ganhosLoja += novo;
        else if (l.category === "Doa√ß√£o") state.totalDoacao += novo;
        else state.ganhosApps += novo;
      } else state.gastos += novo;

      saveState();
      updateUI();
    });

    // deletar
    item.querySelector(".delete").addEventListener("click", () => {
      state.history = state.history.filter(x => x.id !== l.id);
      saveState();
      updateUI();
    });

    lancamentosList.appendChild(item);
  });
}
    // ============================================
//  RESUMO POR CATEGORIA
// ============================================
function renderResumoFinal() {
  const totalApps = state.ganhosApps;
  const totalLoja = state.ganhosLoja;
  const totalDoacao = state.totalDoacao;
  const totalGeral = totalApps + totalLoja + totalDoacao - state.gastos;

  finalTotalApps.textContent = formatBRL(totalApps);
  finalTotalLoja.textContent = formatBRL(totalLoja);
  finalTotalDoacao.textContent = formatBRL(totalDoacao);
  finalTotalGeral.textContent = formatBRL(totalGeral);
}

// ============================================
//  M√âTRICAS COMPLETAS
// ============================================
function updateDerivedMetrics() {
  const totalBruto =
    state.ganhosApps + state.ganhosLoja + state.totalDoacao;

  const lucro = totalBruto - state.gastos;
  const tempo = getTempoTotal();
  const horas = tempo / (1000 * 60 * 60) || 0;

  const mediaBruto = horas > 0 ? totalBruto / horas : 0;
  const mediaLiq = horas > 0 ? lucro / horas : 0;
  const lucroKm =
    getKMRodados() > 0 ? lucro / getKMRodados() : 0;

  metricGanhosApps.textContent = formatBRL(state.ganhosApps);
  metricGanhosTotal.textContent = formatBRL(totalBruto);
  metricGastosTotal.textContent = formatBRL(state.gastos);
  metricLucroTotal.textContent = formatBRL(lucro);

  metricMediaHoraBrutoTotal.textContent = formatBRL(mediaBruto);
  metricMediaHoraLiqTotal.textContent = formatBRL(mediaLiq);
  metricLucroKmTotal.textContent = formatBRL(lucroKm);

  metricEntradasApps.textContent = state.entradasApps;
  metricEntradasLoja.textContent = state.entradasLoja;

  tempoTrabalhado.textContent = formatTime(tempo);
  kmRodados.textContent = formatKM(getKMRodados());

  updateProgressBar();
  renderResumoFinal();
}

// ============================================
//  BARRA DE PROGRESSO + CELEBRA√á√ÉO
// ============================================

function updateProgressBar() {
  const meta = Number(state.meta || 0);
  const atual =
    state.ganhosApps + state.ganhosLoja;

  if (meta === 0) {
    progressBar.style.width = "0%";
    progressText.textContent = "0%";
    metaMessage.textContent =
      "Defina a meta para acompanhar o progresso.";
    return;
  }

  const pct = Math.min(100, (atual / meta) * 100);
  progressBar.style.width = pct + "%";
  progressText.textContent = Math.round(pct) + "%";

  if (atual < meta) {
    const falta = meta - atual;
    metaMessage.textContent =
      `Faltam ${formatBRL(falta)} para bater a meta.`;
  } else {
    metaMessage.textContent =
      `Meta batida! üéâ (+${formatBRL(atual - meta)})`;
    celebrate();
  }
}

// CELEBRA√á√ÉO
function celebrate() {
  if (state.celebrated) return;
  state.celebrated = true;

  // Trombeta + Aplausos
  playVictorySequence();

  // Confetti
  triggerConfetti();

  saveState();
}

// Trombeta + aplausos
function playVictorySequence() {
  const ctx = new (window.AudioContext ||
    window.webkitAudioContext)();
  const now = ctx.currentTime;

  // Trombeta
  const osc = ctx.createOscillator();
  osc.type = "sawtooth";
  osc.frequency.value = 480;
  const gain = ctx.createGain();
  gain.gain.setValueAtTime(0.01, now);
  gain.gain.exponentialRampToValueAtTime(1, now + 0.1);
  gain.gain.exponentialRampToValueAtTime(0.01, now + 1.3);

  osc.connect(gain);
  gain.connect(ctx.destination);

  osc.start(now);
  osc.stop(now + 1.4);

  // Aplausos
  const buffer = ctx.createBuffer(
    1,
    ctx.sampleRate * 5,
    ctx.sampleRate
  );
  const data = buffer.getChannelData(0);

  for (let i = 0; i < data.length; i++) {
    data[i] =
      (Math.random() * 2 - 1) *
      (1 - i / data.length) *
      1.2;
  }

  const applause = ctx.createBufferSource();
  applause.buffer = buffer;
  applause.connect(ctx.destination);
  applause.start(now + 0.6);
}

// Confetti
function triggerConfetti() {
  for (let i = 0; i < 70; i++) {
    const c = document.createElement("div");
    c.classList.add("c");
    c.style.left = Math.random() * 100 + "%";
    c.style.top = "-20px";

    confettiRoot.appendChild(c);

    setTimeout(() => c.remove(), 2000);
  }
}

// ============================================
//  TEMA DIA / NOITE + CORES
// ============================================

const autoThemeBtn = $("#autoThemeBtn");
let autoMode = true;

autoThemeBtn.addEventListener("click", () => {
  autoMode = !autoMode;

  if (autoMode) {
    applyAutoTheme();
    autoThemeBtn.textContent = "Auto üåó";
  } else {
    document.body.classList.toggle("light-mode");
    autoThemeBtn.textContent =
      document.body.classList.contains("light-mode")
        ? "Modo Noite üåô"
        : "Modo Dia ‚òÄÔ∏è";
  }
});

function applyAutoTheme() {
  if (!autoMode) return;

  const hour = new Date().getHours();
  const day = hour >= 6 && hour < 18;

  document.body.classList.toggle("light-mode", day);
}

setInterval(applyAutoTheme, 60000);

// COR TEMA
const themeDots = $$(".color-dot");
themeDots.forEach(dot => {
  dot.addEventListener("click", () => {
    const acc = dot.dataset.accent;

    document.body.classList.remove(
      "accent-green",
      "accent-orange",
      "accent-yellow",
      "accent-red",
      "accent-pink"
    );
    document.body.classList.add("accent-" + acc);

    localStorage.setItem("maxrota_accent", acc);
  });
});

// Carregar tema salvo
const savedAccent =
  localStorage.getItem("maxrota_accent") || "green";
document.body.classList.add("accent-" + savedAccent);

// ============================================
//  RENDER COMPLETO DA INTERFACE
// ============================================

function updateUI() {
  kmInicialEl.value = state.kmInicial || "";
  kmFinalEl.value = state.kmFinal || "";
  metaInput.value = state.meta || "";

  // Bot√£o iniciar
  if (state.status === "running") toggleStartBtn.textContent = "Pausar";
  else if (state.status === "paused")
    toggleStartBtn.textContent = "Retomar";
  else toggleStartBtn.textContent = "Iniciar Expediente";

  renderLancamentos();
  updateDerivedMetrics();
  renderResumoFinal();

  saveState();
}

// Carregar ao iniciar
if (state.status === "running" && state.lastStartTime) {
  startTimer();
}

updateUI();

console.log("MAX ROTA ‚Äî Script carregado.");
