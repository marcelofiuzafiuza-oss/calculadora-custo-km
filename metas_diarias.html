<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAX ROTA DI√ÅRIO</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    /* (mantive seu CSS enxuto; se quiser eu colo todo o CSS original, mas mantenho layout) */
    :root{--accent:#10b981;--bg1:#041226;--bg2:#2a1160;--text:#e6eef6;--muted:#9aa6b2;--card:rgba(255,255,255,0.06);--radius:14px}
    html,body{height:100%;margin:0;padding:0}
    body{font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--text);padding:20px}
    .wrap{max-width:1200px;margin:0 auto}
    .card{background:var(--card);backdrop-filter:blur(6px);border-radius:16px;padding:18px;margin-bottom:18px;border:1px solid rgba(255,255,255,0.03)}
    .header-card{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .logo-img{height:74px}
    .theme-controls{display:flex;gap:10px;align-items:center}
    .theme-btn{background:linear-gradient(120deg,var(--accent),#3b82f6);color:#fff;padding:10px;border-radius:12px;border:none;cursor:pointer}
    .color-dot{width:30px;height:30px;border-radius:999px;border:2px solid rgba(255,255,255,0.12);cursor:pointer}
    .radio-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .station-btn{padding:12px;border-radius:12px;color:#fff;border:0;cursor:pointer;height:52px;font-weight:800}
    .station-btn.active{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,0.5)}
    .meta-row{display:flex;gap:10px}
    .meta-row input{flex:1;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.02);color:var(--text)}
    .btn{padding:10px 14px;border-radius:12px;background:linear-gradient(120deg,var(--accent),#7c3aed);border:none;color:#fff;cursor:pointer}
    .btn-ghost{padding:10px 14px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);cursor:pointer;color:var(--muted)}
    .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .grid-2cols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .apps-grid button{min-width:110px}
    .launch-list{max-height:300px;overflow:auto}
    .muted{color:var(--muted)}
    .small{font-size:13px}
    .hidden-value{visibility:hidden;position:relative}
    .hidden-value::after{content:'****';visibility:visible;position:absolute;left:0;top:0;color:var(--text)}
  </style>
</head>
<body>
  <!-- auth guard (redirect if not logged) -->
  <script type="module" src="./auth-guard.js"></script>

  <div class="wrap">
    <!-- HEADER -->
    <header class="card header-card">
      <div style="display:flex;align-items:center;gap:12px">
        <img class="logo-img" src="https://i.postimg.cc/3RWn008g/Chat-GPT-Image-12-de-nov-de-2025-14-32-56.png" alt="MAX ROTA">
        <div>
          <h1 style="margin:0">MAX ROTA DI√ÅRIO</h1>
          <div class="small muted">Painel do Motorista</div>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;gap:10px;align-items:flex-end">
        <div class="theme-controls">
          <button id="autoThemeBtn" class="theme-btn">Auto üåó</button>
          <div style="display:flex;gap:8px;margin-left:8px">
            <button class="color-dot" data-accent="green" style="background:#10b981"></button>
            <button class="color-dot" data-accent="orange" style="background:#f97316"></button>
            <button class="color-dot" data-accent="yellow" style="background:#facc15"></button>
            <button class="color-dot" data-accent="red" style="background:#ef4444"></button>
          </div>
        </div>
        <div style="display:flex;gap:8px">
          <button id="toggleValuesBtn" class="btn btn-ghost" aria-pressed="false">Esconder Valores</button>
          <button id="logoutBtn" class="btn btn-ghost">Sair</button>
        </div>
      </div>
    </header>

    <!-- R√°dios -->
    <section class="card">
      <h2 style="margin:0 0 12px 0">üéß Esta√ß√µes</h2>
      <div id="stationButtons" class="radio-grid">
        <button class="station-btn" data-src="https://live.hunter.fm/pop_high" data-name="Hunter Pop" style="background:#10b981">Hunter Pop</button>
        <button class="station-btn" data-src="https://live.hunter.fm/pop2k_high" data-name="Hunter Pop2K" style="background:#06b6d4">Pop2K</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/u80s-128-mp3" data-name="Flashback 80s" style="background:#8b5cf6">80s</button>
        <button class="station-btn" data-src="http://listen.181fm.com/181-power_128k.mp3" data-name="Power 181" style="background:#f97316">Power181</button>

        <button class="station-btn" data-src="https://live.hunter.fm/rock_high" data-name="Rock Classic" style="background:#ef4444">Rock</button>
        <button class="station-btn" data-src="https://live.hunter.fm/sertanejo_high" data-name="Sertanejo" style="background:#f59e0b">Sertanejo</button>
        <button class="station-btn" data-src="https://live.hunter.fm/hiphop_high" data-name="Hip Hop" style="background:#111827">HipHop</button>
        <button class="station-btn" data-src="https://live.hunter.fm/gospel_high" data-name="Crist√£" style="background:#facc15;color:#111">Crist√£</button>

        <button class="station-btn" data-src="https://ice1.somafm.com/groovesalad-128-mp3" data-name="GrooveSalad" style="background:#2563eb">Eletr√¥nica</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/beatblender-128-mp3" data-name="BeatBlender" style="background:#7c3aed">House / Deep</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/secretagent-128-mp3" data-name="Surf" style="background:#06b6d4">Surf</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/dubstep-128-mp3" data-name="Reggae/Dub" style="background:#4ade80">Reggae</button>

        <button class="station-btn" data-src="https://live.hunter.fm/mpb_high" data-name="MPB Brasil" style="background:#1e3a8a">MPB</button>
        <button class="station-btn" data-src="https://stream.radioparadise.com/mp3-192" data-name="Radio Paradise" style="background:#111827">RadioParadise</button>
        <button class="station-btn" data-src="http://listen.181fm.com/181-beat_128k.mp3" data-name="181 HipHop" style="background:#0ea5e9">181 HipHop</button>
        <button class="station-btn" data-src="https://live.hunter.fm/mpb_high" data-name="MPB (alt)" style="background:#8b5cf6">MPB alt</button>
      </div>

      <div style="margin-top:12px;display:flex;align-items:center;gap:12px">
        <audio id="radioPlayer" controls preload="none" style="flex:1"></audio>
        <div style="min-width:140px">
          <button id="stopRadioBtn" class="btn-ghost">Parar R√°dio</button>
          <div id="nowPlaying" class="small muted" style="margin-top:6px">Nenhuma r√°dio selecionada.</div>
        </div>
      </div>
    </section>

    <!-- Meta -->
    <section class="card">
      <h2 style="margin:0 0 12px 0">üéØ Meta Di√°ria</h2>
      <div class="meta-row">
        <input id="metaInput" type="number" placeholder="Ex: 300">
        <button id="setMetaBtn" class="btn">Salvar Meta</button>
      </div>
      <div style="margin-top:12px">
        <div style="height:44px;border-radius:22px;background:rgba(255,255,255,0.03);position:relative;overflow:hidden">
          <div id="progressBar" style="height:100%;width:0;background:linear-gradient(120deg,var(--accent),#2563eb)"></div>
          <div id="progressText" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800">0%</div>
        </div>
        <div id="metaMessage" class="small muted" style="margin-top:8px">Defina a meta para acompanhar o progresso.</div>
      </div>
    </section>

    <!-- KM & Timer -->
    <section class="card">
      <h2 style="margin:0 0 12px 0">üöó Jornada e KM</h2>
      <div class="grid-4">
        <div><label class="small muted">KM Inicial</label><input id="kmInicial" type="number" placeholder="Ex: 150000"></div>
        <div><label class="small muted">KM Final</label><input id="kmFinal" type="number" placeholder="Ex: 150250"></div>
        <div><label class="small muted">Tempo Trabalhado</label><div id="tempoTrabalhado" style="font-weight:900">00:00:00</div></div>
        <div><label class="small muted">KM Rodados</label><div id="kmRodados" style="font-weight:900">0.0 km</div></div>
      </div>
      <div style="margin-top:12px;display:flex;gap:10px">
        <button id="toggleStartBtn" class="btn">Iniciar Expediente</button>
        <button id="finalizeBtn" class="btn-ghost">Finalizar Dia</button>
        <button id="saveKmBtn" class="btn">Salvar KM</button>
      </div>
    </section>

    <!-- Lan√ßamentos -->
    <section class="card">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <h3 style="margin:0 0 8px 0">‚ûï Entradas (Apps)</h3>
          <div style="display:flex;gap:8px"><input id="valorEntrada" type="number" placeholder="Valor (R$)"><button id="addEntradaBtn" class="btn">Lan√ßar</button></div>
          <div class="apps-grid" style="margin-top:10px">
            <button class="app-btn" data-cat="Uber" style="background:#000">Uber</button>
            <button class="app-btn" data-cat="99" style="background:#facc15;color:#111">99</button>
            <button class="app-btn" data-cat="inDriver" style="background:#10b981">inDriver</button>
            <button class="app-btn" data-cat="Particular" style="background:#6b7280">Particular</button>
            <button class="app-btn" data-cat="Loja" style="background:#1e3a8a">Loja</button>
            <button class="app-btn" data-cat="Doa√ß√£o" style="background:#8b5cf6">Doa√ß√£o</button>
          </div>
        </div>

        <div>
          <h3 style="margin:0 0 8px 0">‚ûñ Sa√≠das (Gastos)</h3>
          <div style="display:flex;gap:8px"><input id="valorSaida" type="number" placeholder="Valor (R$)"><button id="addSaidaBtn" class="btn">Lan√ßar</button></div>
          <div class="gastos-grid" style="margin-top:10px">
            <button class="gasto-btn" data-cat="Combust√≠vel" style="background:#ef4444">Combust√≠vel</button>
            <button class="gasto-btn" data-cat="Alimenta√ß√£o" style="background:#8b5cf6">Alimenta√ß√£o</button>
            <button class="gasto-btn" data-cat="Manuten√ß√£o" style="background:#6b7280">Manuten√ß√£o</button>
            <button class="gasto-btn" data-cat="Outros" style="background:#374151">Outros</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Lan√ßamentos recentes -->
    <section class="card">
      <h3 style="margin:0 0 8px 0">Lan√ßamentos Recentes</h3>
      <div id="lancamentosList" class="launch-list muted small">Nenhum lan√ßamento ainda.</div>
    </section>

    <!-- Resumo -->
    <section class="card">
      <h3 style="margin:0 0 8px 0">Resumo R√°pido por Categoria</h3>
      <div id="resumoCategorias" class="resumo-grid muted small"></div>
    </section>

    <!-- M√©tricas -->
    <section class="card">
      <h3 style="margin:0 0 8px 0">M√©tricas</h3>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
        <div><div class="small muted">Ganhos Apps</div><div id="metricGanhosApps" style="font-weight:900">R$ 0,00</div></div>
        <div><div class="small muted">Gastos Totais</div><div id="metricGastosTotal" style="font-weight:900">R$ 0,00</div></div>
        <div><div class="small muted">Lucro L√≠quido</div><div id="metricLucroTotal" style="font-weight:900">R$ 0,00</div></div>
      </div>
    </section>

    <!-- A√ß√µes -->
    <section class="card">
      <div style="display:flex;gap:10px">
        <button id="saveAndResetBtn" class="btn">Salvar Resumo & Resetar Dia</button>
        <button id="exportBtn" class="btn-ghost">Exportar Resumo (JSON)</button>
        <button id="viewHistoryBtn" class="btn-ghost">Ver Hist√≥rico de Dias</button>
      </div>
      <div id="historyPanel" class="muted small" style="margin-top:12px;display:none"></div>
    </section>

    <!-- Final resumo -->
    <section class="card">
      <h3 style="margin:0 0 8px 0">Resumo Final por Categoria</h3>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px">
        <div><div class="small muted">Total Apps</div><div id="finalTotalApps" style="font-weight:900">R$ 0,00</div></div>
        <div><div class="small muted">Total Loja</div><div id="finalTotalLoja" style="font-weight:900">R$ 0,00</div></div>
        <div><div class="small muted">Total Doa√ß√µes</div><div id="finalTotalDoacao" style="font-weight:900">R$ 0,00</div></div>
        <div><div class="small muted">Total Geral</div><div id="finalTotalGeral" style="font-weight:900">R$ 0,00</div></div>
      </div>
    </section>

    <footer class="small muted" style="text-align:center;margin-top:12px">Dados sincronizados com Firestore. Fa√ßa logout em dispositivos p√∫blicos.</footer>
  </div>

  <!-- confetti container -->
  <div id="confettiRoot" style="position:fixed;inset:0;pointer-events:none;z-index:9999"></div>

  <!-- SCRIPT: main behavior + Firestore sync -->
  <script type="module">
    import {
      auth,
      signOut,
      onAuthStateChanged,
      saveUserState,
      listenUserState,
      saveDayForUser
    } from "./firebase.js";

    // --- util functions (format) ---
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    function uid(){return Math.random().toString(36).slice(2,9)}
    function formatBRL(v){ return Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
    function formatKM(v){ return Number(v||0).toFixed(1) + ' km'; }
    function formatTime(ms){ if(!ms||ms<=0) return '00:00:00'; const s=Math.floor(ms/1000); const h=Math.floor(s/3600); const m=Math.floor((s%3600)/60); const sec=s%60; return [h,m,sec].map(n=>String(n).padStart(2,'0')).join(':'); }

    // --- refs ---
    const stationBtns = $$('#stationButtons .station-btn');
    const radioPlayer = $('#radioPlayer'), nowPlaying = $('#nowPlaying'), stopRadioBtn = $('#stopRadioBtn');
    const metaInput = $('#metaInput'), setMetaBtn = $('#setMetaBtn'), progressBar = $('#progressBar'), progressText = $('#progressText'), metaMessage = $('#metaMessage');
    const kmInicialEl = $('#kmInicial'), kmFinalEl = $('#kmFinal'), tempoTrabalhado = $('#tempoTrabalhado'), kmRodados = $('#kmRodados');
    const toggleStartBtn = $('#toggleStartBtn'), finalizeBtn = $('#finalizeBtn'), saveKmBtn = $('#saveKmBtn');
    const valorEntrada = $('#valorEntrada'), addEntradaBtn = $('#addEntradaBtn'), valorSaida = $('#valorSaida'), addSaidaBtn = $('#addSaidaBtn');
    const appBtns = $$('.app-btn'), gastoBtns = $$('.gasto-btn');
    const lancamentosList = $('#lancamentosList'), resumoCategorias = $('#resumoCategorias');
    const metricGanhosApps = $('#metricGanhosApps'), metricGastosTotal = $('#metricGastosTotal'), metricLucroTotal = $('#metricLucroTotal');
    const finalTotalApps = $('#finalTotalApps'), finalTotalLoja = $('#finalTotalLoja'), finalTotalDoacao = $('#finalTotalDoacao'), finalTotalGeral = $('#finalTotalGeral');
    const saveAndResetBtn = $('#saveAndResetBtn'), exportBtn = $('#exportBtn'), viewHistoryBtn = $('#viewHistoryBtn'), historyPanel = $('#historyPanel');
    const toggleValuesBtn = $('#toggleValuesBtn'), logoutBtn = $('#logoutBtn');

    // --- app state (local mirror) ---
    let state = {
      meta:0, ganhosApps:0, ganhosLoja:0, totalDoacao:0, entradasApps:0, entradasLoja:0, gastos:0,
      history:[], kmInicial:0, kmFinal:0, totalTimeWorked:0, lastStartTime:null, status:'stopped', celebrated:false, valuesHidden:false
    };

    // --- local persistence fallback (keep your previous localStorage usage) ---
    function saveLocal(){ localStorage.setItem('maxrota_state', JSON.stringify(state)); }
    function loadLocal(){ try{ const s = JSON.parse(localStorage.getItem('maxrota_state')||'{}'); if(Object.keys(s).length) Object.assign(state,s); const m = localStorage.getItem('maxrota_meta'); if(m) state.meta = Number(m); const ki = localStorage.getItem('maxrota_kmInicial'); const kf = localStorage.getItem('maxrota_kmFinal'); if(ki) state.kmInicial = Number(ki); if(kf) state.kmFinal = Number(kf); const hidden = localStorage.getItem('maxrota_valuesHidden'); if(hidden) state.valuesHidden = hidden === 'true'; }catch(e){console.warn(e);} }
    loadLocal();

    // --- firestore sync logic ---
    let currentUid = null;
    let unsubRemote = null;
    // debounce function (throttle writes)
    function debounce(fn, wait=900){
      let t;
      return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); };
    }
    const saveUserStateDebounced = debounce(async () => {
      if(!currentUid) return;
      try{ await saveUserState(currentUid, state); }catch(e){ console.warn('saveUserState fail', e); }
    }, 800);

    // merge remote -> local safely (do not override while user typing)
    function applyRemoteState(remote){
      if(!remote) return;
      // merge: keep local editing if focused
      const active = document.activeElement;
      // we will copy over everything except if the user is focused in that field
      const safeCopy = Object.assign({}, state, remote);
      // preserve fields the user is actively editing
      if(active && (active === metaInput)) safeCopy.meta = state.meta;
      if(active && (active === kmInicialEl)) safeCopy.kmInicial = state.kmInicial;
      if(active && (active === kmFinalEl)) safeCopy.kmFinal = state.kmFinal;
      // now replace local
      state = safeCopy;
      saveLocal();
      renderAll();
    }

    // start listening to remote doc for this user
    function startRemoteSync(uid){
      if(unsubRemote) unsubRemote();
      unsubRemote = listenUserState(uid, (remoteState)=>{
        if(!remoteState) {
          // first time: push local state to cloud
          saveUserState(uid, state).catch(()=>{});
        } else {
          // apply remote changes
          applyRemoteState(remoteState);
        }
      });
    }

    // auth hookup
    onAuthStateChanged(auth, user=>{
      if(user){
        currentUid = user.uid;
        startRemoteSync(currentUid);
        // add logout handler
        logoutBtn.addEventListener('click', async ()=>{ try{ await signOut(auth); location.href='login.html'; }catch(e){console.error(e);} });
      } else {
        currentUid = null;
        if(unsubRemote) unsubRemote();
        unsubRemote = null;
      }
    });

    // --- RADIO player ---
    function setActiveStation(btn){
      stationBtns.forEach(b=>b.classList.remove('active'));
      if(btn) btn.classList.add('active');
    }
    stationBtns.forEach(btn=>btn.addEventListener('click', async ()=>{
      try{ radioPlayer.pause(); }catch(e){}
      radioPlayer.src = '';
      const url = btn.dataset.src; const name = btn.dataset.name || 'R√°dio';
      setActiveStation(btn); nowPlaying.textContent = 'Carregando: ' + name;
      try{ radioPlayer.src = url; radioPlayer.load(); await radioPlayer.play(); nowPlaying.textContent = 'Tocando: ' + name; }catch(err){ nowPlaying.textContent = 'Falha ao tocar ' + name; setActiveStation(null); }
    }));
    stopRadioBtn.addEventListener('click', ()=>{ try{ radioPlayer.pause(); radioPlayer.removeAttribute('src'); radioPlayer.load(); }catch(e){} nowPlaying.textContent='Nenhuma r√°dio selecionada.'; setActiveStation(null); });
    radioPlayer.addEventListener('error', ()=>{ nowPlaying.textContent='Erro ao carregar esta√ß√£o.'; setActiveStation(null); });

    // --- TIMER & KM ---
    let timerInterval = null;
    function getTempoTotal(){ let t = Number(state.totalTimeWorked||0); if(state.status==='running' && state.lastStartTime) t += (Date.now() - state.lastStartTime); return t; }
    function getKMRodados(){ const ini = Number(state.kmInicial||0), fim = Number(state.kmFinal||0); return (fim>ini)?(fim-ini):0; }

    function startTimer(){ stopTimer(); if(!state.lastStartTime) state.lastStartTime = Date.now(); timerInterval = setInterval(()=>{ tempoTrabalhado.textContent = formatTime(getTempoTotal()); updateDerivedMetrics(); }, 1000); }
    function stopTimer(){ if(timerInterval){ clearInterval(timerInterval); timerInterval = null; } }

    toggleStartBtn.addEventListener('click', ()=>{
      if(state.status==='stopped'){ state.status='running'; state.lastStartTime = Date.now(); toggleStartBtn.textContent='Pausar'; startTimer(); }
      else if(state.status==='running'){ state.totalTimeWorked += (Date.now() - state.lastStartTime); state.lastStartTime = null; state.status = 'paused'; toggleStartBtn.textContent='Retomar'; stopTimer(); }
      else if(state.status==='paused'){ state.status = 'running'; state.lastStartTime = Date.now(); toggleStartBtn.textContent='Pausar'; startTimer(); }
      saveLocal(); saveUserStateDebounced();
      renderAll();
    });

    finalizeBtn.addEventListener('click', ()=>{
      if(state.status==='running'){ state.totalTimeWorked += (Date.now() - state.lastStartTime); state.lastStartTime = null; }
      const tempoFinal = getTempoTotal(); const kmDia = getKMRodados();
      state.status = 'stopped';
      stopTimer();
      // Append small resumo card near finalize button
      const existing = finalizeBtn.parentElement.querySelector('.day-resume-card'); if(existing) existing.remove();
      const resumoCard = document.createElement('div'); resumoCard.className='day-resume-card'; resumoCard.style.marginTop='10px'; resumoCard.style.padding='8px'; resumoCard.style.background='rgba(255,255,255,0.03)'; resumoCard.style.borderRadius='8px';
      resumoCard.innerHTML = `<b>Dia Finalizado</b><br>Tempo Trabalhado: ${formatTime(tempoFinal)}<br>KM Rodado: ${formatKM(kmDia)}`;
      finalizeBtn.parentElement.appendChild(resumoCard);
      // zero timer totals (but keep day in history if user wants)
      state.totalTimeWorked = 0;
      state.lastStartTime = null;
      saveLocal();
      saveUserStateDebounced();
      renderAll();
    });

    saveKmBtn.addEventListener('click', ()=>{
      // read and persist
      state.kmInicial = Number(kmInicialEl.value) || 0;
      state.kmFinal = Number(kmFinalEl.value) || 0;
      localStorage.setItem('maxrota_kmInicial', state.kmInicial);
      localStorage.setItem('maxrota_kmFinal', state.kmFinal);
      saveLocal();
      saveUserStateDebounced();
      renderAll();
    });

    // --- LAN√áAMENTOS (entradas/saidas) ---
    function addLancamento({type,value,category}){
      const item = { id: uid(), type, value: Number(value), category, date: new Date().toISOString() };
      if(type === 'ganho'){
        if(category === 'Loja'){ state.ganhosLoja += item.value; state.entradasLoja++; }
        else if(category === 'Doa√ß√£o'){ state.totalDoacao += item.value; }
        else { state.ganhosApps += item.value; state.entradasApps++; }
      } else {
        state.gastos += item.value;
      }
      state.history.unshift(item);
      saveLocal();
      saveUserStateDebounced();
      // clear input quickly
      valorEntrada.value=''; valorSaida.value='';
      renderAll();
    }

    $('#addEntradaBtn').addEventListener('click', ()=>{ const v = Number(valorEntrada.value); if(isNaN(v)||v<=0){ alert('Valor inv√°lido'); return; } addLancamento({type:'ganho',value:v,category:'Particular'}); });
    $('#addSaidaBtn').addEventListener('click', ()=>{ const v = Number(valorSaida.value); if(isNaN(v)||v<=0){ alert('Valor inv√°lido'); return; } addLancamento({type:'gasto',value:v,category:'Outros'}); });

    appBtns.forEach(b=>b.addEventListener('click', ()=>{ const v = Number(valorEntrada.value); if(isNaN(v)||v<=0){ alert('Valor inv√°lido'); return; } addLancamento({type:'ganho',value:v,category:b.dataset.cat}); }));
    gastoBtns.forEach(b=>b.addEventListener('click', ()=>{ const v = Number(valorSaida.value); if(isNaN(v)||v<=0){ alert('Valor inv√°lido'); return; } addLancamento({type:'gasto',value:v,category:b.dataset.cat}); }));

    // edit/delete handlers created in renderLancamentos()

    // --- RENDER / METRICS ---
    function renderLancamentos(){
      if(!state.history || state.history.length===0){ lancamentosList.innerHTML = '<div class="muted small text-center">Nenhum lan√ßamento ainda.</div>'; return; }
      lancamentosList.innerHTML = '';
      state.history.slice(0,200).forEach(it=>{
        const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.padding='8px 4px'; el.style.borderBottom='1px solid rgba(255,255,255,0.03)';
        const left = document.createElement('div'); left.style.fontWeight='800';
        const valueSpan = document.createElement('span'); valueSpan.textContent = (it.type==='ganho'?'+':'-') + ' ' + formatBRL(it.value);
        if(state.valuesHidden) valueSpan.classList.add('hidden-value');
        left.innerHTML = `${it.category}: `;
        left.appendChild(valueSpan);
        const right = document.createElement('div');
        const edit = document.createElement('button'); edit.className='btn-ghost'; edit.textContent='‚úèÔ∏è'; edit.style.marginRight='6px';
        const del = document.createElement('button'); del.className='btn-ghost'; del.textContent='üóëÔ∏è';
        right.appendChild(edit); right.appendChild(del);
        el.appendChild(left); el.appendChild(right);
        lancamentosList.appendChild(el);

        edit.addEventListener('click', ()=>{
          const novoStr = prompt('Novo valor (R$):', it.value.toFixed(2));
          if(novoStr===null) return;
          const novo = Number(novoStr);
          if(isNaN(novo)||novo<0){ alert('Valor inv√°lido'); return; }
          // revert old totals
          if(it.type==='ganho'){
            if(it.category==='Loja') state.ganhosLoja -= it.value;
            else if(it.category==='Doa√ß√£o') state.totalDoacao -= it.value;
            else state.ganhosApps -= it.value;
          } else state.gastos -= it.value;
          // apply new
          it.value = novo;
          if(it.type==='ganho'){
            if(it.category==='Loja') state.ganhosLoja += it.value;
            else if(it.category==='Doa√ß√£o') state.totalDoacao += it.value;
            else state.ganhosApps += it.value;
          } else state.gastos += it.value;
          saveLocal(); saveUserStateDebounced(); renderAll();
        });

        del.addEventListener('click', ()=>{
          if(!confirm('Excluir lan√ßamento?')) return;
          state.history = state.history.filter(x=>x.id !== it.id);
          recalcTotalsFromHistory();
          saveLocal(); saveUserStateDebounced(); renderAll();
        });
      });
    }

    function recalcTotalsFromHistory(){
      state.ganhosApps=0; state.ganhosLoja=0; state.totalDoacao=0; state.gastos=0; state.entradasApps=0; state.entradasLoja=0;
      state.history.forEach(it=>{
        if(it.type === 'ganho'){
          if(it.category==='Loja'){ state.ganhosLoja += it.value; state.entradasLoja++; }
          else if(it.category==='Doa√ß√£o'){ state.totalDoacao += it.value; }
          else { state.ganhosApps += it.value; state.entradasApps++; }
        } else state.gastos += it.value;
      });
    }

    function renderResumoCategorias(){
      const totals = {}, counts = {};
      state.history.forEach(it=>{ if(it.type!=='ganho') return; const c = it.category||'Outros'; totals[c] = (totals[c]||0) + it.value; counts[c] = (counts[c]||0) + 1; });
      resumoCategorias.innerHTML = '';
      const order = ['Uber','99','inDriver','Particular','Loja','Doa√ß√£o'];
      order.forEach(cat=>{
        const val = totals[cat]||0, cnt = counts[cat]||0;
        const node = document.createElement('div'); node.style.padding='8px'; node.style.background='rgba(255,255,255,0.02)'; node.style.borderRadius='8px';
        const v = document.createElement('div'); v.style.fontWeight='800'; v.textContent = formatBRL(val); if(state.valuesHidden) v.classList.add('hidden-value');
        node.innerHTML = `<div style="font-weight:900">${cat}</div>`;
        node.appendChild(v);
        node.innerHTML += `<div class="small muted">${cnt} entr.</div>`;
        resumoCategorias.appendChild(node);
      });
      Object.keys(totals).forEach(cat=>{
        if(order.includes(cat)) return;
        const node = document.createElement('div'); node.style.padding='8px'; node.style.background='rgba(255,255,255,0.02)'; node.style.borderRadius='8px';
        const v = document.createElement('div'); v.style.fontWeight='800'; v.textContent = formatBRL(totals[cat]); if(state.valuesHidden) v.classList.add('hidden-value');
        node.innerHTML = `<div style="font-weight:900">${cat}</div>`;
        node.appendChild(v);
        node.innerHTML += `<div class="small muted">${counts[cat]||0} entr.</div>`;
        resumoCategorias.appendChild(node);
      });
    }

    function updateDerivedMetrics(){
      const totalBruto = Number(state.ganhosApps||0)+Number(state.ganhosLoja||0)+Number(state.totalDoacao||0);
      const lucro = totalBruto - Number(state.gastos||0);
      metricGanhosApps.textContent = formatBRL(state.ganhosApps);
      metricGastosTotal.textContent = formatBRL(state.gastos);
      metricLucroTotal.textContent = formatBRL(lucro);

      // apply hidden
      [metricGanhosApps, metricGastosTotal, metricLucroTotal].forEach(el=>{
        if(state.valuesHidden) el.classList.add('hidden-value'); else el.classList.remove('hidden-value');
      });

      tempoTrabalhado.textContent = formatTime(getTempoTotal());
      kmRodados.textContent = formatKM(getKMRodados());
      renderResumoFinal();
      updateProgressBar();
    }

    function updateProgressBar(){
      const meta = Number(state.meta||0);
      const atual = state.ganhosApps + state.ganhosLoja;
      if(!meta){ progressBar.style.width='0%'; progressText.textContent='0%'; metaMessage.textContent='Defina a meta para acompanhar o progresso.'; return; }
      const pct = Math.min(100, (atual/meta)*100);
      progressBar.style.width = pct + '%';
      progressText.textContent = Math.round(pct) + '%';
      if(atual < meta) metaMessage.textContent = `Faltam ${formatBRL(meta - atual)} para bater a meta.`;
      else metaMessage.textContent = `Meta batida! (+${formatBRL(atual - meta)})`;
    }

    function renderResumoFinal(){
      const totalApps = state.ganhosApps; const totalLoja = state.ganhosLoja; const totalDoacao = state.totalDoacao;
      const lucro = totalApps + totalLoja + totalDoacao - state.gastos;
      finalTotalApps.textContent = formatBRL(totalApps);
      finalTotalLoja.textContent = formatBRL(totalLoja);
      finalTotalDoacao.textContent = formatBRL(totalDoacao);
      finalTotalGeral.textContent = formatBRL(lucro);
      [finalTotalApps, finalTotalLoja, finalTotalDoacao, finalTotalGeral].forEach(el=>{
        if(state.valuesHidden) el.classList.add('hidden-value'); else el.classList.remove('hidden-value');
      });
    }

    // --- TOGGLE VALORES ---
    toggleValuesBtn.addEventListener('click', ()=>{
      state.valuesHidden = !state.valuesHidden;
      localStorage.setItem('maxrota_valuesHidden', state.valuesHidden);
      toggleValuesBtn.textContent = state.valuesHidden ? 'Mostrar Valores' : 'Esconder Valores';
      saveLocal();
      saveUserStateDebounced();
      renderAll();
    });

    // --- SET META (save) ---
    setMetaBtn.addEventListener('click', ()=>{
      const v = Number(metaInput.value);
      if(isNaN(v) || v <= 0){ alert('Meta inv√°lida'); return; }
      state.meta = v;
      localStorage.setItem('maxrota_meta', v);
      saveLocal();
      saveUserStateDebounced();
      renderAll();
    });

    // --- SAVE & RESET (tamb√©m salva em collection days) ---
    saveAndResetBtn.addEventListener('click', async ()=>{
      if(!confirm('Deseja salvar o resumo do dia e resetar todos os dados atuais?')) return;
      const totalBruto = state.ganhosApps + state.ganhosLoja + state.totalDoacao;
      const lucro = totalBruto - state.gastos;
      const tempo = getTempoTotal();
      const km = getKMRodados();
      const mediaHora = tempo>0 ? totalBruto / (tempo/(1000*60*60)) : 0;
      const resumo = { meta: state.meta, kmInicial: state.kmInicial, kmFinal: state.kmFinal, ganhosApps: state.ganhosApps, ganhosLoja: state.ganhosLoja, ganhoDoacao: state.totalDoacao, entradasApps: state.entradasApps, entradasLoja: state.entradasLoja, gastos: state.gastos, lucro, tempo, km, mediaHora, history: state.history.slice(0,500) };

      // save to Firestore collection days (so each user has days)
      if(currentUid) {
        try { await saveDayForUser(currentUid, resumo); } catch(e){ console.warn(e); }
      }

      // reset local state (keep valuesHidden)
      const keepHidden = state.valuesHidden;
      state = { meta:0, ganhosApps:0, ganhosLoja:0, totalDoacao:0, entradasApps:0, entradasLoja:0, gastos:0, history:[], kmInicial:0, kmFinal:0, totalTimeWorked:0, lastStartTime:null, status:'stopped', celebrated:false, valuesHidden: keepHidden };
      localStorage.removeItem('maxrota_meta');
      localStorage.removeItem('maxrota_kmInicial');
      localStorage.removeItem('maxrota_kmFinal');
      saveLocal();
      saveUserStateDebounced();
      renderAll();
    });

    // export JSON
    exportBtn.addEventListener('click', ()=>{
      const data = { state, days: JSON.parse(localStorage.getItem('maxrota_days')||'[]') };
      const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download='maxrota_export.json'; a.click(); URL.revokeObjectURL(url);
    });

    // view history (local days backup)
    viewHistoryBtn.addEventListener('click', ()=>{
      const arr = JSON.parse(localStorage.getItem('maxrota_days')||'[]');
      if(!arr || arr.length===0){ historyPanel.style.display='block'; historyPanel.textContent='Nenhum dia salvo.'; return; }
      historyPanel.style.display = historyPanel.style.display === 'block' ? 'none' : 'block';
      historyPanel.innerHTML = arr.map(d=>{
        const date = new Date(d.date || d.id || Date.now());
        return `<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)"><div style="font-weight:800">${date.toLocaleString()}</div><div class="small muted">Lucro: ${formatBRL(d.lucro)} ¬∑ KM: ${d.km}</div></div>`;
      }).join('');
    });

    // --- renderAll & periodic update ---
    function renderAll(){
      // protect not to overwrite while typing
      if(document.activeElement !== metaInput) metaInput.value = state.meta || '';
      if(document.activeElement !== kmInicialEl) kmInicialEl.value = state.kmInicial || '';
      if(document.activeElement !== kmFinalEl) kmFinalEl.value = state.kmFinal || '';
      if(state.status==='running') toggleStartBtn.textContent='Pausar'; else if(state.status==='paused') toggleStartBtn.textContent='Retomar'; else toggleStartBtn.textContent='Iniciar Expediente';
      renderLancamentos(); renderResumoCategorias(); updateDerivedMetrics();
      // save local always
      saveLocal();
    }

    // initial render
    renderAll();

    // sync local changes to firestore periodically
    setInterval(()=>{ saveUserStateDebounced(); }, 3000);

    // when remote updates arrive (listener in firebase.js), applyRemoteState will be called (see startRemoteSync)

    // When page unloads, flush state once
    window.addEventListener('beforeunload', ()=>{ if(currentUid) saveUserState(currentUid, state); });

  </script>
</body>
          </html>
