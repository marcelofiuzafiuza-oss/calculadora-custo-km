<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MAX ROTA DI√ÅRIO ‚Äî Com Firestore</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--accent:#10b981;--bg1:#041226;--bg2:#2a1160;--text:#e6eef6;--muted:#9aa6b2;--card:rgba(255,255,255,0.06);--radius:12px}
    html,body{height:100%;margin:0;padding:18px;font-family:'Inter',system-ui, -apple-system, "Segoe UI", Roboto;color:var(--text);background:linear-gradient(135deg,var(--bg1),var(--bg2))}
    .wrap{max-width:1200px;margin:0 auto}
    .card{background:var(--card);padding:16px;border-radius:12px;margin-bottom:14px;border:1px solid rgba(255,255,255,0.03)}
    h1{margin:0;font-size:20px}
    .small{font-size:13px;color:var(--muted)}
    input,button{font-family:inherit}
    .btn{padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,var(--accent),#7c3aed);border:0;color:#fff;font-weight:700;cursor:pointer}
    .btn-ghost{padding:8px 12px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);cursor:pointer}
    .station-btn{padding:12px;border-radius:10px;color:#fff;font-weight:800;border:0;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;margin:6px;height:48px;min-width:150px}
    .active{box-shadow:0 12px 30px rgba(0,0,0,0.5);transform:translateY(-4px)}
    .apps-grid .app-btn,.gastos-grid .gasto-btn{min-width:120px;padding:12px;border-radius:12px;border:0;font-weight:800;color:#fff;cursor:pointer;margin:6px}
    .launch-list{max-height:260px;overflow:auto}
    .launch-item{display:flex;justify-content:space-between;padding:8px;border-bottom:1px dashed rgba(255,255,255,0.04)}
    .metric-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
    .metric-col{background:rgba(255,255,255,0.03);padding:12px;border-radius:10px}
    .progress-container{height:40px;border-radius:20px;background:rgba(255,255,255,0.03);position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.04)}
    .progress-bar{position:absolute;left:0;top:0;height:100%;background:linear-gradient(120deg,var(--accent),#2563eb);width:0%;transition:width .6s}
    .progress-text{position:absolute;right:8px;top:8px;font-weight:800;color:#012}
    .muted{color:var(--muted)}
    @media(max-width:900px){ .radio-grid{display:grid;grid-template-columns:repeat(2,1fr)} .apps-grid{display:flex;flex-wrap:wrap} }
  </style>
</head>
<body>
  <div class="wrap">

    <header class="card" id="headerCard">
      <div style="display:flex;align-items:center;gap:12px">
        <img src="https://i.postimg.cc/3RWn008g/Chat-GPT-Image-12-de-nov-de-2025-14-32-56.png" alt="MAX ROTA DI√ÅRIO" style="height:64px;border-radius:8px">
        <div>
          <h1>MAX ROTA DI√ÅRIO</h1>
          <div class="small muted">Painel sincronizado ‚Äî Firestore</div>
        </div>
      </div>
      <div style="float:right;margin-top:-56px">
        <button id="signOutBtn" class="btn-ghost">Sair</button>
      </div>
    </header>

    <!-- R√°dio -->
    <section class="card">
      <h2>üéß Esta√ß√µes</h2>
      <div id="stationButtons" class="radio-grid"></div>
      <div style="margin-top:10px;display:flex;align-items:center;gap:12px">
        <audio id="radioPlayer" controls preload="none" style="flex:1"></audio>
        <button id="stopRadioBtn" class="btn-ghost">Parar R√°dio</button>
      </div>
      <div id="nowPlaying" class="small muted" style="margin-top:8px">Nenhuma r√°dio selecionada.</div>
    </section>

    <!-- Meta -->
    <section class="card">
      <h2>üéØ Meta Di√°ria</h2>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="metaInput" type="number" placeholder="Ex: 300" style="flex:1;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);color:inherit">
        <button id="setMetaBtn" class="btn">Salvar Meta</button>
      </div>
      <div class="progress-container" style="margin-top:12px">
        <div id="progressBar" class="progress-bar"></div>
        <div id="progressText" class="progress-text">0%</div>
      </div>
      <div id="metaMessage" class="small muted" style="margin-top:8px">Defina a meta para acompanhar o progresso.</div>
    </section>

    <!-- KM & Timer -->
    <section class="card">
      <h2>üöó Jornada e KM</h2>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px">
        <div>
          <label class="small muted">KM Inicial</label>
          <input id="kmInicial" type="number" placeholder="150000" style="width:100%;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04)">
        </div>
        <div>
          <label class="small muted">KM Final</label>
          <input id="kmFinal" type="number" placeholder="150250" style="width:100%;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04)">
        </div>
        <div>
          <label class="small muted">Tempo Trabalhado</label>
          <div id="tempoTrabalhado" style="font-weight:800;font-size:18px">00:00:00</div>
        </div>
        <div>
          <label class="small muted">KM Rodados</label>
          <div id="kmRodados" style="font-weight:800;font-size:18px">0.0 km</div>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="toggleStartBtn" class="btn">Iniciar Expediente</button>
        <button id="saveKmBtn" class="btn">Salvar KM</button>
        <button id="finalizeBtn" class="btn-ghost">Finalizar Dia</button>
      </div>
    </section>

    <!-- Lan√ßamentos -->
    <section class="card">
      <div style="display:flex;gap:18px">
        <div style="flex:1">
          <h3>‚ûï Entradas (Apps)</h3>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="valorEntrada" type="number" placeholder="Valor (R$)" style="flex:1;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04)">
            <button id="addEntradaBtn" class="btn">Lan√ßar</button>
          </div>
          <div class="apps-grid" style="margin-top:10px">
            <!-- Buttons added by JS for clarity -->
          </div>
        </div>

        <div style="flex:1">
          <h3>‚ûñ Sa√≠das (Gastos)</h3>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="valorSaida" type="number" placeholder="Valor (R$)" style="flex:1;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04)">
            <button id="addSaidaBtn" class="btn">Lan√ßar</button>
          </div>
          <div class="gastos-grid" style="margin-top:10px">
            <!-- Buttons added by JS -->
          </div>
        </div>
      </div>
    </section>

    <!-- Lan√ßamentos recentes -->
    <section class="card">
      <h3>Lan√ßamentos Recentes</h3>
      <div id="lancamentosList" class="launch-list" style="margin-top:8px">
        <div class="muted small">Carregando...</div>
      </div>
    </section>

    <!-- Resumo / M√©tricas -->
    <section class="card">
      <h3>M√©tricas & Resumo Final</h3>
      <div class="metric-grid" style="margin-top:10px">
        <div class="metric-col"><div class="small muted">Ganhos Brutos ‚Äî Somente Apps</div><div id="metricGanhosApps" style="font-weight:800">R$ 0,00</div></div>
        <div class="metric-col"><div class="small muted">Ganhos Brutos ‚Äî Apps + Loja</div><div id="metricGanhosTotal" style="font-weight:800">R$ 0,00</div></div>
        <div class="metric-col"><div class="small muted">Gastos Totais</div><div id="metricGastosTotal" style="font-weight:800">R$ 0,00</div></div>
        <div class="metric-col"><div class="small muted">Lucro L√≠quido</div><div id="metricLucroTotal" style="font-weight:800">R$ 0,00</div></div>
        <div class="metric-col"><div class="small muted">M√©dia/Hora (Bruto)</div><div id="metricMediaHoraBrutoTotal" style="font-weight:800">R$ 0,00</div></div>
        <div class="metric-col"><div class="small muted">M√©dia/Hora (L√≠quido)</div><div id="metricMediaHoraLiqTotal" style="font-weight:800">R$ 0,00</div></div>
        <div class="metric-col"><div class="small muted">Lucro / KM (L√≠quido)</div><div id="metricLucroKmTotal" style="font-weight:800">R$ 0,00</div></div>
        <div class="metric-col"><div class="small muted">Entradas Apps</div><div id="metricEntradasApps" style="font-weight:800">0</div></div>
      </div>
    </section>

    <section class="card">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="saveAndResetBtn" class="btn">Salvar Resumo & Resetar Dia</button>
        <button id="exportBtn" class="btn-ghost">Exportar (JSON)</button>
        <button id="viewHistoryBtn" class="btn-ghost">Ver Hist√≥rico de Dias</button>
      </div>
      <div id="historyPanel" style="margin-top:12px;display:none"></div>
    </section>

    <footer class="small muted" style="text-align:center">Dados sincronizados por usu√°rio no Firestore.</footer>
  </div>

  <!-- Firebase v9 modular via CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    /*******************************
     * CONFIGURA√á√ÉO FIREBASE
     * Substitua se necess√°rio - use o config do seu projeto
     *******************************/
    const firebaseConfig = {
      apiKey: "AIzaSyBXkQlm0TbCsCdVGil8-5kGWbtj07SKXwA",
      authDomain: "maxrota.firebaseapp.com",
      projectId: "maxrota",
      storageBucket: "maxrota.firebasestorage.app",
      messagingSenderId: "425002957978",
      appId: "1:425002957978:web:1e4f38239e552de452f323",
      measurementId: "G-RBK7LM483D"
    };

    // initialize compat (mais simples para este HTML √∫nico)
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    /*******************************
     * ELEMENTOS & ESTADO
     *******************************/
    const stationButtonsContainer = document.getElementById('stationButtons');
    const radioPlayer = document.getElementById('radioPlayer');
    const nowPlaying = document.getElementById('nowPlaying');
    const stopRadioBtn = document.getElementById('stopRadioBtn');
    const metaInput = document.getElementById('metaInput');
    const setMetaBtn = document.getElementById('setMetaBtn');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const metaMessage = document.getElementById('metaMessage');
    const kmInicialEl = document.getElementById('kmInicial');
    const kmFinalEl = document.getElementById('kmFinal');
    const tempoTrabalhadoEl = document.getElementById('tempoTrabalhado');
    const kmRodadosEl = document.getElementById('kmRodados');
    const toggleStartBtn = document.getElementById('toggleStartBtn');
    const saveKmBtn = document.getElementById('saveKmBtn');
    const finalizeBtn = document.getElementById('finalizeBtn');
    const valorEntradaEl = document.getElementById('valorEntrada');
    const addEntradaBtn = document.getElementById('addEntradaBtn');
    const valorSaidaEl = document.getElementById('valorSaida');
    const addSaidaBtn = document.getElementById('addSaidaBtn');
    const lancamentosList = document.getElementById('lancamentosList');
    const appsGrid = document.querySelector('.apps-grid');
    const gastosGrid = document.querySelector('.gastos-grid');
    const metricGanhosApps = document.getElementById('metricGanhosApps');
    const metricGanhosTotal = document.getElementById('metricGanhosTotal');
    const metricGastosTotal = document.getElementById('metricGastosTotal');
    const metricLucroTotal = document.getElementById('metricLucroTotal');
    const metricMediaHoraBrutoTotal = document.getElementById('metricMediaHoraBrutoTotal');
    const metricMediaHoraLiqTotal = document.getElementById('metricMediaHoraLiqTotal');
    const metricLucroKmTotal = document.getElementById('metricLucroKmTotal');
    const metricEntradasApps = document.getElementById('metricEntradasApps');
    const saveAndResetBtn = document.getElementById('saveAndResetBtn');
    const exportBtn = document.getElementById('exportBtn');
    const viewHistoryBtn = document.getElementById('viewHistoryBtn');
    const historyPanel = document.getElementById('historyPanel');
    const signOutBtn = document.getElementById('signOutBtn');

    // esta√ß√£o padr√£o ‚Äî lista testada (Hunter + SomaFM + alternativos)
    const stations = [
      {name:'Hunter Pop', src:'https://live.hunter.fm/pop_high', color:'#10b981'},
      {name:'Hunter Pop2K', src:'https://live.hunter.fm/pop2k_high', color:'#06b6d4'},
      {name:'Flashback 80s', src:'https://ice1.somafm.com/u80s-128-mp3', color:'#8b5cf6'},
      {name:'Rock Classic', src:'https://live.hunter.fm/rock_high', color:'#ef4444'},
      {name:'HipHop (Hunter)', src:'https://live.hunter.fm/hiphop_high', color:'#111827'},
      {name:'Sertanejo', src:'https://live.hunter.fm/sertanejo_high', color:'#f59e0b'},
      {name:'Eletr√¥nica (GrooveSalad)', src:'https://ice1.somafm.com/groovesalad-128-mp3', color:'#2563eb'},
      {name:'House / BeatBlender', src:'https://ice1.somafm.com/beatblender-128-mp3', color:'#7c3aed'},
      {name:'Surf / SecretAgent', src:'https://ice1.somafm.com/secretagent-128-mp3', color:'#06b6d4'},
      {name:'Reggae / Dub', src:'https://ice1.somafm.com/dubstep-128-mp3', color:'#4ade80'},
      {name:'MPB Brasil', src:'https://live.hunter.fm/mpb_high', color:'#1e3a8a'},
      {name:'Radio Paradise', src:'https://stream.radioparadise.com/mp3-192', color:'#0ea5e9'}
    ];

    // app buttons config
    const appButtonsConfig = [
      {cat:'Uber', color:'#000'},
      {cat:'99', color:'#facc15', textColor:'#111'},
      {cat:'inDriver', color:'#10b981'},
      {cat:'Particular', color:'#6b7280'},
      {cat:'Loja', color:'#1e3a8a'},
      {cat:'Doa√ß√£o', color:'#8b5cf6'}
    ];
    const gastoButtonsConfig = [
      {cat:'Combust√≠vel', color:'#ef4444'},
      {cat:'Alimenta√ß√£o', color:'#8b5cf6'},
      {cat:'Manuten√ß√£o', color:'#6b7280'},
      {cat:'Outros', color:'#374151'}
    ];

    // application state (client-side mirror)
    let uid = null;
    let userState = {
      meta:0,
      ganhosApps:0,
      ganhosLoja:0,
      totalDoacao:0,
      entradasApps:0,
      entradasLoja:0,
      gastos:0,
      history:[],
      kmInicial:0,
      kmFinal:0,
      totalTimeWorked:0,
      lastStartTime:null,
      status:'stopped',
      celebrated:false
    };

    let timerInterval = null;
    let unsubStateListener = null;
    let unsubLancamentosListener = null;

    /*******************************
     * UI: montar r√°dios e bot√µes
     *******************************/
    function buildUI(){
      stationButtonsContainer.innerHTML = '';
      stations.forEach(s=>{
        const b = document.createElement('button');
        b.className = 'station-btn';
        b.style.background = s.color;
        b.textContent = s.name;
        b.dataset.src = s.src;
        b.addEventListener('click', ()=>playStation(b));
        stationButtonsContainer.appendChild(b);
      });

      // apps buttons
      appsGrid.innerHTML = '';
      appButtonsConfig.forEach(a=>{
        const btn = document.createElement('button');
        btn.className = 'app-btn';
        btn.style.background = a.color;
        if(a.textColor) btn.style.color = a.textColor;
        btn.dataset.cat = a.cat;
        btn.textContent = a.cat;
        btn.addEventListener('click', ()=>onAppButtonClick(a.cat));
        appsGrid.appendChild(btn);
      });

      gastosGrid.innerHTML = '';
      gastoButtonsConfig.forEach(g=>{
        const btn = document.createElement('button');
        btn.className = 'gasto-btn';
        btn.style.background = g.color;
        btn.dataset.cat = g.cat;
        btn.textContent = g.cat;
        btn.addEventListener('click', ()=>onGastoButtonClick(g.cat));
        gastosGrid.appendChild(btn);
      });
    }

    buildUI();

    /*******************************
     * RADIO HANDLERS
     *******************************/
    function clearActiveStations(){ Array.from(document.querySelectorAll('.station-btn')).forEach(b=>b.classList.remove('active')); }
    async function playStation(btn){
      const src = btn.dataset.src;
      const name = btn.textContent;
      clearActiveStations();
      btn.classList.add('active');
      nowPlaying.textContent = 'Carregando: ' + name;
      try{ radioPlayer.pause(); }catch(e){}
      radioPlayer.src = src;
      try{ await radioPlayer.play(); nowPlaying.textContent = 'Tocando: ' + name; }catch(err){ console.warn(err); nowPlaying.textContent = 'Falha ao tocar ' + name; btn.classList.remove('active'); }
    }
    stopRadioBtn.addEventListener('click', ()=>{
      try{ radioPlayer.pause(); radioPlayer.removeAttribute('src'); radioPlayer.load(); }catch(e){}
      nowPlaying.textContent = 'Nenhuma r√°dio selecionada.'; clearActiveStations();
    });

    /*******************************
     * AUTH / FIRESTORE LISTENERS
     *******************************/
    // redirect to login if not authenticated
    auth.onAuthStateChanged(async (user) => {
      if(user){
        uid = user.uid;
        console.log('Usu√°rio logado', user.email || uid);
        attachUserListeners();
      } else {
        // not logged in -> go to login page
        window.location.href = 'login.html';
      }
    });

    // sign out
    signOutBtn.addEventListener('click', ()=>{ auth.signOut(); });

    // attach realtime listeners for the logged user
    function attachUserListeners(){
      // unsubscribe previous if any
      if(unsubStateListener) unsubStateListener();
      if(unsubLancamentosListener) unsubLancamentosListener();

      const docRef = db.collection('users').doc(uid).collection('meta').doc('state'); // nested location to be safe
      unsubStateListener = docRef.onSnapshot(doc => {
        if(!doc.exists) {
          // if none, create initial doc from local fallback
          docRef.set(userState, {merge:true}).catch(()=>{});
          return;
        }
        const data = doc.data() || {};
        // merge remote into local userState
        Object.assign(userState, data);
        // ensure arrays are present
        userState.history = userState.history || [];
        // render UI
        updateUIFromState();
      }, err => console.error('state listener error', err));

      // listen to lancamentos collection (real-time)
      const lancRef = db.collection('users').doc(uid).collection('lancamentos').orderBy('date','desc');
      unsubLancamentosListener = lancRef.onSnapshot(snapshot => {
        // rebuild history from lancamentos collection
        const arr = [];
        snapshot.forEach(doc => arr.push(Object.assign({id:doc.id}, doc.data())));
        // set local history and recalc totals
        userState.history = arr;
        recalcTotalsFromHistory();
        updateUIFromState();
      }, err => console.error('lancamentos listener error', err));
    }

    /*******************************
     * SAVE / LOAD helpers (Firestore)
     *******************************/
    function saveStateToFirestore(){
      if(!uid) return;
      const docRef = db.collection('users').doc(uid).collection('meta').doc('state');
      // clone state but don't include heavy fields not needed
      const safe = {
        meta: userState.meta || 0,
        ganhosApps: userState.ganhosApps || 0,
        ganhosLoja: userState.ganhosLoja || 0,
        totalDoacao: userState.totalDoacao || 0,
        entradasApps: userState.entradasApps || 0,
        entradasLoja: userState.entradasLoja || 0,
        gastos: userState.gastos || 0,
        kmInicial: userState.kmInicial || 0,
        kmFinal: userState.kmFinal || 0,
        totalTimeWorked: userState.totalTimeWorked || 0,
        lastStartTime: userState.lastStartTime || null,
        status: userState.status || 'stopped',
        celebrated: userState.celebrated || false
      };
      return docRef.set(safe, {merge:true}).catch(e=>console.error('save state failed', e));
    }

    // lancamento: writes to collection users/{uid}/lancamentos
    function addLancamentoToFirestore(item){
      if(!uid) return;
      const col = db.collection('users').doc(uid).collection('lancamentos');
      return col.add(item).catch(e=>console.error('add lancamento failed', e));
    }

    // delete lancamento
    function deleteLancamentoFirestore(id){
      if(!uid) return;
      const doc = db.collection('users').doc(uid).collection('lancamentos').doc(id);
      return doc.delete().catch(e=>console.error('delete lancamento failed', e));
    }

    // edit lancamento (update)
    function updateLancamentoFirestore(id, updates){
      if(!uid) return;
      const doc = db.collection('users').doc(uid).collection('lancamentos').doc(id);
      return doc.update(updates).catch(e=>console.error('update lancamento failed', e));
    }

    // save day summary (to collection days)
    async function saveDaySummaryFirestore(){
      if(!uid) return;
      const daysCol = db.collection('users').doc(uid).collection('dias');
      const totalBruto = (userState.ganhosApps||0) + (userState.ganhosLoja||0) + (userState.totalDoacao||0);
      const lucro = totalBruto - (userState.gastos||0);
      const tempo = getTempoTotal();
      const km = getKMRodados();
      const mediaHora = tempo>0 ? totalBruto/(tempo/(1000*60*60)) : 0;
      const resumo = {
        date: new Date().toISOString(),
        meta: userState.meta || 0,
        kmInicial: userState.kmInicial || 0,
        kmFinal: userState.kmFinal || 0,
        ganhosApps: userState.ganhosApps || 0,
        ganhosLoja: userState.ganhosLoja || 0,
        ganhoDoacao: userState.totalDoacao || 0,
        entradasApps: userState.entradasApps || 0,
        entradasLoja: userState.entradasLoja || 0,
        gastos: userState.gastos || 0,
        lucro,
        tempo,
        km,
        mediaHora,
        history: userState.history || []
      };
      await daysCol.add(resumo);
    }

    /*******************************
     * TIMERS / KM helpers
     *******************************/
    function getTempoTotal(){
      let t = Number(userState.totalTimeWorked || 0);
      if(userState.status === 'running' && userState.lastStartTime) t += (Date.now() - userState.lastStartTime);
      return t;
    }
    function getKMRodados(){ const ini = Number(userState.kmInicial||0); const fim = Number(userState.kmFinal||0); return (fim>ini)?(fim-ini):0; }

    function startTimerLocal(){
      stopTimerLocal();
      if(!userState.lastStartTime) userState.lastStartTime = Date.now();
      timerInterval = setInterval(()=>{ tempoTrabalhadoEl.textContent = formatTime(getTempoTotal()); updateDerivedMetricsLocal(); }, 1000);
    }
    function stopTimerLocal(){ if(timerInterval){ clearInterval(timerInterval); timerInterval = null; } }

    toggleStartBtn.addEventListener('click', ()=>{
      if(userState.status === 'stopped'){
        userState.status = 'running';
        userState.lastStartTime = Date.now();
        toggleStartBtn.textContent = 'Pausar';
        startTimerLocal();
      } else if(userState.status === 'running'){
        userState.totalTimeWorked = Number(userState.totalTimeWorked || 0) + (Date.now() - userState.lastStartTime);
        userState.lastStartTime = null;
        userState.status = 'paused';
        toggleStartBtn.textContent = 'Retomar';
        stopTimerLocal();
      } else if(userState.status === 'paused'){
        userState.status = 'running';
        userState.lastStartTime = Date.now();
        toggleStartBtn.textContent = 'Pausar';
        startTimerLocal();
      }
      saveStateToFirestore();
    });

    finalizeBtn.addEventListener('click', async ()=>{
      // finalize day: accumulate final time, show small card, save day, reset timer but not delete history until saveAndReset
      if(userState.status === 'running'){
        userState.totalTimeWorked = Number(userState.totalTimeWorked || 0) + (Date.now() - userState.lastStartTime);
        userState.lastStartTime = null;
      }
      userState.status = 'stopped';
      stopTimerLocal();
      saveStateToFirestore();
      // show small card
      const tempoFinal = getTempoTotal();
      const kmDia = getKMRodados();
      const resumoCard = document.createElement('div');
      resumoCard.style.padding = '10px';
      resumoCard.style.marginTop = '10px';
      resumoCard.style.borderRadius = '10px';
      resumoCard.style.background = 'rgba(255,255,255,0.03)';
      resumoCard.innerHTML = `<b>Dia Finalizado</b><br>Tempo Trabalhado: ${formatTime(tempoFinal)}<br>KM Rodado: ${formatKM(kmDia)}`;
      finalizeBtn.parentElement.appendChild(resumoCard);
      // not resetting totals ‚Äî up to user to save day & reset
    });

    saveKmBtn.addEventListener('click', ()=>{
      userState.kmInicial = Number(kmInicialEl.value) || 0;
      userState.kmFinal = Number(kmFinalEl.value) || 0;
      // save persistent
      saveStateToFirestore();
    });

    /*******************************
     * LAN√áAMENTOS UI actions
     *******************************/
    addEntradaBtn.addEventListener('click', ()=> {
      const v = Number(valorEntradaEl.value);
      if(isNaN(v) || v <= 0) return alert('Valor inv√°lido');
      // default category: Particular
      addLancamento({type:'ganho', value:v, category:'Particular'});
      valorEntradaEl.value = '';
    });
    addSaidaBtn.addEventListener('click', ()=> {
      const v = Number(valorSaidaEl.value);
      if(isNaN(v) || v <= 0) return alert('Valor inv√°lido');
      addLancamento({type:'gasto', value:v, category:'Outros'});
      valorSaidaEl.value = '';
    });

    function onAppButtonClick(cat){
      const v = Number(valorEntradaEl.value);
      if(isNaN(v) || v <= 0) return alert('Valor inv√°lido');
      addLancamento({type:'ganho', value:v, category:cat});
      valorEntradaEl.value = '';
    }
    function onGastoButtonClick(cat){
      const v = Number(valorSaidaEl.value);
      if(isNaN(v) || v <= 0) return alert('Valor inv√°lido');
      addLancamento({type:'gasto', value:v, category:cat});
      valorSaidaEl.value = '';
    }

    async function addLancamento(item){
      // item = {type, value, category}
      const doc = {
        type: item.type,
        value: Number(item.value),
        category: item.category || '‚Äî',
        date: new Date().toISOString()
      };
      await addLancamentoToFirestore(doc);
      // Firestore onSnapshot will update UI automatically
    }

    function recalcTotalsFromHistory(){
      userState.ganhosApps = 0; userState.ganhosLoja = 0; userState.totalDoacao = 0; userState.gastos = 0;
      userState.entradasApps = 0; userState.entradasLoja = 0;
      (userState.history||[]).forEach(it=>{
        if(it.type === 'ganho'){
          if(it.category === 'Loja'){ userState.ganhosLoja += it.value; userState.entradasLoja++; }
          else if(it.category === 'Doa√ß√£o'){ userState.totalDoacao += it.value; }
          else { userState.ganhosApps += it.value; userState.entradasApps++; }
        } else {
          userState.gastos += it.value;
        }
      });
    }

    /*******************************
     * RENDER / UI UPDATE
     *******************************/
    function updateUIFromState(){
      // meta, km fields (only update if user not typing)
      if(document.activeElement !== metaInput) metaInput.value = userState.meta || '';
      if(document.activeElement !== kmInicialEl) kmInicialEl.value = userState.kmInicial || '';
      if(document.activeElement !== kmFinalEl) kmFinalEl.value = userState.kmFinal || '';

      // tempo & km
      tempoTrabalhadoEl.textContent = formatTime(getTempoTotal());
      kmRodadosEl.textContent = formatKM(getKMRodados());

      // metrics
      updateDerivedMetricsLocal();

      // render lancamentos
      renderLancamentosList();
    }

    function renderLancamentosList(){
      lancamentosList.innerHTML = '';
      if(!userState.history || userState.history.length === 0){
        lancamentosList.innerHTML = '<div class="muted small">Nenhum lan√ßamento ainda.</div>'; return;
      }
      userState.history.forEach(it=>{
        const el = document.createElement('div'); el.className = 'launch-item';
        const left = document.createElement('div');
        left.innerHTML = `<div style="font-weight:800">${it.category}: ${it.type==='ganho'?'+':'-'} ${formatBRL(it.value)}</div><div class="small muted">${new Date(it.date).toLocaleString()}</div>`;
        const right = document.createElement('div');
        const edit = document.createElement('button'); edit.className='btn-ghost'; edit.textContent='‚úèÔ∏è';
        const del = document.createElement('button'); del.className='btn-ghost'; del.textContent='üóëÔ∏è';
        edit.addEventListener('click', async ()=> {
          const novoStr = prompt('Novo valor (R$):', (it.value||0).toFixed(2));
          if(novoStr === null) return;
          const novo = Number(novoStr);
          if(isNaN(novo) || novo < 0) return alert('Valor inv√°lido');
          await updateLancamentoFirestore(it.id, { value: novo });
        });
        del.addEventListener('click', async ()=> {
          if(!confirm('Excluir lan√ßamento?')) return;
          await deleteLancamentoFirestore(it.id);
        });
        right.appendChild(edit); right.appendChild(del);
        el.appendChild(left); el.appendChild(right);
        lancamentosList.appendChild(el);
      });
    }

    function updateDerivedMetricsLocal(){
      const totalBruto = (userState.ganhosApps || 0) + (userState.ganhosLoja || 0) + (userState.totalDoacao || 0);
      const lucro = totalBruto - (userState.gastos || 0);
      const tempo = getTempoTotal();
      const horas = tempo/(1000*60*60) || 0;
      const mediaBruto = horas > 0 ? totalBruto / horas : 0;
      const mediaLiq = horas > 0 ? lucro / horas : 0;
      // set UI
      metricGanhosApps.textContent = formatBRL(userState.ganhosApps || 0);
      metricGanhosTotal.textContent = formatBRL(totalBruto);
      metricGastosTotal.textContent = formatBRL(userState.gastos || 0);
      metricLucroTotal.textContent = formatBRL(lucro);
      metricMediaHoraBrutoTotal.textContent = formatBRL(mediaBruto);
      metricMediaHoraLiqTotal.textContent = formatBRL(mediaLiq);
      metricLucroKmTotal.textContent = formatBRL(getKMRodados()>0 ? (lucro/getKMRodados()) : 0);
      metricEntradasApps.textContent = userState.entradasApps || 0;
      // progress bar
      updateProgressBarLocal();
    }

    function updateProgressBarLocal(){
      const meta = Number(userState.meta || 0);
      const atual = Number(userState.ganhosApps || 0) + Number(userState.ganhosLoja || 0);
      if(!meta){ progressBar.style.width = '0%'; progressText.textContent = '0%'; metaMessage.textContent = 'Defina a meta para acompanhar o progresso.'; return; }
      const pct = Math.min(100, (atual/meta)*100);
      progressBar.style.width = pct + '%';
      progressText.textContent = Math.round(pct) + '%';
      if(atual < meta) metaMessage.textContent = `Faltam ${formatBRL(meta - atual)} para bater a meta.`;
      else metaMessage.textContent = `Meta batida! (+${formatBRL(atual - meta)})`;
    }

    /*******************************
     * UTIL & FORMAT
     *******************************/
    function formatBRL(v){ return Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
    function formatKM(v){ return Number(v||0).toFixed(1) + ' km'; }
    function formatTime(ms){ if(!ms || ms<=0) return '00:00:00'; const s = Math.floor(ms/1000), h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60; return [h,m,sec].map(n=>String(n).padStart(2,'0')).join(':'); }

    /*******************************
     * EVENTS: set meta & export & history
     *******************************/
    setMetaBtn.addEventListener('click', ()=>{
      const v = Number(metaInput.value);
      if(isNaN(v) || v <= 0){ return alert('Meta inv√°lida'); }
      userState.meta = v;
      saveStateToFirestore();
    });

    saveAndResetBtn.addEventListener('click', async ()=>{
      if(!confirm('Salvar resumo do dia e resetar os dados?')) return;
      await saveDaySummaryFirestore();
      // reset state
      userState = {
        meta:0, ganhosApps:0, ganhosLoja:0, totalDoacao:0, entradasApps:0, entradasLoja:0, gastos:0,
        history:[], kmInicial:0, kmFinal:0, totalTimeWorked:0, lastStartTime:null, status:'stopped', celebrated:false
      };
      // clear lancamentos collection for user (optional: keep history in dias) -> implement if needed later
      // update firestore state and UI
      await saveStateToFirestore();
      updateUIFromState();
    });

    exportBtn.addEventListener('click', async ()=>{
      // export state and days
      if(!uid) return alert('Usu√°rio n√£o autenticado');
      const stateDoc = await db.collection('users').doc(uid).collection('meta').doc('state').get();
      const days = await db.collection('users').doc(uid).collection('dias').get();
      const daysArr = [];
      days.forEach(d=>daysArr.push(Object.assign({id:d.id}, d.data())));
      const data = { state: stateDoc.exists ? stateDoc.data() : {}, dias: daysArr };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'maxrota_export.json'; a.click(); URL.revokeObjectURL(url);
    });

    viewHistoryBtn.addEventListener('click', async ()=>{
      if(historyPanel.style.display === 'block'){ historyPanel.style.display = 'none'; return; }
      historyPanel.style.display = 'block';
      historyPanel.innerHTML = 'Carregando hist√≥rico...';
      const days = await db.collection('users').doc(uid).collection('dias').orderBy('date','desc').limit(50).get();
      if(days.empty){ historyPanel.innerHTML = '<div class="muted small">Nenhum dia salvo.</div>'; return; }
      historyPanel.innerHTML = days.docs.map(d => {
        const data = d.data();
        const date = new Date(data.date).toLocaleString();
        return `<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)"><b>${date}</b><div class="small muted">Lucro: ${formatBRL(data.lucro)} ¬∑ KM: ${data.km} ¬∑ M√©dia/H: ${formatBRL(data.mediaHora||0)}</div></div>`;
      }).join('');
    });

    /*******************************
     * INITIAL SYNC
     *******************************/
    // If user is already logged in at load time, onAuthStateChanged will attach listeners.
    // But to ensure UI builds early:
    buildUI();

    /*******************************
     * Simple helpers for safety
     *******************************/
    // debounce save state to firestore (to avoid spamming)
    let saveTimeout = null;
    function debouncedSave(){
      if(saveTimeout) clearTimeout(saveTimeout);
      saveTimeout = setTimeout(()=>{ saveStateToFirestore(); saveTimeout = null; }, 800);
    }

    // helper format
    function assertSignedInOrRedirect(){
      if(!auth.currentUser) { window.location.href = 'login.html'; }
    }

    // convenience: periodically ensure timer and UI correct
    setInterval(()=>{ if(uid) updateUIFromState(); }, 2000);

    // end of script
    console.log('MAX ROTA DI√ÅRIO ‚Äî Firestore version loaded');
  </script>
</body>
</html>
