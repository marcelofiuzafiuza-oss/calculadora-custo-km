<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAX ROTA DI√ÅRIO</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <!-- Chart.js caso queira ativar gr√°ficos no futuro -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

  <style>
  /* ===========================
     MAX ROTA ‚Äì ESTILO GLOBAL
     =========================== */
  :root {
    --accent: #10b981;
    --bg1: #041226;
    --bg2: #2a1160;
    --text: #e6eef6;
    --muted: #9aa6b2;
    --card: rgba(255, 255, 255, 0.06);
    --radius: 14px;
    --scale: 1.02;
  }
  html,body{height:100%;margin:0;padding:0}
  body{
    font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    color:var(--text);padding:20px;transform:scale(var(--scale));transform-origin:top left;
  }
  .wrap{max-width:1200px;margin:0 auto}
  .card{background:var(--card);backdrop-filter:blur(6px);border-radius:16px;padding:18px;margin-bottom:18px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 26px rgba(0,0,0,0.35)}
  .header-card{display:flex;justify-content:space-between;align-items:center; flex-wrap: wrap; gap: 10px;}
  .logo-img{height:74px;width:auto;border-radius:12px}
  .theme-controls{display:flex;align-items:center;gap:12px}
  .theme-btn{background:linear-gradient(120deg,var(--accent),#3b82f6);color:#fff;padding:10px 14px;border-radius:12px;border:none;font-weight:700;cursor:pointer;box-shadow:0 6px 20px rgba(0,0,0,0.3)}
  .theme-dots{display:flex;gap:10px}
  .color-dot{width:30px;height:30px;border-radius:999px;border:2px solid rgba(255,255,255,0.12);cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,0.3)}

  .radio-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .station-btn{padding:14px;border-radius:12px;color:#fff;font-weight:800;border:0;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:0.12s;font-size:16px;height:56px}
  .station-btn.active{box-shadow:0 10px 26px rgba(0,0,0,0.5);transform:translateY(-3px)}

  .radio-player{margin-top:12px;display:flex;align-items:center;gap:12px}
  .meta-row{display:flex;gap:12px}
  .meta-row input{flex:1;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.03);color:var(--text);font-weight:800;font-size:16px}

  .progress-container{height:44px;border-radius:22px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);overflow:hidden;position:relative}
  .progress-bar{position:absolute;left:0;top:0;height:100%;background:linear-gradient(120deg,var(--accent),#2563eb);width:0%;animation:waveMove 3.5s linear infinite;background-size:200% 200%}
  @keyframes waveMove{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  .progress-text{position:absolute;width:100%;height:100%;line-height:44px;text-align:center;font-weight:900;font-size:15px}

  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .grid-4 input{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.03);color:var(--text);font-weight:700;font-size:15px}
  .big-time{font-size:20px;font-weight:900}

  .km-actions{margin-top:12px;display:flex;gap:12px;flex-wrap:wrap}
  .btn{padding:12px 16px;border-radius:12px;background:linear-gradient(120deg,var(--accent),#7c3aed);border:none;font-weight:800;cursor:pointer;color:#fff;font-size:15px;box-shadow:0 8px 20px rgba(0,0,0,0.3)}
  .btn-ghost{padding:12px 16px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);font-weight:700;cursor:pointer;color:var(--muted)}

  .grid-2cols{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .input-row{display:flex;gap:12px}
  .input-row input{flex:1;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.03);color:var(--text);font-weight:700;font-size:15px}

  .apps-grid,.gastos-grid{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
  .app-btn,.gasto-btn{padding:12px 14px;border:none;border-radius:12px;cursor:pointer;font-weight:900;color:#fff;font-size:15px;display:flex;align-items:center;justify-content:center;min-width:120px}

  .launch-list{max-height:300px;overflow-y:auto;padding:6px}
  .launch-item{display:flex;justify-content:space-between;border-bottom:1px dashed rgba(255,255,255,0.06);padding:10px 6px;border-radius:10px}

  .metric-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px}
  .metric-col{padding:12px;border-radius:12px;background:rgba(255,255,255,0.04)}
  .metric-title{font-size:13px;color:var(--muted)}
  .metric-value{margin-top:8px;font-size:18px;font-weight:900}

  .resumo-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}

  .history-panel{background:rgba(255,255,255,0.03);padding:12px;border-radius:12px}

  .confetti{pointer-events:none;position:fixed;inset:0;overflow:hidden;z-index:9999}

  .accent-green{--accent:#10b981}
  .accent-orange{--accent:#f97316}
  .accent-yellow{--accent:#facc15}
  .accent-red{--accent:#ef4444}
  .accent-pink{--accent:#ec4899}

  body.light-mode{--bg1:#f5f7fb;--bg2:#e8f0ff;--text:#0b1220;--muted:#566170;--card:rgba(255,255,255,0.9)}
  </style>
</head>

<body class="accent-green">
  <script type="module">
/* ===========================
   MAX ROTA ‚Äî SCRIPT PRINCIPAL
   =========================== */
import { 
  doc, 
  getDoc, 
  setDoc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* UTIL */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const uid = () => Math.random().toString(36).slice(2,9);

function formatBRL(v){ 
  return Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); 
}
function formatKM(v){ 
  return Number(v||0).toFixed(1) + ' km'; 
}
function formatTime(ms){ 
  if(!ms||ms<=0) return '00:00:00'; 
  const s=Math.floor(ms/1000); 
  const h=Math.floor(s/3600); 
  const m=Math.floor((s%3600)/60); 
  const sec=s%60; 
  return [h,m,sec].map(n=>String(n).padStart(2,'0')).join(':'); 
}

/* STATE */
let state = {
  meta: 0,
  ganhosApps: 0,
  ganhosLoja: 0,
  totalDoacao: 0,
  entradasApps: 0,
  entradasLoja: 0,
  gastos: 0,
  history: [],
  kmInicial: 0,
  kmFinal: 0,
  totalTimeWorked: 0,
  lastStartTime: null,
  status: 'stopped',
  celebrated: false,
  valuesHidden: false,
  savedDays: []
};

/* LOCAL LOAD */
function loadLocalState() {
  try {
    const s = localStorage.getItem("maxrota_state");
    if (s) Object.assign(state, JSON.parse(s));
    if (!Array.isArray(state.savedDays)) {
      state.savedDays = JSON.parse(localStorage.getItem("maxrota_days") || "[]");
    }
  } catch (e) {
    console.warn("Erro ao carregar localStorage:", e);
  }
}

/* LOCAL SAVE */
function saveLocalState() {
  localStorage.setItem("maxrota_state", JSON.stringify(state));
}

/* CARREGAR FIREBASE */
async function loadState() {
  const uid = window.__USER_UID__;
  if (!uid) {
    loadLocalState();
    updateUI();
    return;
  }

  const { db } = window.__FIREBASE__;
  const ref = doc(db, "users", uid);

  try {
    const snap = await getDoc(ref);
    if (snap.exists()) {
      Object.assign(state, snap.data());
      saveLocalState();
      updateUI();
    } else {
      saveState();
    }
  } catch (e) {
    loadLocalState();
    updateUI();
  }
}

/* SALVAR FIREBASE */
async function saveState() {
  const uid = window.__USER_UID__;
  const { db } = window.__FIREBASE__;

  saveLocalState();

  if (!uid) return;

  try {
    await setDoc(doc(db, "users", uid), state, { merge: true });
  } catch (e) {
    console.error("Erro ao salvar Firebase:", e);
  }
}
   /* SALVAR DIA NO HIST√ìRICO */
async function saveDaySummary() {
  const uid = window.__USER_UID__;
  const { db } = window.__FIREBASE__;

  const resumo = {
    id: new Date().toISOString(),
    date: new Date().toISOString(),
    meta: state.meta,
    kmInicial: state.kmInicial,
    kmFinal: state.kmFinal,
    ganhosApps: state.ganhosApps,
    ganhosLoja: state.ganhosLoja,
    ganhoDoacao: state.totalDoacao,
    entradasApps: state.entradasApps,
    entradasLoja: state.entradasLoja,
    gastos: state.gastos,
    lucro:
      state.ganhosApps +
      state.ganhosLoja +
      state.totalDoacao -
      state.gastos,
    tempo: state.totalTimeWorked,
    km: state.kmFinal - state.kmInicial,
    history: state.history,
  };

  let days = state.savedDays || [];
  days.unshift(resumo);
  state.savedDays = days;
  localStorage.setItem("maxrota_days", JSON.stringify(days.slice(0, 120)));
  saveLocalState();

  if (!uid) return;

  try {
    await setDoc(
      doc(db, "users", uid),
      { savedDays: state.savedDays },
      { merge: true }
    );
  } catch (e) {
    console.error("Erro ao salvar resumo no Firebase:", e);
  }
}

/* ELEMENTOS */
const metaInput = $('#metaInput'),
      setMetaBtn = $('#setMetaBtn'),
      progressBar = $('#progressBar'),
      progressText = $('#progressText'),
      metaMessage = $('#metaMessage'),
      progressBubbles = $('#progressBubbles');

const kmInicialEl = $('#kmInicial'),
      kmFinalEl = $('#kmFinal'),
      tempoTrabalhado = $('#tempoTrabalhado'),
      kmRodados = $('#kmRodados'),
      toggleStartBtn = $('#toggleStartBtn'),
      finalizeBtn = $('#finalizeBtn'),
      saveKmBtn = $('#saveKmBtn');

const valorEntrada = $('#valorEntrada'),
      valorSaida = $('#valorSaida'),
      lancamentosList = $('#lancamentosList');

const appBtns = $$('.app-btn'),
      gastoBtns = $$('.gasto-btn');

const stationButtons = $$('#stationButtons .station-btn'),
      radioPlayer = $('#radioPlayer'),
      nowPlaying = $('#nowPlaying'),
      stopRadioBtn = $('#stopRadioBtn');

const metricGanhosApps = $('#metricGanhosApps'),
      metricGanhosTotal = $('#metricGanhosTotal'),
      metricGastosTotal = $('#metricGastosTotal'),
      metricLucroTotal = $('#metricLucroTotal'),
      metricMediaHoraBrutoTotal = $('#metricMediaHoraBrutoTotal'),
      metricMediaHoraLiqTotal = $('#metricMediaHoraLiqTotal'),
      metricLucroKmTotal = $('#metricLucroKmTotal'),
      metricEntradasApps = $('#metricEntradasApps'),
      metricEntradasLoja = $('#metricEntradasLoja');

const finalTotalApps = $('#finalTotalApps'),
      finalTotalLoja = $('#finalTotalLoja'),
      finalTotalDoacao = $('#finalTotalDoacao'),
      finalTotalGeral = $('#finalTotalGeral');

const confettiRoot = $('#confettiRoot'),
      saveAndResetBtn = $('#saveAndResetBtn'),
      exportBtn = $('#exportBtn'),
      viewHistoryBtn = $('#viewHistoryBtn'),
      historyPanel = $('#historyPanel');

const autoThemeBtn = $('#autoThemeBtn'),
      themeDots = $$('.color-dot');

const resumoCategorias = $('#resumoCategorias');
const toggleValuesBtn = $('#toggleValuesBtn');

/* ESCONDER/EXIBIR VALORES */
function toggleValuesVisibility(){
  state.valuesHidden = !state.valuesHidden;
  saveState();
  toggleValuesBtn.textContent = state.valuesHidden ? 'Mostrar Valores' : 'Esconder Valores';
  updateUI();
}
toggleValuesBtn.addEventListener('click', toggleValuesVisibility);

/* ===========================
      PLAYER DE R√ÅDIO
===========================*/
function setActiveStation(btn){
  stationButtons.forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
}

stationButtons.forEach(btn =>
  btn.addEventListener('click', async () => {
    try { radioPlayer.pause(); } catch {}
    radioPlayer.src = '';

    const url = btn.dataset.src;
    const name = btn.dataset.name;

    setActiveStation(btn);
    nowPlaying.textContent = 'Carregando: ' + name;

    try {
      radioPlayer.src = url;
      radioPlayer.load();
      await radioPlayer.play();
      nowPlaying.textContent = 'Tocando: ' + name;
    } catch {
      nowPlaying.textContent = 'Falha ao carregar ' + name;
      setActiveStation(null);
    }
  })
);

stopRadioBtn.addEventListener('click', () => {
  try { radioPlayer.pause(); radioPlayer.src=''; radioPlayer.load(); } catch {}
  nowPlaying.textContent = 'Nenhuma r√°dio selecionada.';
  setActiveStation(null);
}); 
    /* ===========================
      TIMER & KM
===========================*/
let timerInterval = null;

function getTempoTotal(){
  let t = Number(state.totalTimeWorked || 0);
  if(state.status === 'running' && state.lastStartTime){
    t += (Date.now() - state.lastStartTime);
  }
  return t;
}

function getKMRodados(){
  const ini = Number(state.kmInicial || 0);
  const fim = Number(state.kmFinal || 0);
  return fim > ini ? (fim - ini) : 0;
}

function startTimer(){
  stopTimer();
  if(!state.lastStartTime) state.lastStartTime = Date.now();
  timerInterval = setInterval(() => {
    tempoTrabalhado.textContent = formatTime(getTempoTotal());
    updateDerivedMetrics();
  }, 1000);
}

function stopTimer(){
  if(timerInterval){
    clearInterval(timerInterval);
    timerInterval = null;
  }
}

toggleStartBtn.addEventListener('click', () => {
  if(state.status === 'stopped'){
    state.status = 'running';
    state.lastStartTime = Date.now();
    toggleStartBtn.textContent = 'Pausar';
    startTimer();
  }
  else if(state.status === 'running'){
    state.totalTimeWorked += (Date.now() - state.lastStartTime);
    state.lastStartTime = null;
    state.status = 'paused';
    toggleStartBtn.textContent = 'Retomar';
    stopTimer();
  }
  else if(state.status === 'paused'){
    state.status = 'running';
    state.lastStartTime = Date.now();
    toggleStartBtn.textContent = 'Pausar';
    startTimer();
  }

  saveState();
  updateUI();
});

finalizeBtn.addEventListener('click', () => {
  if(state.status === 'running'){
    state.totalTimeWorked += (Date.now() - state.lastStartTime);
    state.lastStartTime = null;
  }

  const tempoFinal = getTempoTotal();
  const kmDia = getKMRodados();

  state.status = 'stopped';
  stopTimer();

  const existing = finalizeBtn.parentElement.querySelector('.day-resume-card');
  if(existing) existing.remove();

  const resumoCard = document.createElement('div');
  resumoCard.className = 'day-resume-card';
  resumoCard.style.padding = '10px';
  resumoCard.style.marginTop = '10px';
  resumoCard.style.borderRadius = '10px';
  resumoCard.style.background = 'rgba(255,255,255,0.06)';
  resumoCard.innerHTML = `
    <b>Dia Finalizado</b><br>
    Tempo Trabalhado: ${formatTime(tempoFinal)}<br>
    KM Rodado: ${formatKM(kmDia)}
  `;

  finalizeBtn.parentElement.appendChild(resumoCard);

  state.totalTimeWorked = 0;
  state.lastStartTime = null;

  saveState();
  updateUI();
});

saveKmBtn.addEventListener('click', () => {
  state.kmInicial = Number(kmInicialEl.value) || 0;
  state.kmFinal = Number(kmFinalEl.value) || 0;
  saveState();
  updateUI();
});

/* ===========================
      LAN√áAMENTOS
===========================*/
function addLancamento({type, value, category}){
  const item = {
    id: uid(),
    type,
    value: Number(value),
    category,
    date: new Date().toISOString()
  };

  if(type === 'ganho'){
    if(category === 'Loja'){
      state.ganhosLoja += item.value;
      state.entradasLoja++;
    } else if(category === 'Doa√ß√£o'){
      state.totalDoacao += item.value;
    } else {
      state.ganhosApps += item.value;
      state.entradasApps++;
    }
  } else {
    state.gastos += item.value;
  }

  state.history.unshift(item);
  saveState();
  updateUI();

  valorEntrada.value = '';
  valorSaida.value = '';
}

$('#addEntradaBtn').addEventListener('click', () => {
  const v = Number(valorEntrada.value);
  if(isNaN(v) || v <= 0) return;
  addLancamento({type:'ganho', value:v, category:'Particular'});
});

$('#addSaidaBtn').addEventListener('click', () => {
  const v = Number(valorSaida.value);
  if(isNaN(v) || v <= 0) return;
  addLancamento({type:'gasto', value:v, category:'Outros'});
});

appBtns.forEach(b =>
  b.addEventListener('click', () => {
    const v = Number(valorEntrada.value);
    if(isNaN(v) || v <= 0) return;
    addLancamento({type:'ganho', value:v, category:b.dataset.cat});
  })
);

gastoBtns.forEach(b =>
  b.addEventListener('click', () => {
    const v = Number(valorSaida.value);
    if(isNaN(v) || v <= 0) return;
    addLancamento({type:'gasto', value:v, category:b.dataset.cat});
  })
);

/* ===========================
   RENDER LAN√áAMENTOS
===========================*/
function renderLancamentos(){
  if(!state.history || state.history.length === 0){
    lancamentosList.innerHTML = '<div class="muted small text-center">Nenhum lan√ßamento ainda.</div>';
    return;
  }

  lancamentosList.innerHTML = '';

  state.history.slice(0,200).forEach(it => {
    const el = document.createElement('div');
    el.className = 'launch-item';

    const valueClass = state.valuesHidden ? 'hidden-value' : '';

    const left = document.createElement('div');
    left.style.fontWeight = '800';
    left.innerHTML = `
      ${it.category}: ${it.type === 'ganho' ? '+' : '-'} 
      <span class="${valueClass}">${formatBRL(it.value)}</span>
    `;

    const right = document.createElement('div');
    const edit = document.createElement('button');
    edit.className = 'btn-ghost';
    edit.textContent = '‚úèÔ∏è';
    edit.style.marginRight = '8px';

    const del = document.createElement('button');
    del.className = 'btn-ghost';
    del.textContent = 'üóëÔ∏è';

    right.appendChild(edit);
    right.appendChild(del);

    el.appendChild(left);
    el.appendChild(right);

    lancamentosList.appendChild(el);

    edit.addEventListener('click', () => {
      const novoStr = prompt('Novo valor (R$):', it.value.toFixed(2));
      if(novoStr === null) return;
      const novo = Number(novoStr);
      if(isNaN(novo) || novo < 0) return;

      if(it.type === 'ganho'){
        if(it.category === 'Loja') state.ganhosLoja -= it.value;
        else if(it.category === 'Doa√ß√£o') state.totalDoacao -= it.value;
        else state.ganhosApps -= it.value;
      } else {
        state.gastos -= it.value;
      }

      it.value = novo;

      if(it.type === 'ganho'){
        if(it.category === 'Loja') state.ganhosLoja += it.value;
        else if(it.category === 'Doa√ß√£o') state.totalDoacao += it.value;
        else state.ganhosApps += it.value;
      } else {
        state.gastos += it.value;
      }

      saveState();
      updateUI();
    });

    del.addEventListener('click', () => {
      if(!confirm('Excluir lan√ßamento?')) return;

      state.history = state.history.filter(x => x.id !== it.id);
      recalcTotalsFromHistory();

      saveState();
      updateUI();
    });
  });
}

/* REBUILD TOTALS */
function recalcTotalsFromHistory(){
  state.ganhosApps = 0;
  state.ganhosLoja = 0;
  state.totalDoacao = 0;
  state.gastos = 0;
  state.entradasApps = 0;
  state.entradasLoja = 0;

  state.history.forEach(it => {
    if(it.type === 'ganho'){
      if(it.category === 'Loja'){ 
        state.ganhosLoja += it.value; 
        state.entradasLoja++; 
      }
      else if(it.category === 'Doa√ß√£o'){ 
        state.totalDoacao += it.value; 
      }
      else { 
        state.ganhosApps += it.value; 
        state.entradasApps++; 
      }
    }
    else {
      state.gastos += it.value;
    }
  });
    }
    /* ===========================
   RESUMO POR CATEGORIA
===========================*/
function renderResumoCategorias(){
  const totals = {};
  const counts = {};

  state.history.forEach(it => {
    if(it.type !== 'ganho') return;
    const c = it.category || 'Outros';

    totals[c] = (totals[c] || 0) + it.value;
    counts[c] = (counts[c] || 0) + 1;
  });

  resumoCategorias.innerHTML = '';

  const valueClass = state.valuesHidden ? 'hidden-value' : '';

  const order = ['Uber','99','inDriver','Particular','Loja','Doa√ß√£o'];

  order.forEach(cat => {
    const val = totals[cat] || 0;
    const cnt = counts[cat] || 0;

    const node = document.createElement('div');
    node.innerHTML = `
      <div style="font-weight:900;margin-bottom:6px">${cat}</div>
      <div class="${valueClass}" style="font-weight:800">${formatBRL(val)}</div>
      <div class="small muted"><span class="${valueClass}">${cnt}</span> entr.</div>
    `;
    resumoCategorias.appendChild(node);
  });
}

/* ===========================
      M√âTRICAS
===========================*/
function updateDerivedMetrics(){
  const totalBruto =
    Number(state.ganhosApps) +
    Number(state.ganhosLoja) +
    Number(state.totalDoacao);

  const lucro = totalBruto - Number(state.gastos);

  const tempo = getTempoTotal();
  const horas = tempo / 3600000;
  const mediaBruto = horas > 0 ? totalBruto / horas : 0;
  const mediaLiq = horas > 0 ? lucro / horas : 0;
  const lucroKm = getKMRodados() > 0 ? lucro / getKMRodados() : 0;

  const hideClass = state.valuesHidden ? 'hidden-value' : '';

  metricGanhosApps.textContent = formatBRL(state.ganhosApps);
  metricGanhosTotal.textContent = formatBRL(totalBruto);
  metricGastosTotal.textContent = formatBRL(state.gastos);
  metricLucroTotal.textContent = formatBRL(lucro);
  metricMediaHoraBrutoTotal.textContent = formatBRL(mediaBruto);
  metricMediaHoraLiqTotal.textContent = formatBRL(mediaLiq);
  metricLucroKmTotal.textContent = formatBRL(lucroKm);
  metricEntradasApps.textContent = state.entradasApps;
  metricEntradasLoja.textContent = state.entradasLoja;

  [
    metricGanhosApps,
    metricGanhosTotal,
    metricGastosTotal,
    metricLucroTotal,
    metricMediaHoraBrutoTotal,
    metricMediaHoraLiqTotal,
    metricLucroKmTotal,
    metricEntradasApps,
    metricEntradasLoja
  ].forEach(el => el.classList.toggle('hidden-value', state.valuesHidden));

  tempoTrabalhado.textContent = formatTime(tempo);
  kmRodados.textContent = formatKM(getKMRodados());

  renderResumoFinal();
  updateProgressBar();
}

/* ===========================
      PROGRESS BAR
===========================*/
function updateProgressBar(){
  const meta = Number(state.meta || 0);
  const atual = state.ganhosApps + state.ganhosLoja;

  if(meta === 0){
    progressBar.style.width = '0%';
    progressText.textContent = '0%';
    metaMessage.textContent = 'Defina a meta para acompanhar.';
    return;
  }

  const pct = Math.min(100, (atual / meta) * 100);
  progressBar.style.width = pct + '%';
  progressText.textContent = Math.round(pct) + '%';

  const hideClass = state.valuesHidden ? 'hidden-value' : '';

  if(atual < meta){
    metaMessage.innerHTML = `Faltam <span class="${hideClass}">${formatBRL(meta - atual)}</span>`;
  } else {
    metaMessage.innerHTML = `Meta batida! (+<span class="${hideClass}">${formatBRL(atual - meta)}</span>)`;
    celebrate();
  }
}

/* ===========================
      CELEBRA√á√ÉO
===========================*/
function celebrate(){
  if(state.celebrated) return;
  state.celebrated = true;
  saveState();
}

/* ===========================
      RESUMO FINAL
===========================*/
function renderResumoFinal(){
  const totalApps = state.ganhosApps;
  const totalLoja = state.ganhosLoja;
  const totalDoacao = state.totalDoacao;

  const totalGeralBruto = totalApps + totalLoja + totalDoacao;
  const lucroFinal = totalGeralBruto - state.gastos;

  finalTotalApps.textContent = formatBRL(totalApps);
  finalTotalLoja.textContent = formatBRL(totalLoja);
  finalTotalDoacao.textContent = formatBRL(totalDoacao);
  finalTotalGeral.textContent = formatBRL(lucroFinal);

  [
    finalTotalApps,
    finalTotalLoja,
    finalTotalDoacao,
    finalTotalGeral
  ].forEach(el => el.classList.toggle('hidden-value', state.valuesHidden));
}

/* ===========================
      SALVAR / EXPORTAR
===========================*/
saveAndResetBtn.addEventListener('click', async () => {
  if(!confirm('Salvar resumo e resetar dia?')) return;

  await saveDaySummary();

  const hidden = state.valuesHidden;
  const saved = state.savedDays;

  state = {
    meta:0, ganhosApps:0, ganhosLoja:0, totalDoacao:0,
    entradasApps:0, entradasLoja:0, gastos:0,
    history:[], kmInicial:0, kmFinal:0,
    totalTimeWorked:0, lastStartTime:null,
    status:'stopped', celebrated:false,
    valuesHidden:hidden, savedDays:saved
  };

  kmInicialEl.value='';
  kmFinalEl.value='';
  metaInput.value='';
  valorEntrada.value='';
  valorSaida.value='';

  toggleStartBtn.textContent='Iniciar Expediente';

  saveState();
  updateUI();
});

exportBtn.addEventListener('click', () => {
  const data = { state };
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = 'maxrota_export.json';
  a.click();

  URL.revokeObjectURL(url);
});

/* ===========================
      HIST√ìRICO
===========================*/
viewHistoryBtn.addEventListener('click', () => {
  historyPanel.classList.toggle('hidden');
  if(!historyPanel.classList.contains('hidden')) renderHistory();
});

function renderHistory(){
  const arr = state.savedDays || [];
  if(arr.length === 0){
    historyPanel.innerHTML = '<div class="muted small">Nenhum dia salvo.</div>';
    return;
  }

  historyPanel.innerHTML = arr.map(d => {
    const date = new Date(d.date);
    return `
      <div style="padding:10px;border-bottom:1px solid rgba(255,255,255,0.06)">
        <div style="font-weight:800">${date.toLocaleString()}</div>
        <div class="small muted">
          Lucro: ${formatBRL(d.lucro)} ¬∑ KM: ${d.km}
        </div>
      </div>
    `;
  }).join('');
}

/* ===========================
      TEMA / CORES
===========================*/
let autoMode = true;

function applyAutoTheme(){
  if(!autoMode) return;
  const hour = new Date().getHours();
  const day = hour >= 6 && hour < 18;
  document.body.classList.toggle('light-mode', day);
}

applyAutoTheme();
setInterval(applyAutoTheme, 60000);

autoThemeBtn.addEventListener('click', () => {
  autoMode = !autoMode;
  if(autoMode) applyAutoTheme();
  else document.body.classList.toggle('light-mode');
});

themeDots.forEach(dot =>
  dot.addEventListener('click', () => {
    const acc = dot.dataset.accent;
    document.body.classList.remove(
      'accent-green','accent-orange','accent-yellow','accent-red','accent-pink'
    );
    document.body.classList.add('accent-' + acc);
    localStorage.setItem('maxrota_accent', acc);
  })
);

document.body.classList.add(
  'accent-' + (localStorage.getItem('maxrota_accent') || 'green')
);

/* CARREGAR META */
setMetaBtn.addEventListener('click', () => {
  const v = Number(metaInput.value);
  if(!isNaN(v) && v > 0){
    state.meta = v;
    saveState();
    updateUI();
  }
});

/* ===========================
      UPDATE UI
===========================*/
function updateUI(){
  toggleValuesBtn.textContent = state.valuesHidden ? 'Mostrar Valores' : 'Esconder Valores';

  if(document.activeElement !== metaInput) metaInput.value = state.meta || '';
  if(document.activeElement !== kmInicialEl) kmInicialEl.value = state.kmInicial || '';
  if(document.activeElement !== kmFinalEl) kmFinalEl.value = state.kmFinal || '';

  if(state.status === 'running') toggleStartBtn.textContent = 'Pausar';
  else if(state.status === 'paused') toggleStartBtn.textContent = 'Retomar';
  else toggleStartBtn.textContent = 'Iniciar Expediente';

  renderLancamentos();
  renderResumoCategorias();
  updateDerivedMetrics();
}

/* ===========================
      INICIALIZA√á√ÉO
===========================*/
loadLocalState();
updateUI();

if(state.status === 'running' && state.lastStartTime){
  startTimer();
}

</script>
<!-- ===========================
      FIREBASE CORE (C)
===========================-->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // CONFIGURA√á√ÉO DA SUA CONTA FIREBASE
  const firebaseConfig = {
    apiKey: "AIzaSyBXkQlm0TbCsCdVGil8-5kGWbtj07SKXwA",
    authDomain: "maxrota.firebaseapp.com",
    projectId: "maxrota",
    storageBucket: "maxrota.firebasestorage.app",
    messagingSenderId: "425002957978",
    appId: "1:425002957978:web:1e4f38239e552de452f323",
    measurementId: "G-RBK7LM483D"
  };

  // INICIALIZAR
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Expor Firebase globalmente
  window.__FIREBASE__ = { auth, db };
  window.auth = auth;
</script>

<!-- ===========================
      LOGOUT
===========================-->
<script type="module">
  import { signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  window.logout = async () => {
    await signOut(window.auth);
    location.href = "login.html";
  };
</script>

<!-- ===========================
      SINCRONIZA√á√ÉO AUTOM√ÅTICA
===========================-->
<script type="module">
  // Aguarda login ‚Üí carrega dados Firebase
  document.addEventListener("DOMContentLoaded", () => {
    const check = setInterval(() => {
      if (window.__USER_UID__) {
        clearInterval(check);
        loadState(); // carrega do Firebase
      }
    }, 300);
  });

  // Atualiza a cada 15 segundos sem apagar layout
  setInterval(async () => {
    if (!window.__USER_UID__) return;
    await loadState();
  }, 15000);
</script>

</body>
</html>
