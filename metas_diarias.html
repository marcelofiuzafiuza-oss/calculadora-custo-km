<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Diário Avançado</title>
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega a fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        /* Melhora a aparência dos inputs number */
        input[type=number] {
            -moz-appearance: textfield;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Estilo para a barra de progresso */
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
        /* Botão de Privacidade */
        #togglePrivacyBtn.oculto {
            background-color: #ef4444; /* red-600 */
        }
        #togglePrivacyBtn.oculto:hover {
            background-color: #dc2626; /* red-700 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

    <div class="bg-gray-800 p-6 w-full min-h-screen">

        <!-- Título e Modo Privacidade -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-cyan-400">Controle Diário</h1>
            <!-- Botão de Privacidade -->
            <button id="togglePrivacyBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">
                Ocultar
            </button>
        </div>

        <!-- Seção 1: Meta de Ganhos (MOVIMENTADO) -->
        <div class="mb-6">
            <label for="metaDiaria" class="block text-sm font-medium text-gray-300 mb-2">Sua Meta de Ganhos Brutos (R$)</label>
            <div class="flex space-x-2 mb-3">
                <input type="number" id="metaDiaria" step="10" placeholder="Ex: 300" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500">
                <button id="salvarMetaBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg transition duration-300">
                    Definir
                </button>
            </div>
            <!-- Barra de Progresso (Meta de Ganhos Brutos) -->
            <div class="w-full bg-gray-600 rounded-full h-4 mb-2 overflow-hidden mt-1">
                <div id="progressBar" class="bg-green-500 h-4 rounded-full progress-bar-fill" style="width: 0%"></div>
            </div>
            <p class="text-center text-sm text-gray-300" id="resumoFaltando">Defina uma meta para começar.</p>
        </div>

        <!-- Seção 2: Odômetro (REFEITO) -->
        <div class="bg-gray-700 p-4 rounded-lg mb-6">
            <h2 class="text-lg font-semibold mb-3 text-center text-gray-300">Odômetro</h2>
            <div class="grid grid-cols-2 gap-3">
                <!-- KM Inicial -->
                <div class="space-y-2">
                    <label for="kmInicial" class="block text-xs font-medium text-gray-300 mb-1">KM Inicial</label>
                    <input type="number" id="kmInicial" placeholder="Ex: 150000" class="w-full p-2 bg-gray-600 border border-gray-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                    <button id="salvarKmInicialBtn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Salvar Inicial</button>
                </div>
                <!-- KM Final -->
                <div class="space-y-2">
                    <label for="kmFinal" class="block text-xs font-medium text-gray-300 mb-1">KM Final</label>
                    <input type="number" id="kmFinal" placeholder="Ex: 150250" class="w-full p-2 bg-gray-600 border border-gray-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                    <button id="salvarKmFinalBtn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Salvar Final</button>
                </div>
            </div>
        </div>

        <!-- Seção 3: Controle de Tempo (MOVIMENTADO) -->
        <div class="bg-gray-700 p-4 rounded-lg mb-6">
            <h2 class="text-lg font-semibold mb-3 text-center text-gray-300">Controle de Jornada</h2>
            <div class="grid grid-cols-2 gap-3">
                <!-- Botões que se alternam -->
                <button id="iniciarDiaBtn" class="w-full col-span-2 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Iniciar Dia</button>
                <button id="pausarDiaBtn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 hidden">Pausar</button>
                <button id="retomarDiaBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 hidden">Retomar</button>
                <button id="encerrarDiaBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 hidden">Encerrar Dia</button>
            </div>
        </div>

        <!-- Seção 4: Lançamentos (MOVIMENTADO E RE-ESTILIZADO) -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <!-- Adicionar Corrida -->
            <div class="space-y-2">
                <label for="valorCorrida" class="block text-sm font-medium text-gray-300">Valor da Corrida (R$)</label>
                <input type="number" id="valorCorrida" step="0.5" placeholder="12.50" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="addCorridaBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-300 text-lg">
                    + Adicionar Ganho
                </button>
                <p id="erroInput" class="text-red-400 text-center text-sm mt-1 hidden"></p>
            </div>
            <!-- Adicionar Gasto -->
            <div class="space-y-2">
                <label for="valorGasto" class="block text-sm font-medium text-gray-300">Valor do Gasto (R$)</label>
                <input type="number" id="valorGasto" step="0.5" placeholder="50.00" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-red-500">
                <button id="addGastoBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition duration-300 text-lg">
                    - Adicionar Gasto
                </button>
                <p id="erroGasto" class="text-red-400 text-center text-sm mt-1 hidden"></p>
            </div>
        </div>

        <!-- Seção 5: Resumo Financeiro (MOVIMENTADO) -->
        <div class="bg-gray-700 p-5 rounded-lg mb-6">
            <!-- Lucro Líquido -->
            <div class="text-center mb-6">
                <p class="text-sm text-gray-400 uppercase tracking-wider">Lucro Líquido</p>
                <p class="text-4xl font-bold text-cyan-400" id="lucroLiquido">R$ 0,00</p>
            </div>
            <!-- Ganhos Brutos vs Gastos -->
            <div class="flex justify-between text-center">
                <div>
                    <p class="text-sm text-gray-400">Ganhos Brutos</p>
                    <p class="text-2xl font-semibold text-green-400" id="totalGanhos">R$ 0,00</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Gastos Hoje</p>
                    <p class="text-2xl font-semibold text-red-400" id="totalGastos">R$ 0,00</p>
                </div>
            </div>
        </div>

        <!-- Seção 6: Estatísticas (MOVIMENTADO) -->
        <div class="bg-gray-700 p-5 rounded-lg mb-6">
            <div class="grid grid-cols-2 gap-4 text-center">
                <!-- Lucro / KM (Líquido) - MOVIMENTADO PARA CIMA -->
                <div class="col-span-2 text-center"> 
                    <p class="text-sm text-gray-400">Lucro / KM (Líquido)</p>
                    <p class="text-3xl font-semibold text-cyan-400" id="lucroPorKm">R$ 0,00</p>
                </div>

                <div>
                    <p class="text-sm text-gray-400">Tempo Trabalhado</p>
                    <p class="text-2xl font-semibold" id="tempoTrabalhado">00:00:00</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Média / Hora (Líquido)</p>
                    <p class="text-2xl font-semibold" id="mediaPorHora">R$ 0,00</p>
                </div>

                <!-- NOVO CAMPO ADICIONADO -->
                <div>
                    <p class="text-sm text-gray-400">Média / Hora (Bruto)</p>
                    <p class="text-2xl font-semibold" id="mediaPorHoraBruto">R$ 0,00</p>
                </div>

                <div>
                    <p class="text-sm text-gray-400">Corridas</p>
                    <p class="text-2xl font-semibold" id="totalCorridas">0</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Média / Corrida</p>
                    <p class="text-2xl font-semibold" id="mediaPorCorrida">R$ 0,00</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">KM Rodados</p>
                    <p class="text-2xl font-semibold" id="kmRodados">0.0 km</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Ganho / KM (Bruto)</p>
                    <p class="text-2xl font-semibold" id="ganhoPorKm">R$ 0,00</p>
                </div>
            </div>
        </div>

        <!-- Seção 7: Histórico Lançamentos -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold mb-3 text-gray-300">Últimos Lançamentos</h3>
            <div id="historicoLista" class="bg-gray-700 p-4 rounded-lg h-32 overflow-y-auto space-y-2">
                <p class="text-gray-400 text-center">Nenhum lançamento ainda.</p>
            </div>
        </div>

        <!-- Seção 8: Controles -->
        <button id="resetarDiaBtn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300 mt-4">
            Salvar Resumo e Resetar Dia
        </button>

    </div>

    <!-- Seção 9: Histórico de Dias Salvos -->
    <div class="bg-gray-800 p-6 w-full">
        <div class="bg-gray-700 p-5 rounded-lg">
            <button id="verHistoricoBtn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                Ver Histórico de Dias Salvos
            </button>
            <div id="historicoDiasLista" class="mt-4 space-y-3 hidden">
                <!-- Conteúdo do histórico será injetado aqui -->
            </div>
            <!-- BUG CORRIGIDO: class_Original -> class -->
            <button id="limparHistoricoBtn" class="w-full bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 mt-3 hidden">
                Limpar Histórico de Dias
            </button>
        </div>
    </div>


    <script>
        // --- Seleção de Elementos ---
        const togglePrivacyBtn = document.getElementById('togglePrivacyBtn');
        
        const iniciarDiaBtn = document.getElementById('iniciarDiaBtn');
        const pausarDiaBtn = document.getElementById('pausarDiaBtn');
        const retomarDiaBtn = document.getElementById('retomarDiaBtn');
        const encerrarDiaBtn = document.getElementById('encerrarDiaBtn');

        const kmInicialInput = document.getElementById('kmInicial');
        const kmFinalInput = document.getElementById('kmFinal');
        const salvarKmInicialBtn = document.getElementById('salvarKmInicialBtn');
        const salvarKmFinalBtn = document.getElementById('salvarKmFinalBtn');

        const metaDiariaInput = document.getElementById('metaDiaria');
        const salvarMetaBtn = document.getElementById('salvarMetaBtn');
        
        const valorCorridaInput = document.getElementById('valorCorrida');
        const addCorridaBtn = document.getElementById('addCorridaBtn');
        const erroInput = document.getElementById('erroInput');

        const valorGastoInput = document.getElementById('valorGasto');
        const addGastoBtn = document.getElementById('addGastoBtn');
        const erroGasto = document.getElementById('erroGasto');
        
        const lucroLiquido = document.getElementById('lucroLiquido');
        const totalGanhos = document.getElementById('totalGanhos');
        const totalGastos = document.getElementById('totalGastos');

        const progressBar = document.getElementById('progressBar');
        const resumoFaltando = document.getElementById('resumoFaltando');
        
        const tempoTrabalhado = document.getElementById('tempoTrabalhado');
        const mediaPorHora = document.getElementById('mediaPorHora');
        const mediaPorHoraBruto = document.getElementById('mediaPorHoraBruto'); // NOVO
        const totalCorridas = document.getElementById('totalCorridas');
        const mediaPorCorrida = document.getElementById('mediaPorCorrida');

        const kmRodados = document.getElementById('kmRodados');
        const ganhoPorKm = document.getElementById('ganhoPorKm');
        const lucroPorKm = document.getElementById('lucroPorKm');

        const historicoLista = document.getElementById('historicoLista');
        
        const resetarDiaBtn = document.getElementById('resetarDiaBtn');

        const verHistoricoBtn = document.getElementById('verHistoricoBtn');
        const historicoDiasLista = document.getElementById('historicoDiasLista');
        const limparHistoricoBtn = document.getElementById('limparHistoricoBtn');

        // --- Estado da Aplicação ---
        let state = {
            meta: 0,
            ganhos: 0,
            corridas: 0,
            gastos: 0,
            history: [], 
            totalTimeWorked: 0, // em ms
            lastStartTime: null, // timestamp
            status: 'stopped', // 'stopped', 'running', 'paused'
            privacyMode: false, 
            kmInicial: 0,
            kmFinal: 0
        };

        let timerInterval = null; 

        // --- Funções Auxiliares ---

        // Formata número para Real (com modo privacidade)
        function formatarBRL(valor) {
            if (state.privacyMode) {
                return "R$ --,--";
            }
            return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // Formata KM
        function formatarKM(km) {
            if (state.privacyMode) {
                return "--,-- km";
            }
            return km.toLocaleString('pt-BR', { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + ' km';
        }
        
        // Formata BRL (sempre visível, para o histórico)
        function formatarBRLVisivel(valor) {
            return (valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // Formata milissegundos para HH:MM:SS
        function formatarTempo(ms) {
            if (ms < 0) ms = 0;
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            return [hours, minutes, seconds]
                .map(v => v.toString().padStart(2, '0'))
                .join(':');
        }

        // Calcula o tempo trabalhado (incluindo o tempo atual se estiver rodando)
        function getTempoTrabalhadoAtual() {
            let tempoTotal = state.totalTimeWorked;
            if (state.status === 'running' && state.lastStartTime) {
                tempoTotal += (Date.now() - state.lastStartTime);
            }
            return tempoTotal;
        }

        // Calcula KM Rodados
        function getKMRodados() {
            const { kmInicial, kmFinal } = state;
            if (kmFinal > kmInicial) {
                return kmFinal - kmInicial;
            }
            return 0;
        }

        // --- Funções do Timer ---

        function iniciarTimer() {
            pararTimer(); // Garante que não haja timers duplicados
            timerInterval = setInterval(() => {
                const tempoTotalMs = getTempoTrabalhadoAtual();
                tempoTrabalhado.textContent = formatarTempo(tempoTotalMs);
                
                // Atualiza Média/Hora (Líquido)
                const lucro = state.ganhos - state.gastos;
                const horasTrabalhadas = tempoTotalMs / (1000 * 60 * 60);
                let mediaHoraValor = 0;
                if (horasTrabalhadas > 0) {
                    mediaHoraValor = lucro / horasTrabalhadas;
                }
                mediaPorHora.textContent = formatarBRL(mediaHoraValor);

                // NOVO: Atualiza Média/Hora (Bruto)
                let mediaHoraBrutoValor = 0;
                if (horasTrabalhadas > 0) {
                    mediaHoraBrutoValor = state.ganhos / horasTrabalhadas;
                }
                mediaPorHoraBruto.textContent = formatarBRL(mediaHoraBrutoValor);


            }, 1000);
        }

        function pararTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // --- Funções Principais ---

        // Atualiza toda a interface
        function atualizarInterface() {
            const { meta, ganhos, corridas, gastos, history, status, privacyMode } = state;

            const lucro = ganhos - gastos;
            const mediaCorrida = (corridas > 0) ? (ganhos / corridas) : 0;
            const faltando = meta - ganhos;
            const tempoTotalMs = getTempoTrabalhadoAtual();
            const horasTrabalhadas = tempoTotalMs / (1000 * 60 * 60);
            
            const totalKMRodados = getKMRodados();
            let ganhoPorKMValor = 0;
            let lucroPorKMValor = 0;
            if (totalKMRodados > 0) {
                ganhoPorKMValor = ganhos / totalKMRodados;
                lucroPorKMValor = lucro / totalKMRodados;
            }

            let mediaHoraValor = 0;
            if (horasTrabalhadas > 0) {
                mediaHoraValor = lucro / horasTrabalhadas;
            }
            
            // NOVO: Cálculo Bruto
            let mediaHoraBrutoValor = 0;
            if (horasTrabalhadas > 0) {
                mediaHoraBrutoValor = ganhos / horasTrabalhadas;
            }

            // Modo Privacidade
            togglePrivacyBtn.textContent = privacyMode ? "Mostrar" : "Ocultar";
            togglePrivacyBtn.classList.toggle('oculto', privacyMode);

            // Resumo Financeiro
            lucroLiquido.textContent = formatarBRL(lucro);
            totalGanhos.textContent = formatarBRL(ganhos);
            totalGastos.textContent = formatarBRL(gastos);

            // Cor do Lucro
            if (lucro > 0) {
                lucroLiquido.className = "text-4xl font-bold text-cyan-400";
            } else if (lucro < 0) {
                lucroLiquido.className = "text-4xl font-bold text-red-400";
            } else {
                lucroLiquido.className = "text-4xl font-bold text-gray-400";
            }

            // Meta
            if (meta > 0 && document.activeElement !== metaDiariaInput) {
                metaDiariaInput.value = meta;
            }
            let pct = 0;
            if (meta > 0) {
                pct = (ganhos / meta) * 100;
                if (pct > 100) pct = 100;
            }
            progressBar.style.width = `${pct}%`;

            if (meta === 0) {
                resumoFaltando.textContent = "Defina uma meta de ganhos brutos.";
            } else if (faltando > 0) {
                resumoFaltando.textContent = `Faltam ${formatarBRL(faltando)} para sua meta.`;
            } else {
                const extra = ganhos - meta;
                resumoFaltando.textContent = `✅ Meta batida! (${formatarBRL(extra)} extra)`;
            }
            if (privacyMode && meta > 0) {
                 resumoFaltando.textContent = `Progresso da Meta`;
            }

            // Estatísticas
            tempoTrabalhado.textContent = formatarTempo(tempoTotalMs);
            mediaPorHora.textContent = formatarBRL(mediaHoraValor);
            mediaPorHoraBruto.textContent = formatarBRL(mediaHoraBrutoValor); // NOVO
            totalCorridas.textContent = corridas;
            mediaPorCorrida.textContent = formatarBRL(mediaCorrida);

            kmRodados.textContent = formatarKM(totalKMRodados);
            ganhoPorKm.textContent = formatarBRL(ganhoPorKMValor);
            lucroPorKm.textContent = formatarBRL(lucroPorKMValor);
            
            // Cor do Lucro/KM
            if (lucroPorKMValor > 0) {
                lucroPorKm.className = "text-3xl font-semibold text-cyan-400";
            } else if (lucroPorKMValor < 0) {
                lucroPorKm.className = "text-3xl font-semibold text-red-400";
            } else {
                lucroPorKm.className = "text-3xl font-semibold text-gray-400";
            }

            // Inputs de KM
            if (state.kmInicial > 0 && document.activeElement !== kmInicialInput) {
                kmInicialInput.value = state.kmInicial;
            }
            if (state.kmFinal > 0 && document.activeElement !== kmFinalInput) { 
                kmFinalInput.value = state.kmFinal;
            }


            // Histórico
            if (history.length === 0) {
                historicoLista.innerHTML = '<p class="text-gray-400 text-center">Nenhum lançamento ainda.</p>';
            } else {
                historicoLista.innerHTML = history.slice(0, 10) // Mostra os últimos 10
                    .map(item => {
                        const valorFormatado = formatarBRL(item.value);
                        if (item.type === 'ganho') {
                            return `<div class="text-green-400">+ ${valorFormatado}</div>`;
                        } else {
                            return `<div class="text-red-400">- ${valorFormatado}</div>`;
                        }
                    }).join('');
            }
            
            // Controle de Botões de Tempo
            iniciarDiaBtn.classList.toggle('hidden', status !== 'stopped');
            pausarDiaBtn.classList.toggle('hidden', status !== 'running');
            retomarDiaBtn.classList.toggle('hidden', status !== 'paused');
            encerrarDiaBtn.classList.toggle('hidden', status === 'stopped');
            
            // Ajusta layout do Encerrar Dia
            if (status === 'paused') {
                encerrarDiaBtn.classList.remove('col-span-2');
            } else {
                encerrarDiaBtn.classList.add('col-span-2');
            }
            if (status === 'running') {
                encerrarDiaBtn.classList.remove('col-span-2');
                pausarDiaBtn.classList.remove('col-span-2');
            } else {
                pausarDiaBtn.classList.add('col-span-2');
            }
        }

        // Salva o estado atual no localStorage
        function salvarEstado() {
            localStorage.setItem('estadoMotoristaAppAvancado', JSON.stringify(state));
        }

        // Carrega o estado do localStorage
        function carregarEstado() {
            const estadoSalvo = localStorage.getItem('estadoMotoristaAppAvancado');
            if (estadoSalvo) {
                state = JSON.parse(estadoSalvo);
                // Garante que os novos campos existam
                state.gastos = state.gastos || 0;
                state.history = state.history || [];
                state.totalTimeWorked = state.totalTimeWorked || 0;
                state.lastStartTime = state.lastStartTime || null;
                state.status = state.status || 'stopped';
                state.privacyMode = state.privacyMode || false;
                state.kmInicial = state.kmInicial || 0;
                state.kmFinal = state.kmFinal || 0;

                if (state.status === 'running') {
                    iniciarTimer();
                }
            }
            atualizarInterface();
        }

        // Função para salvar o dia atual no histórico geral
        function salvarResumoDia() {
            try {
                const historicoGeral = JSON.parse(localStorage.getItem('historicoDiasMotorista')) || [];
                
                const lucro = state.ganhos - state.gastos;
                const tempoTotalMs = getTempoTrabalhadoAtual();
                const horasTrabalhadas = tempoTotalMs / (1000 * 60 * 60);
                const totalKMRodados = getKMRodados();
                
                let lucroPorKMValor = 0;
                // state.lastStartTime = null;  <- REMOVIDO, estava no lugar errado
                // state.status = 'stopped'; <- REMOVIDO, estava no lugar errado
                
                // ADICIONADO: Cálculos que estavam faltando
                if (totalKMRodados > 0) {
                    lucroPorKMValor = lucro / totalKMRodados;
                }
                let mediaHoraValor = 0;
                if (horasTrabalhadas > 0) {
                    mediaHoraValor = lucro / horasTrabalhadas;
                }

                // NOVO: Salva também a meta e KMs para futura função de "Editar"
                const resumoDia = {
                    date: new Date().toISOString(),
                    // Salva os dados brutos para permitir edição futura
                    meta: state.meta, 
                    kmInicial: state.kmInicial,
                    kmFinal: state.kmFinal,
                    // Salva os resumos
                    ganhos: state.ganhos,
                    gastos: state.gastos,
                    lucro: lucro,
                    corridas: state.corridas,
                    tempoTrabalhado: tempoTotalMs,
                    kmRodados: totalKMRodados,
                    lucroPorKm: lucroPorKMValor,
                    mediaPorHora: mediaHoraValor
                };

                historicoGeral.unshift(resumoDia); // Adiciona o mais recente no topo
                localStorage.setItem('historicoDiasMotorista', JSON.stringify(historicoGeral.slice(0, 100))); // Salva os últimos 100 dias
            } catch (e) {
                console.error("Erro ao salvar histórico de dias:", e);
            }
        }

        // --- Event Listeners (BLOCO ÚNICO E CORRIGIDO) ---

        // Modo Privacidade
        togglePrivacyBtn.addEventListener('click', () => {
            state.privacyMode = !state.privacyMode;
            atualizarInterface();
            salvarEstado();
        });

        // --- Controles de Tempo (Listeners Adicionados) ---
        iniciarDiaBtn.addEventListener('click', () => {
            state.status = 'running';
            state.lastStartTime = Date.now();
            iniciarTimer();
            atualizarInterface();
            salvarEstado();
        });
        
        pausarDiaBtn.addEventListener('click', () => {
            pararTimer();
            if (state.status === 'running') {
                state.totalTimeWorked += (Date.now() - state.lastStartTime);
            }
            state.lastStartTime = null;
            state.status = 'paused';
            atualizarInterface();
            salvarEstado();
        });

        retomarDiaBtn.addEventListener('click', () => {
            state.status = 'running';
            state.lastStartTime = Date.now();
            iniciarTimer();
            atualizarInterface();
            salvarEstado();
        });

        encerrarDiaBtn.addEventListener('click', () => {
            pararTimer();
            if (state.status === 'running') {
                state.totalTimeWorked += (Date.now() - state.lastStartTime);
            }
            state.lastStartTime = null;
            state.status = 'stopped';
            atualizarInterface(); // Atualiza o tempo final
            salvarEstado();
        }); // <-- ESTA CHAVE ESTAVA FALTANDO E FOI ADICIONADA

        // --- Controles de KM (Listeners Adicionados e Separados) ---
        salvarKmInicialBtn.addEventListener('click', () => {
            const ki = parseFloat(kmInicialInput.value);
            if (!isNaN(ki) && ki >= 0) {
                state.kmInicial = ki;
                atualizarInterface();
                salvarEstado();
                kmInicialInput.blur();
            }
        });
        
        salvarKmFinalBtn.addEventListener('click', () => {
            const kf = parseFloat(kmFinalInput.value);
            if (!isNaN(kf) && kf >= 0) {
                state.kmFinal = kf;
                atualizarInterface();
                salvarEstado();
                kmFinalInput.blur();
            }
        });


        // Salvar Meta
        salvarMetaBtn.addEventListener('click', () => {
            const novaMeta = parseFloat(metaDiariaInput.value);
            if (!isNaN(novaMeta) && novaMeta > 0) {
                state.meta = novaMeta;
                atualizarInterface();
                salvarEstado();
                metaDiariaInput.blur();
            } else if (novaMeta <= 0) {
                 state.meta = 0;
                metaDiariaInput.value = "";
                atualizarInterface();
                salvarEstado();
                metaDiariaInput.blur();
            }
        });

        // Adicionar Corrida
        addCorridaBtn.addEventListener('click', () => {
            const valor = parseFloat(valorCorridaInput.value);
            if (isNaN(valor) || valor <= 0) {
                erroInput.textContent = "Valor inválido.";
                erroInput.classList.remove('hidden');
                return;
            }
            erroInput.classList.add('hidden');
            valorCorridaInput.value = "";
            
            state.ganhos += valor;
            state.corridas += 1;
            state.history.unshift({ type: 'ganho', value: valor }); // Adiciona no início
            
            atualizarInterface();
            salvarEstado();
            valorCorridaInput.blur();
        });

        // Adicionar Gasto
        addGastoBtn.addEventListener('click', () => {
            const valor = parseFloat(valorGastoInput.value);
            if (isNaN(valor) || valor <= 0) {
                erroGasto.textContent = "Valor inválido.";
                erroGasto.classList.remove('hidden');
                return;
            }
            erroGasto.classList.add('hidden');
            valorGastoInput.value = "";
            
            state.gastos += valor;
            state.history.unshift({ type: 'gasto', value: valor }); // Adiciona no início
            
            atualizarInterface();
            salvarEstado();
            valorGastoInput.blur();
        });

        // Resetar o Dia
        resetarDiaBtn.addEventListener('click', () => {
            // REMOVIDO: if (confirm("...")) {
            // A confirmação nativa (confirm) pode não funcionar em todos os ambientes
            // e impede a execução do salvamento.
            
            // Salvar o dia no histórico antes de resetar - CONDIÇÃO CORRIGIDA
            if (state.ganhos > 0 || state.gastos > 0 || state.totalTimeWorked > 0 || getKMRodados() > 0) {
                salvarResumoDia();
                // Adicionado log para depuração
                console.log("Resumo do dia salvo com sucesso.");
            }
            
            pararTimer();
                state = {
                    meta: 0,
                    ganhos: 0,
                    corridas: 0,
                    gastos: 0,
                    history: [],
                    totalTimeWorked: 0,
                    lastStartTime: null,
                    status: 'stopped',
                    privacyMode: state.privacyMode // Mantém a escolha de privacidade
                    ,
                    kmInicial: 0,
                    kmFinal: 0
                };
                metaDiariaInput.value = "";
                kmInicialInput.value = ""; 
            kmFinalInput.value = ""; 
            
            atualizarInterface();
            salvarEstado();
            // REMOVIDO: } (fechamento do 'if' removido)
        });

        // Ver/Ocultar Histórico de Dias
        verHistoricoBtn.addEventListener('click', () => {
            const estaVisivel = !historicoDiasLista.classList.contains('hidden');
            
            if (estaVisivel) {
                historicoDiasLista.classList.add('hidden');
                limparHistoricoBtn.classList.add('hidden');
                verHistoricoBtn.textContent = "Ver Histórico de Dias Salvos";
                return;
            }

            // Carregar e mostrar o histórico
            historicoDiasLista.classList.remove('hidden');
            verHistoricoBtn.textContent = "Ocultar Histórico";
            
            renderizarHistorico(); // Chama a nova função
        });

        // NOVO: Listener para Excluir item do histórico (usa delegação de evento)
        historicoDiasLista.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-dia-btn');
            
            if (!deleteBtn) return; // Não foi no botão de excluir

            const dataId = deleteBtn.dataset.id;
            
            // Confirmação removida (não funciona bem no iframe)
            try {
                let historicoGeral = JSON.parse(localStorage.getItem('historicoDiasMotorista')) || [];
                historicoGeral = historicoGeral.filter(dia => dia.date !== dataId); // Filtra o item
                localStorage.setItem('historicoDiasMotorista', JSON.stringify(historicoGeral));
                
                // Re-renderizar a lista
                renderizarHistorico();
            } catch (err) {
                console.error("Erro ao excluir dia:", err);
            }
        });

        // NOVO: Função separada para renderizar o histórico (para re-uso)
        function renderizarHistorico() {
            const historicoGeral = JSON.parse(localStorage.getItem('historicoDiasMotorista')) || [];
            
            if (historicoGeral.length === 0) {
                historicoDiasLista.innerHTML = '<p class="text-gray-400 text-center">Nenhum dia salvo no histórico.</p>';
                limparHistoricoBtn.classList.add('hidden');
                return;
            }

            limparHistoricoBtn.classList.remove('hidden'); // Mostra o botão de limpar
            historicoDiasLista.innerHTML = historicoGeral.map(dia => {
                const data = new Date(dia.date);
                const dataFormatada = data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                
                const lucroFormatado = formatarBRLVisivel(dia.lucro);
                const kmFormatado = (dia.kmRodados || 0).toLocaleString('pt-BR', { maximumFractionDigits: 1 }) + ' km';
                const lucroKmFormatado = formatarBRLVisivel(dia.lucroPorKm);
                const tempoFormatado = formatarTempo(dia.tempoTrabalhado || 0);
                const corridas = dia.corridas || 0;

                return `
                    <div class="bg-gray-600 p-4 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-lg text-cyan-300">${dataFormatada}</h4>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-300">${corridas} corridas</span>
                                <!-- BOTÃO EXCLUIR ADICIONADO -->
                                <button data-id="${dia.date}" class="delete-dia-btn bg-red-800 hover:bg-red-700 text-white text-xs py-1 px-2 rounded transition-colors duration-200">- Excluir</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm mt-2">
                            <div><span class="text-gray-400">Lucro:</span> <strong class="text-white">${lucroFormatado}</strong></div>
                            <div><span class="text-gray-400">Tempo:</span> <strong class="text-white">${tempoFormatado}</strong></div>
                            <div><span class="text-gray-400">KM Rodados:</span> <strong class="text-white">${kmFormatado}</strong></div>
                            <div><span class="text-gray-400">Lucro/KM:</span> <strong class="text-white">${lucroKmFormatado}</strong></div>
                        </div>
                    </div>
                `;
            }).join('');
        } // <-- CORRIGIDO: Estava '});' o que quebrava o script.

        // Limpar Histórico de Dias
        limparHistoricoBtn.addEventListener('click', () => {
            // REMOVIDO: if (confirm("...")) {
            // A confirmação nativa (confirm) pode não funcionar em todos os ambientes
            localStorage.removeItem('historicoDiasMotorista');
            historicoDiasLista.innerHTML = '<p class="text-gray-400 text-center">Histórico limpo.</p>';
            limparHistoricoBtn.classList.add('hidden');
            // REMOVIDO: }
        });

        // --- Inicialização ---
        document.addEventListener('DOMContentLoaded', carregarEstado);

    </script>
</body>
</html>










