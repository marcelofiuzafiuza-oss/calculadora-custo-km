<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAX ROTA ‚Äî GESTOR DE LUCRATIVIDADE</title>

  <!-- Fonte e Chart.js (Chart ser√° usado na Parte 2) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

  <!-- ===========================
       CSS: Estilo id√™ntico ao Max Rota Di√°rio
       (usar as mesmas vari√°veis e classes)
       =========================== -->
  <style>
  :root {
    --accent: #10b981;
    --bg1: #041226;
    --bg2: #2a1160;
    --text: #e6eef6;
    --muted: #9aa6b2;
    --card: rgba(255, 255, 255, 0.06);
    --radius: 14px;
    --scale: 1.02;
  }

  html,body{height:100%;margin:0;padding:0}
  body{
    font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    color:var(--text);padding:20px;transform:scale(var(--scale));transform-origin:top left;
  }

  .wrap{max-width:1200px;margin:0 auto}
  .card{background:var(--card);backdrop-filter:blur(6px);border-radius:16px;padding:18px;margin-bottom:18px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 26px rgba(0,0,0,0.35)}
  .header-card{display:flex;justify-content:space-between;align-items:center; flex-wrap: wrap; gap: 10px;}
  .logo-img{height:74px;width:auto;border-radius:12px}
  .theme-controls{display:flex;align-items:center;gap:12px}
  .theme-btn{background:linear-gradient(120deg,var(--accent),#3b82f6);color:#fff;padding:10px 14px;border-radius:12px;border:none;font-weight:700;cursor:pointer;box-shadow:0 6px 20px rgba(0,0,0,0.3)}
  .theme-dots{display:flex;gap:10px}
  .color-dot{width:30px;height:30px;border-radius:999px;border:2px solid rgba(255,255,255,0.12);cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,0.3)}
  .radio-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(100px,1fr));
    gap:12px;
  }
  @media(max-width:480px){
    .radio-grid{grid-template-columns:repeat(2,1fr);}
  }

  .station-btn{padding:14px;border-radius:12px;color:#fff;font-weight:800;border:0;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:0.12s;font-size:16px;height:56px}
  .station-btn.active{box-shadow:0 10px 26px rgba(0,0,0,0.5);transform:translateY(-3px)}
  .radio-player{margin-top:12px;display:flex;align-items:center;gap:12px}

  .meta-row{display:flex;gap:12px}
  .meta-row input{flex:1;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.03);color:var(--text);font-weight:800;font-size:16px}
  .progress-container{height:44px;border-radius:22px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);overflow:hidden;position:relative}
  .progress-bar{position:absolute;left:0;top:0;height:100%;background:linear-gradient(120deg,var(--accent),#2563eb);width:0%;animation:waveMove 3.5s linear infinite;background-size:200% 200%}
  @keyframes waveMove{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  .progress-text{position:absolute;width:100%;height:100%;line-height:44px;text-align:center;font-weight:900;font-size:15px}
  .progress-bubbles{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;overflow:hidden}

  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .grid-4 input{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.03);color:var(--text);font-weight:700;font-size:15px}
  .big-time{font-size:20px;font-weight:900}
  .km-actions{margin-top:12px;display:flex;gap:12px;flex-wrap:wrap}
  .btn{padding:12px 16px;border-radius:12px;background:linear-gradient(120deg,var(--accent),#7c3aed);border:none;font-weight:800;cursor:pointer;color:#fff;font-size:15px;box-shadow:0 8px 20px rgba(0,0,0,0.3)}
  .btn-ghost{padding:12px 16px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);font-weight:700;cursor:pointer;color:var(--muted)}
  .grid-2cols{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .input-row{display:flex;gap:12px}
  .input-row input{flex:1;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.03);color:var(--text);font-weight:700;font-size:15px}
  .apps-grid,.gastos-grid{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
  .app-btn,.gasto-btn{padding:12px 14px;border:none;border-radius:12px;cursor:pointer;font-weight:900;color:#fff;font-size:15px;display:flex;align-items:center;justify-content:center;min-width:120px}
  .launch-list{max-height:300px;overflow-y:auto;padding:6px}
  .launch-item{display:flex;justify-content:space-between;border-bottom:1px dashed rgba(255,255,255,0.06);padding:10px 6px;border-radius:10px}
  .metric-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px}
  .metric-col{padding:12px;border-radius:12px;background:rgba(255,255,255,0.04)}
  .metric-title{font-size:13px;color:var(--muted)}
  .metric-value{margin-top:8px;font-size:18px;font-weight:900}
  .resumo-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
  .history-panel{background:rgba(255,255,255,0.03);padding:12px;border-radius:12px}
  .confetti{pointer-events:none;position:fixed;inset:0;overflow:hidden;z-index:9999}
  .confetti .c{position:absolute;width:10px;height:14px;opacity:0.95}
  .accent-green{--accent:#10b981}
  .accent-orange{--accent:#f97316}
  .accent-yellow{--accent:#facc15}
  .accent-red{--accent:#ef4444}
  .accent-pink{--accent:#ec4899}
  body.light-mode{--bg1:#f5f7fb;--bg2:#e8f0ff;--text:#0b1220;--muted:#566170;--card:rgba(255,255,255,0.9)}
  .muted{color:var(--muted)}
  .small{font-size:13px}
  .hidden-value {
    visibility: hidden;
    position: relative;
  }
  .hidden-value::after {
    content: '****';
    visibility: visible;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    color: var(--text);
    text-align: inherit;
    line-height: inherit;
    font-size: inherit;
    font-weight: inherit;
  }
  .header-actions-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: flex-end;
  }
  .toggle-btn {
    padding: 6px 10px;
    border-radius: 8px;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.08);
    font-weight: 600;
    cursor: pointer;
    color: var(--text);
    font-size: 13px;
    white-space: nowrap;
    width: fit-content;
  }

  /* Pequenas utilit√°rias para manter compatibilidade com JS original */
  .mt-2{margin-top:8px}
  .mt-3{margin-top:12px}
  .mt-4{margin-top:16px}
  .w-full{width:100%}

  @media(max-width:1000px){body{transform:scale(1.00)}.grid-4{grid-template-columns:repeat(2,1fr)}.grid-2cols{grid-template-columns:1fr}.wrap{padding:8px}}
  </style>
</head>

<body class="accent-green">
  <div class="wrap">
    <!-- HEADER (id√™ntico ao Max Rota Di√°rio) -->
    <header class="card header-card" role="banner" aria-label="Cabe√ßalho MAX ROTA">
      <div style="display:flex;align-items:center;gap:12px">
        <img id="logoImg" class="logo-img" src="https://i.postimg.cc/3RWn008g/Chat-GPT-Image-12-de-nov-de-2025-14-32-56.png" alt="MAX ROTA ‚Äî GESTOR">
        <div>
          <h1 id="pageTitle" style="margin:0;font-size:20px">MAX ROTA ‚Äî GESTOR DE LUCRATIVIDADE</h1>
          <div class="small muted">Painel de Gest√£o ‚Äî Lucratividade e Proje√ß√µes</div>
        </div>
      </div>

      <div class="header-actions-container">
        <div class="theme-controls" aria-hidden="false">
          <button id="autoThemeBtn" class="theme-btn" title="Ativar modo autom√°tico dia/noite">Auto üåó</button>
          <div class="theme-dots" role="toolbar" aria-label="Temas" style="margin-left:8px">
            <button class="color-dot" data-accent="green" style="background:#10b981" title="Verde"></button>
            <button class="color-dot" data-accent="orange" style="background:#f97316" title="Laranja"></button>
            <button class="color-dot" data-accent="yellow" style="background:#facc15" title="Amarelo"></button>
            <button class="color-dot" data-accent="red" style="background:#ef4444" title="Vermelho"></button>
            <button class="color-dot" data-accent="pink" style="background:#ec4899" title="Rosa"></button>
          </div>
        </div>
        <button id="toggleValuesBtn" class="toggle-btn" aria-pressed="false" title="Mostrar/Esconder valores monet√°rios e de contagem">Esconder Valores</button>
      </div>
    </header>

    <!-- ======= Se√ß√µes: copiei TUDO do Gestor original (IDs preservados) ======= -->

    <!-- R√°dios / Controle de √°udio (preservado para compatibilidade) -->
    <section class="card radio-card" aria-label="R√°dios">
      <div style="display:flex; justify-content: space-between; align-items: center;">
        <h2 style="margin:0;font-size:16px">üéß Esta√ß√µes</h2>
        <button id="logoutBtn" class="btn">Sair</button>
      </div>

      <div id="stationButtons" class="radio-grid" role="list" aria-label="Lista de r√°dios">
        <!-- bot√µes de esta√ß√£o (preservei os mesmos data-src/data-name para compatibilidade com seu JS) -->
        <button class="station-btn" data-src="https://live.hunter.fm/pop_high" data-name="Hunter Pop" style="background:#10b981">Hunter Pop</button>
        <button class="station-btn" data-src="https://live.hunter.fm/pop2k_high" data-name="Hunter Pop2K" style="background:#06b6d4">Pop2K</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/u80s-128-mp3" data-name="Flashback 80s" style="background:#8b5cf6">80s</button>
        <button class="station-btn" data-src="http://listen.181fm.com/181-power_128k.mp3" data-name="Power 181" style="background:#f97316">Power181</button>

        <button class="station-btn" data-src="https://live.hunter.fm/rock_high" data-name="Rock Classic" style="background:#ef4444">Rock</button>
        <button class="station-btn" data-src="https://live.hunter.fm/sertanejo_high" data-name="Sertanejo" style="background:#f59e0b">Sertanejo</button>
        <button class="station-btn" data-src="https://live.hunter.fm/hiphop_high" data-name="Hip Hop" style="background:#111827">HipHop</button>
        <button class="station-btn" data-src="https://live.hunter.fm/gospel_high" data-name="Crist√£" style="background:#facc15;color:#111">Crist√£</button>

        <button class="station-btn" data-src="https://ice1.somafm.com/groovesalad-128-mp3" data-name="GrooveSalad" style="background:#2563eb">Eletr√¥nica</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/beatblender-128-mp3" data-name="BeatBlender" style="background:#7c3aed">House / Deep</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/secretagent-128-mp3" data-name="Surf" style="background:#06b6d4">Surf</button>
        <button class="station-btn" data-src="https://ice1.somafm.com/dubstep-128-mp3" data-name="Reggae/Dub" style="background:#4ade80">Reggae</button>

        <button class="station-btn" data-src="https://live.hunter.fm/mpb_high" data-name="MPB Brasil" style="background:#1e3a8a">MPB</button>
        <button class="station-btn" data-src="https://stream.radioparadise.com/mp3-192" data-name="Radio Paradise" style="background:#111827">RadioParadise</button>
        <button class="station-btn" data-src="http://listen.181fm.com/181-beat_128k.mp3" data-name="181 HipHop" style="background:#0ea5e9">181 HipHop</button>
        <button class="station-btn" data-src="https://live.hunter.fm/mpb_high" data-name="MPB (alt)" style="background:#8b5cf6">MPB alt</button>
      </div>

      <div class="radio-player mt-4" aria-label="Player de r√°dio">
        <audio id="radioPlayer" controls preload="none" class="w-full" aria-label="Player de r√°dio"></audio>
        <div style="display:flex;flex-direction:column;gap:8px;margin-left:12px">
          <button id="stopRadioBtn" class="btn-ghost w-36" aria-label="Parar r√°dio">Parar R√°dio</button>
          <div id="nowPlaying" class="small muted" aria-live="polite">Nenhuma r√°dio selecionada.</div>
        </div>
      </div>
    </section>

    <!-- Meta di√°ria -->
    <section class="card meta-card" aria-label="Meta di√°ria">
      <h2 style="margin:0 0 8px 0;font-size:16px">üéØ Meta Di√°ria</h2>

      <div class="meta-row mt-3" role="form" aria-label="Definir meta di√°ria">
        <input id="metaInput" type="number" placeholder="Ex: 300" aria-label="Valor da meta" />
        <button id="setMetaBtn" class="btn" aria-label="Salvar meta">Salvar Meta</button>
      </div>

      <div class="progress-container mt-4" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div id="progressBar" class="progress-bar" style="width:0%"></div>
        <div id="progressBubbles" class="progress-bubbles" aria-hidden="true"></div>
        <div id="progressText" class="progress-text">0%</div>
      </div>

      <div id="metaMessage" class="small muted mt-2" aria-live="polite">Defina a meta para acompanhar o progresso.</div>
    </section>

    <!-- Jornada e KM -->
    <section class="card km-card" aria-label="Jornada e quilometragem">
      <h2 style="margin:0 0 8px 0;font-size:16px">üöó Jornada e KM</h2>

      <div class="grid-4 mt-3" role="group" aria-label="Campos de quilometragem e tempo">
        <div>
          <label class="small muted" for="kmInicial">KM Inicial</label>
          <input id="kmInicial" type="number" placeholder="Ex: 150000" aria-label="KM inicial" />
        </div>

        <div>
          <label class="small muted" for="kmFinal">KM Final</label>
          <input id="kmFinal" type="number" placeholder="Ex: 150250" aria-label="KM final" />
        </div>

        <div>
          <label class="small muted">Tempo Trabalhado</label>
          <div id="tempoTrabalhado" class="big-time" aria-live="polite">00:00:00</div>
        </div>

        <div>
          <label class="small muted">KM Rodados</label>
          <div id="kmRodados" class="big-time" aria-live="polite">0.0 km</div>
        </div>
      </div>

      <div class="km-actions">
        <button id="toggleStartBtn" class="btn mt-4" aria-pressed="false">Iniciar Expediente</button>
        <button id="finalizeBtn" class="btn-ghost mt-4">Finalizar Dia</button>
        <button id="saveKmBtn" class="btn mt-4">Salvar KM</button>
      </div>
    </section>

    <!-- Lan√ßamentos: entradas e sa√≠das -->
    <section class="card lancamentos-card grid-2cols" aria-label="Lan√ßamentos">
      <div>
        <h3 style="margin:0 0 8px 0;font-size:15px">‚ûï Entradas (Apps)</h3>

        <div class="input-row mt-2" role="form" aria-label="Lan√ßar entrada">
          <input id="valorEntrada" type="number" placeholder="Valor (R$)" aria-label="Valor de entrada" />
          <button id="addEntradaBtn" class="btn" aria-label="Adicionar entrada">Lan√ßar</button>
        </div>

        <div class="apps-grid mt-2" role="list" aria-label="Lista de apps">
          <button class="app-btn" data-cat="Uber" style="background:#000">Uber</button>
          <button class="app-btn" data-cat="99" style="background:#facc15;color:#111">99</button>
          <button class="app-btn" data-cat="inDriver" style="background:#10b981">inDriver</button>
          <button class="app-btn" data-cat="Particular" style="background:#6b7280">Particular</button>
          <button class="app-btn" data-cat="Loja" style="background:#1e3a8a">Loja</button>
          <button class="app-btn" data-cat="Doa√ß√£o" style="background:#8b5cf6">Doa√ß√£o</button>
        </div>
      </div>

      <div>
        <h3 style="margin:0 0 8px 0;font-size:15px">‚ûñ Sa√≠das (Gastos)</h3>

        <div class="input-row mt-2" role="form" aria-label="Lan√ßar gasto">
          <input id="valorSaida" type="number" placeholder="Valor (R$)" aria-label="Valor de sa√≠da" />
          <button id="addSaidaBtn" class="btn" aria-label="Adicionar gasto">Lan√ßar</button>
        </div>

        <div class="gastos-grid mt-2" role="list" aria-label="Principais gastos">
          <button class="gasto-btn" data-cat="Combust√≠vel" style="background:#ef4444">Combust√≠vel</button>
          <button class="gasto-btn" data-cat="Alimenta√ß√£o" style="background:#8b5cf6">Alimenta√ß√£o</button>
          <button class="gasto-btn" data-cat="Manuten√ß√£o" style="background:#6b7280">Manuten√ß√£o</button>
          <button class="gasto-btn" data-cat="Outros" style="background:#374151">Outros</button>
        </div>
      </div>
    </section>

    <!-- Lan√ßamentos recentes -->
    <section class="card recentes-card" aria-label="Lan√ßamentos recentes">
      <h3 style="margin:0 0 8px 0;font-size:15px">Lan√ßamentos Recentes</h3>
      <div id="lancamentosList" class="launch-list mt-2" aria-live="polite">
        <div class="muted small text-center">Nenhum lan√ßamento ainda.</div>
      </div>
    </section>

    <!-- Resumo por categoria -->
    <section class="card resumo-cat" aria-label="Resumo por categoria">
      <h3 style="margin:0 0 8px 0;font-size:15px">Resumo R√°pido por Categoria</h3>
      <div id="resumoCategorias" class="resumo-grid mt-2 small muted" role="list"></div>
    </section>

    <!-- M√©tricas -->
    <section class="card metric-card" aria-label="M√©tricas">
      <h3 style="margin:0 0 8px 0;font-size:15px">M√©tricas</h3>

      <div class="metric-grid mt-3">
        <div class="metric-col">
          <div class="metric-title">Ganhos Brutos ‚Äî Somente Apps</div>
          <div id="metricGanhosApps" class="metric-value text-green-400">R$ 0,00</div>
        </div>

        <div class="metric-col">
          <div class="metric-title">Ganhos Brutos ‚Äî Apps + Loja</div>
          <div id="metricGanhosTotal" class="metric-value text-cyan-300">R$ 0,00</div>
        </div>

        <div class="metric-col">
          <div class="metric-title">Gastos Totais</div>
          <div id="metricGastosTotal" class="metric-value text-red-400">R$ 0,00</div>
        </div>

        <div class="metric-col">
          <div class="metric-title">Lucro L√≠quido</div>
          <div id="metricLucroTotal" class="metric-value">R$ 0,00</div>
        </div>

        <div class="metric-col">
          <div class="metric-title">M√©dia/Hora (Bruto)</div>
          <div id="metricMediaHoraBrutoTotal" class="metric-value">R$ 0,00</div>
        </div>

        <div class="metric-col">
          <div class="metric-title">M√©dia/Hora (L√≠quido)</div>
          <div id="metricMediaHoraLiqTotal" class="metric-value">R$ 0,00</div>
        </div>

        <div class="metric-col">
          <div class="metric-title">Lucro / KM (L√≠quido)</div>
          <div id="metricLucroKmTotal" class="metric-value">R$ 0,00</div>
        </div>

        <div class="metric-col">
          <div class="metric-title">Entradas Apps</div>
          <div id="metricEntradasApps" class="metric-value">0</div>
        </div>

        <div class="metric-col">
          <div class="metric-title">Entradas Loja</div>
          <div id="metricEntradasLoja" class="metric-value">0</div>
        </div>
      </div>
    </section>

    <!-- A√ß√µes -->
    <section class="card actions-card" aria-label="A√ß√µes">
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <button id="saveAndResetBtn" class="btn">Salvar Resumo & Resetar Dia</button>
        <button id="exportBtn" class="btn-ghost">Exportar Resumo (JSON)</button>
        <button id="viewHistoryBtn" class="btn-ghost">Ver Hist√≥rico de Dias</button>
      </div>

      <div id="historyPanel" class="history-panel mt-4 hidden" aria-live="polite"></div>
    </section>

    <!-- Resumo final -->
    <section class="card final-resumo" aria-label="Resumo final">
      <h3 style="margin:0 0 8px 0;font-size:15px">Resumo Final por Categoria</h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-top:8px">
        <div style="background:linear-gradient(135deg,rgba(255,255,255,0.06),rgba(255,255,255,0.03));padding:12px;border-radius:12px;text-align:center">
          <div class="muted">Total Apps</div>
          <div id="finalTotalApps" class="metric-value">R$ 0,00</div>
        </div>
        <div style="background:linear-gradient(135deg,rgba(255,255,255,0.06),rgba(255,255,255,0.03));padding:12px;border-radius:12px;text-align:center">
          <div class="muted">Total Loja</div>
          <div id="finalTotalLoja" class="metric-value">R$ 0,00</div>
        </div>
        <div style="background:linear-gradient(135deg,rgba(255,255,255,0.06),rgba(255,255,255,0.03));padding:12px;border-radius:12px;text-align:center">
          <div class="muted">Total Doa√ß√µes</div>
          <div id="finalTotalDoacao" class="metric-value">R$ 0,00</div>
        </div>
        <div style="background:linear-gradient(135deg,var(--accent),#3b82f6);padding:12px;border-radius:12px;text-align:center;color:#fff">
          <div class="muted" style="opacity:0.9">Total Geral</div>
          <div id="finalTotalGeral" class="metric-value">R$ 0,00</div>
        </div>
      </div>
    </section>

    <footer class="small muted" style="text-align:center;margin-top:10px">Dados armazenados localmente (localStorage) e sincronizados com Firestore.</footer>
  </div>

  <div id="confettiRoot" class="confetti" aria-hidden="true"></div>

  <!-- PARTE 2: SCRIPTS
       -------------------------------------------------------
       A seguir voc√™ colar√° a Parte 2 (JavaScript completo):
       - inicializa√ß√£o firebase (se quiser manter)
       - todas as fun√ß√µes e handlers do Gestor original
       - charts, proje√ß√µes da IA, e demais l√≥gicas
       - sincroniza√ß√£o de tema / esconder valores / etc.
       -------------------------------------------------------
  -->
</body>
</html>
<!-- PARTE 2: SCRIPTS (Cole abaixo do <!-- PARTE 2: SCRIPTS --> ) -->
<script>
/* ==========================================================
   MAX ROTA ‚Äî GESTOR DE LUCRATIVIDADE (PARTE 2 - JS)
   - Preserva l√≥gica original (localStorage, charts, IA)
   - Integra com a Parte 1 (mesmos IDs)
   - Fonte / refer√™ncia: seu arquivo original (daily_tracker_app_style.html). Ó®Å1Ó®Ç
   ========================================================== */

/* =========================
   Vari√°veis e Estado
   ========================= */
const LOCAL_RECORDS_KEY = 'maxrota_gestor_records_v1';
const LOCAL_CONFIG_KEY = 'maxrota_gestor_config_v1';

let allRecords = [];
let currentCalculatedData = null;
let recordIdToUpdate = { value: '' }; // placeholder ser√° ligado a elemento real abaixo
let geminiPredictionDebounceTimer = null;
let waitTimeInterval = null;
let timerStartTime = null;
let totalWaitSeconds = 0;
let trendChartInstance = null, gainChartInstance = null, expenseChartInstance = null, gainPerHourChartInstance = null, tripsPerHourChartInstance = null;
let apiKey = ''; // se for usar IA localmente, insira aqui

/* =========================
   Elementos DOM (mapa)
   ========================= */
/* many elements are present in the markup of Parte 1 (ids preserved) */
const elements = {
    // core inputs
    dailyInfo: document.getElementById('dailyInfo'),
    // private fare inputs
    rideKm: document.getElementById('rideKm'),
    rideTimeMinutes: document.getElementById('rideTimeMinutes'),
    rideKmRate: document.getElementById('rideKmRate'),
    tollCost: document.getElementById('tollCost'),
    waitTimeMinutes: document.getElementById('waitTimeMinutes'),
    waitTimeDisplay: document.getElementById('waitTimeDisplay'),
    startWaitButton: document.getElementById('startWaitButton'),
    resetWaitButton: document.getElementById('resetWaitButton'),
    privateFareDisplay: document.getElementById('privateFareDisplay'),
    marginDisplay: document.getElementById('marginDisplay'),
    waitRateDisplay: document.getElementById('waitRateDisplay'),

    // fixed cost calc
    monthlyKmEstimate: document.getElementById('monthlyKmEstimate'),
    costProLabore: document.getElementById('costProLabore'),
    costVehiclePayment: document.getElementById('costVehiclePayment'),
    costMobileInternet: document.getElementById('costMobileInternet'),
    costAesthetics: document.getElementById('costAesthetics'),
    costOilChange: document.getElementById('costOilChange'),
    costTireChange: document.getElementById('costTireChange'),
    costAnnualInsurance: document.getElementById('costAnnualInsurance'),
    costAnnualDocumentation: document.getElementById('costAnnualDocumentation'),
    costAnnualDepreciation: document.getElementById('costAnnualDepreciation'),
    fixedCostPerKm: document.getElementById('fixedCostPerKm'),
    totalMonthlyFixedCostDisplay: document.getElementById('totalMonthlyFixedCostDisplay'),
    calculateFixedCostButton: document.getElementById('calculateFixedCostButton'),

    // gains & expenses (IDs preserved from original)
    gainUber: document.getElementById('gainUber'),
    gain99: document.getElementById('gain99'),
    gainIndriver: document.getElementById('gainIndriver'),
    gainPrivate: document.getElementById('gainPrivate'),
    gainProducts: document.getElementById('gainProducts'),

    expenseFuel: document.getElementById('expenseFuel'),
    expenseFood: document.getElementById('expenseFood'),
    expenseParking: document.getElementById('expenseParking'),
    expenseEmergency: document.getElementById('expenseEmergency'),
    expenseOthers: document.getElementById('expenseOthers'),

    // summary displays
    summaryGains: document.getElementById('summaryGains'),
    summaryCosts: document.getElementById('summaryCosts'),
    summaryNetProfit: document.getElementById('summaryNetProfit'),

    resultNetProfit: document.getElementById('resultNetProfit'),
    resultTotalCost: document.getElementById('resultTotalCost'),
    resultCostPerKm: document.getElementById('resultCostPerKm'),
    resultProfitPerKm: document.getElementById('resultProfitPerKm'),

    // goals & projections
    weeklyGoalInput: document.getElementById('weeklyGoalInput'),
    monthlyGoalInput: document.getElementById('monthlyGoalInput'),
    weeklyGoalDisplay: document.getElementById('weeklyGoalDisplay'),
    monthlyGoalDisplay: document.getElementById('monthlyGoalDisplay'),
    weeklyProgressBar: document.getElementById('weeklyProgressBar'),
    weeklyProgressValue: document.getElementById('weeklyProgressValue'),
    monthlyProgressBar: document.getElementById('monthlyProgressBar'),
    monthlyProgressValue: document.getElementById('monthlyProgressValue'),
    weeklyProgressLabel: document.getElementById('weeklyProgressLabel'),
    monthlyProgressLabel: document.getElementById('monthlyProgressLabel'),
    saveGoalsButton: document.getElementById('saveGoalsButton'),

    // history & management
    historyList: document.getElementById('historyList'),
    loadingHistory: document.getElementById('loadingHistory'),
    exportButton: document.getElementById('exportButton'),
    importButton: document.getElementById('importButton'),
    importFile: document.getElementById('importFile'),

    // filters
    filterMonth: document.getElementById('filterMonth'),
    filterYear: document.getElementById('filterYear'),

    // metrics consolidated
    monthlyHoursTotal: document.getElementById('monthlyHoursTotal'),
    weeklyHoursTotal: document.getElementById('weeklyHoursTotal'),
    monthlyTripsTotal: document.getElementById('monthlyTripsTotal'),
    weeklyTripsTotal: document.getElementById('weeklyTripsTotal'),
    monthlyHoursUber: document.getElementById('monthlyHoursUber'),
    monthlyHours99: document.getElementById('monthlyHours99'),
    monthlyHoursIndriver: document.getElementById('monthlyHoursIndriver'),
    monthlyHoursPrivate: document.getElementById('monthlyHoursPrivate'),
    monthlyTripsUber: document.getElementById('monthlyTripsUber'),
    monthlyTrips99: document.getElementById('monthlyTrips99'),
    monthlyTripsIndriver: document.getElementById('monthlyTripsIndriver'),
    monthlyTripsPrivate: document.getElementById('monthlyTripsPrivate'),

    // charts - canvases exist in Parte 1
    gainChartCtx: document.getElementById('gainChart') ? document.getElementById('gainChart').getContext('2d') : null,
    expenseChartCtx: document.getElementById('expenseChart') ? document.getElementById('expenseChart').getContext('2d') : null,
    trendChartCtx: document.getElementById('trendChart') ? document.getElementById('trendChart').getContext('2d') : null,
    gainPerHourChartCtx: document.getElementById('gainPerHourChart') ? document.getElementById('gainPerHourChart').getContext('2d') : null,
    tripsPerHourChartCtx: document.getElementById('tripsPerHourChart') ? document.getElementById('tripsPerHourChart').getContext('2d') : null,

    // IA analysis areas (if present)
    geminiAnalysisContent: document.getElementById('geminiAnalysisContent'),
    geminiCitations: document.getElementById('geminiCitations'),
    geminiApiKeyWarning: document.getElementById('geminiApiKeyWarning'),

    // misc
    saveButton: document.getElementById('saveButton'),
    deleteButton: document.getElementById('deleteButton'),
    loadingIndicator: document.getElementById('loadingIndicator'),
    riskAlertBanner: document.getElementById('riskAlertBanner'),
    calculateButton: document.getElementById('calculateButton'),
};

/* Safety: ensure elements exist (avoid null errors) */
Object.keys(elements).forEach(k => { if (!elements[k]) elements[k] = null; });

/* =========================
   Helpers
   ========================= */
function getFloatValue(el) {
    if (!el) return 0;
    const v = parseFloat(el.value);
    return isNaN(v) ? 0 : v;
}
function formatCurrency(value, decimals = 2) {
    const n = Number(value || 0);
    return 'R$ ' + n.toFixed(decimals).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}
function formatCurrencyRaw(value, decimals = 2) {
    return Number(value || 0).toFixed(decimals);
}
function generateUniqueId() {
    return 'r_' + Date.now().toString(36) + Math.random().toString(36).slice(2,8);
}
function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

/* =========================
   Load / Save Config & Records (LocalStorage)
   ========================= */
function loadFixedCostInputsLocal() {
    try {
        const cfg = JSON.parse(localStorage.getItem(LOCAL_CONFIG_KEY) || '{}');
        if (!cfg) return;
        // map known keys; safe guard with existence checks
        if (elements.monthlyKmEstimate) elements.monthlyKmEstimate.value = cfg.monthlyKmEstimate || '';
        if (elements.costProLabore) elements.costProLabore.value = cfg.costProLabore || '';
        if (elements.costVehiclePayment) elements.costVehiclePayment.value = cfg.costVehiclePayment || '';
        if (elements.costMobileInternet) elements.costMobileInternet.value = cfg.costMobileInternet || '';
        if (elements.costAesthetics) elements.costAesthetics.value = cfg.costAesthetics || '';
        if (elements.costOilChange) elements.costOilChange.value = cfg.costOilChange || '';
        if (elements.costTireChange) elements.costTireChange.value = cfg.costTireChange || '';
        if (elements.costAnnualInsurance) elements.costAnnualInsurance.value = cfg.costAnnualInsurance || '';
        if (elements.costAnnualDocumentation) elements.costAnnualDocumentation.value = cfg.costAnnualDocumentation || '';
        if (elements.costAnnualDepreciation) elements.costAnnualDepreciation.value = cfg.costAnnualDepreciation || '';
        if (elements.fixedCostPerKm) elements.fixedCostPerKm.value = cfg.fixedCostPerKmValue || '';
        if (elements.weeklyGoalInput) elements.weeklyGoalInput.value = cfg.weeklyGoal || '';
        if (elements.monthlyGoalInput) elements.monthlyGoalInput.value = cfg.monthlyGoal || '';
    } catch (e) {
        console.warn('Erro loadFixedCostInputsLocal', e);
    }
}

function saveFixedCostInputsLocal(showSuccessLog = false) {
    try {
        const data = {
            monthlyKmEstimate: getFloatValue(elements.monthlyKmEstimate),
            costProLabore: getFloatValue(elements.costProLabore),
            costVehiclePayment: getFloatValue(elements.costVehiclePayment),
            costMobileInternet: getFloatValue(elements.costMobileInternet),
            costAesthetics: getFloatValue(elements.costAesthetics),
            costOilChange: getFloatValue(elements.costOilChange),
            costTireChange: getFloatValue(elements.costTireChange),
            costAnnualInsurance: getFloatValue(elements.costAnnualInsurance),
            costAnnualDocumentation: getFloatValue(elements.costAnnualDocumentation),
            costAnnualDepreciation: getFloatValue(elements.costAnnualDepreciation),
            profitMarginPercent: getFloatValue(elements.profitMarginPercent || { value: 0 }),
            weeklyGoal: getFloatValue(elements.weeklyGoalInput),
            monthlyGoal: getFloatValue(elements.monthlyGoalInput),
            fixedCostPerKmValue: getFloatValue(elements.fixedCostPerKm)
        };
        localStorage.setItem(LOCAL_CONFIG_KEY, JSON.stringify(data));
        if (showSuccessLog && elements.saveGoalsButton) {
            elements.saveGoalsButton.textContent = "METAS SALVAS!";
            setTimeout(()=> { elements.saveGoalsButton.textContent = "SALVAR METAS"; }, 1600);
        }
    } catch (e) {
        console.error('saveFixedCostInputsLocal', e);
    }
}

function saveRecordsToLocal() {
    try {
        localStorage.setItem(LOCAL_RECORDS_KEY, JSON.stringify(allRecords));
    } catch (e) {
        console.error('saveRecordsToLocal', e);
    }
}

function loadRecordsLocal() {
    try {
        const raw = localStorage.getItem(LOCAL_RECORDS_KEY);
        allRecords = raw ? JSON.parse(raw) : [];
        // Sort descending by date (if dateInfo present)
        allRecords.sort((a,b) => (b.dateInfo || '').localeCompare(a.dateInfo || ''));
        renderHistory(allRecords);
        calculateSummaries(allRecords);
        calculateDailyProfit(false);
        if (elements.loadingHistory) elements.loadingHistory.style.display = allRecords.length ? 'none' : 'block';
    } catch (e) {
        console.error('loadRecordsLocal', e);
    }
}

/* =========================
   CRUD: Save / Delete record
   ========================= */
function saveRecord() {
    if (!currentCalculatedData) {
        alert('Calcule o lucro do dia antes de salvar (pressione CALCULAR).');
        return;
    }
    const isUpdate = (recordIdToUpdate.value && recordIdToUpdate.value !== '');
    try {
        const item = Object.assign({}, currentCalculatedData);
        if (!isUpdate) {
            item.id = generateUniqueId();
            allRecords.push(item);
        } else {
            const idx = allRecords.findIndex(r => r.id === recordIdToUpdate.value);
            if (idx !== -1) allRecords[idx] = item;
        }
        saveRecordsToLocal();
        clearInputFields();
        loadRecordsLocal();
        alert('Lan√ßamento salvo!');
    } catch (e) {
        console.error('saveRecord', e);
    }
}

function deleteRecordLocal(recordId) {
    if (!confirm('Tem certeza que deseja EXCLUIR este lan√ßamento?')) return;
    allRecords = allRecords.filter(r => r.id !== recordId);
    saveRecordsToLocal();
    loadRecordsLocal();
}

/* expose for history buttons */
window.deleteRecordLocal = deleteRecordLocal;

/* =========================
   Clear / Load record to inputs
   ========================= */
function clearInputFields() {
    // Clear typical inputs (safe: check existence)
    const fields = ['dailyInfo','rideKm','rideTimeMinutes','rideKmRate','tollCost','waitTimeMinutes','waitTimeDisplay',
                    'gainUber','gain99','gainIndriver','gainPrivate','gainProducts',
                    'expenseFuel','expenseFood','expenseParking','expenseEmergency','expenseOthers'];
    fields.forEach(id => {
        try{ const el = document.getElementById(id); if(el) el.value = ''; }catch(e){}
    });
    // Reset temporary state
    recordIdToUpdate.value = '';
    if (elements.saveButton) elements.saveButton.textContent = 'SALVAR LAN√áAMENTO';
    resetDailyDisplay();
}

function loadRecordToInputs(data) {
    // Map data to inputs (IDs preserved)
    try {
        if (!data) return;
        if (elements.dailyInfo) elements.dailyInfo.value = data.dateInfo || '';
        if (elements.dailyKmInput) elements.dailyKmInput.value = data.dailyKm || '';
        if (elements.gainUber) elements.gainUber.value = data.gainUber || '';
        if (elements.gain99) elements.gain99.value = data.gain99 || '';
        if (elements.gainIndriver) elements.gainIndriver.value = data.gainIndriver || '';
        if (elements.gainPrivate) elements.gainPrivate.value = data.gainPrivate || '';
        if (elements.gainProducts) elements.gainProducts.value = data.gainProducts || '';

        if (elements.expenseFuel) elements.expenseFuel.value = data.expenseFuel || 0;
        if (elements.expenseFood) elements.expenseFood.value = data.expenseFood || 0;
        if (elements.expenseParking) elements.expenseParking.value = data.expenseParking || 0;
        if (elements.expenseEmergency) elements.expenseEmergency.value = data.expenseEmergency || 0;
        if (elements.expenseOthers) elements.expenseOthers.value = data.expenseOthers || 0;

        // show update state
        recordIdToUpdate.value = data.id || '';
        if (elements.saveButton) elements.saveButton.textContent = 'ATUALIZAR LAN√áAMENTO';
        calculateDailyProfit(false);
    } catch (e) {
        console.error('loadRecordToInputs error', e);
    }
}

/* =========================
   Rendering: History & Summaries
   ========================= */
function renderHistory(records) {
    if (!elements.historyList) return;
    elements.historyList.innerHTML = '';
    const selectedMonth = elements.filterMonth ? elements.filterMonth.value : '';
    const selectedYear = elements.filterYear ? elements.filterYear.value : '';

    let filtered = (records || []).slice();
    if (selectedYear) filtered = filtered.filter(r => r.dateInfo && r.dateInfo.startsWith(selectedYear));
    if (selectedMonth) filtered = filtered.filter(r => r.dateInfo && r.dateInfo.slice(5,7) === selectedMonth);

    if (filtered.length === 0) {
        elements.loadingHistory.textContent = 'Nenhum lan√ßamento encontrado para o filtro selecionado.';
        elements.loadingHistory.style.display = 'block';
        return;
    } else {
        elements.loadingHistory.style.display = 'none';
    }

    filtered.forEach(data => {
        const li = document.createElement('li');
        const dateDisplay = formatDateDisplay(data.dateInfo);
        const profit = data.netProfit || 0;
        const profitKm = data.profitPerKm || 0;
        const profitClass = profit < 0 ? 'text-red-400' : 'text-green-400';

        li.className = 'history-item bg-gray-800 p-3 rounded-lg flex justify-between items-center hover:bg-gray-700 cursor-pointer';
        li.innerHTML = `
            <div class="flex flex-col flex-grow">
                <span class="text-sm font-semibold text-white">${dateDisplay}</span>
                <span class="text-xs ${profitClass}">L√≠q.: ${formatCurrency(profit)} | Lucro/KM: ${formatCurrencyRaw(profitKm,3)}</span>
                <span class="history-details text-xs">KM: ${data.dailyKm || 0} | Bruto: ${formatCurrency(data.totalGains || 0)}</span>
            </div>
            <button class="delete-btn text-lg text-red-500 ml-2" title="Excluir Lan√ßamento">&times;</button>
        `;
        // click to load
        li.addEventListener('click', () => loadRecordToInputs(data));
        // delete button
        li.querySelector('.delete-btn').addEventListener('click', (ev) => {
            ev.stopPropagation();
            deleteRecordLocal(data.id);
            loadRecordsLocal();
        });

        elements.historyList.appendChild(li);
    });
}

function calculateSummaries(records) {
    // quick totals
    const totals = records.reduce((acc, r) => {
        acc.totalGains += Number(r.totalGains || 0);
        acc.totalCosts += Number(r.totalCosts || 0);
        acc.netProfit += Number(r.netProfit || 0);
        return acc;
    }, { totalGains: 0, totalCosts: 0, netProfit: 0 });

    if (elements.summaryGains) elements.summaryGains.textContent = formatCurrency(totals.totalGains);
    if (elements.summaryCosts) elements.summaryCosts.textContent = formatCurrency(totals.totalCosts);
    if (elements.summaryNetProfit) elements.summaryNetProfit.textContent = formatCurrency(totals.netProfit);
}

/* =========================
   Charts: helpers and renderers (Chart.js 3)
   ========================= */
function createChart(ctxId, type, data, options) {
    // clean up if exists
    try {
        if (ctxId && ctxId.canvas && ctxId.canvas.id) {
            // no-op
        }
    } catch(e){}

    return new Chart(ctxId, { type, data, options });
}

function createChartOptions(tickCallback) {
    return {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (ctx) => tickCallback ? tickCallback(ctx.parsed.y) : ctx.parsed.y } }
        },
        scales: {
            x: { grid: { display: false }, ticks: { color: '#cbd5e1' } },
            y: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#cbd5e1', callback: (v) => tickCallback ? tickCallback(v) : v } }
        }
    };
}

function renderGainChart(dataObj = {}) {
    if (!elements.gainChartCtx) return;
    const labels = dataObj.labels || [];
    const data = dataObj.data || [];
    const chartData = {
        labels,
        datasets: [{ data, borderColor: '#34d399', backgroundColor: function(context){
            const chart = context.chart;
            const { ctx, chartArea } = chart;
            if (!chartArea) return '#34d399';
            const grad = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
            grad.addColorStop(0, '#34d39955');
            grad.addColorStop(1, '#0ea5e900');
            return grad;
        }, tension: 0.35, fill: true }]
    };
    const opts = createChartOptions(v => 'R$ ' + v);
    if (gainChartInstance) gainChartInstance.destroy();
    gainChartInstance = createChart(elements.gainChartCtx, 'bar', chartData, opts);
}

function renderExpenseChart(dataObj = {}) {
    if (!elements.expenseChartCtx) return;
    const labels = dataObj.labels || [];
    const data = dataObj.data || [];
    const chartData = { labels, datasets: [{ data, backgroundColor: ['#ef4444','#f97316','#facc15','#7c3aed'], borderRadius:6 }] };
    const opts = { plugins: { legend: { display: true, position: 'bottom' } }, maintainAspectRatio:false };
    if (expenseChartInstance) expenseChartInstance.destroy();
    expenseChartInstance = createChart(elements.expenseChartCtx, 'doughnut', chartData, opts);
}

function renderTrendChart(dailyGains = {}) {
    if (!elements.trendChartCtx) return;
    const now = new Date();
    const daysInMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
    const labels = Array.from({ length: daysInMonth }, (_, i) => (i+1).toString());
    const data = labels.map(l => dailyGains[parseInt(l,10)] || 0);
    const chartData = { labels, datasets: [{ label:'Ganho Bruto', data, borderColor:'#6366f1', fill:true, tension:0.25 }] };
    const opts = createChartOptions(v => 'R$ ' + v);
    if (trendChartInstance) trendChartInstance.destroy();
    trendChartInstance = createChart(elements.trendChartCtx, 'line', chartData, opts);
}

/* =========================
   Private Fare (mantive fun√ß√£o original)
   ========================= */
const PRIVATE_FARE_CONSTANTS = { DEFAULT_KM_RATE: 2.50, DEFAULT_TIME_RATE: 0.75, DEFAULT_WAIT_RATE: 0.50 };

function calculatePrivateFare() {
    if (!elements.rideKm) return;
    const km = getFloatValue(elements.rideKm);
    const timeMinutes = getFloatValue(elements.rideTimeMinutes);
    const kmRate = getFloatValue(elements.rideKmRate) || PRIVATE_FARE_CONSTANTS.DEFAULT_KM_RATE;
    const tolls = getFloatValue(elements.tollCost);
    const waitMinutes = getFloatValue(elements.waitTimeMinutes);
    const marginPercent = getFloatValue(elements.profitMarginPercent || { value: 0 });

    const baseFareKm = km * kmRate;
    const baseFareTime = timeMinutes * PRIVATE_FARE_CONSTANTS.DEFAULT_TIME_RATE;
    const waitCost = waitMinutes * PRIVATE_FARE_CONSTANTS.DEFAULT_WAIT_RATE;

    const subtotal = baseFareKm + baseFareTime + waitCost + tolls;
    const finalFare = subtotal * (1 + (marginPercent/100));

    if (elements.privateFareDisplay) elements.privateFareDisplay.textContent = formatCurrency(finalFare);
    if (elements.marginDisplay) elements.marginDisplay.textContent = `${marginPercent.toFixed(0)}% Margem`;
    if (elements.waitRateDisplay) elements.waitRateDisplay.textContent = `R$ ${PRIVATE_FARE_CONSTANTS.DEFAULT_WAIT_RATE.toFixed(2)}/min`;

    // store temporary for use when saving a record if desired
    currentCalculatedData = currentCalculatedData || {};
    currentCalculatedData.privateFare = finalFare;
}
window.calculatePrivateFare = calculatePrivateFare;

/* =========================
   Wait Timer (Private fare)
   ========================= */
function updateWaitTimer() {
    const now = Date.now();
    const elapsed = Math.floor((now - timerStartTime) / 1000) + totalWaitSeconds;
    const h = Math.floor(elapsed/3600), m = Math.floor((elapsed%3600)/60), s = elapsed%60;
    if (elements.waitTimeDisplay) elements.waitTimeDisplay.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    if (elements.waitTimeMinutes) elements.waitTimeMinutes.value = (elapsed/60).toFixed(2);
    calculatePrivateFare();
}

function startTimer() {
    if (waitTimeInterval) { // pause
        pauseTimer();
        return;
    }
    timerStartTime = Date.now();
    waitTimeInterval = setInterval(updateWaitTimer, 1000);
    if (elements.startWaitButton) elements.startWaitButton.textContent = 'PAUSAR';
}

function pauseTimer() {
    if (!waitTimeInterval) return;
    clearInterval(waitTimeInterval);
    waitTimeInterval = null;
    // accumulate seconds
    const elapsed = Math.floor((Date.now() - timerStartTime) / 1000);
    totalWaitSeconds += elapsed;
    timerStartTime = null;
    if (elements.startWaitButton) elements.startWaitButton.textContent = 'INICIAR';
}

function resetTimer() {
    clearInterval(waitTimeInterval);
    waitTimeInterval = null;
    timerStartTime = null;
    totalWaitSeconds = 0;
    if (elements.waitTimeDisplay) elements.waitTimeDisplay.textContent = '00:00:00';
    if (elements.waitTimeMinutes) elements.waitTimeMinutes.value = 0;
    if (elements.startWaitButton) elements.startWaitButton.textContent = 'INICIAR';
    calculatePrivateFare();
}

/* expose timer controls */
window.startTimer = startTimer;
window.resetTimer = resetTimer;

/* =========================
   Main Calculation: calculateDailyProfit
   - preserves the original algorithm: sums gains, subtracts costs, computes per-km metrics
   - triggers chart updates and IA projection debounce
   ========================= */
let weeklyGoal = 0, monthlyGoal = 0, fixedCostPerKmValue = 0;
let geminiPredictionDebounceTimerLocal = null;

function calculateDailyProfit(callAI = true) {
    try {
        // gather inputs (safe checks)
        const gainUber = getFloatValue(elements.gainUber);
        const gain99 = getFloatValue(elements.gain99);
        const gainIndriver = getFloatValue(elements.gainIndriver);
        const gainPrivate = getFloatValue(elements.gainPrivate);
        const gainProducts = getFloatValue(elements.gainProducts);

        const expenseFuel = getFloatValue(elements.expenseFuel);
        const expenseFood = getFloatValue(elements.expenseFood);
        const expenseParking = getFloatValue(elements.expenseParking);
        const expenseEmergency = getFloatValue(elements.expenseEmergency);
        const expenseOthers = getFloatValue(elements.expenseOthers);

        const totalGains = gainUber + gain99 + gainIndriver + gainPrivate + gainProducts;
        const totalCosts = expenseFuel + expenseFood + expenseParking + expenseEmergency + expenseOthers + getFloatValue(elements.fixedCostPerKm || { value: 0 });

        const netProfit = totalGains - totalCosts;

        const dailyKm = getFloatValue(elements.dailyKmInput || { value: 0 });
        const profitPerKm = dailyKm > 0 ? netProfit / dailyKm : 0;
        const costPerKm = dailyKm > 0 ? totalCosts / dailyKm : 0;

        // update UI
        if (elements.resultNetProfit) elements.resultNetProfit.textContent = formatCurrency(netProfit);
        if (elements.resultTotalCost) elements.resultTotalCost.textContent = formatCurrency(totalCosts);
        if (elements.resultCostPerKm) elements.resultCostPerKm.textContent = formatCurrency(costPerKm, 3);
        if (elements.resultProfitPerKm) elements.resultProfitPerKm.textContent = formatCurrency(profitPerKm, 3);

        // color classes
        if (elements.resultProfitPerKm) {
            elements.resultProfitPerKm.classList.remove('text-green-400','text-red-400','text-yellow-400');
            if (profitPerKm > 1.5) elements.resultProfitPerKm.classList.add('text-green-400');
            else if (profitPerKm <= 0) elements.resultProfitPerKm.classList.add('text-red-400');
            else elements.resultProfitPerKm.classList.add('text-yellow-400');
        }

        // store current calculated data for save
        currentCalculatedData = {
            id: recordIdToUpdate.value || '',
            dateInfo: elements.dailyInfo ? elements.dailyInfo.value : (new Date().toISOString().slice(0,10)),
            dailyKm: dailyKm,
            gainUber, gain99, gainIndriver, gainPrivate, gainProducts,
            expenseFuel, expenseFood, expenseParking, expenseEmergency, expenseOthers,
            totalGains, totalCosts, netProfit, profitPerKm, costPerKm,
            createdAt: new Date().toISOString()
        };

        // update summary displays
        if (elements.summaryGains) elements.summaryGains.textContent = formatCurrency(totalGains);
        if (elements.summaryCosts) elements.summaryCosts.textContent = formatCurrency(totalCosts);
        if (elements.summaryNetProfit) elements.summaryNetProfit.textContent = formatCurrency(netProfit);

        // charts: update with a best-effort data
        try {
            // generate small distribution objects
            const gainsData = { labels: ['Uber','99','Indriver','Priv','Loja'], data: [gainUber, gain99, gainIndriver, gainPrivate, gainProducts] };
            renderGainChart(gainsData);
            const expensesData = { labels: ['Combust√≠vel','Alim.','Estac.','Emerg.','Outros'], data: [expenseFuel, expenseFood, expenseParking, expenseEmergency, expenseOthers] };
            renderExpenseChart(expensesData);

            // trend chart: approximate by mapping today's gains into day-of-month slot
            const day = new Date().getDate();
            const dailyGains = {};
            dailyGains[day] = totalGains;
            renderTrendChart(dailyGains);
        } catch(e){ console.warn('Error updating charts', e); }

        // update progress (weekly/monthly) and call AI projections (debounced)
        weeklyGoal = getFloatValue(elements.weeklyGoalInput || { value: 0 });
        monthlyGoal = getFloatValue(elements.monthlyGoalInput || { value: 0 });

        updateProgressDisplay(totalGains, weeklyGoal, elements.weeklyProgressLabel, elements.weeklyProgressValue, elements.weeklyProgressBar);
        updateMonthlyDisplay(netProfit, totalGains);

        if (callAI) {
            debouncePredictionCalls(totalGains, totalGains); // reuse totals for weekly/monthly for now
        }

    } catch (err) {
        console.error('calculateDailyProfit error', err);
    }
}

/* =========================
   Progress display helpers
   ========================= */
function updateProgressDisplay(current, goal, labelEl, valueEl, barEl) {
    if (!goal || goal <= 0) {
        if (labelEl) labelEl.textContent = 'Meta n√£o definida';
        if (valueEl) valueEl.textContent = '0%';
        if (barEl) barEl.style.width = '0%';
        return;
    }
    const pct = clamp(Math.round((current/goal) * 100), 0, 100);
    if (labelEl) labelEl.textContent = `${pct}%`;
    if (valueEl) valueEl.textContent = formatCurrency(Math.max(0, goal - current));
    if (barEl) barEl.style.width = pct + '%';
}

function updateMonthlyDisplay(totalProfit, totalGains) {
    if (elements.monthlyTotalNetProfit) {
        const profitClass = totalProfit >= 0 ? 'text-green-400' : 'text-red-400';
        elements.monthlyTotalNetProfit.textContent = formatCurrency(totalProfit);
        elements.monthlyTotalNetProfit.className = ''; // reset classes
        elements.monthlyTotalNetProfit.classList.add(profitClass);
    }
    if (elements.monthlyTotalGainsDisplay) elements.monthlyTotalGainsDisplay.textContent = formatCurrency(totalGains);
    if (elements.monthlyGoalDisplay) elements.monthlyGoalDisplay.textContent = formatCurrency(monthlyGoal || 0);
}

/* =========================
   AI / Gemini Prediction (placeholder)
   - This will attempt a local call if you configure an API endpoint; otherwise it's a stub.
   - We debounce calls to avoid spamming.
   ========================= */
function callGeminiPrediction(gains, goal, period = 'weekly') {
    // If no API key configured, just show a friendly tip instead of failing.
    if (!apiKey || apiKey === '') {
        if (elements.geminiAnalysisContent) {
            elements.geminiAnalysisContent.innerHTML = `<div class="text-sm text-gray-300">Proje√ß√µes AI: sem chave configurada. Configure 'apiKey' no JS para ativar previs√µes.</div>`;
        }
        return Promise.resolve(null);
    }

    // Example: call your backend that proxies Gemini / LLM (not included here for security)
    return fetch('/api/gemini-predict', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey },
        body: JSON.stringify({ gains, goal, period })
    }).then(r => r.json()).then(resp => {
        if (elements.geminiAnalysisContent) elements.geminiAnalysisContent.innerHTML = resp.html || JSON.stringify(resp);
        return resp;
    }).catch(err => {
        console.error('callGeminiPrediction error', err);
        if (elements.geminiAnalysisContent) elements.geminiAnalysisContent.innerHTML = '<div class="text-sm text-red-400">Erro ao gerar proje√ß√£o (ver console).</div>';
    });
}

function debouncePredictionCalls(weeklyGains, monthlyGains) {
    clearTimeout(geminiPredictionDebounceTimer);
    geminiPredictionDebounceTimer = setTimeout(() => {
        if (weeklyGoal > 0) callGeminiPrediction(weeklyGains, weeklyGoal, 'weekly');
        if (monthlyGoal > 0) callGeminiPrediction(monthlyGains, monthlyGoal, 'monthly');
    }, 1200);
}

/* =========================
   Import / Export
   ========================= */
if (elements.exportButton) {
    elements.exportButton.addEventListener('click', () => {
        const payload = { records: allRecords, goals: JSON.parse(localStorage.getItem(LOCAL_CONFIG_KEY) || '{}') };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'maxrota_gestor_export.json';
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
    });
}

if (elements.importButton && elements.importFile) {
    elements.importButton.addEventListener('click', () => elements.importFile.click());
    elements.importFile.addEventListener('change', handleImportFile);
}

function handleImportFile(ev) {
    const file = ev.target.files && ev.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const imported = JSON.parse(e.target.result);
            if (!imported || !Array.isArray(imported.records)) return alert('Arquivo inv√°lido.');
            if (!confirm(`Importar ${imported.records.length} registros substituir√° seu hist√≥rico atual. Continuar?`)) return;
            allRecords = imported.records;
            if (imported.goals) localStorage.setItem(LOCAL_CONFIG_KEY, JSON.stringify(imported.goals));
            saveRecordsToLocal();
            loadFixedCostInputsLocal();
            loadRecordsLocal();
            alert('Importa√ß√£o conclu√≠da.');
        } catch (err) {
            console.error('handleImportFile error', err);
            alert('Erro ao ler o arquivo.');
        }
    };
    reader.readAsText(file);
}

/* =========================
   UI Wiring: listeners
   ========================= */
document.addEventListener('DOMContentLoaded', () => {
    // load config and records
    loadFixedCostInputsLocal();
    loadRecordsLocal();

    // wire calculate button if exists
    if (elements.calculateButton) elements.calculateButton.addEventListener('click', () => calculateDailyProfit(true));
    if (elements.saveButton) elements.saveButton.addEventListener('click', saveRecord);
    if (elements.calculateFixedCostButton) elements.calculateFixedCostButton.addEventListener('click', () => { calculateAndSetFixedCost(true); });

    // wire inputs for live recalculation
    const recomputeInputs = document.querySelectorAll('input[type="number"], input[type="date"], select');
    recomputeInputs.forEach(i => {
        i.addEventListener('input', () => calculateDailyProfit(false));
        i.addEventListener('keydown', (e) => { if (e.key === 'Enter') calculateDailyProfit(false); });
    });

    // private fare controls (start / reset)
    if (elements.startWaitButton) elements.startWaitButton.addEventListener('click', startTimer);
    if (elements.resetWaitButton) elements.resetWaitButton.addEventListener('click', resetTimer);

    // fixed cost auto-save
    const fixedInputs = [elements.monthlyKmEstimate, elements.costProLabore, elements.costVehiclePayment, elements.costMobileInternet, elements.costAesthetics, elements.costOilChange, elements.costTireChange, elements.costAnnualInsurance, elements.costAnnualDocumentation, elements.costAnnualDepreciation, elements.fixedCostPerKm, elements.weeklyGoalInput, elements.monthlyGoalInput];
    fixedInputs.forEach(inp => { if (inp) inp.addEventListener('input', () => saveFixedCostInputsLocal(false)); });

    // filters change
    if (elements.filterMonth) elements.filterMonth.addEventListener('change', () => renderHistory(allRecords));
    if (elements.filterYear) elements.filterYear.addEventListener('change', () => renderHistory(allRecords));

    // quick calculate initial
    calculateDailyProfit(false);
});

/* =========================
   Additional utility functions (from original)
   ========================= */
function formatDateDisplay(dateString) {
    if (!dateString) return '';
    const parts = dateString.split('-');
    if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;
    return dateString;
}

/* =========================
   Optional: calculateAndSetFixedCost (small convenience function)
   - approximates total fixed cost per month and per km
   ========================= */
function calculateAndSetFixedCost(showAlert = false) {
    const total = getFloatValue(elements.costProLabore) + getFloatValue(elements.costVehiclePayment) + getFloatValue(elements.costMobileInternet) + getFloatValue(elements.costAesthetics) +
        (getFloatValue(elements.costOilChange) / 2) + (getFloatValue(elements.costTireChange) / 3) +
        getFloatValue(elements.costAnnualInsurance) + (getFloatValue(elements.costAnnualDocumentation) / 12) + (getFloatValue(elements.costAnnualDepreciation) / 12);
    if (elements.totalMonthlyFixedCostDisplay) elements.totalMonthlyFixedCostDisplay.textContent = `Total Fixo Mensal: ${formatCurrency(total)}`;
    const monthlyKm = getFloatValue(elements.monthlyKmEstimate) || 1;
    const perKm = total / monthlyKm;
    if (elements.fixedCostPerKm) elements.fixedCostPerKm.value = perKm.toFixed(2);
    saveFixedCostInputsLocal(true);
    if (showAlert) alert('C√°lculo de custo fixo atualizado.');
}

/* Expose useful functions globally for debugging or oninput usage in HTML */
window.calculateDailyProfit = calculateDailyProfit;
window.saveRecord = saveRecord;
window.calculateAndSetFixedCost = calculateAndSetFixedCost;
window.resetDailyDisplay = resetDailyDisplay;

/* =========================
   Inicializa√ß√£o final
   ========================= */
(function init() {
    // ensure date default
    try {
        if (elements.dailyInfo && !elements.dailyInfo.value) {
            const today = new Date(); const yyyy = today.getFullYear(); const mm = String(today.getMonth()+1).padStart(2,'0'); const dd = String(today.getDate()).padStart(2,'0');
            elements.dailyInfo.value = `${yyyy}-${mm}-${dd}`;
        }
    } catch (e){}

    // initial UI updates
    calculatePrivateFare();
    calculateDailyProfit(false);
})();
</script>
