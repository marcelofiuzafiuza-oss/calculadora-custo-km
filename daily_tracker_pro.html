<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rastreador de Lucros PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <style>
        /* Estilo Base para o Visual Arcade */
        body {
            background-color: #010114;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            flex-direction: column;
            font-family: 'Press Start 2P', monospace;
            color: #00ff66;
            user-select: none;
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        /* Contêiner Principal */
        .arcade-container {
            width: 100%;
            max-width: 550px; 
            margin: 0 auto;
            box-sizing: border-box;
            padding: 0 10px;
        }

        /* NOVO WRAPPER FLEXÍVEL PARA AS COLUNAS */
        .columns-wrapper {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        /* Título Principal */
        .main-header {
            color: #00ff66;
            text-shadow: 0 0 10px #00ff66;
            margin: 15px 0 20px 0;
            font-size: clamp(0.7rem, 4vw, 1rem);
            text-align: center;
            line-height: 1.2;
            padding-bottom: 10px;
            border-bottom: 2px solid #00ccff;
        }

        /* Cartões de Seção para Entradas e Resultados */
        .input-section-card, .summary-card {
            background-color: #000000;
            border: 3px solid #ff33cc;
            box-shadow: 0 0 15px #ff33cc;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: clamp(0.5rem, 2.5vw, 0.7rem);
            line-height: 1.6;
            width: 100%; /* Default mobile size */
            box-sizing: border-box;
        }
        
        /* Regras para Duas Colunas (Aplica-se aos inputs) */
        @media (min-width: 500px) {
            .columns-wrapper .input-section-card {
                width: calc(50% - 10px); /* 50% menos a metade do espaço entre as colunas */
            }
        }
        
        .monthly-summary-card {
            border: 3px solid #ffcc00; 
            box-shadow: 0 0 15px #ffcc00;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid rgba(0, 204, 255, 0.3);
            padding: 5px 0;
        }
        .summary-label {
            color: #00ccff;
            max-width: 60%;
            word-break: break-word;
        }
        .summary-value {
            color: #00ff66;
            text-align: right;
        }

        .summary-divider {
            height: 2px;
            background-color: #ff33cc;
            margin: 8px 0;
            box-shadow: 0 0 5px #ff33cc;
        }

        .input-section-card {
            border: 3px solid #00ccff;
            box-shadow: 0 0 12px #00ccff;
        }
        .section-title {
            color: #ff33cc;
            text-shadow: 0 0 8px #ff33cc;
            margin-bottom: 15px;
            font-size: clamp(0.6rem, 3.5vw, 0.8rem);
            text-align: center;
            border-bottom: 1px solid rgba(255, 51, 204, 0.5);
            padding-bottom: 5px;
        }
        
        .date-user-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .date-col, .user-id-col {
            flex: 1;
        }
        .date-col label, .user-id-col label {
            text-align: center; 
            color: #00ff66; 
            text-shadow: 0 0 5px #00ff66; 
            margin-bottom: 5px; 
            display: block;
            font-size: clamp(0.5rem, 2.5vw, 0.7rem);
            line-height: 1.2;
        }

        .input-group {
            margin-bottom: 12px;
            width: 100%;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #00ccff;
            font-size: clamp(0.5rem, 2.8vw, 0.65rem);
            text-shadow: 0 0 5px #00ccff;
        }
        .input-section-card input[type="number"], 
        .input-section-card input[type="text"],
        .input-section-card input[type="date"] { 
            width: 100%;
            padding: 10px;
            background-color: #010114;
            border: 2px solid #ff33cc;
            color: #00ff66;
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(0.65rem, 3.5vw, 0.8rem);
            box-shadow: 0 0 8px #ff33cc;
            border-radius: 4px;
            text-align: center;
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: none;
        }
        
        .user-id-display {
            width: 100%;
            padding: 10px;
            background-color: #010114;
            border: 2px solid #00ccff;
            color: #ffcc00;
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(0.5rem, 3vw, 0.7rem);
            box-shadow: 0 0 8px #00ccff;
            border-radius: 4px;
            text-align: center;
            box-sizing: border-box;
            height: 42px;
            line-height: 22px;
            word-break: break-all;
            overflow: hidden;
            cursor: help;
        }
        
        /* Estilo KM Inicial/Final lado a lado */
        .km-inputs {
            display: flex;
            gap: 10px;
        }
        .km-inputs .input-group {
            flex: 1;
        }

        /* Botões */
        #calculateButton, #saveButton, #saveGoalsButton, #clearButton {
            background-color: #00ff66;
            color: #000000;
            border: none;
            padding: 12px 25px;
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(0.7rem, 3.5vw, 0.8rem);
            cursor: pointer;
            border-radius: 5px;
            box-shadow: 0 0 10px #00ff66;
            transition: all 0.1s;
            margin: 5px 0;
            width: 100%;
        }
        #saveButton {
            background-color: #ffcc00;
            box-shadow: 0 0 10px #ffcc00;
            margin-bottom: 25px;
        }
        #saveGoalsButton {
            background-color: #00ccff;
            box-shadow: 0 0 10px #00ccff;
            margin-bottom: 25px;
        }
        #clearButton {
            background-color: #9933ff; /* Cor roxa para Limpar */
            box-shadow: 0 0 10px #9933ff;
            margin-top: 15px;
        }

        /* Histórico */
        .history-item {
            background-color: rgba(0, 204, 255, 0.05);
            border-left: 5px solid #00ff66; /* Linha lateral verde para indicar clicável */
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: clamp(0.45rem, 2vw, 0.6rem);
            color: #00ccff;
            box-shadow: 0 0 5px rgba(0, 204, 255, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer; /* Indicar que é clicável */
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .history-item:hover {
            transform: scale(1.01);
            box-shadow: 0 0 10px #00ff66;
        }

        .history-data {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        .history-controls button {
            background: none;
            border: none;
            color: #ff33cc;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            text-shadow: 0 0 5px #ff33cc;
        }
        
        /* Estilos do Gráfico CORRIGIDOS */
        .chart-container {
            background-color: #000;
            border: 2px solid #00ff66;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 15px #00ff66;
            margin-bottom: 20px;
            /* Definição de altura MÁXIMA para evitar expansão infinita no Chart.js */
            height: 280px; 
            min-height: 200px;
        }
        .chart-title {
            color: #ffcc00;
            text-align: center;
            font-size: clamp(0.6rem, 3vw, 0.7rem);
            margin-bottom: 10px;
        }
        
        /* Tabela de Plataformas */
        .platform-table {
            width: 100%;
            border-collapse: collapse;
            font-size: clamp(0.5rem, 2.5vw, 0.7rem);
            text-align: center;
            margin-top: 10px;
        }
        .platform-table th, .platform-table td {
            border: 1px solid rgba(0, 204, 255, 0.5);
            padding: 6px 3px;
        }
        .platform-table th {
            background-color: rgba(0, 204, 255, 0.1);
            color: #00ff66;
            text-shadow: 0 0 5px #00ff66;
        }
        .platform-table td {
            color: #00ccff;
        }
        .platform-table .profit-positive {
            color: #00ff66 !important;
            text-shadow: 0 0 5px #00ff66;
        }
        .platform-table .profit-negative {
            color: #ff33cc !important;
            text-shadow: 0 0 5px #ff33cc;
        }
    </style>
</head>
<body>

<div class="arcade-container">
    <h2 class="main-header">RASTREAMENTO DE LUCROS PRO</h2>
    
    <!-- CAMPO DE INFORMAÇÃO DO DIA & USUÁRIO LADO A LADO -->
    <div class="input-group date-user-container">
        <div class="date-col">
            <label for="dailyInfo">DATA DO LANÇAMENTO:</label>
            <input type="date" id="dailyInfo" title="Selecione a Data do Lançamento">
        </div>
        <div class="user-id-col">
            <label for="loggedInUserDisplay">ID DO USUÁRIO:</label>
            <div id="loggedInUserDisplay" class="user-id-display" title="ID Completo do Usuário: Carregando...">Carregando...</div>
        </div>
    </div>
    
    <!-- Cartão de Resumo de Atividade Diária -->
    <div class="summary-card">
        <div class="section-title" style="margin-top: 0; margin-bottom: 10px;">RESUMO DE ATIVIDADE DO DIA</div>
        
        <div class="summary-item"><span class="summary-label">RECEBIMENTOS BRUTOS:</span><span class="summary-value" id="summaryGains">R$ 0,00</span></div>
        <div class="summary-item"><span class="summary-label">CUSTOS DO DIA (Estimado):</span><span class="summary-value" id="summaryCosts">R$ 0,00</span></div>
        <div class="summary-item"><span class="summary-label">SALDO LÍQUIDO ESTIMADO:</span><span class="summary-value" id="summaryNetProfit">R$ 0,00</span></div>
    </div>
    
    <!-- Cartão de Totalizadores Mensal e Semanal -->
    <div class="summary-card monthly-summary-card" id="monthlySummaryCard">
        <div class="section-title" style="margin-top: 0; margin-bottom: 10px; color: #ffcc00; text-shadow: 0 0 8px #ffcc00;">TOTALIZADORES</div>
        
        <!-- Totalizador Semanal -->
        <div class="summary-item"><span class="summary-label">SEMANA ATUAL (Líq.):</span><span class="summary-value" id="weeklyTotalNetProfit">R$ 0,00</span></div>
        <div class="summary-item"><span class="summary-label">META SEMANAL (BRUTO):</span><span class="summary-value" id="weeklyGoalDisplay">R$ 0,00</span></div>
        <div class="summary-item"><span class="summary-label" id="weeklyProgressLabel">PROG. SEMANAL:</span><span class="summary-value" id="weeklyProgressValue" style="color: #00ccff;">0%</span></div>
        <div class="summary-item" style="border-bottom: none;"><span class="summary-label" style="color: #ff33cc;">SEMANA (BRUTO):</span><span class="summary-value" id="weeklyTotalGains" style="color: #ff33cc;">R$ 0,00</span></div>
        
        <div class="summary-divider"></div>

        <!-- Totalizador Mensal -->
        <div class="summary-item"><span class="summary-label" id="monthlySummaryMonthLabel">MÊS ATUAL (Líq.):</span><span class="summary-value" id="monthlyTotalNetProfit">R$ 0,00</span></div>
        <div class="summary-item"><span class="summary-label">META MENSAL (BRUTO):</span><span class="summary-value" id="monthlyGoalDisplay">R$ 0,00</span></div>
        <div class="summary-item"><span class="summary-label" id="monthlyProgressLabel">PROG. MENSAL:</span><span class="summary-value" id="monthlyProgressValue" style="color: #00ccff;">0%</span></div>
        <div class="summary-item" style="border-bottom: none;"><span class="summary-label" style="color: #ff33cc;">MÊS (BRUTO):</span><span class="summary-value" id="monthlyTotalGains" style="color: #ff33cc;">R$ 0,00</span></div>
    </div>

    <!-- Cartão de Análise de Ganhos (Gráfico) -->
    <div class="summary-card">
        <div class="section-title" style="color: #00ff66; text-shadow: 0 0 8px #00ff66;">DISTRIBUIÇÃO DE GANHOS (MÊS)</div>
        <div class="chart-container">
            <canvas id="gainChart"></canvas>
            <div class="chart-title">Análise de Recebimentos Brutos Mensais</div>
        </div>
    </div>
    
    <!-- Cartão de Análise de Despesas (Gráfico) -->
    <div class="summary-card">
        <div class="section-title" style="color: #ff33cc; text-shadow: 0 0 8px #ff33cc;">DISTRIBUIÇÃO DE DESPESAS (MÊS)</div>
        <div class="chart-container">
            <canvas id="expenseChart"></canvas>
            <div class="chart-title">Análise de Custos Variáveis Mensais</div>
        </div>
    </div>
    
    <!-- NOVO: RELATÓRIO DE EFICIÊNCIA POR PLATAFORMA -->
    <div class="summary-card">
        <div class="section-title" style="color: #00ccff; text-shadow: 0 0 8px #00ccff;">ANÁLISE DE EFICIÊNCIA POR PLATAFORMA (MÊS)</div>
        <div id="platformReport">
            <table class="platform-table">
                <thead>
                    <tr>
                        <th>PLATAFORMA</th>
                        <th>BRUTO MÊS</th>
                        <th>LUCRATIVIDADE MÉDIA</th>
                    </tr>
                </thead>
                <tbody id="platformReportBody">
                    <!-- Dados serão inseridos aqui -->
                </tbody>
            </table>
        </div>
    </div>

    
    <!-- WRAPPER PARA AS DUAS COLUNAS DE ENTRADA -->
    <div class="columns-wrapper">

        <!-- Cartão de DADOS CHAVE & METAS (COLUNA ESQUERDA) -->
        <div class="input-section-card">
            <div class="section-title">DADOS CHAVE DA ROTA</div>
            
            <div class="input-group">
                <label for="dailyKmInput">KM PERCORRIDO NO DIA:</label>
                <input type="number" id="dailyKmInput" placeholder="Ex: 350" min="0" step="1">
            </div>

            <div class="input-group">
                <label for="fixedCostPerKm">CUSTO FIXO POR KM (R$):</label>
                <input type="number" id="fixedCostPerKm" placeholder="Ex: 0.85" min="0" step="0.001">
            </div>
            
            <div class="summary-divider" style="margin-top: 20px;"></div>
            
            <div class="section-title" style="color: #00ff66; text-shadow: 0 0 8px #00ff66;">DEFINIÇÃO DE METAS (BRUTO)</div>
            
            <div class="input-group">
                <label for="weeklyGoalInput">META SEMANAL R$:</label>
                <input type="number" id="weeklyGoalInput" placeholder="Ex: 1200.00" min="0" step="0.01">
            </div>

            <div class="input-group">
                <label for="monthlyGoalInput">META MENSAL R$:</label>
                <input type="number" id="monthlyGoalInput" placeholder="Ex: 5000.00" min="0" step="0.01">
            </div>
            
            <button id="saveGoalsButton">SALVAR METAS</button>
            
        </div>

        <!-- Cartão de Ganhos (COLUNA DIREITA 1) -->
        <div class="input-section-card">
            <div class="section-title">GANHOS BRUTOS</div>
            
            <div class="input-group"><label for="gainUber">UBER R$:</label><input type="number" id="gainUber" placeholder="Ex: 200.00" min="0" step="0.01"></div>
            <div class="input-group"><label for="gain99">99 R$:</label><input type="number" id="gain99" placeholder="Ex: 150.00" min="0" step="0.01"></div>
            <div class="input-group"><label for="gainIndriver">INDRIVER R$:</label><input type="number" id="gainIndriver" placeholder="Ex: 100.00" min="0" step="0.01"></div>
            <div class="input-group"><label for="gainPrivate">PARTICULAR R$:</label><input type="number" id="gainPrivate" placeholder="Ex: 80.00" min="0" step="0.01"></div>
            <div class="input-group"><label for="gainProducts">VENDAS/PRODUTOS R$:</label><input type="number" id="gainProducts" placeholder="Ex: 50.00" min="0" step="0.01"></div>
        </div>

        <!-- Cartão de Despesas (COLUNA DIREITA 2 - Forçado a pular linha em desktop se houver espaço) -->
        <div class="input-section-card" style="width: 100%;">
             <!-- Este card ficará abaixo dos outros dois, mas ainda no wrapper -->
             <!-- Em telas maiores, ficará abaixo dos cards de cima -->
            <div class="section-title">DESPESAS VARIÁVEIS DO DIA</div>

            <div class="input-group"><label for="expenseFuel">COMBUSTÍVEL ABASTECIDO R$:</label><input type="number" id="expenseFuel" placeholder="Ex: 150.00" min="0" step="0.01"></div>
            <div class="input-group"><label for="expenseFood">ALIMENTAÇÃO R$:</label><input type="number" id="expenseFood" placeholder="Ex: 40.00" min="0" step="0.01"></div>
            <div class="input-group"><label for="expenseParking">ESTACIONAMENTO R$:</label><input type="number" id="expenseParking" placeholder="Ex: 15.00" min="0" step="0.01"></div>
            <div class="input-group"><label for="expenseEmergency">EMERGÊNCIA R$:</label><input type="number" id="expenseEmergency" placeholder="Ex: 0.00" min="0" step="0.01"></div>
            <div class="input-group"><label for="expenseOthers">OUTRAS DESPESAS R$:</label><input type="number" id="expenseOthers" placeholder="Ex: 5.00" min="0" step="0.01"></div>
        </div>
        
    </div> <!-- FIM columns-wrapper -->
    
    <!-- CAMPO OCULTO PARA SABER SE ESTAMOS EDITANDO -->
    <input type="hidden" id="recordIdToUpdate" value=""> 

    <button id="calculateButton">CALCULAR LUCRO DO DIA</button>
    <button id="saveButton" disabled>SALVAR LANÇAMENTO</button>
    <button id="clearButton">NOVO LANÇAMENTO (LIMPAR)</button>
    
    <div id="resultDisplay" class="summary-card"> 
        <div class="result-line">LUCRO LÍQUIDO DO DIA: R$ 0,00</div>
        <div class="result-line">CUSTO TOTAL DO DIA: R$ 0,00</div>
        <div class="result-line">CUSTO TOTAL POR KM: R$ 0,000</div>
        <div class="profit-result">LUCRO POR KM: R$ 0,000</div>
    </div>
    
    <!-- HISTÓRICO REINSERIDO -->
    <div id="historyContainer" class="input-section-card">
        <div class="section-title">HISTÓRICO DE LANÇAMENTOS</div>
        
        <div id="loadingHistory" style="text-align:center; color:#ffcc00; font-size: 0.6rem;">Conectando ao histórico...</div>
        <ul id="historyList" class="history-list">
            <!-- Registros serão inseridos aqui -->
        </ul>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, setLogLevel, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Variáveis Globais de Configuração (Fornecidas pelo ambiente Canvas)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

    // Variáveis Firebase
    let db;
    let auth;
    let userId = null;
    let isAuthReady = false;
    let currentCalculatedData = null; 
    let allRecords = []; 
    let gainChartInstance = null;
    let expenseChartInstance = null;
    let recordIdToUpdate = document.getElementById('recordIdToUpdate'); 

    // Variáveis Globais para Metas
    let weeklyGoal = 0;
    let monthlyGoal = 0;
    let fixedCostPerKmValue = 0; 
    
    // Cores Neon (Usadas no Chart.js)
    const NEON_COLORS = {
        UBER: '#00ccff',
        NINETY_NINE: '#ffcc00',
        INDRIVER: '#00ff66',
        PRIVATE: '#ff33cc',
        PRODUCTS: '#00ffff',
        FUEL: '#ff4444',
        FOOD: '#ff7700',
        PARKING: '#9933ff',
        EMERGENCY: '#ff0000',
        OTHERS: '#ff9900',
        BACKGROUND: '#010114',
    };

    // Elementos do DOM
    const elements = {
        dailyKmInput: document.getElementById('dailyKmInput'),
        fixedCostPerKm: document.getElementById('fixedCostPerKm'),
        gainUber: document.getElementById('gainUber'),
        gain99: document.getElementById('gain99'), 
        gainIndriver: document.getElementById('gainIndriver'), 
        gainPrivate: document.getElementById('gainPrivate'),
        gainProducts: document.getElementById('gainProducts'),
        expenseParking: document.getElementById('expenseParking'),
        expenseEmergency: document.getElementById('expenseEmergency'),
        expenseFood: document.getElementById('expenseFood'),
        expenseFuel: document.getElementById('expenseFuel'),
        expenseOthers: document.getElementById('expenseOthers'),
        dailyInfo: document.getElementById('dailyInfo'), 
        calculateButton: document.getElementById('calculateButton'),
        saveButton: document.getElementById('saveButton'),
        clearButton: document.getElementById('clearButton'),
        loggedInUserDisplay: document.getElementById('loggedInUserDisplay'),
        weeklyGoalInput: document.getElementById('weeklyGoalInput'),
        monthlyGoalInput: document.getElementById('monthlyGoalInput'),
        saveGoalsButton: document.getElementById('saveGoalsButton'),
        summaryGains: document.getElementById('summaryGains'),
        summaryCosts: document.getElementById('summaryCosts'),
        summaryNetProfit: document.getElementById('summaryNetProfit'),
        resultDisplay: document.getElementById('resultDisplay'),
        historyList: document.getElementById('historyList'),
        loadingHistory: document.getElementById('loadingHistory'),
        // Totalizadores
        monthlyTotalNetProfit: document.getElementById('monthlyTotalNetProfit'), 
        monthlyTotalGains: document.getElementById('monthlyTotalGains'),
        monthlySummaryMonthLabel: document.getElementById('monthlySummaryMonthLabel'),
        weeklyTotalNetProfit: document.getElementById('weeklyTotalNetProfit'),
        weeklyTotalGains: document.getElementById('weeklyTotalGains'),
        weeklyGoalDisplay: document.getElementById('weeklyGoalDisplay'),
        monthlyGoalDisplay: document.getElementById('monthlyGoalDisplay'),
        weeklyProgressLabel: document.getElementById('weeklyProgressLabel'),
        monthlyProgressLabel: document.getElementById('monthlyProgressLabel'),
        weeklyProgressValue: document.getElementById('weeklyProgressValue'),
        monthlyProgressValue: document.getElementById('monthlyProgressValue'),
        platformReportBody: document.getElementById('platformReportBody') 
    };

    // Constantes de estilo
    const errorColor = '#ff0000';
    const defaultTextColor = '#00ccff';
    const profitColor = '#00ff66';
    const lossColor = '#ff33cc';
    const goalMetColor = '#00ffff';

    // --- FUNÇÕES AUXILIARES ---

    function getFloatValue(element) {
        if (!element) return 0;
        const value = parseFloat(element.value);
        return isNaN(value) ? 0 : value;
    }

    function formatCurrency(value, decimals = 2) {
        return `R$ ${value.toFixed(decimals).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".")}`;
    }
    
    function formatDateDisplay(dateString) {
        if (!dateString) return '';
        const parts = dateString.split('-'); 
        if (parts.length === 3) {
            return `${parts[2]}/${parts[1]}/${parts[0]}`; 
        }
        return dateString;
    }
    
    function getStartOfWeek(date) {
        const d = new Date(date);
        const day = d.getDay(); 
        const diff = d.getDate() - day; 
        const startOfWeek = new Date(d.setDate(diff));
        
        const yyyy = startOfWeek.getFullYear();
        const mm = String(startOfWeek.getMonth() + 1).padStart(2, '0');
        const dd = String(startOfWeek.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }
    
    // --- FUNÇÃO DE LIMPEZA ---
    function clearInputFields() {
        elements.gainUber.value = '';
        elements.gain99.value = '';
        elements.gainIndriver.value = '';
        elements.gainPrivate.value = '';
        elements.gainProducts.value = '';
        elements.expenseFuel.value = '';
        elements.expenseFood.value = '';
        elements.expenseParking.value = '';
        elements.expenseEmergency.value = '';
        elements.expenseOthers.value = '';
        elements.dailyKmInput.value = '';
        
        // Limpa o ID de atualização e reseta o botão
        recordIdToUpdate.value = ''; 
        elements.saveButton.textContent = "SALVAR LANÇAMENTO";

        setTodayDate();
        calculateDailyProfit();
    }

    // --- FUNÇÕES FIREBASE/PERSISTÊNCIA ---

    function getCollectionPath() {
        return `artifacts/${appId}/users/${userId}/daily_records`;
    }

    function getCollectionRef() {
        if (!db || !userId) return null;
        return collection(db, getCollectionPath());
    }
    
    function getSettingsRef() {
        if (!db || !userId) return null;
        const path = `artifacts/${appId}/users/${userId}/user_settings`;
        return doc(db, path, 'goals');
    }

    async function saveRecord() {
        if (!isAuthReady || !currentCalculatedData) {
            alert('Erro: Aguarde a conexão com o banco de dados e calcule o lucro antes de salvar.');
            return;
        }

        elements.saveButton.disabled = true;
        elements.saveButton.textContent = "SALVANDO...";

        const isUpdate = recordIdToUpdate.value !== '';
        
        try {
            const recordsRef = getCollectionRef();
            if (recordsRef) {
                if (isUpdate) {
                    const docRef = doc(recordsRef, recordIdToUpdate.value);
                    await setDoc(docRef, currentCalculatedData); // Usa setDoc para UPDATE
                    alert('Lançamento atualizado com sucesso!');
                } else {
                    await addDoc(recordsRef, currentCalculatedData); // Usa addDoc para NOVO REGISTRO
                    alert('Lançamento salvo com sucesso!');
                }
                
                clearInputFields(); // Limpa e reseta a UI
            }
        } catch (error) {
            console.error("Erro ao salvar/atualizar lançamento: ", error);
            alert(`Erro ao ${isUpdate ? 'atualizar' : 'salvar'} lançamento. Verifique o console.`); 
        } finally {
            elements.saveButton.textContent = isUpdate ? "ATUALIZAR LANÇAMENTO" : "SALVAR LANÇAMENTO";
            elements.saveButton.disabled = false;
        }
    }
    
    async function loadGoals() {
        if (!db || !userId) return;
        try {
            const docSnap = await getDoc(getSettingsRef());
            if (docSnap.exists()) {
                const data = docSnap.data();
                weeklyGoal = data.weeklyGoal || 0;
                monthlyGoal = data.monthlyGoal || 0;
                fixedCostPerKmValue = data.fixedCostPerKmValue || 0;

                elements.weeklyGoalInput.value = weeklyGoal.toFixed(2);
                elements.monthlyGoalInput.value = monthlyGoal.toFixed(2);
                elements.fixedCostPerKm.value = fixedCostPerKmValue.toFixed(3);
            }
        } catch (e) {
            console.error("Erro ao carregar metas:", e);
        }
        calculateSummaries(allRecords); 
        calculateDailyProfit();
    }
    
    async function saveGoals() {
        if (!db || !userId) {
            alert('Aguarde a conexão com o banco de dados antes de salvar.');
            return;
        }

        elements.saveGoalsButton.disabled = true;
        elements.saveGoalsButton.textContent = "SALVANDO...";

        try {
            const newWeeklyGoal = getFloatValue(elements.weeklyGoalInput);
            const newMonthlyGoal = getFloatValue(elements.monthlyGoalInput);
            const newFixedCostPerKm = getFloatValue(elements.fixedCostPerKm);

            weeklyGoal = newWeeklyGoal;
            monthlyGoal = newMonthlyGoal;
            fixedCostPerKmValue = newFixedCostPerKm;
            
            await setDoc(getSettingsRef(), {
                weeklyGoal: newWeeklyGoal,
                monthlyGoal: newMonthlyGoal,
                fixedCostPerKmValue: newFixedCostPerKm,
                timestamp: serverTimestamp()
            });
            
            alert(`Configurações salvas:\nCusto Fixo/KM: ${formatCurrency(newFixedCostPerKm, 3)}\nSemanal (Bruto): ${formatCurrency(newWeeklyGoal)}\nMensal (Bruto): ${formatCurrency(newMonthlyGoal)}`);

        } catch (error) {
            console.error("Erro ao salvar metas: ", error);
            alert('Erro ao salvar metas. Verifique o console.'); 
        } finally {
            elements.saveGoalsButton.textContent = "SALVAR METAS";
            elements.saveGoalsButton.disabled = false;
            calculateSummaries(allRecords); 
            calculateDailyProfit();
        }
    }

    // --- FUNÇÕES DE TOTALIZAÇÃO E UI ---
    
    function updateProgressDisplay(currentTotal, goal, displayLabelElement, displayValueElement) {
        displayLabelElement.style.color = defaultTextColor;
        displayValueElement.style.color = defaultTextColor;
        
        let progress = 0;
        let progressColor = defaultTextColor;
        
        if (goal > 0) {
            progress = (currentTotal / goal) * 100;
            
            if (progress >= 100) {
                progressColor = goalMetColor; 
                displayLabelElement.textContent = `META ATINGIDA:`;
            } else if (progress >= 50) {
                progressColor = profitColor; 
                displayLabelElement.textContent = `PROG. ${progress.toFixed(0)}%:`;
            } else {
                progressColor = lossColor; 
                displayLabelElement.textContent = `PROG. ${progress.toFixed(0)}%:`;
            }
            displayValueElement.textContent = `${progress.toFixed(1)}%`;
        } else {
            progressColor = '#777';
            displayLabelElement.textContent = `SEM META:`;
            displayValueElement.textContent = `N/A`;
        }

        displayValueElement.style.color = progressColor;
        displayValueElement.style.textShadow = `0 0 5px ${progressColor}`;
    }

    function updateSummary(gains, costs, netProfit) {
        elements.summaryGains.textContent = formatCurrency(gains);
        elements.summaryCosts.textContent = formatCurrency(costs);
        elements.summaryNetProfit.textContent = formatCurrency(netProfit);
        
        elements.summaryNetProfit.style.color = netProfit >= 0 ? profitColor : lossColor;
    }
    
    function updateWeeklyDisplay(totalProfit, totalGains) {
        const profitColorFinal = totalProfit >= 0 ? profitColor : lossColor;

        elements.weeklyTotalNetProfit.textContent = formatCurrency(totalProfit);
        elements.weeklyTotalNetProfit.style.color = profitColorFinal;
        elements.weeklyTotalNetProfit.style.textShadow = `0 0 10px ${profitColorFinal}`;
        
        elements.weeklyTotalGains.textContent = formatCurrency(totalGains);
        elements.weeklyTotalGains.style.color = totalGains >= 0 ? '#ff33cc' : lossColor; 
        
        elements.weeklyGoalDisplay.textContent = formatCurrency(weeklyGoal);
        updateProgressDisplay(totalGains, weeklyGoal, elements.weeklyProgressLabel, elements.weeklyProgressValue);
    }

    function updateMonthlyDisplay(totalProfit, totalGains) {
        const profitColorFinal = totalProfit >= 0 ? profitColor : lossColor;

        elements.monthlyTotalNetProfit.textContent = formatCurrency(totalProfit);
        elements.monthlyTotalNetProfit.style.color = profitColorFinal;
        elements.monthlyTotalNetProfit.style.textShadow = `0 0 10px ${profitColorFinal}`;
        
        elements.monthlyTotalGains.textContent = formatCurrency(totalGains);
        elements.monthlyTotalGains.style.color = totalGains >= 0 ? '#ff33cc' : lossColor; 
        
        elements.monthlyGoalDisplay.textContent = formatCurrency(monthlyGoal);
        updateProgressDisplay(totalGains, monthlyGoal, elements.monthlyProgressLabel, elements.monthlyProgressValue);
    }
    
    function calculatePlatformEfficiency(records) {
        const currentYearMonth = new Date().toISOString().slice(0, 7); 
        
        // 1. Inicializa os acumuladores por plataforma
        const platformStats = {
            UBER: { gains: 0, km: 0, profit: 0 },
            NINETY_NINE: { gains: 0, km: 0, profit: 0 },
            INDRIVER: { gains: 0, km: 0, profit: 0 },
            PRIVATE: { gains: 0, km: 0, profit: 0 }
            // Produtos não são baseados em KM e não são incluídos nesta análise
        };

        let totalGainsWithoutFixedCost = 0;
        let totalKmRidden = 0;

        // 2. Acumula dados do mês atual
        records.forEach(doc => {
            const docYearMonth = doc.dateInfo ? doc.dateInfo.slice(0, 7) : null;
            if (docYearMonth !== currentYearMonth) return;

            // Ganho Líquido APENAS das plataformas (excluindo produtos)
            const platformGains = (doc.gainUber || 0) + (doc.gain99 || 0) + (doc.gainIndriver || 0) + (doc.gainPrivate || 0);
            
            // Custos Fixos e Variáveis APENAS para as plataformas
            const totalVariableExpenses = (doc.expenseFuel || 0) + (doc.expenseFood || 0) + (doc.expenseParking || 0) + (doc.expenseEmergency || 0) + (doc.expenseOthers || 0);

            // Ganhos brutos das plataformas - Despesas Variáveis
            const profitBeforeFixedCost = platformGains - totalVariableExpenses;
            
            totalGainsWithoutFixedCost += platformGains;
            totalKmRidden += doc.dailyKm || 0;
            
            // Distribui o profit *antes* do custo fixo pelos ganhos brutos de cada plataforma
            // Se o total de ganhos da plataforma for 0, pula
            if (platformGains > 0) {
                const profitShareUber = (doc.gainUber || 0) / platformGains;
                platformStats.UBER.gains += doc.gainUber || 0;
                platformStats.UBER.profit += profitBeforeFixedCost * profitShareUber;

                const profitShare99 = (doc.gain99 || 0) / platformGains;
                platformStats.NINETY_NINE.gains += doc.gain99 || 0;
                platformStats.NINETY_NINE.profit += profitBeforeFixedCost * profitShare99;

                const profitShareIndriver = (doc.gainIndriver || 0) / platformGains;
                platformStats.INDRIVER.gains += doc.gainIndriver || 0;
                platformStats.INDRIVER.profit += profitBeforeFixedCost * profitShareIndriver;

                const profitSharePrivate = (doc.gainPrivate || 0) / platformGains;
                platformStats.PRIVATE.gains += doc.gainPrivate || 0;
                platformStats.PRIVATE.profit += profitBeforeFixedCost * profitSharePrivate;
            }
        });
        
        // 3. Distribui o Custo Fixo Total do Mês
        const totalMonthlyFixedCost = totalKmRidden * fixedCostPerKmValue;
        
        // Se houver KM e Ganhos, calcula a distribuição do custo fixo
        if (totalKmRidden > 0 && totalGainsWithoutFixedCost > 0) {
            // A proporção de custo fixo que cada plataforma deve cobrir, baseada no KM rodado total
            const fixedCostPerGainsShare = totalMonthlyFixedCost / totalGainsWithoutFixedCost;
            
            // Finaliza o cálculo do lucro líquido e KM para cada plataforma
            for (const key in platformStats) {
                const stats = platformStats[key];
                
                // Reduz o lucro pelo custo fixo
                stats.finalProfit = stats.profit - (stats.gains * fixedCostPerGainsShare);
                
                // Estima o KM da plataforma (proporcional aos ganhos brutos)
                stats.km = totalKmRidden * (stats.gains / totalGainsWithoutFixedCost);
            }
        } else {
             // Caso não haja dados, zera os profits
            for (const key in platformStats) {
                 platformStats[key].finalProfit = 0;
                 platformStats[key].km = 0;
            }
        }
        
        // 4. Renderiza a tabela
        const platformLabels = {
            UBER: 'UBER', NINETY_NINE: '99', INDRIVER: 'INDRIVER', PRIVATE: 'PARTICULAR'
        };

        elements.platformReportBody.innerHTML = '';
        
        for (const key in platformStats) {
            const stats = platformStats[key];
            const avgProfitPerKm = stats.km > 0 ? stats.finalProfit / stats.km : 0;
            const profitClass = avgProfitPerKm >= 0 ? 'profit-positive' : 'profit-negative';
            
            const row = `
                <tr>
                    <td>${platformLabels[key]}</td>
                    <td>${formatCurrency(stats.gains)}</td>
                    <td class="${profitClass}">${formatCurrency(avgProfitPerKm, 3)} / KM</td>
                </tr>
            `;
            elements.platformReportBody.innerHTML += row;
        }
    }


    function calculateSummaries(records) {
        const currentYearMonth = new Date().toISOString().slice(0, 7); 
        const today = new Date();
        const startOfWeekString = getStartOfWeek(today); 
        
        let monthlyTotalProfit = 0;
        let monthlyTotalGains = 0;
        let monthlyGainBreakdown = { UBER: 0, NINETY_NINE: 0, INDRIVER: 0, PRIVATE: 0, PRODUCTS: 0 };
        let monthlyExpenseBreakdown = { FUEL: 0, FOOD: 0, PARKING: 0, EMERGENCY: 0, OTHERS: 0 };
        
        let weeklyTotalProfit = 0;
        let weeklyTotalGains = 0;
        
        const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const [currentYear, currentMonthIndex] = currentYearMonth.split('-');
        const monthLabel = monthNames[parseInt(currentMonthIndex) - 1] + ' / ' + currentYear;
        
        elements.monthlySummaryMonthLabel.textContent = `${monthLabel} (Líq.):`;

        if (records.length === 0) {
            updateMonthlyDisplay(0, 0);
            updateWeeklyDisplay(0, 0);
            updateGainChart(monthlyGainBreakdown);
            updateExpenseChart(monthlyExpenseBreakdown);
            elements.platformReportBody.innerHTML = `<tr><td colspan="3" style="color: #777;">Lance dados para análise.</td></tr>`;
            return;
        }

        records.forEach(doc => {
            const docDate = doc.dateInfo; 
            const docYearMonth = docDate ? docDate.slice(0, 7) : null;
            
            if (docYearMonth === currentYearMonth) {
                monthlyTotalProfit += doc.netProfit;
                monthlyTotalGains += doc.totalGains;
                
                monthlyGainBreakdown.UBER += doc.gainUber || 0;
                monthlyGainBreakdown.NINETY_NINE += doc.gain99 || 0;
                monthlyGainBreakdown.INDRIVER += doc.gainIndriver || 0;
                monthlyGainBreakdown.PRIVATE += doc.gainPrivate || 0;
                monthlyGainBreakdown.PRODUCTS += doc.gainProducts || 0;
                
                monthlyExpenseBreakdown.FUEL += doc.expenseFuel || 0;
                monthlyExpenseBreakdown.FOOD += doc.expenseFood || 0;
                monthlyExpenseBreakdown.PARKING += doc.expenseParking || 0;
                monthlyExpenseBreakdown.EMERGENCY += doc.expenseEmergency || 0;
                monthlyExpenseBreakdown.OTHERS += doc.expenseOthers || 0;
            }

            if (docDate && docDate >= startOfWeekString) {
                weeklyTotalProfit += doc.netProfit;
                weeklyTotalGains += doc.totalGains;
            }
        });
        
        updateMonthlyDisplay(monthlyTotalProfit, monthlyTotalGains);
        updateWeeklyDisplay(weeklyTotalProfit, weeklyTotalGains);
        updateGainChart(monthlyGainBreakdown);
        updateExpenseChart(monthlyExpenseBreakdown);
        calculatePlatformEfficiency(records); // Chamada para a análise de plataformas
    }

    
    // --- FUNÇÃO CHART.JS (Distribuição de Ganhos) ---
    function updateGainChart(gainBreakdown) {
        const ctx = document.getElementById('gainChart').getContext('2d');

        const labels = ['Uber', '99', 'InDriver', 'Particular', 'Vendas/Prod.'];
        const data = [
            gainBreakdown.UBER,
            gainBreakdown.NINETY_NINE,
            gainBreakdown.INDRIVER,
            gainBreakdown.PRIVATE,
            gainBreakdown.PRODUCTS
        ];
        
        const colors = [
            NEON_COLORS.UBER,
            NEON_COLORS.NINETY_NINE,
            NEON_COLORS.INDRIVER,
            NEON_COLORS.PRIVATE,
            NEON_COLORS.PRODUCTS
        ];

        if (gainChartInstance) {
            gainChartInstance.destroy();
        }

        gainChartInstance = new Chart(ctx, {
            type: 'bar', 
            data: {
                labels: labels,
                datasets: [{
                    label: 'Recebimentos Brutos',
                    data: data,
                    backgroundColor: colors,
                    borderColor: NEON_COLORS.BACKGROUND,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false 
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += formatCurrency(context.parsed.y);
                                }
                                return label;
                            }
                        },
                        titleFont: {
                            family: 'Press Start 2P'
                        },
                        bodyFont: {
                            family: 'Press Start 2P',
                            size: 8
                        },
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        borderColor: '#00ff66',
                        borderWidth: 1
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            color: defaultTextColor,
                            font: { family: 'Press Start 2P', size: 8 },
                            callback: function(value, index, values) {
                                return 'R$' + value.toFixed(0);
                            }
                        },
                        grid: {
                            color: 'rgba(0, 204, 255, 0.2)'
                        }
                    },
                    x: {
                        ticks: {
                            color: defaultTextColor,
                            font: { family: 'Press Start 2P', size: 8 }
                        },
                         grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // --- FUNÇÃO CHART.JS (Distribuição de Despesas) ---
    function updateExpenseChart(expenseBreakdown) {
        const ctx = document.getElementById('expenseChart').getContext('2d');

        const labels = ['Combustível', 'Alimentação', 'Estacionamento', 'Emergência', 'Outros'];
        const data = [
            expenseBreakdown.FUEL,
            expenseBreakdown.FOOD,
            expenseBreakdown.PARKING,
            expenseBreakdown.EMERGENCY,
            expenseBreakdown.OTHERS
        ];

        if (expenseChartInstance) {
            expenseChartInstance.destroy();
        }

        expenseChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Despesas Variáveis',
                    data: data,
                    backgroundColor: [
                        NEON_COLORS.FUEL,
                        NEON_COLORS.FOOD,
                        NEON_COLORS.PARKING,
                        NEON_COLORS.EMERGENCY,
                        NEON_COLORS.OTHERS
                    ],
                    borderColor: NEON_COLORS.BACKGROUND,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false 
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += formatCurrency(context.parsed.y);
                                }
                                return label;
                            }
                        },
                        titleFont: {
                            family: 'Press Start 2P'
                        },
                        bodyFont: {
                            family: 'Press Start 2P',
                            size: 8
                        },
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        borderColor: '#ff33cc',
                        borderWidth: 1
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            color: defaultTextColor,
                            font: { family: 'Press Start 2P', size: 8 },
                            callback: function(value, index, values) {
                                return 'R$' + value.toFixed(0);
                            }
                        },
                        grid: {
                            color: 'rgba(255, 51, 204, 0.2)' // Grid lines em magenta suave
                        }
                    },
                    x: {
                        ticks: {
                            color: defaultTextColor,
                            font: { family: 'Press Start 2P', size: 8 }
                        },
                         grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    function updateResultDisplay(profit, totalCostToday, totalCostPerKm, profitPerKm, error = null) {
        const profitColorFinal = profit >= 0 ? profitColor : lossColor;
        
        if (error || (profit === 0 && totalCostToday === 0 && profitPerKm === 0 && totalCostPerKm === 0)) {
            let message = "LUCRO POR KM: R$ 0,000";
            if (error) {
                message = error;
                profitColorFinal = errorColor;
            }
            
            elements.resultDisplay.innerHTML = `
                <div class="result-line">LUCRO LÍQUIDO DO DIA: R$ 0,00</div>
                <div class="result-line">CUSTO TOTAL DO DIA: R$ 0,00</div>
                <div class="result-line">CUSTO TOTAL POR KM: R$ 0,000</div>
                <div class="profit-result" style="color:${profitColorFinal}; text-shadow:0 0 10px ${profitColorFinal};">${message}</div>
            `;
            elements.saveButton.disabled = true;
            currentCalculatedData = null;
            return;
        }

        elements.resultDisplay.innerHTML = `
            <div class="result-line" style="color:${defaultTextColor};">LUCRO LÍQUIDO DO DIA: ${formatCurrency(profit)}</div>
            <div class="result-line" style="color:${defaultTextColor};">CUSTO TOTAL DO DIA: ${formatCurrency(totalCostToday)}</div> 
            <div class="result-line" style="color:${defaultTextColor};">CUSTO TOTAL POR KM: ${formatCurrency(totalCostPerKm, 3)}</div>
            <div class="profit-result" style="color:${profitColorFinal}; text-shadow:0 0 10px ${profitColorFinal};">LUCRO POR KM: ${formatCurrency(profitPerKm, 3)}</div>
        `;
        
        elements.saveButton.disabled = false;
    }

    function calculateDailyProfit() {
        const dailyKm = getFloatValue(elements.dailyKmInput);
        const fixedCostPerKm = getFloatValue(elements.fixedCostPerKm);
        
        const totalGains = getFloatValue(elements.gainUber) 
                           + getFloatValue(elements.gain99)
                           + getFloatValue(elements.gainIndriver)
                           + getFloatValue(elements.gainPrivate)
                           + getFloatValue(elements.gainProducts);

        const totalVariableExpenses = getFloatValue(elements.expenseParking) 
                                     + getFloatValue(elements.expenseEmergency)
                                     + getFloatValue(elements.expenseFood)
                                     + getFloatValue(elements.expenseFuel)
                                     + getFloatValue(elements.expenseOthers);
        
        const totalFixedCostToday = dailyKm * fixedCostPerKm;
        const totalDailyCost = totalVariableExpenses + totalFixedCostToday;
        const netProfit = totalGains - totalDailyCost;
        
        if (dailyKm <= 0 && totalGains > 0) {
            updateResultDisplay(0, 0, 0, 0, "ERRO: KM Rodado no Dia deve ser informado.");
            currentCalculatedData = null;
            return;
        }
        
        const costPerKm = dailyKm > 0 ? totalDailyCost / dailyKm : 0;
        const profitPerKm = dailyKm > 0 ? netProfit / dailyKm : 0;
        
        updateSummary(totalGains, totalDailyCost, netProfit);
        updateResultDisplay(netProfit, totalDailyCost, costPerKm, profitPerKm);

        currentCalculatedData = {
            dateInfo: elements.dailyInfo.value || new Date().toISOString().slice(0, 10), 
            dailyKm,
            fixedCostPerKm,
            gainUber: getFloatValue(elements.gainUber),
            gain99: getFloatValue(elements.gain99),
            gainIndriver: getFloatValue(elements.gainIndriver),
            gainPrivate: getFloatValue(elements.gainPrivate),
            gainProducts: getFloatValue(elements.gainProducts),
            expenseFuel: getFloatValue(elements.expenseFuel),
            expenseFood: getFloatValue(elements.expenseFood),
            expenseParking: getFloatValue(elements.expenseParking),
            expenseEmergency: getFloatValue(elements.expenseEmergency),
            expenseOthers: getFloatValue(elements.expenseOthers),
            totalGains,
            totalVariableExpenses,
            netProfit,
            totalDailyCost,
            profitPerKm,
            timestamp: serverTimestamp() 
        };
        
        // Atualiza o nome do botão se estivermos editando um registro
        const isUpdate = recordIdToUpdate.value !== '';
        elements.saveButton.textContent = isUpdate ? "ATUALIZAR LANÇAMENTO" : "SALVAR LANÇAMENTO";
    }

    // --- NOVA FUNÇÃO: CARREGA DADOS DO HISTÓRICO PARA OS INPUTS ---
    function loadRecordToInputs(data) {
        // 1. Inputs de KM/Custo Fixo
        elements.dailyKmInput.value = data.dailyKm || '';
        elements.fixedCostPerKm.value = data.fixedCostPerKm || '';

        // 2. Ganhos
        elements.gainUber.value = data.gainUber || '';
        elements.gain99.value = data.gain99 || '';
        elements.gainIndriver.value = data.gainIndriver || '';
        elements.gainPrivate.value = data.gainPrivate || '';
        elements.gainProducts.value = data.gainProducts || '';

        // 3. Despesas
        elements.expenseParking.value = data.expenseParking || '';
        elements.expenseEmergency.value = data.expenseEmergency || '';
        elements.expenseFood.value = data.expenseFood || '';
        elements.expenseFuel.value = data.expenseFuel || '';
        elements.expenseOthers.value = data.expenseOthers || '';
        
        // 4. Data e ID
        elements.dailyInfo.value = data.dateInfo;
        recordIdToUpdate.value = data.id; // CRUCIAL: Salva o ID para atualização
        
        // 5. Calcula o lucro e muda o nome do botão
        calculateDailyProfit(); // Atualiza a UI e o nome do botão
    }

    function renderHistory(records) {
        elements.historyList.innerHTML = '';
        elements.loadingHistory.style.display = 'none';

        if (records.length === 0) {
            elements.historyList.innerHTML = `<li style="text-align:center; color:#777;">Nenhum lançamento salvo ainda.</li>`;
            return;
        }
        
        records.forEach(doc => {
            const data = doc;
            const dateDisplay = formatDateDisplay(data.dateInfo);
            const profit = data.netProfit;
            const profitKm = data.profitPerKm;
            const dailyKm = data.dailyKm; 
            const totalGains = data.totalGains; 
            
            const profitClass = profit < 0 ? 'history-negative' : 'history-profit';

            const listItem = document.createElement('li');
            listItem.className = 'history-item';
            
            // Adiciona o manipulador de clique para carregar o lançamento
            listItem.onclick = () => loadRecordToInputs(data); 

            // Container dos Dados
            const dataContainer = document.createElement('div');
            dataContainer.className = 'history-data';

            const dateSpan = document.createElement('span');
            dateSpan.className = 'history-date';
            dateSpan.textContent = dateDisplay;

            const profitSpan = document.createElement('span');
            profitSpan.className = profitClass;
            profitSpan.textContent = `Líq.: ${formatCurrency(profit)} | Lucro/KM: ${formatCurrency(profitKm, 3)}`;
            
            const detailsSpan = document.createElement('span');
            detailsSpan.className = 'history-details';
            detailsSpan.textContent = `KM: ${dailyKm} | Bruto: ${formatCurrency(totalGains)}`;

            dataContainer.appendChild(dateSpan);
            dataContainer.appendChild(profitSpan);
            dataContainer.appendChild(detailsSpan); 

            listItem.appendChild(dataContainer);
            elements.historyList.appendChild(listItem);
        });
    }

    let unsubscribeHistory = null;
    
    function subscribeToHistory() {
        if (!db || !isAuthReady) return;
        
        if (unsubscribeHistory) unsubscribeHistory();

        elements.loadingHistory.style.display = 'block';
        elements.loadingHistory.textContent = "Carregando histórico...";

        const recordsRef = getCollectionRef();
        let q = query(recordsRef, orderBy("dateInfo", "desc")); 

        unsubscribeHistory = onSnapshot(q, (snapshot) => {
            allRecords = []; 
            snapshot.forEach(doc => {
                allRecords.push({...doc.data(), id: doc.id}); 
            });
            
            renderHistory(allRecords);
            calculateSummaries(allRecords); // CORREÇÃO: Chama calculateSummaries aqui
            
        }, (error) => {
            console.error("Erro ao receber dados do histórico:", error);
            elements.loadingHistory.textContent = "Erro ao carregar histórico.";
        });
    }

    function setTodayDate() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        elements.dailyInfo.value = `${yyyy}-${mm}-${dd}`;
    }


    // --- INICIALIZAÇÃO ---

    async function initializeFirebase() {
        elements.loggedInUserDisplay.textContent = "Conectando...";
        
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // O onAuthStateChanged é a forma mais segura de confirmar o login e obter o UID
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;

                    const displayId = userId.substring(0, 12) + '...'; 
                    elements.loggedInUserDisplay.textContent = displayId; 
                    elements.loggedInUserDisplay.title = `ID Completo do Usuário: ${userId}`; 

                    // Inicia a carga de dados que depende do userId
                    loadGoals(); 
                    subscribeToHistory(); 
                } else {
                    // Se não houver usuário logado, tenta fazer o login (anônimo ou com token)
                    if (initialAuthToken) {
                        signInWithCustomToken(auth, initialAuthToken).catch(e => {
                            signInAnonymously(auth); 
                        });
                    } else {
                        signInAnonymously(auth);
                    }
                    elements.loggedInUserDisplay.textContent = "AUTENTICANDO...";
                }
            });

        } catch (error) {
            console.error("Erro fatal ao inicializar Firebase/Auth:", error);
            elements.loggedInUserDisplay.textContent = "ERRO FATAL";
        }
    }
    
    // --- EVENT LISTENERS ---

    if (elements.calculateButton) {
        elements.calculateButton.addEventListener('click', calculateDailyProfit);
    }
    if (elements.saveButton) {
        elements.saveButton.addEventListener('click', saveRecord);
    }
    if (elements.clearButton) {
        elements.clearButton.addEventListener('click', clearInputFields);
    }
    if (elements.saveGoalsButton) {
        elements.saveGoalsButton.addEventListener('click', saveGoals);
    }
    
    const inputElements = document.querySelectorAll('input[type="number"], input[type="date"]');
    inputElements.forEach(input => {
        input.addEventListener('input', calculateDailyProfit);
        input.addEventListener('keydown', (e) => { 
            if (e.key === 'Enter') calculateDailyProfit(); 
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        if (elements.dailyInfo) {
            setTodayDate();
        }
        calculateDailyProfit(); 
        initializeFirebase();
    });
</script>
</body>
</html>

