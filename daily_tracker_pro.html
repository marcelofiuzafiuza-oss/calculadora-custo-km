<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rastreador de Lucros PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <style>
        /* Estilos Globais e Arcade */
        body {
            background-color: #010114;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            flex-direction: column;
            font-family: 'Press Start 2P', monospace;
            color: #00ff66;
            user-select: none;
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        /* Contêiner Principal */
        .arcade-container {
            width: 100%; /* Agora ocupa 100% da largura do body */
            /* max-width: 550px; <-- REMOVIDO */
            margin: 0 auto;
            box-sizing: border-box;
            padding: 0 10px;
        }

        /* NOVO WRAPPER FLEXÍVEL PARA AS DUAS COLUNAS */
        .columns-wrapper {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        /* Título Principal */
        .main-header {
            color: #00ff66;
            text-shadow: 0 0 10px #00ff66;
            margin: 15px 0 20px 0;
            font-size: clamp(0.7rem, 4vw, 1rem);
            text-align: center;
            line-height: 1.2;
            padding-bottom: 10px;
            border-bottom: 2px solid #00ccff;
        }

        /* Cartões de Seção para Entradas e Resultados */
        .input-section-card, .summary-card {
            background-color: #000000;
            border: 3px solid #ff33cc;
            box-shadow: 0 0 15px #ff33cc;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: clamp(0.5rem, 2.5vw, 0.7rem);
            line-height: 1.6;
            width: 100%; /* Default mobile size */
            box-sizing: border-box;
        }
        
        /* Regras para Duas Colunas (Aplica-se aos inputs) */
        @media (min-width: 500px) {
            .columns-wrapper .input-section-card {
                width: calc(50% - 10px); /* 50% menos a metade do espaço entre as colunas */
            }
            .columns-wrapper .input-section-card:nth-child(3) {
                 width: 100%; /* Força o terceiro cartão (Despesas) a ocupar a linha inteira */
            }
        }
        
        .monthly-summary-card {
            border: 3px solid #ffcc00; 
            box-shadow: 0 0 15px #ffcc00;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid rgba(0, 204, 255, 0.3);
            padding: 5px 0;
        }
        .summary-label {
            color: #00ccff;
            max-width: 60%;
            word-break: break-word;
        }
        .summary-value {
            color: #00ff66;
            text-align: right;
        }
        
        /* PROGRESS BAR STYLES */
        .progress-bar-container {
            width: 100%;
            height: 12px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            margin: 5px 0 15px 0;
            overflow: hidden;
            border: 1px solid rgba(0, 204, 255, 0.5);
        }

        .progress-bar {
            height: 100%;
            width: 0;
            transition: width 0.5s ease-out;
        }


        .summary-divider {
            height: 2px;
            background-color: #ff33cc;
            margin: 8px 0;
            box-shadow: 0 0 5px #ff33cc;
        }

        .input-section-card {
            border: 3px solid #00ccff;
            box-shadow: 0 0 12px #00ccff;
        }
        .section-title {
            color: #ff33cc;
            text-shadow: 0 0 8px #ff33cc;
            margin-bottom: 15px;
            font-size: clamp(0.6rem, 3.5vw, 0.8rem);
            text-align: center;
            border-bottom: 1px solid rgba(255, 51, 204, 0.5);
            padding-bottom: 5px;
        }
        
        .date-user-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .date-col, .user-id-col {
            flex: 1;
        }
        .date-col label, .user-id-col label {
            text-align: center; 
            color: #00ff66; 
            text-shadow: 0 0 5px #00ff66; 
            margin-bottom: 5px; 
            display: block;
            font-size: clamp(0.5rem, 2.5vw, 0.7rem);
            line-height: 1.2;
        }

        .input-group {
            margin-bottom: 12px;
            width: 100%;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #00ccff;
            font-size: clamp(0.5rem, 2.8vw, 0.65rem);
            text-shadow: 0 0 5px #00ccff;
        }
        .input-section-card input[type="number"], 
        .input-section-card input[type="text"],
        .input-section-card input[type="date"] { 
            width: 100%;
            padding: 10px;
            background-color: #010114;
            border: 2px solid #ff33cc;
            color: #00ff66;
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(0.65rem, 3.5vw, 0.8rem);
            box-shadow: 0 0 8px #ff33cc;
            border-radius: 4px;
            text-align: center;
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: none;
        }
        
        .user-id-display {
            width: 100%;
            padding: 10px;
            background-color: #010114;
            border: 2px solid #00ccff;
            color: #ffcc00;
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(0.5rem, 3vw, 0.7rem);
            box-shadow: 0 0 8px #00ccff;
            border-radius: 4px;
            text-align: center;
            box-sizing: border-box;
            height: 42px;
            line-height: 22px;
            word-break: break-all;
            overflow: hidden;
            cursor: help;
        }
        
        /* Botões */
        #calculateButton, #saveButton, #saveGoalsButton, #clearButton, .data-management-btn {
            background-color: #00ff66;
            color: #000000;
            border: none;
            padding: 12px 25px;
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(0.7rem, 3.5vw, 0.8rem);
            cursor: pointer;
            border-radius: 5px;
            box-shadow: 0 0 10px #00ff66;
            transition: all 0.1s;
            margin: 5px 0;
            width: 100%;
        }
        #saveButton {
            background-color: #ffcc00;
            box-shadow: 0 0 10px #ffcc00;
            margin-bottom: 25px;
        }
        #saveGoalsButton {
            background-color: #00ccff;
            box-shadow: 0 0 10px #00ccff;
            margin-bottom: 25px;
        }
        #clearButton {
            background-color: #9933ff; /* Cor roxa para Limpar */
            box-shadow: 0 0 10px #9933ff;
            margin-top: 15px;
        }
        .data-management-btn {
            background-color: #ff9900;
            box-shadow: 0 0 10px #ff9900;
            width: 48%; /* Para caber dois lado a lado */
            font-size: clamp(0.5rem, 3vw, 0.7rem);
        }
        .data-management-container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        /* Histórico */
        .history-item {
            background-color: rgba(0, 204, 255, 0.05);
            border-left: 5px solid #00ff66; /* Linha lateral verde para indicar clicável */
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: clamp(0.45rem, 2vw, 0.6rem);
            color: #00ccff;
            box-shadow: 0 0 5px rgba(0, 204, 255, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer; /* Indicar que é clicável */
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .history-item:hover {
            transform: scale(1.01);
            box-shadow: 0 0 10px #00ff66;
        }
        
        .history-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .delete-btn {
            background: none;
            border: none;
            color: #ff33cc;
            font-size: clamp(0.7rem, 3vw, 0.8rem);
            cursor: pointer;
            padding: 5px;
            text-shadow: 0 0 5px #ff33cc;
            transition: color 0.1s;
        }
        .delete-btn:hover {
            color: #ff0000;
        }

        .history-data {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        
        /* Estilos do Gráfico CORRIGIDOS */
        .chart-container {
            background-color: #000;
            border: 2px solid #00ff66;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 15px #00ff66;
            margin-bottom: 20px;
            /* Definição de altura MÁXIMA para evitar expansão infinita no Chart.js */
            height: 280px; 
            min-height: 200px;
        }
        .chart-title {
            color: #ffcc00;
            text-align: center;
            font-size: clamp(0.6rem, 3vw, 0.7rem);
            margin-bottom: 10px;
        }
        
        /* Tabela de Plataformas */
        .platform-table {
            width: 100%;
            border-collapse: collapse;
            font-size: clamp(0.5rem, 2.5vw, 0.7rem);
            text-align: center;
            margin-top: 10px;
        }
        .platform-table th, .platform-table td {
            border: 1px solid rgba(0, 204, 255, 0.5);
            padding: 6px 3px;
        }
        .platform-table th {
            background-color: rgba(0, 204, 255, 0.1);
            color: #00ff66;
            text-shadow: 0 0 5px #00ff66;
        }
        .platform-table td {
            color: #00ccff;
        }
        .platform-table .profit-positive {
            color: #00ff66 !important;
            text-shadow: 0 0 5px #00ff66;
        }
        .platform-table .profit-negative {
            color: #ff33cc !important;
            text-shadow: 0 0 5px #ff33cc;
        }

        /* ESTILOS ESPECÍFICOS PARA OS NOVOS INPUTS DE GANHOS */
        .app-group {
            border-bottom: 1px dashed rgba(255, 204, 0, 0.5);
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .app-title {
            display: block;
            color: #00ff66;
            text-shadow: 0 0 5px #00ff66;
            margin-bottom: 5px;
            font-size: clamp(0.6rem, 3vw, 0.75rem);
            text-align: left;
        }
        .input-row {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }
        .input-col {
            flex: 1; 
        }
        .input-col label {
            font-size: clamp(0.4rem, 2vw, 0.55rem) !important; 
            text-align: center;
            display: block;
            margin-bottom: 2px !important;
        }
        .input-row input {
            padding: 8px !important;
            font-size: clamp(0.65rem, 3.5vw, 0.8rem) !important; /* AUMENTADO */
            text-shadow: 0 0 3px rgba(0, 255, 102, 0.5); /* BRILHO NEON */
        }
        .input-row .full-width {
            flex: 2; /* Para o campo R$ ser maior */
        }
        
    </style>
</head>
<body>

<div class="arcade-container">
    <h2 class="main-header">RASTREAMENTO DE LUCROS PRO</h2>
    
    <!-- CAMPO DE INFORMAÇÃO DO DIA & USUÁRIO LADO A LADO -->
    <div class="input-group date-user-container">
        <div class="date-col">
            <label for="dailyInfo">DATA DO LANÇAMENTO:</label>
            <input type="date" id="dailyInfo" title="Seleccione a Data do Lançamento">
        </div>
        <div class="user-id-col">
            <label for="loggedInUserDisplay">ID DO USUÁRIO:</label>
            <div id="loggedInUserDisplay" class="user-id-display" title="ID Completo do Usuário">Carregando...</div>
        </div>
    </div>
    
    <!-- Cartão de Resumo de Atividade Diária -->
    <div class="summary-card">
        <div class="section-title" style="margin-top: 0; margin-bottom: 10px;">RESUMO DE ATIVIDADE DO DIA</div>
        
        <div class="summary-item"><span class="summary-label">RECEBIMENTOS BRUTOS:</span><span class="summary-value" id="summaryGains">R$ 0,00</span></div>
        <div class="summary-item"><span class="summary-label">CUSTOS DO DIA (Estimado):</span><span class="summary-value" id="summaryCosts">R$ 0,00</span></div>
        <div class="summary-item"><span class="summary-label">SALDO LÍQUIDO ESTIMADO:</span><span class="summary-value" id="summaryNetProfit">R$ 0,00</span></div>
    </div>
    
    <!-- Cartão de Totalizadores Mensal e Semanal -->
    <div class="summary-card monthly-summary-card" id="monthlySummaryCard">
        <div class="section-title" style="margin-top: 0; margin-bottom: 10px; color: #ffcc00; text-shadow: 0 0 8px #ffcc00;">TOTALIZADORES</div>
        
        <!-- Totalizador Semanal -->
        <div class="summary-item"><span class="summary-label">SEMANA ATUAL (Líq.):</span><span class="summary-value" id="weeklyTotalNetProfit">R$ 0,00</span></div>
        <div class="summary-item"><span class="summary-label">META SEMANAL (BRUTO):</span><span class="summary-value" id="weeklyGoalDisplay">R$ 0,00</span></div>
        <div class="summary-item"><span class="summary-label" id="weeklyProgressLabel">PROG. SEMANAL:</span><span class="summary-value" id="weeklyProgressValue" style="color: #00ccff;">0%</span></div>
        <div class="progress-bar-container"><div id="weeklyProgressBar" class="progress-bar"></div></div> 
        <div class="summary-item" style="border-bottom: none;"><span class="summary-label" style="color: #ff33cc;">SEMANA (BRUTO):</span><span class="summary-value" id="weeklyTotalGains" style="color: #ff33cc;">R$ 0,00</span></div>
        
        <div class="summary-divider"></div>

        <!-- Totalizador Mensal -->
        <div class="summary-item"><span class="summary-label" id="monthlySummaryMonthLabel">MÊS ATUAL (Líq.):</span><span class="summary-value" id="monthlyTotalNetProfit">R$ 0,00</span></div>
        <div class="summary-item"><span class="summary-label">META MENSAL (BRUTO):</span><span class="summary-value" id="monthlyGoalDisplay">R$ 0,00</span></div>
        <div class="summary-item"><span class="summary-label" id="monthlyProgressLabel">PROG. MENSAL:</span><span class="summary-value" id="monthlyProgressValue" style="color: #00ccff;">0%</span></div>
        <div class="progress-bar-container"><div id="monthlyProgressBar" class="progress-bar"></div></div> 
        <div class="summary-item" style="border-bottom: none;"><span class="summary-label" style="color: #ff33cc;">MÊS (BRUTO):</span><span class="summary-value" id="monthlyTotalGains" style="color: #ff33cc;">R$ 0,00</span></div>
    </div>

    <!-- Cartão de Análise de Ganhos (Gráfico) -->
    <div class="summary-card">
        <div class="section-title" style="color: #00ff66; text-shadow: 0 0 8px #00ff66;">DISTRIBUIÇÃO DE GANHOS (MÊS)</div>
        <div class="chart-container">
            <canvas id="gainChart"></canvas>
            <div class="chart-title">Análise de Recebimentos Brutos Mensais</div>
        </div>
    </div>
    
    <!-- Cartão de Análise de Despesas (Gráfico) -->
    <div class="summary-card">
        <div class="section-title" style="color: #ff33cc; text-shadow: 0 0 8px #ff33cc;">DISTRIBUIÇÃO DE DESPESAS (MÊS)</div>
        <div class="chart-container">
            <canvas id="expenseChart"></canvas>
            <div class="chart-title">Análise de Custos Variáveis Mensais</div>
        </div>
    </div>

    <!-- NOVO CARTÃO: MÉTRICAS DE EFICIÊNCIA -->
    <div class="summary-card" id="efficiency-metrics-card">
        <div class="section-title" style="color: #00ccff; text-shadow: 0 0 8px #00ccff;">MÉTRICAS DE EFICIÊNCIA</div>
        <div class="chart-container" style="height: 250px;">
            <canvas id="gainPerHourChart"></canvas>
            <div class="chart-title">Ganho Médio por Hora (R$/h)</div>
        </div>
        <div class="summary-divider"></div>
        <div class="chart-container" style="height: 250px;">
            <canvas id="tripsPerHourChart"></canvas>
            <div class="chart-title">Viagens por Hora (Produtividade)</div>
        </div>
    </div>
    
    
    <!-- WRAPPER PARA AS DUAS COLUNAS DE ENTRADA -->
    <div class="columns-wrapper">

        <!-- Cartão de DADOS CHAVE & METAS (COLUNA ESQUERDA) -->
        <div class="input-section-card">
            <div class="section-title">DADOS CHAVE DA ROTA</div>
            
            <div class="input-group">
                <label for="dailyKmInput">KM PERCORRIDO NO DIA:</label>
                <input type="number" id="dailyKmInput" placeholder="Ex: 350" min="0" step="1">
            </div>

            <div class="input-group">
                <label for="fixedCostPerKm">CUSTO FIXO POR KM (R$):</label>
                <input type="number" id="fixedCostPerKm" placeholder="Ex: 0.85" min="0" step="0.001">
            </div>
            
            <div class="summary-divider" style="margin-top: 20px;"></div>
            
            <div class="section-title" style="color: #00ff66; text-shadow: 0 0 8px #00ff66;">DEFINIÇÃO DE METAS (BRUTO)</div>
            
            <div class="input-group">
                <label for="weeklyGoalInput">META SEMANAL R$:</label>
                <input type="number" id="weeklyGoalInput" placeholder="Ex: 1200.00" min="0" step="0.01">
            </div>

            <div class="input-group">
                <label for="monthlyGoalInput">META MENSAL R$:</label>
                <input type="number" id="monthlyGoalInput" placeholder="Ex: 5000.00" min="0" step="0.01">
            </div>
            
            <button id="saveGoalsButton">SALVAR METAS</button>
            
        </div>

        <!-- Cartão de Ganhos (COLUNA DIREITA 1) -->
        <div class="input-section-card">
            <div class="section-title">GANHOS BRUTOS</div>
            
            <!-- UBER -->
            <div class="app-group">
                <label class="app-title">UBER</label>
                <div class="input-row">
                    <div class="input-col full-width"><label for="gainUber">R$:</label><input type="number" id="gainUber" placeholder="200.00" min="0" step="0.01"></div>
                    <div class="input-col"><label for="hoursUber">Horas:</label><input type="number" id="hoursUber" placeholder="5.5" min="0" step="0.1"></div>
                    <div class="input-col"><label for="tripsUber">Viagens:</label><input type="number" id="tripsUber" placeholder="15" min="0" step="1"></div>
                </div>
            </div>

            <!-- 99 -->
            <div class="app-group">
                <label class="app-title">99</label>
                <div class="input-row">
                    <div class="input-col full-width"><label for="gain99">R$:</label><input type="number" id="gain99" placeholder="150.00" min="0" step="0.01"></div>
                    <div class="input-col"><label for="hours99">Horas:</label><input type="number" id="hours99" placeholder="4.0" min="0" step="0.1"></div>
                    <div class="input-col"><label for="trips99">Viagens:</label><input type="number" id="trips99" placeholder="10" min="0" step="1"></div>
                </div>
            </div>

            <!-- INDRIVER -->
            <div class="app-group">
                <label class="app-title">INDRIVER</label>
                <div class="input-row">
                    <div class="input-col full-width"><label for="gainIndriver">R$:</label><input type="number" id="gainIndriver" placeholder="100.00" min="0" step="0.01"></div>
                    <div class="input-col"><label for="hoursIndriver">Horas:</label><input type="number" id="hoursIndriver" placeholder="3.0" min="0" step="0.1"></div>
                    <div class="input-col"><label for="tripsIndriver">Viagens:</label><input type="number" id="tripsIndriver" placeholder="5" min="0" step="1"></div>
                </div>
            </div>

            <!-- PARTICULAR -->
            <div class="app-group">
                <label class="app-title">PARTICULAR</label>
                <div class="input-row">
                    <div class="input-col full-width"><label for="gainPrivate">R$:</label><input type="number" id="gainPrivate" placeholder="80.00" min="0" step="0.01"></div>
                    <div class="input-col"><label for="hoursPrivate">Horas:</label><input type="number" id="hoursPrivate" placeholder="1.5" min="0" step="0.1"></div>
                    <div class="input-col"><label for="tripsPrivate">Viagens:</label><input type="number" id="tripsPrivate" placeholder="2" min="0" step="1"></div>
                </div>
            </div>
            
            <!-- VENDAS (Sem Horas/Viagens) -->
            <div class="app-group" style="border-bottom: none;">
                <label class="app-title" for="gainProducts">VENDAS/PRODUTOS</label>
                <div class="input-row">
                    <div class="input-col" style="flex: 3;"><label for="gainProducts">R$:</label><input type="number" id="gainProducts" placeholder="50.00" min="0" step="0.01"></div>
                </div>
            </div>
        </div>

        <!-- Cartão de Despesas (COLUNA DIREITA 2 - Forçado a pular linha em desktop se houver espaço) -->
        <div class="input-section-card" style="width: 100%;">
            <div class="section-title">DESPESAS VARIÁVEIS DO DIA</div>

            <div class="input-group"><label for="expenseFuel">COMBUSTÍVEL ABASTECIDO R$:</label><input type="number" id="expenseFuel" placeholder="Ex: 150.00" min="0" step="0.01"></div>
            <div class="input-group"><label for="expenseFood">ALIMENTAÇÃO R$:</label><input type="number" id="expenseFood" placeholder="Ex: 40.00" min="0" step="0.01"></div>
            <div class="input-group"><label for="expenseParking">ESTACIONAMENTO R$:</label><input type="number" id="expenseParking" placeholder="Ex: 15.00" min="0" step="0.01"></div>
            <div class="input-group"><label for="expenseEmergency">EMERGÊNCIA R$:</label><input type="number" id="expenseEmergency" placeholder="Ex: 0.00" min="0" step="0.01"></div>
            <div class="input-group"><label for="expenseOthers">OUTRAS DESPESAS R$:</label><input type="number" id="expenseOthers" placeholder="Ex: 5.00" min="0" step="0.01"></div>
        </div>
        
    </div> <!-- FIM columns-wrapper -->
    
    <!-- CAMPO OCULTO PARA SABER SE ESTAMOS EDITANDO -->
    <input type="hidden" id="recordIdToUpdate" value=""> 

    <button id="calculateButton">CALCULAR LUCRO DO DIA</button>
    <button id="saveButton">SALVAR LANÇAMENTO</button>
    <button id="clearButton">NOVO LANÇAMENTO (LIMPAR)</button>
    
    <!-- NOVO CONTÊINER PARA EXPORTAÇÃO E IMPORTAÇÃO -->
    <div class="data-management-container">
        <button id="exportButton" class="data-management-btn">EXPORTAR DADOS (JSON)</button>
        <button id="importButton" class="data-management-btn">IMPORTAR DADOS (JSON)</button>
        <input type="file" id="importFile" accept=".json" style="display:none;">
    </div>
    
    <div id="resultDisplay" class="summary-card"> 
        <div class="result-line">LUCRO LÍQUIDO DO DIA: R$ 0,00</div>
        <div class="result-line">CUSTO TOTAL DO DIA: R$ 0,00</div>
        <div class="result-line">CUSTO TOTAL POR KM: R$ 0,000</div>
        <div class="profit-result">LUCRO POR KM: R$ 0,000</div>
    </div>
    
    <!-- HISTÓRICO REINSERIDO -->
    <div id="historyContainer" class="input-section-card">
        <div class="section-title">HISTÓRICO DE LANÇAMENTOS</div>
        
        <div id="loadingHistory" style="text-align:center; color:#ffcc00; font-size: 0.6rem;">Carregando dados locais...</div>
        <ul id="historyList" class="history-list">
            <!-- Registros serão inseridos aqui -->
        </ul>
    </div>
    
    <!-- NOVO CARTÃO: GRÁFICO DE TENDÊNCIA -->
    <div class="summary-card">
        <div class="section-title" style="color: #00ccff; text-shadow: 0 0 8px #00ccff;">TENDÊNCIA MENSAL DE LUCRO</div>
        <div class="chart-container" style="height: 300px;">
            <canvas id="trendChart"></canvas>
            <div class="chart-title">Evolução do Lucro Líquido Diário (R$)</div>
        </div>
    </div>

</div>

<script>
    // Configurações Local Storage
    const LOCAL_STORAGE_KEY_RECORDS = 'profit_tracker_records';
    const LOCAL_STORAGE_KEY_GOALS = 'profit_tracker_goals';
    
    // Variáveis Globais para Metas
    let weeklyGoal = 0;
    let monthlyGoal = 0;
    let fixedCostPerKmValue = 0; 
    let allRecords = []; 
    let gainChartInstance = null;
    let expenseChartInstance = null;
    let gainPerHourChartInstance = null;
    let tripsPerHourChartInstance = null;
    let trendChartInstance = null; // NOVO
    let currentCalculatedData = null; 
    let recordIdToUpdate = document.getElementById('recordIdToUpdate'); 

    // Cores Neon (Usadas no Chart.js)
    const NEON_COLORS = {
        UBER: '#00ccff',
        NINETY_NINE: '#ffcc00',
        INDRIVER: '#00ff66',
        PRIVATE: '#ff33cc',
        PRODUCTS: '#00ffff',
        FUEL: '#ff4444',
        FOOD: '#ff7700',
        PARKING: '#9933ff',
        EMERGENCY: '#ff0000',
        OTHERS: '#ff9900',
        BACKGROUND: '#010114',
    };

    // Estilos de cor para a UI
    const profitColor = '#00ff66';
    const lossColor = '#ff33cc';
    const goalMetColor = '#00ffff';

    // Elementos do DOM
    const elements = {
        dailyKmInput: document.getElementById('dailyKmInput'),
        fixedCostPerKm: document.getElementById('fixedCostPerKm'),
        gainUber: document.getElementById('gainUber'),
        hoursUber: document.getElementById('hoursUber'),
        tripsUber: document.getElementById('tripsUber'),
        gain99: document.getElementById('gain99'), 
        hours99: document.getElementById('hours99'),
        trips99: document.getElementById('trips99'),
        gainIndriver: document.getElementById('gainIndriver'), 
        hoursIndriver: document.getElementById('hoursIndriver'),
        tripsIndriver: document.getElementById('tripsIndriver'),
        gainPrivate: document.getElementById('gainPrivate'),
        hoursPrivate: document.getElementById('hoursPrivate'),
        tripsPrivate: document.getElementById('tripsPrivate'),
        gainProducts: document.getElementById('gainProducts'),
        expenseParking: document.getElementById('expenseParking'),
        expenseEmergency: document.getElementById('expenseEmergency'),
        expenseFood: document.getElementById('expenseFood'),
        expenseFuel: document.getElementById('expenseFuel'),
        expenseOthers: document.getElementById('expenseOthers'),
        dailyInfo: document.getElementById('dailyInfo'), 
        calculateButton: document.getElementById('calculateButton'),
        saveButton: document.getElementById('saveButton'),
        clearButton: document.getElementById('clearButton'),
        loggedInUserDisplay: document.getElementById('loggedInUserDisplay'),
        weeklyGoalInput: document.getElementById('weeklyGoalInput'),
        monthlyGoalInput: document.getElementById('monthlyGoalInput'),
        saveGoalsButton: document.getElementById('saveGoalsButton'),
        summaryGains: document.getElementById('summaryGains'),
        summaryCosts: document.getElementById('summaryCosts'),
        summaryNetProfit: document.getElementById('summaryNetProfit'),
        resultDisplay: document.getElementById('resultDisplay'),
        historyList: document.getElementById('historyList'),
        loadingHistory: document.getElementById('loadingHistory'),
        // Botões de backup
        exportButton: document.getElementById('exportButton'),
        importButton: document.getElementById('importButton'),
        importFile: document.getElementById('importFile'),
        // Totalizadores
        monthlyTotalNetProfit: document.getElementById('monthlyTotalNetProfit'), 
        monthlyTotalGains: document.getElementById('monthlyTotalGains'),
        monthlySummaryMonthLabel: document.getElementById('monthlySummaryMonthLabel'),
        weeklyTotalNetProfit: document.getElementById('weeklyTotalNetProfit'),
        weeklyTotalGains: document.getElementById('weeklyTotalGains'),
        weeklyGoalDisplay: document.getElementById('weeklyGoalDisplay'),
        monthlyGoalDisplay: document.getElementById('monthlyGoalDisplay'),
        weeklyProgressLabel: document.getElementById('weeklyProgressLabel'),
        monthlyProgressLabel: document.getElementById('monthlyProgressLabel'),
        weeklyProgressValue: document.getElementById('weeklyProgressValue'),
        monthlyProgressValue: document.getElementById('monthlyProgressValue'),
        // Barras de Progresso
        weeklyProgressBar: document.getElementById('weeklyProgressBar'),
        monthlyProgressBar: document.getElementById('monthlyProgressBar'),
        // Novo Gráfico
        trendChartCanvas: document.getElementById('trendChart'),
        
        platformReportBody: document.getElementById('platformReportBody')
    };

    // --- FUNÇÕES AUXILIARES ---

    function getFloatValue(element) {
        if (!element) return 0;
        const value = parseFloat(element.value);
        return isNaN(value) ? 0 : value;
    }

    function formatCurrency(value, decimals = 2) {
        return `R$ ${value.toFixed(decimals).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".")}`;
    }
    
    function formatDateDisplay(dateString) {
        if (!dateString) return '';
        const parts = dateString.split('-'); 
        if (parts.length === 3) {
            return `${parts[2]}/${parts[1]}/${parts[0]}`; 
        }
        return dateString;
    }
    
    function getStartOfWeek(date) {
        const d = new Date(date);
        const day = d.getDay(); 
        const diff = d.getDate() - day; 
        const startOfWeek = new Date(d.setDate(diff));
        
        const yyyy = startOfWeek.getFullYear();
        const mm = String(startOfWeek.getMonth() + 1).padStart(2, '0');
        const dd = String(startOfWeek.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }
    
    function generateUniqueId() {
        // Gera um ID único simples para localStorage
        return 'id-' + Date.now() + Math.random().toString(16).substring(2, 6);
    }
    
    // --- FUNÇÕES DE PERSISTÊNCIA LOCAL ---
    
    function loadRecords() {
        const recordsJson = localStorage.getItem(LOCAL_STORAGE_KEY_RECORDS);
        allRecords = recordsJson ? JSON.parse(recordsJson) : [];
        allRecords.sort((a, b) => (a.dateInfo < b.dateInfo ? 1 : -1)); // Mais recentes primeiro
        return allRecords;
    }

    function saveRecords() {
        localStorage.setItem(LOCAL_STORAGE_KEY_RECORDS, JSON.stringify(allRecords));
    }
    
    function loadGoals() {
        const goalsJson = localStorage.getItem(LOCAL_STORAGE_KEY_GOALS);
        const data = goalsJson ? JSON.parse(goalsJson) : {};

        weeklyGoal = data.weeklyGoal || 0;
        monthlyGoal = data.monthlyGoal || 0;
        fixedCostPerKmValue = data.fixedCostPerKmValue || 0;

        elements.weeklyGoalInput.value = weeklyGoal > 0 ? weeklyGoal.toFixed(2) : '';
        elements.monthlyGoalInput.value = monthlyGoal > 0 ? monthlyGoal.toFixed(2) : '';
        elements.fixedCostPerKm.value = fixedCostPerKmValue > 0 ? fixedCostPerKmValue.toFixed(3) : '';
        
        // Atualiza a UI após carregar
        allRecords = loadRecords();
        renderHistory(allRecords);
        calculateSummaries(allRecords);
        calculateDailyProfit();
    }
    
    function saveGoals() {
        const newWeeklyGoal = getFloatValue(elements.weeklyGoalInput);
        const newMonthlyGoal = getFloatValue(elements.monthlyGoalInput);
        const newFixedCostPerKm = getFloatValue(elements.fixedCostPerKm);

        weeklyGoal = newWeeklyGoal;
        monthlyGoal = newMonthlyGoal;
        fixedCostPerKmValue = newFixedCostPerKm;
        
        const data = {
            weeklyGoal: newWeeklyGoal,
            monthlyGoal: newMonthlyGoal,
            fixedCostPerKmValue: newFixedCostPerKm
        };

        localStorage.setItem(LOCAL_STORAGE_KEY_GOALS, JSON.stringify(data));
        
        alert(`Configurações salvas localmente:\nCusto Fixo/KM: ${formatCurrency(newFixedCostPerKm, 3)}\nSemanal (Bruto): ${formatCurrency(newWeeklyGoal)}\nMensal (Bruto): ${formatCurrency(newMonthlyGoal)}`);

        calculateSummaries(allRecords); 
        calculateDailyProfit();
    }

    // --- FUNÇÃO DE BACKUP (EXPORTAÇÃO/IMPORTAÇÃO) ---
    function exportData() {
        const data = {
            records: allRecords,
            goals: {
                weeklyGoal,
                monthlyGoal,
                fixedCostPerKmValue
            }
        };

        const dataStr = JSON.stringify(data, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        const date = new Date().toISOString().slice(0, 10);
        a.download = `rastreador_dados_${date}.json`;
        a.href = url;
        
        // CORREÇÃO: Adicionar o link ao body para garantir o clique simulado
        document.body.appendChild(a); 
        a.click();
        
        // Limpar após o clique
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    function importData() {
        elements.importFile.click(); // Abre o seletor de arquivo
    }
    
    function handleImportFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                
                if (!importedData.records || !Array.isArray(importedData.records)) {
                    alert('Erro: Arquivo JSON inválido. Verifique o formato do histórico.');
                    return;
                }
                
                if (confirm(`Deseja substituir o histórico atual com ${importedData.records.length} lançamentos importados?`)) {
                    // Substitui os registros
                    allRecords = importedData.records;
                    saveRecords();

                    // Tenta carregar metas, se existirem
                    if (importedData.goals) {
                        localStorage.setItem(LOCAL_STORAGE_KEY_GOALS, JSON.stringify(importedData.goals));
                    }
                    
                    // Recarrega o app para refletir a mudança
                    loadGoals(); 
                    alert('Dados importados com sucesso!');
                }

            } catch (error) {
                console.error('Erro ao ler ou parsear arquivo de importação:', error);
                alert('Erro ao importar. Certifique-se de que o arquivo é um JSON válido e não foi modificado.');
            }
        };
        reader.readAsText(file);
    }
    
    // --- FUNÇÃO DE SALVAMENTO / ATUALIZAÇÃO ---
    async function saveRecord() {
        if (!currentCalculatedData) {
            alert('Calcule o lucro do dia antes de salvar.');
            return;
        }
        
        const isUpdate = recordIdToUpdate.value !== '';
        
        if (isUpdate) {
            // Atualiza o registro existente
            const index = allRecords.findIndex(r => r.id === recordIdToUpdate.value);
            if (index !== -1) {
                allRecords[index] = { ...currentCalculatedData, id: recordIdToUpdate.value };
                alert('Lançamento atualizado localmente!');
            }
        } else {
            // Novo registro
            const newRecord = { ...currentCalculatedData, id: generateUniqueId() };
            allRecords.push(newRecord);
            alert('Lançamento salvo localmente!');
        }
        
        saveRecords(); // Salva no localStorage
        allRecords = loadRecords(); // Recarrega e ordena
        renderHistory(allRecords);
        calculateSummaries(allRecords);
        clearInputFields(); 
    }
    
    // --- FUNÇÃO DE LIMPEZA ---
    function clearInputFields() {
        elements.gainUber.value = '';
        elements.hoursUber.value = '';
        elements.tripsUber.value = '';
        elements.gain99.value = '';
        elements.hours99.value = '';
        elements.trips99.value = '';
        elements.gainIndriver.value = '';
        elements.hoursIndriver.value = '';
        elements.tripsIndriver.value = '';
        elements.gainPrivate.value = '';
        elements.hoursPrivate.value = '';
        elements.tripsPrivate.value = '';
        elements.gainProducts.value = '';
        elements.expenseFuel.value = '';
        elements.expenseFood.value = '';
        elements.expenseParking.value = '';
        elements.expenseEmergency.value = '';
        elements.expenseOthers.value = '';
        elements.dailyKmInput.value = '';
        
        // Limpa o ID de atualização e reseta o botão
        recordIdToUpdate.value = ''; 
        elements.saveButton.textContent = "SALVAR LANÇAMENTO";

        setTodayDate();
        calculateDailyProfit();
    }
    
    // --- FUNÇÕES DE TOTALIZAÇÃO E UI ---
    
    function updateProgressDisplay(currentTotal, goal, displayLabelElement, displayValueElement, progressBarElement) {
        let progress = 0;
        let progressColor = '#777'; 
        
        if (goal > 0) {
            progress = (currentTotal / goal) * 100;
            
            if (progress >= 100) {
                progressColor = profitColor; 
                displayLabelElement.textContent = `META ATINGIDA:`;
            } else if (progress >= 50) {
                progressColor = goalMetColor; 
                displayLabelElement.textContent = `PROG. ${progress.toFixed(0)}%:`;
            } else {
                progressColor = lossColor; 
                displayLabelElement.textContent = `PROG. ${progress.toFixed(0)}%:`;
            }
            displayValueElement.textContent = `${progress.toFixed(1)}%`;
        } else {
            progressColor = '#777';
            displayLabelElement.textContent = `SEM META:`;
            displayValueElement.textContent = `N/A`;
        }

        displayValueElement.style.color = progressColor;
        displayValueElement.style.textShadow = `0 0 5px ${progressColor}`;
        
        // --- NOVO: Lógica da Barra de Progresso ---
        const barWidth = Math.min(progress, 100); 
        progressBarElement.style.width = `${barWidth}%`;
        
        if (barWidth >= 100) {
            progressBarElement.style.boxShadow = `0 0 8px ${profitColor}`;
            progressBarElement.style.background = `linear-gradient(90deg, ${goalMetColor}, ${profitColor})`;
        } else if (barWidth > 0) {
            progressBarElement.style.boxShadow = `0 0 5px ${goalMetColor}`;
            progressBarElement.style.background = `linear-gradient(90deg, ${lossColor}, ${goalMetColor})`;
        } else {
            progressBarElement.style.boxShadow = `none`;
            progressBarElement.style.background = `none`;
        }
        // --- FIM Lógica da Barra de Progresso ---
    }

    function updateSummary(gains, costs, netProfit) {
        elements.summaryGains.textContent = formatCurrency(gains);
        elements.summaryCosts.textContent = formatCurrency(costs);
        elements.summaryNetProfit.textContent = formatCurrency(netProfit);
        
        elements.summaryNetProfit.style.color = netProfit >= 0 ? profitColor : lossColor;
    }
    
    function updateWeeklyDisplay(totalProfit, totalGains) {
        const profitColorFinal = totalProfit >= 0 ? profitColor : lossColor;

        elements.weeklyTotalNetProfit.textContent = formatCurrency(totalProfit);
        elements.weeklyTotalNetProfit.style.color = profitColorFinal;
        
        elements.weeklyTotalGains.textContent = formatCurrency(totalGains);
        elements.weeklyTotalGains.style.color = totalGains >= 0 ? goalMetColor : lossColor; 
        
        elements.weeklyGoalDisplay.textContent = formatCurrency(weeklyGoal);
        updateProgressDisplay(totalGains, weeklyGoal, elements.weeklyProgressLabel, elements.weeklyProgressValue, elements.weeklyProgressBar);
    }

    function updateMonthlyDisplay(totalProfit, totalGains) {
        const profitColorFinal = totalProfit >= 0 ? profitColor : lossColor;

        elements.monthlyTotalNetProfit.textContent = formatCurrency(totalProfit);
        elements.monthlyTotalNetProfit.style.color = profitColorFinal;
        
        elements.monthlyTotalGains.textContent = formatCurrency(totalGains);
        elements.monthlyTotalGains.style.color = totalGains >= 0 ? goalMetColor : lossColor; 
        
        elements.monthlyGoalDisplay.textContent = formatCurrency(monthlyGoal);
        updateProgressDisplay(totalGains, monthlyGoal, elements.monthlyProgressLabel, elements.monthlyProgressValue, elements.monthlyProgressBar);
    }
    
    
    // --- FUNÇÃO CHART.JS ---
    
    function createChart(chartId, type, data, options) {
        const ctx = document.getElementById(chartId).getContext('2d');
        if (Chart.getChart(ctx)) {
            Chart.getChart(ctx).destroy();
        }
        return new Chart(ctx, { type, data, options });
    }
    
    // --- NOVO GRÁFICO DE TENDÊNCIA DE LINHA ---
    function updateTrendChart(records) {
        const currentYearMonth = new Date().toISOString().slice(0, 7);
        // Filtra e agrupa registros apenas do mês atual
        const monthlyRecords = records.filter(doc => doc.dateInfo && doc.dateInfo.startsWith(currentYearMonth));
        
        // Mapeia lucros diários (chave: dia do mês, valor: lucro)
        const dailyProfits = {};
        monthlyRecords.forEach(doc => {
            const dayOfMonth = parseInt(doc.dateInfo.slice(8, 10), 10);
            dailyProfits[dayOfMonth] = (dailyProfits[dayOfMonth] || 0) + doc.netProfit;
        });
        
        const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
        const labels = Array.from({ length: daysInMonth }, (_, i) => (i + 1).toString()); // 1, 2, 3...
        const data = labels.map(day => dailyProfits[parseInt(day, 10)] || 0);
        
        const chartData = {
            labels: labels,
            datasets: [{
                label: 'Lucro Líquido (R$)',
                data: data,
                borderColor: NEON_COLORS.INDRIVER,
                backgroundColor: 'rgba(0, 255, 102, 0.2)',
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 4,
                pointBackgroundColor: NEON_COLORS.PRODUCTS,
                fill: true,
            }]
        };

        const options = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { 
                    beginAtZero: true, 
                    ticks: { color: NEON_COLORS.PRODUCTS, callback: function(value) { return 'R$ ' + value; } },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: { 
                    ticks: { color: NEON_COLORS.PRODUCTS },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            },
            plugins: { legend: { display: false } }
        };

        if (trendChartInstance) trendChartInstance.destroy();
        trendChartInstance = createChart('trendChart', 'line', chartData, options);
    }
    
    // --- FIM NOVO GRÁFICO DE TENDÊNCIA ---


    function calculateEfficiencyMetrics(records) {
        const currentYearMonth = new Date().toISOString().slice(0, 7); 
        
        // Estrutura para somar os totais mensais por plataforma
        let monthlyMetrics = {
            UBER: { gains: 0, hours: 0, trips: 0 },
            NINETY_NINE: { gains: 0, hours: 0, trips: 0 },
            INDRIVER: { gains: 0, hours: 0, trips: 0 },
            PRIVATE: { gains: 0, hours: 0, trips: 0 },
        };

        records.forEach(doc => {
            const docYearMonth = doc.dateInfo ? doc.dateInfo.slice(0, 7) : null;
            
            if (docYearMonth === currentYearMonth) {
                // Soma os valores
                monthlyMetrics.UBER.gains += doc.gainUber || 0;
                monthlyMetrics.UBER.hours += doc.hoursUber || 0;
                monthlyMetrics.UBER.trips += doc.tripsUber || 0;
                
                monthlyMetrics.NINETY_NINE.gains += doc.gain99 || 0;
                monthlyMetrics.NINETY_NINE.hours += doc.hours99 || 0;
                monthlyMetrics.NINETY_NINE.trips += doc.trips99 || 0;

                monthlyMetrics.INDRIVER.gains += doc.gainIndriver || 0;
                monthlyMetrics.INDRIVER.hours += doc.hoursIndriver || 0;
                monthlyMetrics.INDRIVER.trips += doc.tripsIndriver || 0;
                
                monthlyMetrics.PRIVATE.gains += doc.gainPrivate || 0;
                monthlyMetrics.PRIVATE.hours += doc.hoursPrivate || 0;
                monthlyMetrics.PRIVATE.trips += doc.tripsPrivate || 0;
            }
        });
        
        const platforms = ['UBER', 'NINETY_NINE', 'INDRIVER', 'PRIVATE'];
        const metrics = {
            gainPerHour: [],
            tripsPerHour: [],
            labels: [],
            colors: []
        };
        
        platforms.forEach(p => {
            const data = monthlyMetrics[p];
            
            if (data.gains > 0) { // Só inclui a plataforma se ela tiver ganhos no mês
                const label = p === 'NINETY_NINE' ? '99' : p === 'PRIVATE' ? 'PART.' : p;
                metrics.labels.push(label);
                metrics.colors.push(NEON_COLORS[p]);

                // Cálculo seguro: Ganho por Hora (R$/h)
                const gainPerHour = data.hours > 0 ? data.gains / data.hours : 0;
                metrics.gainPerHour.push(gainPerHour);

                // Cálculo seguro: Viagens por Hora
                const tripsPerHour = data.hours > 0 ? data.trips / data.hours : 0;
                metrics.tripsPerHour.push(tripsPerHour);
            }
        });

        return metrics;
    }

    function updateEfficiencyCharts(metrics) {
        // 1. Ganho por Hora (R$/h)
        const gainPerHourData = {
            labels: metrics.labels,
            datasets: [{
                label: 'R$ / Hora',
                data: metrics.gainPerHour,
                backgroundColor: metrics.colors,
                borderColor: '#fff',
                borderWidth: 1,
            }]
        };
        
        const gainPerHourOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { color: NEON_COLORS.INDRIVER, callback: function(value) { return 'R$ ' + value.toFixed(2); } } },
                x: { ticks: { color: NEON_COLORS.INDRIVER } }
            },
            plugins: { legend: { display: false } }
        };
        
        if (gainPerHourChartInstance) gainPerHourChartInstance.destroy();
        gainPerHourChartInstance = createChart('gainPerHourChart', 'bar', gainPerHourData, gainPerHourOptions);
        
        // 2. Viagens por Hora
        const tripsPerHourData = {
            labels: metrics.labels,
            datasets: [{
                label: 'Viagens / Hora',
                data: metrics.tripsPerHour,
                backgroundColor: metrics.colors,
                borderColor: '#fff',
                borderWidth: 1,
            }]
        };
        
        const tripsPerHourOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { color: NEON_COLORS.INDRIVER, callback: function(value) { return value.toFixed(1); } } },
                x: { ticks: { color: NEON_COLORS.INDRIVER } }
            },
            plugins: { legend: { display: false } }
        };

        if (tripsPerHourChartInstance) tripsPerHourChartInstance.destroy();
        tripsPerHourChartInstance = createChart('tripsPerHourChart', 'bar', tripsPerHourData, tripsPerHourOptions);
    }
    
    function updateGainChart(gainBreakdown) {
        // Abreviado para caber melhor na tela
        const labels = ['UBER', '99', 'IND.', 'PART.', 'VENDAS']; 
        const data = [
            gainBreakdown.UBER, gainBreakdown.NINETY_NINE, gainBreakdown.INDRIVER,
            gainBreakdown.PRIVATE, gainBreakdown.PRODUCTS
        ];
        
        const chartData = {
            labels: labels,
            datasets: [{
                label: 'Ganhos Brutos (R$)',
                data: data,
                backgroundColor: [
                    NEON_COLORS.UBER, NEON_COLORS.NINETY_NINE, NEON_COLORS.INDRIVER,
                    NEON_COLORS.PRIVATE, NEON_COLORS.PRODUCTS
                ],
                borderColor: '#fff',
                borderWidth: 1,
            }]
        };

        const options = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { color: NEON_COLORS.UBER } },
                x: { ticks: { color: NEON_COLORS.UBER } }
            },
            plugins: { legend: { display: false } }
        };

        gainChartInstance = createChart('gainChart', 'bar', chartData, options);
    }
    
    function updateExpenseChart(expenseBreakdown) {
        // Rótulos abreviados
        const labels = ['COMB.', 'ALIM.', 'ESTAC.', 'EMERG.', 'OUTROS'];
        const data = [
            expenseBreakdown.FUEL, expenseBreakdown.FOOD, expenseBreakdown.PARKING,
            expenseBreakdown.EMERGENCY, expenseBreakdown.OTHERS
        ];
        
        const chartData = {
            labels: labels,
            datasets: [{
                label: 'Despesas Variáveis (R$)',
                data: data,
                backgroundColor: [
                    NEON_COLORS.FUEL, NEON_COLORS.FOOD, NEON_COLORS.PARKING,
                    NEON_COLORS.EMERGENCY, NEON_COLORS.OTHERS
                ],
                borderColor: '#fff',
                borderWidth: 1,
            }]
        };

        const options = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { color: NEON_COLORS.FUEL } },
                // Garantir que os rótulos X fiquem alinhados (já é o comportamento padrão com nomes curtos)
                x: { ticks: { color: NEON_COLORS.FUEL } } 
            },
            plugins: { legend: { display: false } }
        };

        expenseChartInstance = createChart('expenseChart', 'bar', chartData, options);
    }


    function calculateSummaries(records) {
        const currentYearMonth = new Date().toISOString().slice(0, 7); 
        const today = new Date();
        const startOfWeekString = getStartOfWeek(today); 
        
        let monthlyTotalProfit = 0;
        let monthlyTotalGains = 0;
        let monthlyGainBreakdown = { UBER: 0, NINETY_NINE: 0, INDRIVER: 0, PRIVATE: 0, PRODUCTS: 0 };
        let monthlyExpenseBreakdown = { FUEL: 0, FOOD: 0, PARKING: 0, EMERGENCY: 0, OTHERS: 0 };
        
        let weeklyTotalProfit = 0;
        let weeklyTotalGains = 0;
        
        const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const [currentYear, currentMonthIndex] = currentYearMonth.split('-');
        const monthLabel = monthNames[parseInt(currentMonthIndex) - 1] + ' / ' + currentYear;
        
        elements.monthlySummaryMonthLabel.textContent = `${monthLabel} (Líq.):`;

        if (records.length === 0) {
            updateMonthlyDisplay(0, 0);
            updateWeeklyDisplay(0, 0);
            updateGainChart(monthlyGainBreakdown);
            updateExpenseChart(monthlyExpenseBreakdown);
            updateEfficiencyCharts({ gainPerHour: [], tripsPerHour: [], labels: [], colors: [] });
            updateTrendChart([]);
            return;
        }

        records.forEach(doc => {
            const docDate = doc.dateInfo; 
            const docYearMonth = docDate ? docDate.slice(0, 7) : null;
            
            if (docYearMonth === currentYearMonth) {
                monthlyTotalProfit += doc.netProfit;
                monthlyTotalGains += doc.totalGains;
                
                monthlyGainBreakdown.UBER += doc.gainUber || 0;
                monthlyGainBreakdown.NINETY_NINE += doc.gain99 || 0;
                monthlyGainBreakdown.INDRIVER += doc.gainIndriver || 0;
                monthlyGainBreakdown.PRIVATE += doc.gainPrivate || 0;
                monthlyGainBreakdown.PRODUCTS += doc.gainProducts || 0;
                
                monthlyExpenseBreakdown.FUEL += doc.expenseFuel || 0;
                monthlyExpenseBreakdown.FOOD += doc.expenseFood || 0;
                monthlyExpenseBreakdown.PARKING += doc.expenseParking || 0;
                monthlyExpenseBreakdown.EMERGENCY += doc.expenseEmergency || 0;
                monthlyExpenseBreakdown.OTHERS += doc.expenseOthers || 0;
            }

            if (docDate && docDate >= startOfWeekString) {
                weeklyTotalProfit += doc.netProfit;
                weeklyTotalGains += doc.totalGains;
            }
        });
        
        const efficiencyMetrics = calculateEfficiencyMetrics(records);

        updateMonthlyDisplay(monthlyTotalProfit, monthlyTotalGains);
        updateWeeklyDisplay(weeklyTotalProfit, weeklyTotalGains);
        updateGainChart(monthlyGainBreakdown);
        updateExpenseChart(monthlyExpenseBreakdown);
        updateEfficiencyCharts(efficiencyMetrics); // Atualiza os gráficos de eficiência
        updateTrendChart(records); // NOVO: Atualiza o Gráfico de Tendência
    }

    function updateResultDisplay(profit, totalCostToday, totalCostPerKm, profitPerKm, error = null) {
        const profitColorFinal = profit >= 0 ? profitColor : lossColor;
        const profitPerKmColor = profitPerKm >= 0 ? profitColor : lossColor;
        
        const resultsHtml = `
            <div class="result-line">LUCRO LÍQUIDO DO DIA: <span style="color: ${profitColorFinal};">${formatCurrency(profit)}</span></div>
            <div class="result-line">CUSTO TOTAL DO DIA: <span style="color: ${lossColor};">${formatCurrency(totalCostToday)}</span></div>
            <div class="result-line">CUSTO TOTAL POR KM: <span style="color: ${lossColor};">${formatCurrency(totalCostPerKm, 3)}</span></div>
            <div class="profit-result" style="color: ${profitPerKmColor}; text-shadow: 0 0 8px ${profitPerKmColor};">LUCRO POR KM: ${formatCurrency(profitPerKm, 3)}</div>
        `;
        
        elements.resultDisplay.innerHTML = error ? `<div style="color: ${lossColor}; text-align: center;">${error}</div>` : resultsHtml;
    }

    function calculateDailyProfit() {
        const dailyKm = getFloatValue(elements.dailyKmInput);
        const fixedCostPerKm = getFloatValue(elements.fixedCostPerKm);
        
        const totalGains = getFloatValue(elements.gainUber) + getFloatValue(elements.gain99) + getFloatValue(elements.gainIndriver) + getFloatValue(elements.gainPrivate) + getFloatValue(elements.gainProducts);
        const totalVariableExpenses = getFloatValue(elements.expenseParking) + getFloatValue(elements.expenseEmergency) + getFloatValue(elements.expenseFood) + getFloatValue(elements.expenseFuel) + getFloatValue(elements.expenseOthers);
        
        const totalFixedCostToday = dailyKm * fixedCostPerKm;
        const totalDailyCost = totalVariableExpenses + totalFixedCostToday;
        const netProfit = totalGains - totalDailyCost;
        
        if (dailyKm === 0 && totalGains > 0) {
            updateResultDisplay(netProfit, totalDailyCost, 0, 0, "AVISO: KM Rodado é necessário para calcular custo/KM.");
            currentCalculatedData = null; // Impede salvamento de dados incompletos
            return;
        }

        const costPerKm = dailyKm > 0 ? totalDailyCost / dailyKm : 0;
        const profitPerKm = dailyKm > 0 ? netProfit / dailyKm : 0;
        
        updateSummary(totalGains, totalDailyCost, netProfit);
        updateResultDisplay(netProfit, totalDailyCost, costPerKm, profitPerKm);
        
        currentCalculatedData = {
            id: recordIdToUpdate.value || generateUniqueId(),
            dateInfo: elements.dailyInfo.value || new Date().toISOString().slice(0, 10),
            dailyKm,
            totalGains,
            totalVariableExpenses,
            totalDailyCost,
            netProfit,
            profitPerKm,
            // Ganhos (R$)
            gainUber: getFloatValue(elements.gainUber),
            gain99: getFloatValue(elements.gain99),
            gainIndriver: getFloatValue(elements.gainIndriver),
            gainPrivate: getFloatValue(elements.gainPrivate),
            gainProducts: getFloatValue(elements.gainProducts),
            // Ganhos (Horas/Viagens) - NOVOS CAMPOS
            hoursUber: getFloatValue(elements.hoursUber),
            tripsUber: getFloatValue(elements.tripsUber),
            hours99: getFloatValue(elements.hours99),
            trips99: getFloatValue(elements.trips99),
            hoursIndriver: getFloatValue(elements.hoursIndriver),
            tripsIndriver: getFloatValue(elements.tripsIndriver),
            hoursPrivate: getFloatValue(elements.hoursPrivate),
            tripsPrivate: getFloatValue(elements.tripsPrivate),
            // Despesas
            expenseFuel: getFloatValue(elements.expenseFuel),
            expenseFood: getFloatValue(elements.expenseFood),
            expenseParking: getFloatValue(elements.expenseParking),
            expenseEmergency: getFloatValue(elements.expenseEmergency),
            expenseOthers: getFloatValue(elements.expenseOthers),
        };
        
        elements.saveButton.disabled = false;
        elements.saveButton.textContent = recordIdToUpdate.value !== '' ? "ATUALIZAR LANÇAMENTO" : "SALVAR LANÇAMENTO";
    }


    function loadRecordToInputs(data) {
        elements.dailyInfo.value = data.dateInfo;
        elements.dailyKmInput.value = data.dailyKm;
        
        // Ganhos (R$)
        elements.gainUber.value = data.gainUber;
        elements.gain99.value = data.gain99;
        elements.gainIndriver.value = data.gainIndriver;
        elements.gainPrivate.value = data.gainPrivate;
        elements.gainProducts.value = data.gainProducts;
        
        // Ganhos (Horas/Viagens) - NOVOS CAMPOS
        elements.hoursUber.value = data.hoursUber || '';
        elements.tripsUber.value = data.tripsUber || '';
        elements.hours99.value = data.hours99 || '';
        elements.trips99.value = data.trips99 || '';
        elements.hoursIndriver.value = data.hoursIndriver || '';
        elements.tripsIndriver.value = data.tripsIndriver || '';
        elements.hoursPrivate.value = data.hoursPrivate || '';
        elements.tripsPrivate.value = data.tripsPrivate || '';

        // Despesas
        elements.expenseFuel.value = data.expenseFuel;
        elements.expenseFood.value = data.expenseFood;
        elements.expenseParking.value = data.expenseParking;
        elements.expenseEmergency.value = data.expenseEmergency;
        elements.expenseOthers.value = data.expenseOthers;

        // Salva o ID do registro para a função 'Atualizar'
        recordIdToUpdate.value = data.id; 
        elements.saveButton.textContent = "ATUALIZAR LANÇAMENTO";

        calculateDailyProfit(); // Recalcula para atualizar o resumo
    }

    function renderHistory(records) {
        elements.historyList.innerHTML = '';
        elements.loadingHistory.style.display = 'none';

        if (records.length === 0) {
            elements.historyList.innerHTML = `<li style="text-align:center; color:#777;">Nenhum lançamento salvo ainda.</li>`;
            return;
        }
        
        records.forEach(data => {
            const dateDisplay = formatDateDisplay(data.dateInfo);
            const profit = data.netProfit;
            const profitKm = data.profitPerKm;
            const dailyKm = data.dailyKm; 
            const totalGains = data.totalGains; 
            
            const profitClass = profit < 0 ? 'history-negative' : 'history-profit';

            const listItem = document.createElement('li');
            listItem.className = 'history-item';
            
            // Adiciona o manipulador de clique para carregar o lançamento
            listItem.onclick = () => loadRecordToInputs(data); 

            const dataContainer = document.createElement('div');
            dataContainer.className = 'history-data';

            const dateSpan = document.createElement('span');
            dateSpan.className = 'history-date';
            dateSpan.textContent = dateDisplay;

            const profitSpan = document.createElement('span');
            profitSpan.className = profitClass;
            profitSpan.textContent = `Líq.: ${formatCurrency(profit)} | Lucro/KM: ${formatCurrency(profitKm, 3)}`;
            
            const detailsSpan = document.createElement('span');
            detailsSpan.className = 'history-details';
            // Exibe as novas métricas de performance no histórico para uma análise rápida (Total de Horas e Viagens)
            const totalHours = (data.hoursUber || 0) + (data.hours99 || 0) + (data.hoursIndriver || 0) + (data.hoursPrivate || 0);
            const totalTrips = (data.tripsUber || 0) + (data.trips99 || 0) + (data.tripsIndriver || 0) + (data.tripsPrivate || 0);

            detailsSpan.textContent = `KM: ${dailyKm} | Bruto: ${formatCurrency(totalGains)} | H: ${totalHours.toFixed(1)} | V: ${totalTrips}`;

            dataContainer.appendChild(dateSpan);
            dataContainer.appendChild(profitSpan);
            dataContainer.appendChild(detailsSpan); 

            listItem.appendChild(dataContainer);
            
            // CONTROLES DE EXCLUSÃO (NOVO)
            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'history-controls';
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = '&#128465;'; // Ícone de Lixeira (Trash icon)
            deleteBtn.title = 'Excluir Lançamento';
            
            // CORREÇÃO: Usar o closure para garantir que o ID é passado e que o clique não é propagado
            deleteBtn.onclick = (e) => {
                e.stopPropagation(); 
                if (confirm(`Tem certeza que deseja EXCLUIR o lançamento de ${dateDisplay}? Esta ação é irreversível.`)) {
                    deleteRecord(data.id);
                }
            };
            
            controlsDiv.appendChild(deleteBtn);
            listItem.appendChild(controlsDiv);


            elements.historyList.appendChild(listItem);
        });
    }

    function deleteRecord(recordId) {
        const initialCount = allRecords.length;
        allRecords = allRecords.filter(record => record.id !== recordId);
        
        if (allRecords.length < initialCount) {
            saveRecords();
            loadGoals(); // Recarrega tudo para atualizar gráficos e totais
            alert('Lançamento excluído com sucesso!');
        } else {
            alert('Erro: Lançamento não encontrado.');
        }
    }

    function setTodayDate() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        elements.dailyInfo.value = `${yyyy}-${mm}-${dd}`;
    }
    
    // --- FUNÇÕES DE CONTROLE DE ACESSO ---

    function initializeLocalStorage() {
        const userIdLocal = localStorage.getItem('local_user_id') || crypto.randomUUID();
        localStorage.setItem('local_user_id', userIdLocal);
        
        const displayId = userIdLocal.substring(0, 12) + '...'; 
        elements.loggedInUserDisplay.textContent = displayId; 
        elements.loggedInUserDisplay.title = `ID Local: ${userIdLocal} (Dados salvos apenas neste dispositivo)`;

        // Carrega metas e dados
        loadGoals(); 
    }
    
    // --- EVENT LISTENERS ---
    
    if (elements.calculateButton) {
        elements.calculateButton.addEventListener('click', calculateDailyProfit);
    }
    if (elements.saveButton) {
        elements.saveButton.addEventListener('click', saveRecord);
    }
    if (elements.clearButton) {
        elements.clearButton.addEventListener('click', clearInputFields);
    }
    if (elements.saveGoalsButton) {
        elements.saveGoalsButton.addEventListener('click', saveGoals);
    }
    
    if (elements.exportButton) {
        elements.exportButton.addEventListener('click', exportData);
    }
    if (elements.importButton) {
        elements.importButton.addEventListener('click', importData);
    }
    if (elements.importFile) {
        elements.importFile.addEventListener('change', handleImportFile);
    }


    const inputElements = document.querySelectorAll('input[type="number"], input[type="date"]');
    inputElements.forEach(input => {
        input.addEventListener('input', calculateDailyProfit);
        input.addEventListener('keydown', (e) => { 
            if (e.key === 'Enter') calculateDailyProfit(); 
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        if (elements.dailyInfo) {
            setTodayDate();
        }
        initializeLocalStorage();
    });
</script>
</body>
</html>
