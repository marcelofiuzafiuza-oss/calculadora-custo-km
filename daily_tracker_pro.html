<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rastreador de Lucros PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <style>
        /* Estilos Neon Retro - Alta Contraste */
        :root {
            --bg-dark: #121212;
            --card-bg: #1e1e1e;
            --text-light: #00ffff; /* Ciano Neon */
            --accent-primary: #ff00ff; /* Magenta Neon */
            --accent-secondary: #ffcc00; /* Amarelo Neon */
            --success-green: #00ff00; /* Verde Neon */
            --loss-red: #ff3333; /* Vermelho Neon */
            --shadow-glow: 0 0 5px var(--accent-primary);
            --shadow-success: 0 0 8px var(--success-green);
        }

        body {
            background-color: var(--bg-dark);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            flex-direction: column;
            font-family: 'Share Tech Mono', monospace;
            color: var(--text-light);
            user-select: none;
            padding: 15px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        /* Contêiner Principal */
        .arcade-container {
            width: 100%;
            max-width: 700px; 
            margin: 0 auto;
            box-sizing: border-box;
            padding: 0 5px;
        }

        /* NOVO WRAPPER FLEXÍVEL PARA AS COLUNAS */
        .columns-wrapper {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        /* Título Principal */
        .main-header {
            font-family: 'Audiowide', cursive;
            color: var(--accent-primary);
            margin: 15px 0 20px 0;
            font-size: clamp(1.2rem, 6vw, 1.8rem);
            text-align: center;
            line-height: 1.2;
            padding-bottom: 10px;
            text-shadow: var(--shadow-glow);
            border-bottom: 2px solid var(--accent-secondary);
        }

        /* Cartões de Seção para Entradas e Resultados */
        .input-section-card, .summary-card {
            background-color: var(--card-bg);
            border: 2px solid var(--accent-primary);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.3);
            font-size: clamp(0.7rem, 2.5vw, 0.9rem);
            line-height: 1.6;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Regras para Duas Colunas */
        @media (min-width: 550px) {
            .columns-wrapper .input-section-card {
                width: calc(50% - 10px);
            }
        }
        
        .monthly-summary-card {
            border-left: 5px solid var(--success-green);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.2);
            padding: 5px 0;
        }
        .summary-label {
            color: var(--text-light);
            max-width: 60%;
            word-break: break-word;
        }
        .summary-value {
            color: var(--accent-secondary);
            text-align: right;
            font-weight: 700;
        }

        .summary-divider {
            height: 1px;
            background-color: var(--accent-secondary);
            margin: 8px 0;
        }

        .section-title {
            color: var(--success-green);
            margin-bottom: 15px;
            font-size: clamp(0.9rem, 3.5vw, 1.1rem);
            text-align: center;
            border-bottom: 1px solid var(--accent-secondary);
            padding-bottom: 5px;
            text-shadow: 0 0 3px rgba(0, 255, 0, 0.5);
        }
        
        .date-user-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .date-col, .user-id-col {
            flex: 1;
        }
        .date-col label, .user-id-col label {
            color: var(--accent-secondary);
            margin-bottom: 5px; 
            display: block;
            font-size: clamp(0.8rem, 3.0vw, 0.9rem); /* AUMENTADO */
            text-align: center;
        }

        .input-group {
            margin-bottom: 12px;
            width: 100%;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-light);
            font-size: clamp(0.8rem, 3.2vw, 1.0rem); /* AUMENTADO */
        }
        .input-section-card input[type="number"], 
        .input-section-card input[type="text"],
        .input-section-card input[type="date"] { 
            width: 100%;
            padding: 10px;
            background-color: var(--bg-dark);
            border: 1px solid var(--accent-secondary);
            color: var(--success-green);
            font-family: 'Share Tech Mono', monospace;
            font-size: clamp(1.1rem, 4.5vw, 1.3rem); /* AUMENTADO */
            border-radius: 4px;
            text-align: center;
            /* NOVO ESTILO PARA BRILHO DE TEXTO */
            text-shadow: 0 0 5px var(--success-green); 
            box-shadow: inset 0 0 3px rgba(0, 255, 0, 0.5);
            box-sizing: border-box;
        }
        
        .user-id-display {
            width: 100%;
            padding: 10px;
            background-color: var(--bg-dark);
            border: 1px solid var(--accent-secondary);
            color: var(--accent-primary);
            font-family: 'Share Tech Mono', monospace;
            font-size: clamp(0.7rem, 3.5vw, 0.9rem); /* AUMENTADO */
            border-radius: 4px;
            text-align: center;
            box-sizing: border-box;
            height: 40px;
            line-height: 20px;
            word-break: break-all;
            overflow: hidden;
        }
        
        /* Botões */
        #calculateButton, #saveButton, #saveGoalsButton, #clearButton {
            background-color: var(--accent-secondary);
            color: var(--bg-dark);
            border: none;
            padding: 12px 25px;
            font-family: 'Audiowide', cursive;
            font-size: clamp(0.8rem, 3.5vw, 1rem);
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.1s;
            margin: 5px 0;
            width: 100%;
            font-weight: 700;
        }
        #calculateButton:hover, #saveButton:hover, #saveGoalsButton:hover, #clearButton:hover {
            box-shadow: 0 0 10px var(--accent-secondary);
            opacity: 1;
        }
        #calculateButton { background-color: #ffaa00; }
        #saveButton { background-color: var(--success-green); }
        #saveGoalsButton { background-color: var(--accent-primary); }
        #clearButton { background-color: #555; color: var(--text-light); }
        #saveButton:disabled { opacity: 0.5; cursor: not-allowed; }

        
        /* Resultado Final */
        #resultDisplay {
            border-left: 5px solid var(--success-green);
            box-shadow: 0 0 10px var(--success-green);
        }
        .profit-result {
            font-size: clamp(1.1rem, 4.5vw, 1.3rem); /* AUMENTADO */
            font-weight: 700;
            margin-top: 10px;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.8);
        }
        
        /* Histórico */
        .history-item {
            background-color: #262626;
            border: 1px solid #333;
            border-left: 5px solid var(--accent-primary);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: clamp(0.7rem, 2.5vw, 0.9rem); /* AUMENTADO */
            color: var(--text-light);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(255, 0, 255, 0.2);
        }
        .history-item:hover {
            background-color: #383838;
        }

        .history-data {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        .history-date {
            font-weight: 700;
            color: var(--accent-secondary);
        }
        
        .history-negative {
            color: var(--loss-red);
            font-weight: 700;
            text-shadow: 0 0 3px rgba(255, 51, 51, 0.5);
        }
        .history-profit {
            color: var(--success-green);
            font-weight: 700;
            text-shadow: 0 0 3px rgba(0, 255, 0, 0.5);
        }

        /* Estilos do Gráfico */
        .chart-container {
            background-color: var(--card-bg);
            border: 1px solid var(--accent-primary);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 20px;
            height: 280px; 
            min-height: 200px;
        }
        .platform-table th { color: var(--accent-secondary); }
        .platform-table .profit-positive { color: var(--success-green) !important; }
        .platform-table .profit-negative { color: var(--loss-red) !important; }
        .platform-table th, .platform-table td { border: 1px solid #444; color: var(--text-light); }

        
    </style>
</head>
<body>

<div class="arcade-container">
    <h2 class="main-header">RASTREAMENTO DE LUCROS PRO</h2>
    
    <!-- CAMPO DE INFORMAÇÃO DO DIA & USUÁRIO LADO A LADO -->
    <div class="input-group date-user-container">
        <div class="date-col">
            <label for="dailyInfo">DATA DO LANÇAMENTO:</label>
            <input type="date" id="dailyInfo" title="Selecione a Data do Lançamento">
        </div>
        <div class="user-id-col">
            <label for="loggedInUserDisplay">ID DO USUÁRIO:</label>
            <div id="loggedInUserDisplay" class="user-id-display" title="ID Completo do Usuário: Carregando...">Conectando...</div>
        </div>
    </div>
    
    <!-- Cartão de Resumo de Atividade Diária -->
    <div class="summary-card">
        <div class="section-title" style="margin-top: 0; margin-bottom: 10px; color: var(--accent-primary);">RESUMO DE ATIVIDADE DO DIA</div>
        
        <div class="summary-item"><span class="summary-label">RECEBIMENTOS BRUTOS:</span><span class="summary-value" id="summaryGains">R$ 0,00</span></div>
        <div class="summary-item"><span class="summary-label">CUSTOS DO DIA (Estimado):</span><span class="summary-value" id="summaryCosts">R$ 0,00</span></div>
        <div class="summary-item"><span class="summary-label">SALDO LÍQUIDO ESTIMADO:</span><span class="summary-value" id="summaryNetProfit">R$ 0,00</span></div>
    </div>
    
    <!-- Cartão de Totalizadores Mensal e Semanal -->
    <div class="summary-card monthly-summary-card" id="monthlySummaryCard">
        <div class="section-title" style="margin-top: 0; margin-bottom: 10px; color: var(--accent-secondary);">TOTALIZADORES</div>
        
        <!-- Totalizador Semanal -->
        <div class="summary-item"><span class="summary-label">SEMANA ATUAL (Líq.):</span><span class="summary-value" id="weeklyTotalNetProfit">R$ 0,00</span></div>
        <div class="summary-item"><span class="summary-label">META SEMANAL (BRUTO):</span><span class="summary-value" id="weeklyGoalDisplay">R$ 0,00</span></div>
        <div class="summary-item"><span class="summary-label" id="weeklyProgressLabel">PROG. SEMANAL:</span><span class="summary-value" id="weeklyProgressValue" style="color: var(--accent-primary);">0%</span></div>
        <div class="summary-item" style="border-bottom: none;"><span class="summary-label" style="color: var(--text-light);">SEMANA (BRUTO):</span><span class="summary-value" id="weeklyTotalGains" style="color: var(--loss-red);">R$ 0,00</span></div>
        
        <div class="summary-divider"></div>

        <!-- Totalizador Mensal -->
        <div class="summary-item"><span class="summary-label" id="monthlySummaryMonthLabel">MÊS ATUAL (Líq.):</span><span class="summary-value" id="monthlyTotalNetProfit">R$ 0,00</span></div>
        <div class="summary-item"><span class="summary-label">META MENSAL (BRUTO):</span><span class="summary-value" id="monthlyGoalDisplay">R$ 0,00</span></div>
        <div class="summary-item"><span class="summary-label" id="monthlyProgressLabel">PROG. MENSAL:</span><span class="summary-value" id="monthlyProgressValue" style="color: var(--accent-primary);">0%</span></div>
        <div class="summary-item" style="border-bottom: none;"><span class="summary-label" style="color: var(--text-light);">MÊS (BRUTO):</span><span class="summary-value" id="monthlyTotalGains" style="color: var(--loss-red);">R$ 0,00</span></div>
    </div>

    <!-- Cartão de Análise de Ganhos (Gráfico) -->
    <div class="summary-card">
        <div class="section-title" style="color: var(--success-green);">DISTRIBUIÇÃO DE GANHOS (MÊS)</div>
        <div class="chart-container">
            <canvas id="gainChart"></canvas>
            <div class="chart-title">Análise de Recebimentos Brutos Mensais</div>
        </div>
    </div>
    
    <!-- Cartão de Análise de Despesas (Gráfico) -->
    <div class="summary-card">
        <div class="section-title" style="color: var(--loss-red);">DISTRIBUIÇÃO DE DESPESAS (MÊS)</div>
        <div class="chart-container">
            <canvas id="expenseChart"></canvas>
            <div class="chart-title">Análise de Custos Variáveis Mensais</div>
        </div>
    </div>
    
    <!-- NOVO: RELATÓRIO DE EFICIÊNCIA POR PLATAFORMA -->
    <div class="summary-card">
        <div class="section-title" style="color: var(--accent-primary);">ANÁLISE DE EFICIÊNCIA POR PLATAFORMA (MÊS)</div>
        <div id="platformReport">
            <table class="platform-table">
                <thead>
                    <tr>
                        <th>PLATAFORMA</th>
                        <th>BRUTO MÊS</th>
                        <th>LUCRATIVIDADE MÉDIA</th>
                    </tr>
                </thead>
                <tbody id="platformReportBody">
                    <!-- Dados serão inseridos aqui -->
                </tbody>
            </table>
        </div>
    </div>

    
    <!-- WRAPPER PARA AS DUAS COLUNAS DE ENTRADA -->
    <div class="columns-wrapper">

        <!-- Cartão de DADOS CHAVE & METAS (COLUNA ESQUERDA) -->
        <div class="input-section-card">
            <div class="section-title">DADOS CHAVE DA ROTA</div>
            
            <div class="input-group">
                <label for="dailyKmInput">KM PERCORRIDO NO DIA:</label>
                <input type="number" id="dailyKmInput" placeholder="Ex: 350" min="0" step="1">
            </div>

            <div class="input-group">
                <label for="fixedCostPerKm">CUSTO FIXO POR KM (R$):</label>
                <input type="number" id="fixedCostPerKm" placeholder="Ex: 0.85" min="0" step="0.001">
            </div>
            
            <div class="summary-divider" style="margin-top: 20px;"></div>
            
            <div class="section-title" style="color: var(--accent-secondary);">DEFINIÇÃO DE METAS (BRUTO)</div>
            
            <div class="input-group">
                <label for="weeklyGoalInput">META SEMANAL R$:</label>
                <input type="number" id="weeklyGoalInput" placeholder="Ex: 1200.00" min="0" step="0.01">
            </div>

            <div class="input-group">
                <label for="monthlyGoalInput">META MENSAL R$:</label>
                <input type="number" id="monthlyGoalInput" placeholder="Ex: 5000.00" min="0" step="0.01">
            </div>
            
            <button id="saveGoalsButton">SALVAR METAS</button>
            
        </div>

        <!-- Cartão de Ganhos (COLUNA DIREITA 1) -->
        <div class="input-section-card">
            <div class="section-title">GANHOS BRUTOS</div>
            
            <div class="input-group"><label for="gainUber">UBER R$:</label><input type="number" id="gainUber" placeholder="Ex: 200.00" min="0" step="0.01"></div>
            <div class="input-group"><label for="gain99">99 R$:</label><input type="number" id="gain99" placeholder="Ex: 150.00" min="0" step="0.01"></div>
            <div class="input-group"><label for="gainIndriver">INDRIVER R$:</label><input type="number" id="gainIndriver" placeholder="Ex: 100.00" min="0" step="0.01"></div>
            <div class="input-group"><label for="gainPrivate">PARTICULAR R$:</label><input type="number" id="gainPrivate" placeholder="Ex: 80.00" min="0" step="0.01"></div>
            <div class="input-group"><label for="gainProducts">VENDAS/PRODUTOS R$:</label><input type="number" id="gainProducts" placeholder="Ex: 50.00" min="0" step="0.01"></div>
        </div>

        <!-- Cartão de Despesas (COLUNA DIREITA 2 - Forçado a pular linha em desktop se houver espaço) -->
        <div class="input-section-card" style="width: 100%;">
             <!-- Este card ficará abaixo dos outros dois, mas ainda no wrapper -->
             <!-- Em telas maiores, ficará abaixo dos cards de cima -->
            <div class="section-title">DESPESAS VARIÁVEIS DO DIA</div>

            <div class="input-group"><label for="expenseFuel">COMBUSTÍVEL ABASTECIDO R$:</label><input type="number" id="expenseFuel" placeholder="Ex: 150.00" min="0" step="0.01"></div>
            <div class="input-group"><label for="expenseFood">ALIMENTAÇÃO R$:</label><input type="number" id="expenseFood" placeholder="Ex: 40.00" min="0" step="0.01"></div>
            <div class="input-group"><label for="expenseParking">ESTACIONAMENTO R$:</label><input type="number" id="expenseParking" placeholder="Ex: 15.00" min="0" step="0.01"></div>
            <div class="input-group"><label for="expenseEmergency">EMERGÊNCIA R$:</label><input type="number" id="expenseEmergency" placeholder="Ex: 0.00" min="0" step="0.01"></div>
            <div class="input-group"><label for="expenseOthers">OUTRAS DESPESAS R$:</label><input type="number" id="expenseOthers" placeholder="Ex: 5.00" min="0" step="0.01"></div>
        </div>
        
    </div> <!-- FIM columns-wrapper -->
    
    <!-- CAMPO OCULTO PARA SABER SE ESTAMOS EDITANDO -->
    <input type="hidden" id="recordIdToUpdate" value=""> 

    <button id="calculateButton">CALCULAR LUCRO DO DIA</button>
    <button id="saveButton" disabled>SALVAR LANÇAMENTO</button>
    <button id="clearButton">NOVO LANÇAMENTO (LIMPAR)</button>
    
    <div id="resultDisplay" class="summary-card"> 
        <div class="result-line">LUCRO LÍQUIDO DO DIA: R$ 0,00</div>
        <div class="result-line">CUSTO TOTAL DO DIA: R$ 0,00</div>
        <div class="result-line">CUSTO TOTAL POR KM: R$ 0,000</div>
        <div class="profit-result">LUCRO POR KM: R$ 0,000</div>
    </div>
    
    <!-- HISTÓRICO REINSERIDO -->
    <div id="historyContainer" class="input-section-card">
        <div class="section-title">HISTÓRICO DE LANÇAMENTOS</div>
        
        <div id="loadingHistory" style="text-align:center; color:var(--accent-secondary); font-size: 0.7rem;">Conectando ao histórico...</div>
        <ul id="historyList" class="history-list">
            <!-- Registros serão inseridos aqui -->
        </ul>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Variáveis Globais de Configuração (Fornecidas pelo ambiente Canvas)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    
    // Variáveis Firebase
    let db;
    let auth;
    let userId = null;
    let isAuthReady = false;
    let currentCalculatedData = null; 
    let allRecords = []; 
    let gainChartInstance = null;
    let expenseChartInstance = null;
    let recordIdToUpdate = document.getElementById('recordIdToUpdate'); 

    // Variáveis Globais para Metas
    let weeklyGoal = 0;
    let monthlyGoal = 0;
    let fixedCostPerKmValue = 0; 
    
    // Cores (Ajustadas para o tema Neon/Dark)
    const CHART_COLORS = {
        UBER: '#00ffff', // Ciano
        NINETY_NINE: '#ffaa00', // Laranja
        INDRIVER: '#00ff00', // Verde
        PRIVATE: '#ff00ff', // Magenta
        PRODUCTS: '#ffff00', // Amarelo
        FUEL: '#ff5252', // Vermelho (Perda)
        FOOD: '#ffc107',
        PARKING: '#00ff00',
        EMERGENCY: '#ff0000',
        OTHERS: '#ff9800',
    };

    // Estilos de cor para a UI
    const errorColor = '#ff5252';
    const defaultTextColor = '#00ffff';
    const profitColor = '#00ff00';
    const lossColor = '#ff5252';
    const goalMetColor = '#00bcd4';

    // Elementos do DOM (mantidos iguais)
    const elements = {
        dailyKmInput: document.getElementById('dailyKmInput'),
        fixedCostPerKm: document.getElementById('fixedCostPerKm'),
        gainUber: document.getElementById('gainUber'),
        gain99: document.getElementById('gain99'), 
        gainIndriver: document.getElementById('gainIndriver'), 
        gainPrivate: document.getElementById('gainPrivate'),
        gainProducts: document.getElementById('gainProducts'),
        expenseParking: document.getElementById('expenseParking'),
        expenseEmergency: document.getElementById('expenseEmergency'),
        expenseFood: document.getElementById('expenseFood'),
        expenseFuel: document.getElementById('expenseFuel'),
        expenseOthers: document.getElementById('expenseOthers'),
        dailyInfo: document.getElementById('dailyInfo'), 
        calculateButton: document.getElementById('calculateButton'),
        saveButton: document.getElementById('saveButton'),
        clearButton: document.getElementById('clearButton'),
        loggedInUserDisplay: document.getElementById('loggedInUserDisplay'),
        weeklyGoalInput: document.getElementById('weeklyGoalInput'),
        monthlyGoalInput: document.getElementById('monthlyGoalInput'),
        saveGoalsButton: document.getElementById('saveGoalsButton'),
        summaryGains: document.getElementById('summaryGains'),
        summaryCosts: document.getElementById('summaryCosts'),
        summaryNetProfit: document.getElementById('summaryNetProfit'),
        resultDisplay: document.getElementById('resultDisplay'),
        historyList: document.getElementById('historyList'),
        loadingHistory: document.getElementById('loadingHistory'),
        // Totalizadores
        monthlyTotalNetProfit: document.getElementById('monthlyTotalNetProfit'), 
        monthlyTotalGains: document.getElementById('monthlyTotalGains'),
        monthlySummaryMonthLabel: document.getElementById('monthlySummaryMonthLabel'),
        weeklyTotalNetProfit: document.getElementById('weeklyTotalNetProfit'),
        weeklyTotalGains: document.getElementById('weeklyTotalGains'),
        weeklyGoalDisplay: document.getElementById('weeklyGoalDisplay'),
        monthlyGoalDisplay: document.getElementById('monthlyGoalDisplay'),
        weeklyProgressLabel: document.getElementById('weeklyProgressLabel'),
        monthlyProgressLabel: document.getElementById('monthlyProgressLabel'),
        weeklyProgressValue: document.getElementById('weeklyProgressValue'),
        monthlyProgressValue: document.getElementById('monthlyProgressValue'),
        platformReportBody: document.getElementById('platformReportBody') 
    };

    // --- FUNÇÕES AUXILIARES ---

    function getFloatValue(element) {
        if (!element) return 0;
        const value = parseFloat(element.value);
        return isNaN(value) ? 0 : value;
    }

    function formatCurrency(value, decimals = 2) {
        return `R$ ${value.toFixed(decimals).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".")}`;
    }
    
    function formatDateDisplay(dateString) {
        if (!dateString) return '';
        const parts = dateString.split('-'); 
        if (parts.length === 3) {
            return `${parts[2]}/${parts[1]}/${parts[0]}`; 
        }
        return dateString;
    }
    
    function getStartOfWeek(date) {
        const d = new Date(date);
        const day = d.getDay(); 
        const diff = d.getDate() - day; 
        const startOfWeek = new Date(d.setDate(diff));
        
        const yyyy = startOfWeek.getFullYear();
        const mm = String(startOfWeek.getMonth() + 1).padStart(2, '0');
        const dd = String(startOfWeek.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }
    
    // --- FUNÇÃO DE LIMPEZA ---
    function clearInputFields() {
        elements.gainUber.value = '';
        elements.gain99.value = '';
        elements.gainIndriver.value = '';
        elements.gainPrivate.value = '';
        elements.gainProducts.value = '';
        elements.expenseFuel.value = '';
        elements.expenseFood.value = '';
        elements.expenseParking.value = '';
        elements.expenseEmergency.value = '';
        elements.expenseOthers.value = '';
        elements.dailyKmInput.value = '';
        
        recordIdToUpdate.value = ''; 
        elements.saveButton.textContent = "SALVAR LANÇAMENTO";

        setTodayDate();
        calculateDailyProfit();
    }

    // --- FUNÇÕES FIREBASE/PERSISTÊNCIA ---

    function getCollectionPath() {
        return `artifacts/${appId}/users/${userId}/daily_records`;
    }

    function getCollectionRef() {
        if (!db || !userId) return null;
        return collection(db, getCollectionPath());
    }
    
    function getSettingsRef() {
        if (!db || !userId) return null;
        const path = `artifacts/${appId}/users/${userId}/user_settings`;
        return doc(db, path, 'goals');
    }

    async function saveRecord() {
        if (!isAuthReady || !currentCalculatedData) {
            alert('Erro: Aguarde a conexão com o banco de dados e calcule o lucro antes de salvar.');
            return;
        }

        elements.saveButton.disabled = true;
        elements.saveButton.textContent = "SALVANDO...";

        const isUpdate = recordIdToUpdate.value !== '';
        
        try {
            const recordsRef = getCollectionRef();
            if (recordsRef) {
                if (isUpdate) {
                    const docRef = doc(recordsRef, recordIdToUpdate.value);
                    await setDoc(docRef, currentCalculatedData); 
                    alert('Lançamento atualizado com sucesso!');
                } else {
                    await addDoc(recordsRef, currentCalculatedData); 
                    alert('Lançamento salvo com sucesso!');
                }
                
                clearInputFields(); 
            }
        } catch (error) {
            console.error("Erro ao salvar/atualizar lançamento: ", error);
            alert(`Erro ao ${isUpdate ? 'atualizar' : 'salvar'} lançamento. Verifique o console.`); 
        } finally {
            elements.saveButton.textContent = isUpdate ? "ATUALIZAR LANÇAMENTO" : "SALVAR LANÇAMENTO";
            elements.saveButton.disabled = false;
        }
    }
    
    async function loadGoals() {
        if (!db || !userId) return;
        try {
            const docSnap = await getDoc(getSettingsRef());
            if (docSnap.exists()) {
                const data = docSnap.data();
                weeklyGoal = data.weeklyGoal || 0;
                monthlyGoal = data.monthlyGoal || 0;
                fixedCostPerKmValue = data.fixedCostPerKmValue || 0;

                elements.weeklyGoalInput.value = weeklyGoal.toFixed(2);
                elements.monthlyGoalInput.value = monthlyGoal.toFixed(2);
                elements.fixedCostPerKm.value = fixedCostPerKmValue.toFixed(3);
            }
        } catch (e) {
            console.error("Erro ao carregar metas:", e);
        }
        calculateSummaries(allRecords); 
        calculateDailyProfit();
    }
    
    async function saveGoals() {
        if (!db || !userId) {
            alert('Aguarde a conexão com o banco de dados antes de salvar.');
            return;
        }

        elements.saveGoalsButton.disabled = true;
        elements.saveGoalsButton.textContent = "SALVANDO...";

        try {
            const newWeeklyGoal = getFloatValue(elements.weeklyGoalInput);
            const newMonthlyGoal = getFloatValue(elements.monthlyGoalInput);
            const newFixedCostPerKm = getFloatValue(elements.fixedCostPerKm);

            weeklyGoal = newWeeklyGoal;
            monthlyGoal = newMonthlyGoal;
            fixedCostPerKmValue = newFixedCostPerKm;
            
            await setDoc(getSettingsRef(), {
                weeklyGoal: newWeeklyGoal,
                monthlyGoal: newMonthlyGoal,
                fixedCostPerKmValue: newFixedCostPerKm,
                timestamp: serverTimestamp()
            });
            
            alert(`Configurações salvas:\nCusto Fixo/KM: ${formatCurrency(newFixedCostPerKm, 3)}\nSemanal (Bruto): ${formatCurrency(newWeeklyGoal)}\nMensal (Bruto): ${formatCurrency(newMonthlyGoal)}`);

        } catch (error) {
            console.error("Erro ao salvar metas: ", error);
            alert('Erro ao salvar metas. Verifique o console.'); 
        } finally {
            elements.saveGoalsButton.textContent = "SALVAR METAS";
            elements.saveGoalsButton.disabled = false;
            calculateSummaries(allRecords); 
            calculateDailyProfit();
        }
    }

    // --- FUNÇÕES DE TOTALIZAÇÃO E UI ---
    
    function updateProgressDisplay(currentTotal, goal, displayLabelElement, displayValueElement) {
        displayLabelElement.style.color = defaultTextColor;
        displayValueElement.style.color = defaultTextColor;
        
        let progress = 0;
        let progressColor = defaultTextColor;
        
        if (goal > 0) {
            progress = (currentTotal / goal) * 100;
            
            if (progress >= 100) {
                progressColor = profitColor; 
                displayLabelElement.textContent = `META ATINGIDA:`;
            } else if (progress >= 50) {
                progressColor = '#00ffff'; 
                displayLabelElement.textContent = `PROG. ${progress.toFixed(0)}%:`;
            } else {
                progressColor = lossColor; 
                displayLabelElement.textContent = `PROG. ${progress.toFixed(0)}%:`;
            }
            displayValueElement.textContent = `${progress.toFixed(1)}%`;
        } else {
            progressColor = '#777';
            displayLabelElement.textContent = `SEM META:`;
            displayValueElement.textContent = `N/A`;
        }

        displayValueElement.style.color = progressColor;
    }

    function updateSummary(gains, costs, netProfit) {
        elements.summaryGains.textContent = formatCurrency(gains);
        elements.summaryCosts.textContent = formatCurrency(costs);
        elements.summaryNetProfit.textContent = formatCurrency(netProfit);
        
        elements.summaryNetProfit.style.color = netProfit >= 0 ? profitColor : lossColor;
    }
    
    function updateWeeklyDisplay(totalProfit, totalGains) {
        const profitColorFinal = totalProfit >= 0 ? profitColor : lossColor;

        elements.weeklyTotalNetProfit.textContent = formatCurrency(totalProfit);
        elements.weeklyTotalNetProfit.style.color = profitColorFinal;
        
        elements.weeklyTotalGains.textContent = formatCurrency(totalGains);
        elements.weeklyTotalGains.style.color = totalGains >= 0 ? lossColor : lossColor; 
        
        elements.weeklyGoalDisplay.textContent = formatCurrency(weeklyGoal);
        updateProgressDisplay(totalGains, weeklyGoal, elements.weeklyProgressLabel, elements.weeklyProgressValue);
    }

    function updateMonthlyDisplay(totalProfit, totalGains) {
        const profitColorFinal = totalProfit >= 0 ? profitColor : lossColor;

        elements.monthlyTotalNetProfit.textContent = formatCurrency(totalProfit);
        elements.monthlyTotalNetProfit.style.color = profitColorFinal;
        
        elements.monthlyTotalGains.textContent = formatCurrency(totalGains);
        elements.monthlyTotalGains.style.color = totalGains >= 0 ? lossColor : lossColor; 
        
        elements.monthlyGoalDisplay.textContent = formatCurrency(monthlyGoal);
        updateProgressDisplay(totalGains, monthlyGoal, elements.monthlyProgressLabel, elements.monthlyProgressValue);
    }
    
    function calculatePlatformEfficiency(records) {
        const currentYearMonth = new Date().toISOString().slice(0, 7); 
        
        // 1. Inicializa os acumuladores por plataforma
        const platformStats = {
            UBER: { gains: 0, km: 0, profit: 0 },
            NINETY_NINE: { gains: 0, km: 0, profit: 0 },
            INDRIVER: { gains: 0, km: 0, profit: 0 },
            PRIVATE: { gains: 0, km: 0, profit: 0 }
        };

        let totalGainsWithoutFixedCost = 0;
        let totalKmRidden = 0;

        // 2. Acumula dados do mês atual
        records.forEach(doc => {
            const docYearMonth = doc.dateInfo ? doc.dateInfo.slice(0, 7) : null;
            if (docYearMonth !== currentYearMonth) return;

            const platformGains = (doc.gainUber || 0) + (doc.gain99 || 0) + (doc.gainIndriver || 0) + (doc.gainPrivate || 0);
            const totalVariableExpenses = (doc.expenseFuel || 0) + (doc.expenseFood || 0) + (doc.expenseParking || 0) + (doc.expenseEmergency || 0) + (doc.expenseOthers || 0);
            const profitBeforeFixedCost = platformGains - totalVariableExpenses;
            
            totalGainsWithoutFixedCost += platformGains;
            totalKmRidden += doc.dailyKm || 0;
            
            if (platformGains > 0) {
                const totalProfitShare = profitBeforeFixedCost / platformGains;
                
                platformStats.UBER.gains += doc.gainUber || 0;
                platformStats.UBER.profit += (doc.gainUber || 0) * totalProfitShare;

                platformStats.NINETY_NINE.gains += doc.gain99 || 0;
                platformStats.NINETY_NINE.profit += (doc.gain99 || 0) * totalProfitShare;

                platformStats.INDRIVER.gains += doc.gainIndriver || 0;
                platformStats.INDRIVER.profit += (doc.gainIndriver || 0) * totalProfitShare;

                platformStats.PRIVATE.gains += doc.gainPrivate || 0;
                platformStats.PRIVATE.profit += (doc.gainPrivate || 0) * totalProfitShare;
            }
        });
        
        // 3. Distribui o Custo Fixo Total do Mês
        const totalMonthlyFixedCost = totalKmRidden * fixedCostPerKmValue;
        
        if (totalKmRidden > 0 && totalGainsWithoutFixedCost > 0) {
            const fixedCostPerGainsShare = totalMonthlyFixedCost / totalGainsWithoutFixedCost;
            
            for (const key in platformStats) {
                const stats = platformStats[key];
                
                stats.finalProfit = stats.profit - (stats.gains * fixedCostPerGainsShare);
                stats.km = totalKmRidden * (stats.gains / totalGainsWithoutFixedCost);
            }
        } else {
            for (const key in platformStats) {
                 platformStats[key].finalProfit = 0;
                 platformStats[key].km = 0;
            }
        }
        
        // 4. Renderiza a tabela
        const platformLabels = {
            UBER: 'UBER', NINETY_NINE: '99', INDRIVER: 'INDRIVER', PRIVATE: 'PARTICULAR'
        };

        elements.platformReportBody.innerHTML = '';
        
        for (const key in platformStats) {
            const stats = platformStats[key];
            const avgProfitPerKm = stats.km > 0 ? stats.finalProfit / stats.km : 0;
            const profitClass = avgProfitPerKm >= 0 ? 'profit-positive' : 'profit-negative';
            
            const row = `
                <tr>
                    <td>${platformLabels[key]}</td>
                    <td>${formatCurrency(stats.gains)}</td>
                    <td class="${profitClass}">${formatCurrency(avgProfitPerKm, 3)} / KM</td>
                </tr>
            `;
            elements.platformReportBody.innerHTML += row;
        }
    }


    function calculateSummaries(records) {
        const currentYearMonth = new Date().toISOString().slice(0, 7); 
        const today = new Date();
        const startOfWeekString = getStartOfWeek(today); 
        
        let monthlyTotalProfit = 0;
        let monthlyTotalGains = 0;
        let monthlyGainBreakdown = { UBER: 0, NINETY_NINE: 0, INDRIVER: 0, PRIVATE: 0, PRODUCTS: 0 };
        let monthlyExpenseBreakdown = { FUEL: 0, FOOD: 0, PARKING: 0, EMERGENCY: 0, OTHERS: 0 };
        
        let weeklyTotalProfit = 0;
        let weeklyTotalGains = 0;
        
        const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const [currentYear, currentMonthIndex] = currentYearMonth.split('-');
        const monthLabel = monthNames[parseInt(currentMonthIndex) - 1] + ' / ' + currentYear;
        
        elements.monthlySummaryMonthLabel.textContent = `${monthLabel} (Líq.):`;

        if (records.length === 0) {
            updateMonthlyDisplay(0, 0);
            updateWeeklyDisplay(0, 0);
            updateGainChart(monthlyGainBreakdown);
            updateExpenseChart(monthlyExpenseBreakdown);
            elements.platformReportBody.innerHTML = `<tr><td colspan="3" style="color: #777;">Lance dados para análise.</td></tr>`;
            return;
        }

        records.forEach(doc => {
            const docDate = doc.dateInfo; 
            const docYearMonth = docDate ? docDate.slice(0, 7) : null;
            
            if (docYearMonth === currentYearMonth) {
                monthlyTotalProfit += doc.netProfit;
                monthlyTotalGains += doc.totalGains;
                
                monthlyGainBreakdown.UBER += doc.gainUber || 0;
                monthlyGainBreakdown.NINETY_NINE += doc.gain99 || 0;
                monthlyGainBreakdown.INDRIVER += doc.gainIndriver || 0;
                monthlyGainBreakdown.PRIVATE += doc.gainPrivate || 0;
                monthlyGainBreakdown.PRODUCTS += doc.gainProducts || 0;
                
                monthlyExpenseBreakdown.FUEL += doc.expenseFuel || 0;
                monthlyExpenseBreakdown.FOOD += doc.expenseFood || 0;
                monthlyExpenseBreakdown.PARKING += doc.expenseParking || 0;
                monthlyExpenseBreakdown.EMERGENCY += doc.expenseEmergency || 0;
                monthlyExpenseBreakdown.OTHERS += doc.expenseOthers || 0;
            }

            if (docDate && docDate >= startOfWeekString) {
                weeklyTotalProfit += doc.netProfit;
                weeklyTotalGains += doc.totalGains;
            }
        });
        
        updateMonthlyDisplay(monthlyTotalProfit, monthlyTotalGains);
        updateWeeklyDisplay(weeklyTotalProfit, weeklyTotalGains);
        updateGainChart(monthlyGainBreakdown);
        updateExpenseChart(monthlyExpenseBreakdown);
        calculatePlatformEfficiency(records); 
    }

    
    // --- FUNÇÃO CHART.JS (Distribuição de Ganhos) ---
    function updateGainChart(gainBreakdown) {
        const ctx = document.getElementById('gainChart').getContext('2d');

        const labels = ['Uber', '99', 'InDriver', 'Particular', 'Vendas/Prod.'];
        const data = [
            gainBreakdown.UBER,
            gainBreakdown.NINETY_NINE,
            gainBreakdown.INDRIVER,
            gainBreakdown.PRIVATE,
            gainBreakdown.PRODUCTS
        ];
        
        const colors = [
            CHART_COLORS.UBER,
            CHART_COLORS.NINETY_NINE,
            CHART_COLORS.INDRIVER,
            CHART_COLORS.PRIVATE,
            CHART_COLORS.PRODUCTS
        ];

        if (gainChartInstance) {
            gainChartInstance.destroy();
        }

        gainChartInstance = new Chart(ctx, {
            type: 'bar', 
            data: {
                labels: labels,
                datasets: [{
                    label: 'Recebimentos Brutos',
                    data: data,
                    backgroundColor: colors,
                    borderColor: colors, 
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false 
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += formatCurrency(context.parsed.y);
                                }
                                return label;
                            }
                        },
                        titleFont: {
                            family: 'Share Tech Mono',
                            weight: '700'
                        },
                        bodyFont: {
                            family: 'Share Tech Mono',
                            size: 10
                        },
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        borderColor: profitColor, 
                        borderWidth: 1
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            color: defaultTextColor,
                            font: { family: 'Share Tech Mono', size: 10 },
                            callback: function(value, index, values) {
                                return 'R$' + value.toFixed(0);
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)' 
                        }
                    },
                    x: {
                        ticks: {
                            color: defaultTextColor,
                            font: { family: 'Share Tech Mono', size: 10 }
                        },
                         grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // --- FUNÇÃO CHART.JS (Distribuição de Despesas) ---
    function updateExpenseChart(expenseBreakdown) {
        const ctx = document.getElementById('expenseChart').getContext('2d');

        const labels = ['Combustível', 'Alimentação', 'Estacionamento', 'Emergência', 'Outros'];
        const data = [
            expenseBreakdown.FUEL,
            expenseBreakdown.FOOD,
            expenseBreakdown.PARKING,
            expenseBreakdown.EMERGENCY,
            expenseBreakdown.OTHERS
        ];

        if (expenseChartInstance) {
            expenseChartInstance.destroy();
        }

        expenseChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Despesas Variáveis',
                    data: data,
                    backgroundColor: [
                        CHART_COLORS.FUEL,
                        CHART_COLORS.FOOD,
                        CHART_COLORS.PARKING,
                        CHART_COLORS.EMERGENCY,
                        CHART_COLORS.OTHERS
                    ],
                    borderColor: [
                        CHART_COLORS.FUEL,
                        CHART_COLORS.FOOD,
                        CHART_COLORS.PARKING,
                        CHART_COLORS.EMERGENCY,
                        CHART_COLORS.OTHERS
                    ], 
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false 
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += formatCurrency(context.parsed.y);
                                }
                                return label;
                            }
                        },
                        titleFont: {
                            family: 'Share Tech Mono',
                            weight: '700'
                        },
                        bodyFont: {
                            family: 'Share Tech Mono',
                            size: 10
                        },
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        borderColor: lossColor, 
                        borderWidth: 1
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            color: defaultTextColor,
                            font: { family: 'Share Tech Mono', size: 10 },
                            callback: function(value, index, values) {
                                return 'R$' + value.toFixed(0);
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)' 
                        }
                    },
                    x: {
                        ticks: {
                            color: defaultTextColor,
                            font: { family: 'Share Tech Mono', size: 10 }
                        },
                         grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    function updateResultDisplay(profit, totalCostToday, totalCostPerKm, profitPerKm, error = null) {
        const profitColorFinal = profit >= 0 ? profitColor : lossColor;
        
        if (error || (profit === 0 && totalCostToday === 0 && profitPerKm === 0 && totalCostPerKm === 0)) {
            let message = "LUCRO POR KM: R$ 0,000";
            if (error) {
                message = error;
                profitColorFinal = errorColor;
            }
            
            elements.resultDisplay.innerHTML = `
                <div class="result-line">LUCRO LÍQUIDO DO DIA: R$ 0,00</div>
                <div class="result-line">CUSTO TOTAL DO DIA: R$ 0,00</div>
                <div class="result-line">CUSTO TOTAL POR KM: R$ 0,000</div>
                <div class="profit-result" style="color:${profitColorFinal};">${message}</div>
            `;
            elements.saveButton.disabled = true;
            currentCalculatedData = null;
            return;
        }

        elements.resultDisplay.innerHTML = `
            <div class="result-line" style="color:${defaultTextColor};">LUCRO LÍQUIDO DO DIA: ${formatCurrency(profit)}</div>
            <div class="result-line" style="color:${defaultTextColor};">CUSTO TOTAL DO DIA: ${formatCurrency(totalCostToday)}</div> 
            <div class="result-line" style="color:${defaultTextColor};">CUSTO TOTAL POR KM: ${formatCurrency(totalCostPerKm, 3)}</div>
            <div class="profit-result" style="color:${profitColorFinal};">${profitPerKm >= 0 ? 'LUCRO' : 'PREJUÍZO'} POR KM: ${formatCurrency(profitPerKm, 3)}</div>
        `;
        
        elements.saveButton.disabled = false;
    }

    function calculateDailyProfit() {
        const dailyKm = getFloatValue(elements.dailyKmInput);
        const fixedCostPerKm = getFloatValue(elements.fixedCostPerKm);
        
        const totalGains = getFloatValue(elements.gainUber) 
                           + getFloatValue(elements.gain99)
                           + getFloatValue(elements.gainIndriver)
                           + getFloatValue(elements.gainPrivate)
                           + getFloatValue(elements.gainProducts);

        const totalVariableExpenses = getFloatValue(elements.expenseParking) 
                                     + getFloatValue(elements.expenseEmergency)
                                     + getFloatValue(elements.expenseFood)
                                     + getFloatValue(elements.expenseFuel)
                                     + getFloatValue(elements.expenseOthers);
        
        const totalFixedCostToday = dailyKm * fixedCostPerKm;
        const totalDailyCost = totalVariableExpenses + totalFixedCostToday;
        const netProfit = totalGains - totalDailyCost;
        
        if (dailyKm <= 0 && totalGains > 0) {
            updateResultDisplay(0, 0, 0, 0, "ERRO: KM Rodado no Dia deve ser informado.");
            currentCalculatedData = null;
            return;
        }
        
        const costPerKm = dailyKm > 0 ? totalDailyCost / dailyKm : 0;
        const profitPerKm = dailyKm > 0 ? netProfit / dailyKm : 0;
        
        updateSummary(totalGains, totalDailyCost, netProfit);
        updateResultDisplay(netProfit, totalDailyCost, costPerKm, profitPerKm);

        currentCalculatedData = {
            dateInfo: elements.dailyInfo.value || new Date().toISOString().slice(0, 10), 
            dailyKm,
            fixedCostPerKm,
            gainUber: getFloatValue(elements.gainUber),
            gain99: getFloatValue(elements.gain99),
            gainIndriver: getFloatValue(elements.gainIndriver),
            gainPrivate: getFloatValue(elements.gainPrivate),
            gainProducts: getFloatValue(elements.gainProducts),
            expenseFuel: getFloatValue(elements.expenseFuel),
            expenseFood: getFloatValue(elements.expenseFood),
            expenseParking: getFloatValue(elements.expenseParking),
            expenseEmergency: getFloatValue(elements.expenseEmergency),
            expenseOthers: getFloatValue(elements.expenseOthers),
            totalGains,
            totalVariableExpenses,
            netProfit,
            totalDailyCost,
            profitPerKm,
            timestamp: serverTimestamp() 
        };
        
        const isUpdate = recordIdToUpdate.value !== '';
        elements.saveButton.textContent = isUpdate ? "ATUALIZAR LANÇAMENTO" : "SALVAR LANÇAMENTO";
    }

    // --- NOVA FUNÇÃO: CARREGA DADOS DO HISTÓRICO PARA OS INPUTS ---
    function loadRecordToInputs(data) {
        // 1. Inputs de KM/Custo Fixo
        elements.dailyKmInput.value = data.dailyKm || '';
        elements.fixedCostPerKm.value = data.fixedCostPerKm || '';

        // 2. Ganhos
        elements.gainUber.value = data.gainUber || '';
        elements.gain99.value = data.gain99 || '';
        elements.gainIndriver.value = data.gainIndriver || '';
        elements.gainPrivate.value = data.gainPrivate || '';
        elements.gainProducts.value = data.gainProducts || '';

        // 3. Despesas
        elements.expenseParking.value = data.expenseParking || '';
        elements.expenseEmergency.value = data.expenseEmergency || '';
        elements.expenseFood.value = data.expenseFood || '';
        elements.expenseFuel.value = data.expenseFuel || '';
        elements.expenseOthers.value = data.expenseOthers || '';
        
        // 4. Data e ID
        elements.dailyInfo.value = data.dateInfo;
        recordIdToUpdate.value = data.id; 
        
        // 5. Calcula o lucro e muda o nome do botão
        calculateDailyProfit(); 
    }

    function renderHistory(records) {
        elements.historyList.innerHTML = '';
        elements.loadingHistory.style.display = 'none';

        if (records.length === 0) {
            elements.historyList.innerHTML = `<li style="text-align:center; color:#777;">Nenhum lançamento salvo ainda.</li>`;
            return;
        }
        
        records.forEach(doc => {
            const data = doc;
            const dateDisplay = formatDateDisplay(data.dateInfo);
            const profit = data.netProfit;
            const profitKm = data.profitPerKm;
            const dailyKm = data.dailyKm; 
            const totalGains = data.totalGains; 
            
            const profitClass = profit < 0 ? 'history-negative' : 'history-profit';

            const listItem = document.createElement('li');
            listItem.className = 'history-item';
            
            listItem.onclick = () => loadRecordToInputs(data); 

            const dataContainer = document.createElement('div');
            dataContainer.className = 'history-data';

            const dateSpan = document.createElement('span');
            dateSpan.className = 'history-date';
            dateSpan.textContent = dateDisplay;

            const profitSpan = document.createElement('span');
            profitSpan.className = profitClass;
            profitSpan.textContent = `Líq.: ${formatCurrency(profit)} | Lucro/KM: ${formatCurrency(profitKm, 3)}`;
            
            const detailsSpan = document.createElement('span');
            detailsSpan.className = 'history-details';
            detailsSpan.textContent = `KM: ${dailyKm} | Bruto: ${formatCurrency(totalGains)}`;

            dataContainer.appendChild(dateSpan);
            dataContainer.appendChild(profitSpan);
            dataContainer.appendChild(detailsSpan); 

            listItem.appendChild(dataContainer);
            elements.historyList.appendChild(listItem);
        });
    }

    let unsubscribeHistory = null;
    
    function subscribeToHistory() {
        if (!db || !isAuthReady) return;
        
        if (unsubscribeHistory) unsubscribeHistory();

        elements.loadingHistory.style.display = 'block';
        elements.loadingHistory.textContent = "Carregando histórico...";

        const recordsRef = getCollectionRef();
        let q = query(recordsRef, orderBy("dateInfo", "desc")); 

        unsubscribeHistory = onSnapshot(q, (snapshot) => {
            allRecords = []; 
            snapshot.forEach(doc => {
                allRecords.push({...doc.data(), id: doc.id}); 
            });
            
            renderHistory(allRecords);
            calculateSummaries(allRecords); 
            
        }, (error) => {
            console.error("Erro ao receber dados do histórico:", error);
            elements.loadingHistory.textContent = "Erro ao carregar histórico.";
        });
    }

    function setTodayDate() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        elements.dailyInfo.value = `${yyyy}-${mm}-${dd}`;
    }


    // --- INICIALIZAÇÃO ---

    async function initializeFirebase() {
        elements.loggedInUserDisplay.textContent = "Conectando...";
        
        try {
            // 1. Inicializa o App
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // 2. Autenticação anônima garantida (padrão mais simples)
            await signInAnonymously(auth);
            
            // 3. O onAuthStateChanged é chamado APÓS o login ser bem-sucedido
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;

                    const displayId = userId.substring(0, 12) + '...'; 
                    elements.loggedInUserDisplay.textContent = displayId; 
                    elements.loggedInUserDisplay.title = `ID Completo do Usuário: ${userId}`; 

                    loadGoals(); 
                    subscribeToHistory(); 
                } else {
                    elements.loggedInUserDisplay.textContent = "ID PENDENTE";
                }
            });

        } catch (error) {
            // Se a inicialização falhar aqui, o problema é na configuração
            console.error("Erro fatal ao inicializar Firebase:", error);
            elements.loggedInUserDisplay.textContent = "ERRO FATAL";
        }
    }
    
    // --- EVENT LISTENERS ---

    if (elements.calculateButton) {
        elements.calculateButton.addEventListener('click', calculateDailyProfit);
    }
    if (elements.saveButton) {
        elements.saveButton.addEventListener('click', saveRecord);
    }
    if (elements.clearButton) {
        elements.clearButton.addEventListener('click', clearInputFields);
    }
    if (elements.saveGoalsButton) {
        elements.saveGoalsButton.addEventListener('click', saveGoals);
    }
    
    const inputElements = document.querySelectorAll('input[type="number"], input[type="date"]');
    inputElements.forEach(input => {
        input.addEventListener('input', calculateDailyProfit);
        input.addEventListener('keydown', (e) => { 
            if (e.key === 'Enter') calculateDailyProfit(); 
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        if (elements.dailyInfo) {
            setTodayDate();
        }
        calculateDailyProfit(); 
        initializeFirebase();
    });
</script>
</body>
</html>

